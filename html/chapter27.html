<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="27">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨CUDAå¼€å‘ç¯å¢ƒçš„ä¸“ä¸šé…ç½®å’Œå·¥å…·é“¾ä¼˜åŒ–ã€‚ä»ç¼–è¯‘å™¨é€‰é¡¹çš„ç²¾ç»†è°ƒä¼˜åˆ°è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹çš„æ„å»ºï¼Œä½ å°†æŒæ¡æ„å»ºé«˜æ•ˆCUDAå¼€å‘å·¥ä½œæµçš„å…¨éƒ¨æŠ€èƒ½ã€‚è¿™äº›å·¥ç¨‹å®è·µç»éªŒå¯¹äºç®¡ç†å¤§å‹CUDAé¡¹ç›®ã€ç¡®ä¿ä»£ç è´¨é‡å’Œä¼˜åŒ–å¼€å‘æ•ˆç‡è‡³å…³é‡è¦ã€‚</p>
<h2 id="271-cuda">27.1 CUDAå·¥å…·é“¾æ·±åº¦é…ç½®</h2>
<h3 id="2711-cuda-toolkit">27.1.1 CUDA Toolkitç»„ä»¶è§£æ</h3>
<p>CUDA ToolkitåŒ…å«å¤šä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œç†è§£æ¯ä¸ªç»„ä»¶çš„ä½œç”¨å¯¹äºä¼˜åŒ–å¼€å‘ç¯å¢ƒè‡³å…³é‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code>CUDA Toolkitæ¶æ„
â”œâ”€â”€ ç¼–è¯‘å™¨å·¥å…·
â”‚   â”œâ”€â”€ nvccï¼šCUDA C++ç¼–è¯‘å™¨é©±åŠ¨
â”‚   â”œâ”€â”€ ptxasï¼šPTXæ±‡ç¼–å™¨
â”‚   â”œâ”€â”€ nvdisasmï¼šäºŒè¿›åˆ¶åæ±‡ç¼–å™¨
â”‚   â””â”€â”€ nvpruneï¼šè®¾å¤‡ä»£ç ç²¾ç®€å·¥å…·
â”œâ”€â”€ è¿è¡Œæ—¶åº“
â”‚   â”œâ”€â”€ cudartï¼šCUDAè¿è¡Œæ—¶API
â”‚   â”œâ”€â”€ cudart_staticï¼šé™æ€é“¾æ¥ç‰ˆæœ¬
â”‚   â””â”€â”€ cudadevrtï¼šè®¾å¤‡è¿è¡Œæ—¶ï¼ˆåŠ¨æ€å¹¶è¡Œï¼‰
â”œâ”€â”€ æ•°å­¦åº“
â”‚   â”œâ”€â”€ cuBLASï¼šçº¿æ€§ä»£æ•°
â”‚   â”œâ”€â”€ cuFFTï¼šå¿«é€Ÿå‚…é‡Œå¶å˜æ¢
â”‚   â”œâ”€â”€ cuSPARSEï¼šç¨€ç–çŸ©é˜µ
â”‚   â”œâ”€â”€ cuSOLVERï¼šçº¿æ€§æ±‚è§£å™¨
â”‚   â””â”€â”€ cuRANDï¼šéšæœºæ•°ç”Ÿæˆ
â”œâ”€â”€ é€šä¿¡åº“
â”‚   â”œâ”€â”€ NCCLï¼šå¤šGPUé€šä¿¡
â”‚   â””â”€â”€ NVSHMEMï¼šåˆ†å¸ƒå¼å…±äº«å†…å­˜
â””â”€â”€ å¼€å‘å·¥å…·
    â”œâ”€â”€ cuda-gdbï¼šè°ƒè¯•å™¨
    â”œâ”€â”€ cuda-memcheckï¼šå†…å­˜æ£€æŸ¥
    â”œâ”€â”€ nvprofï¼šæ€§èƒ½åˆ†æï¼ˆå·²åºŸå¼ƒï¼‰
    â””â”€â”€ nsight-systems/computeï¼šæ–°ä¸€ä»£åˆ†æå·¥å…·
</code></pre></div>

<h3 id="2712">27.1.2 ç¯å¢ƒå˜é‡é…ç½®ç­–ç•¥</h3>
<p>æ­£ç¡®é…ç½®ç¯å¢ƒå˜é‡æ˜¯CUDAå¼€å‘çš„åŸºç¡€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŸºç¡€è·¯å¾„é…ç½®</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_HOME</span><span class="o">=</span>/usr/local/cuda
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$CUDA</span><span class="se">\_</span>HOME/bin:<span class="nv">$PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$CUDA</span><span class="se">\_</span>HOME/lib64:<span class="nv">$LD_LIBRARY_PATH</span>

<span class="c1"># ç¼–è¯‘å™¨è¡Œä¸ºæ§åˆ¶</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_CACHE_DISABLE</span><span class="o">=</span><span class="m">0</span><span class="w">          </span><span class="c1"># å¯ç”¨JITç¼–è¯‘ç¼“å­˜</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_CACHE_MAXSIZE</span><span class="o">=</span><span class="m">268435456</span><span class="w">  </span><span class="c1"># ç¼“å­˜å¤§å°256MB</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_CACHE_PATH</span><span class="o">=</span>/tmp/cuda_cache

<span class="c1"># è¿è¡Œæ—¶ä¼˜åŒ–</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_LAUNCH_BLOCKING</span><span class="o">=</span><span class="m">0</span><span class="w">        </span><span class="c1"># å¼‚æ­¥å†…æ ¸æ‰§è¡Œ</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_DEVICE_ORDER</span><span class="o">=</span>PCI_BUS_ID<span class="w">  </span><span class="c1"># è®¾å¤‡æšä¸¾é¡ºåº</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1<span class="w">      </span><span class="c1"># å¯è§GPUè®¾å¤‡</span>

<span class="c1"># è°ƒè¯•ç›¸å…³</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_ENABLE_COREDUMP_ON_EXCEPTION</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_COREDUMP_FILE</span><span class="o">=</span>/tmp/cuda_coredump.%p
</code></pre></div>

<h3 id="2713-cuda">27.1.3 å¤šç‰ˆæœ¬CUDAç®¡ç†</h3>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œç»å¸¸éœ€è¦åœ¨ä¸åŒCUDAç‰ˆæœ¬é—´åˆ‡æ¢ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½¿ç”¨update-alternativesç®¡ç†ï¼ˆUbuntu/Debianï¼‰</span>
sudo<span class="w"> </span>update-alternatives<span class="w"> </span>--install<span class="w"> </span>/usr/local/cuda<span class="w"> </span>cuda<span class="w"> </span>/usr/local/cuda-11.8<span class="w"> </span><span class="m">118</span>
sudo<span class="w"> </span>update-alternatives<span class="w"> </span>--install<span class="w"> </span>/usr/local/cuda<span class="w"> </span>cuda<span class="w"> </span>/usr/local/cuda-12.0<span class="w"> </span><span class="m">120</span>
sudo<span class="w"> </span>update-alternatives<span class="w"> </span>--config<span class="w"> </span>cuda

<span class="c1"># æˆ–ä½¿ç”¨æ¨¡å—åŒ–ç¯å¢ƒç®¡ç†</span>
<span class="c1"># åˆ›å»ºç‰ˆæœ¬åˆ‡æ¢è„šæœ¬</span>
<span class="c1">#!/bin/bash</span>
<span class="c1"># cuda-switch.sh</span>
<span class="nv">CUDA_VERSION</span><span class="o">=</span><span class="nv">$1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_HOME</span><span class="o">=</span>/usr/local/cuda-<span class="si">${</span><span class="nv">CUDA_VERSION</span><span class="si">}</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$CUDA</span><span class="se">\_</span>HOME/bin:<span class="si">${</span><span class="nv">PATH</span><span class="p">//</span><span class="se">\/</span><span class="nv">usr</span><span class="se">\/</span><span class="nv">local</span><span class="se">\/</span><span class="nv">cuda</span><span class="p">-[0-9.]*</span><span class="se">\/</span><span class="nv">bin</span><span class="p">:/</span><span class="si">}</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$CUDA</span><span class="se">\_</span>HOME/lib64:<span class="si">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="p">//</span><span class="se">\/</span><span class="nv">usr</span><span class="se">\/</span><span class="nv">local</span><span class="se">\/</span><span class="nv">cuda</span><span class="p">-[0-9.]*</span><span class="se">\/</span><span class="nv">lib64</span><span class="p">:/</span><span class="si">}</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Switched to CUDA </span><span class="si">${</span><span class="nv">CUDA_VERSION</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<h3 id="2714">27.1.4 é©±åŠ¨ä¸è¿è¡Œæ—¶ç‰ˆæœ¬å…¼å®¹æ€§</h3>
<p>ç†è§£CUDAé©±åŠ¨å’Œè¿è¡Œæ—¶çš„ç‰ˆæœ¬å…¼å®¹æ€§çŸ©é˜µï¼š</p>
<div class="codehilite"><pre><span></span><code>é©±åŠ¨ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥æµç¨‹ï¼š

1. æ£€æŸ¥é©±åŠ¨ç‰ˆæœ¬ï¼šnvidia-smi
2. æŸ¥çœ‹æ”¯æŒçš„CUDAç‰ˆæœ¬ï¼šnvidia-smiä¸­çš„CUDA Version
3. è¿è¡Œæ—¶ç‰ˆæœ¬ï¼šnvcc --version
4. åº”ç”¨ç¨‹åºç¼–è¯‘ç‰ˆæœ¬ï¼šé€šè¿‡cudaRuntimeGetVersion()è·å–

å…¼å®¹æ€§åŸåˆ™ï¼š

- é©±åŠ¨ç‰ˆæœ¬ &gt;= è¿è¡Œæ—¶ç‰ˆæœ¬ï¼ˆå‘åå…¼å®¹ï¼‰
- ç¼–è¯‘æ—¶CUDAç‰ˆæœ¬ &lt;= è¿è¡Œæ—¶CUDAç‰ˆæœ¬
- PTX JITç¼–è¯‘æä¾›å‰å‘å…¼å®¹æ€§
</code></pre></div>

<h2 id="272-nvcc">27.2 nvccç¼–è¯‘é€‰é¡¹ä¼˜åŒ–</h2>
<h3 id="2721">27.2.1 æ¶æ„ç›®æ ‡ä¸ä»£ç ç”Ÿæˆ</h3>
<p>é€‰æ‹©æ­£ç¡®çš„GPUæ¶æ„å¯¹æ€§èƒ½è‡³å…³é‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c"># åŸºç¡€æ¶æ„æŒ‡å®š</span>
<span class="err">nvcc</span><span class="w"> </span><span class="nv">-arch</span><span class="o">=</span>sm_86<span class="w"> </span>kernel.cu<span class="w">  </span><span class="c1"># é’ˆå¯¹ç‰¹å®šæ¶æ„</span>

<span class="c"># ç”Ÿæˆå¤šæ¶æ„äºŒè¿›åˆ¶</span>
<span class="err">nvcc</span><span class="w"> </span><span class="err">-gencode</span><span class="w"> </span><span class="nv">arch</span><span class="o">=</span>compute_70,code<span class="o">=</span>sm_70<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-gencode<span class="w"> </span><span class="nv">arch</span><span class="o">=</span>compute_75,code<span class="o">=</span>sm_75<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-gencode<span class="w"> </span><span class="nv">arch</span><span class="o">=</span>compute_80,code<span class="o">=</span>sm_80<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-gencode<span class="w"> </span><span class="nv">arch</span><span class="o">=</span>compute_86,code<span class="o">=</span>sm_86<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-gencode<span class="w"> </span><span class="nv">arch</span><span class="o">=</span>compute_86,code<span class="o">=</span>compute_86<span class="w"> </span><span class="se">\ </span><span class="w"> </span><span class="c1"># PTX for future</span>
<span class="w">     </span>kernel.cu

<span class="c"># ä½¿ç”¨æ¶æ„åˆ—è¡¨ç®€åŒ–</span>
<span class="err">nvcc</span><span class="w"> </span><span class="nv">-arch</span><span class="o">=</span>sm_70<span class="w"> </span>-arch<span class="o">=</span>sm_75<span class="w"> </span>-arch<span class="o">=</span>sm_80<span class="w"> </span>-arch<span class="o">=</span>sm_86<span class="w"> </span>kernel.cu

<span class="c"># è™šæ‹Ÿæ¶æ„ç”¨äºå‰å‘å…¼å®¹</span>
<span class="err">nvcc</span><span class="w"> </span><span class="nv">-arch</span><span class="o">=</span>compute_86<span class="w"> </span>-code<span class="o">=</span>compute_86<span class="w"> </span>kernel.cu<span class="w">  </span><span class="c1"># ä»…ç”ŸæˆPTX</span>
</code></pre></div>

<h3 id="2722">27.2.2 ä¼˜åŒ–çº§åˆ«ä¸ç¼–è¯‘æ ‡å¿—</h3>
<p>æ·±å…¥ç†è§£å„ç§ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c"># ä¼˜åŒ–çº§åˆ«</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-O3<span class="w">              </span><span class="c1"># æœ€é«˜ä¼˜åŒ–çº§åˆ«</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-use_fast_math<span class="w">   </span><span class="c1"># å¿«é€Ÿæ•°å­¦åº“ï¼ˆç‰ºç‰²ç²¾åº¦ï¼‰</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-ftz<span class="o">=</span><span class="nb">true</span><span class="w">        </span><span class="c1"># Flush denormals to zero</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-prec-div<span class="o">=</span><span class="nb">false</span><span class="w">  </span><span class="c1"># å…³é—­ç²¾ç¡®é™¤æ³•</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-prec-sqrt<span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="c1"># å…³é—­ç²¾ç¡®å¹³æ–¹æ ¹</span>

<span class="c"># å†…è”æ§åˆ¶</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>--maxrregcount<span class="o">=</span><span class="m">32</span><span class="w">    </span><span class="c1"># é™åˆ¶å¯„å­˜å™¨ä½¿ç”¨</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>--ptxas-options<span class="o">=</span>-v<span class="w">   </span><span class="c1"># æ˜¾ç¤ºå¯„å­˜å™¨å’Œå…±äº«å†…å­˜ä½¿ç”¨</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-lineinfo<span class="w">            </span><span class="c1"># ä¿ç•™è¡Œå·ä¿¡æ¯ï¼ˆç”¨äºprofilingï¼‰</span>

<span class="c"># è®¾å¤‡ä»£ç ä¼˜åŒ–</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-dlcm<span class="o">=</span>cg<span class="w">             </span><span class="c1"># å¯ç”¨L1ç¼“å­˜ç”¨äºå…¨å±€å†…å­˜</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-dscm<span class="o">=</span>wt<span class="w">             </span><span class="c1"># å…±äº«å†…å­˜é…ç½®</span>

<span class="c"># ä¸»æœºç¼–è¯‘å™¨ä¼ é€’</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-Xcompiler<span class="w"> </span>-fopenmp<span class="w">  </span><span class="c1"># å¯ç”¨OpenMP</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-Xcompiler<span class="w"> </span>-march<span class="o">=</span>native<span class="w">  </span><span class="c1"># CPUä¼˜åŒ–</span>
<span class="nv">NVCC_FLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-Xcompiler<span class="w"> </span>-Wall<span class="w">     </span><span class="c1"># å¯ç”¨è­¦å‘Š</span>
</code></pre></div>

<h3 id="2723">27.2.3 ç¼–è¯‘è¯Šæ–­ä¸åˆ†æ</h3>
<p>åˆ©ç”¨ç¼–è¯‘å™¨è¾“å‡ºè¿›è¡Œæ€§èƒ½åˆ†æï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è¯¦ç»†çš„PTXæ±‡ç¼–ä¿¡æ¯</span>
nvcc<span class="w"> </span>-arch<span class="o">=</span>sm_86<span class="w"> </span>--ptxas-options<span class="o">=</span>-v<span class="w"> </span>kernel.cu<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>compile.log

<span class="c1"># è¾“å‡ºç¤ºä¾‹åˆ†æï¼š</span>
<span class="c1"># ptxas info : Function properties for kernel_function</span>
<span class="c1"># 96 bytes stack frame, 0 bytes spill stores, 0 bytes spill loads</span>
<span class="c1"># ptxas info : Used 64 registers, 8192 bytes smem, 360 bytes cmem[0]</span>

<span class="c1"># ç”Ÿæˆä¾èµ–å…³ç³»</span>
nvcc<span class="w"> </span>-M<span class="w"> </span>kernel.cu<span class="w"> </span>&gt;<span class="w"> </span>dependencies.txt

<span class="c1"># ä¿ç•™ä¸­é—´æ–‡ä»¶</span>
nvcc<span class="w"> </span>--keep<span class="w"> </span>kernel.cu<span class="w">  </span><span class="c1"># ä¿ç•™.cubin, .ptxç­‰</span>
nvcc<span class="w"> </span>--keep-dir<span class="w"> </span>./temp<span class="w"> </span>kernel.cu

<span class="c1"># ç”Ÿæˆè®¾å¤‡ä»£ç æ±‡ç¼–</span>
nvcc<span class="w"> </span>-arch<span class="o">=</span>sm_86<span class="w"> </span>-cubin<span class="w"> </span>kernel.cu
cuobjdump<span class="w"> </span>-sass<span class="w"> </span>kernel.cubin<span class="w"> </span>&gt;<span class="w"> </span>kernel.sass
</code></pre></div>

<h3 id="2724">27.2.4 åˆ†ç¦»ç¼–è¯‘ä¸è®¾å¤‡é“¾æ¥</h3>
<p>å¤§å‹é¡¹ç›®çš„æ¨¡å—åŒ–ç¼–è¯‘ç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c"># åˆ†ç¦»ç¼–è¯‘æ¨¡å¼</span>
<span class="c"># æ­¥éª¤1ï¼šç¼–è¯‘ä¸ºè®¾å¤‡å¯¹è±¡æ–‡ä»¶</span>
<span class="err">nvcc</span><span class="w"> </span><span class="nv">-arch</span><span class="o">=</span>sm_86<span class="w"> </span>-dc<span class="w"> </span>kernel1.cu<span class="w"> </span>-o<span class="w"> </span>kernel1.o
<span class="err">nvcc</span><span class="w"> </span><span class="nv">-arch</span><span class="o">=</span>sm_86<span class="w"> </span>-dc<span class="w"> </span>kernel2.cu<span class="w"> </span>-o<span class="w"> </span>kernel2.o

<span class="c"># æ­¥éª¤2ï¼šè®¾å¤‡ä»£ç é“¾æ¥</span>
<span class="err">nvcc</span><span class="w"> </span><span class="nv">-arch</span><span class="o">=</span>sm_86<span class="w"> </span>-dlink<span class="w"> </span>kernel1.o<span class="w"> </span>kernel2.o<span class="w"> </span>-o<span class="w"> </span>device_link.o

<span class="c"># æ­¥éª¤3ï¼šæœ€ç»ˆé“¾æ¥</span>
<span class="err">g++</span><span class="w"> </span><span class="err">main.cpp</span><span class="w"> </span><span class="err">kernel1.o</span><span class="w"> </span><span class="err">kernel2.o</span><span class="w"> </span><span class="err">device_link.o</span><span class="w"> </span><span class="err">-lcudart</span><span class="w"> </span><span class="err">-o</span><span class="w"> </span><span class="err">app</span>

<span class="c"># æˆ–ä½¿ç”¨nvccä¸€æ­¥å®Œæˆ</span>
<span class="err">nvcc</span><span class="w"> </span><span class="nv">-arch</span><span class="o">=</span>sm_86<span class="w"> </span>main.cpp<span class="w"> </span>kernel1.cu<span class="w"> </span>kernel2.cu<span class="w"> </span>-o<span class="w"> </span>app
</code></pre></div>

<h2 id="273-cmake">27.3 CMakeä¸æ„å»ºç³»ç»Ÿé›†æˆ</h2>
<h3 id="2731-cmake-cuda">27.3.1 ç°ä»£CMake CUDAæ”¯æŒ</h3>
<p>CMake 3.18+æä¾›äº†åŸç”ŸCUDAæ”¯æŒï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.18</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">CUDAProject</span><span class="w"> </span><span class="s">LANGUAGES</span><span class="w"> </span><span class="s">CXX</span><span class="w"> </span><span class="s">CUDA</span><span class="p">)</span>

<span class="c"># å¯ç”¨CUDAè¯­è¨€</span>
<span class="nb">enable_language</span><span class="p">(</span><span class="s">CUDA</span><span class="p">)</span>

<span class="c"># è®¾ç½®CUDAæ ‡å‡†</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_STANDARD</span><span class="w"> </span><span class="s">17</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_STANDARD_REQUIRED</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="c"># æ¶æ„é…ç½®</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_ARCHITECTURES</span><span class="w"> </span><span class="s">70</span><span class="w"> </span><span class="s">75</span><span class="w"> </span><span class="s">80</span><span class="w"> </span><span class="s">86</span><span class="p">)</span>

<span class="c"># ç¼–è¯‘é€‰é¡¹</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_FLAGS</span><span class="w"> </span><span class="s2">&quot;${CMAKE_CUDA_FLAGS} -use_fast_math&quot;</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_FLAGS_DEBUG</span><span class="w"> </span><span class="s2">&quot;-g -G -O0&quot;</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_FLAGS_RELEASE</span><span class="w"> </span><span class="s2">&quot;-O3&quot;</span><span class="p">)</span>

<span class="c"># åˆ›å»ºCUDAåº“</span>
<span class="nb">add_library</span><span class="p">(</span><span class="s">cuda_kernels</span><span class="w"> </span><span class="s">STATIC</span>
<span class="w">    </span><span class="s">kernels/gemm.cu</span>
<span class="w">    </span><span class="s">kernels/conv.cu</span>
<span class="w">    </span><span class="s">kernels/reduce.cu</span>
<span class="p">)</span>

<span class="c"># è®¾ç½®ç›®æ ‡å±æ€§</span>
<span class="nb">set_target_properties</span><span class="p">(</span><span class="s">cuda_kernels</span><span class="w"> </span><span class="s">PROPERTIES</span>
<span class="w">    </span><span class="s">CUDA_SEPARABLE_COMPILATION</span><span class="w"> </span><span class="s">ON</span>
<span class="w">    </span><span class="s">CUDA_RESOLVE_DEVICE_SYMBOLS</span><span class="w"> </span><span class="s">ON</span>
<span class="w">    </span><span class="s">POSITION_INDEPENDENT_CODE</span><span class="w"> </span><span class="s">ON</span>
<span class="p">)</span>

<span class="c"># ç›®æ ‡ç¼–è¯‘é€‰é¡¹</span>
<span class="nb">target_compile_options</span><span class="p">(</span><span class="s">cuda_kernels</span><span class="w"> </span><span class="s">PRIVATE</span>
<span class="w">    </span><span class="o">$&lt;</span><span class="nv">$&lt;COMPILE_LANGUAGE:CUDA</span><span class="o">&gt;</span><span class="s">:</span>
<span class="w">        </span><span class="s">--expt-relaxed-constexpr</span>
<span class="w">        </span><span class="s">--extended-lambda</span>
<span class="w">        </span><span class="s">-lineinfo</span>
<span class="w">    </span><span class="s">&gt;</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="2732">27.3.2 ä¾èµ–ç®¡ç†ä¸æŸ¥æ‰¾</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># æŸ¥æ‰¾CUDAç»„ä»¶</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">CUDAToolkit</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>

<span class="c"># é“¾æ¥CUDAåº“</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">my_app</span><span class="w"> </span><span class="s">PRIVATE</span>
<span class="w">    </span><span class="s">CUDA::cudart</span>
<span class="w">    </span><span class="s">CUDA::cublas</span>
<span class="w">    </span><span class="s">CUDA::cufft</span>
<span class="w">    </span><span class="s">CUDA::cusparse</span>
<span class="w">    </span><span class="s">CUDA::curand</span>
<span class="w">    </span><span class="s">CUDA::npp</span>
<span class="p">)</span>

<span class="c"># æ¡ä»¶æŸ¥æ‰¾å¯é€‰ç»„ä»¶</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">CUDAToolkit</span><span class="w"> </span><span class="s">COMPONENTS</span><span class="w"> </span><span class="s">cudnn</span><span class="w"> </span><span class="s">nccl</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="s">CUDAToolkit_FOUND</span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s">TARGET</span><span class="w"> </span><span class="s">CUDA::cudnn</span><span class="p">)</span>
<span class="w">        </span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">my_app</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">CUDA::cudnn</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s">TARGET</span><span class="w"> </span><span class="s">CUDA::nccl</span><span class="p">)</span>
<span class="w">        </span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">my_app</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">CUDA::nccl</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># è‡ªå®šä¹‰CUDAè·¯å¾„</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CUDAToolkit_ROOT</span><span class="w"> </span><span class="s">/usr/local/cuda-12.0</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">CUDAToolkit</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
</code></pre></div>

<h3 id="2733">27.3.3 æ··åˆç¼–è¯‘é…ç½®</h3>
<p>å¤„ç†CUDAä¸C++çš„æ··åˆç¼–è¯‘ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c"># åˆ›å»ºæ··åˆç›®æ ‡</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="s">hybrid_app</span>
<span class="w">    </span><span class="s">main.cpp</span>
<span class="w">    </span><span class="s">cpu_algo.cpp</span>
<span class="w">    </span><span class="s">gpu_kernels.cu</span>
<span class="w">    </span><span class="s">utils.cpp</span>
<span class="p">)</span>

<span class="c"># é’ˆå¯¹ä¸åŒè¯­è¨€è®¾ç½®ä¸åŒé€‰é¡¹</span>
<span class="nb">target_compile_options</span><span class="p">(</span><span class="s">hybrid_app</span><span class="w"> </span><span class="s">PRIVATE</span>
<span class="w">    </span><span class="o">$&lt;</span><span class="nv">$&lt;COMPILE_LANGUAGE:CXX</span><span class="o">&gt;</span><span class="s">:-Wall</span><span class="w"> </span><span class="s">-Wextra</span><span class="w"> </span><span class="s">-O3&gt;</span>
<span class="w">    </span><span class="o">$&lt;</span><span class="nv">$&lt;COMPILE_LANGUAGE:CUDA</span><span class="o">&gt;</span><span class="s">:--extended-lambda</span><span class="w"> </span><span class="s">-lineinfo&gt;</span>
<span class="p">)</span>

<span class="c"># æ¥å£åº“ç”¨äºå¤´æ–‡ä»¶</span>
<span class="nb">add_library</span><span class="p">(</span><span class="s">cuda_interface</span><span class="w"> </span><span class="s">INTERFACE</span><span class="p">)</span>
<span class="nb">target_include_directories</span><span class="p">(</span><span class="s">cuda_interface</span><span class="w"> </span><span class="s">INTERFACE</span>
<span class="w">    </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/include</span>
<span class="w">    </span><span class="o">${</span><span class="nv">CUDAToolkit_INCLUDE_DIRS</span><span class="o">}</span>
<span class="p">)</span>

<span class="c"># ç”Ÿæˆå™¨è¡¨è¾¾å¼</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="s">hybrid_app</span><span class="w"> </span><span class="s">PRIVATE</span>
<span class="w">    </span><span class="o">$&lt;</span><span class="nv">$&lt;CONFIG:Debug</span><span class="o">&gt;</span><span class="s">:DEBUG_MODE&gt;</span>
<span class="w">    </span><span class="o">$&lt;</span><span class="nv">$&lt;AND:$&lt;CONFIG:Release</span><span class="o">&gt;</span><span class="s">,</span><span class="o">$&lt;</span><span class="nv">COMPILE_LANGUAGE:CUDA</span><span class="o">&gt;</span><span class="s">&gt;:USE_FAST_MATH&gt;</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="2734">27.3.4 æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•é›†æˆ</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># å¯ç”¨æµ‹è¯•</span>
<span class="nb">enable_testing</span><span class="p">()</span>

<span class="c"># æ·»åŠ Google Test</span>
<span class="nb">include</span><span class="p">(</span><span class="s">FetchContent</span><span class="p">)</span>
<span class="nb">FetchContent_Declare</span><span class="p">(</span>
<span class="w">    </span><span class="s">googletest</span>
<span class="w">    </span><span class="s">GIT_REPOSITORY</span><span class="w"> </span><span class="s">https://github.com/google/googletest.git</span>
<span class="w">    </span><span class="s">GIT_TAG</span><span class="w"> </span><span class="s">release-1.12.1</span>
<span class="p">)</span>
<span class="nb">FetchContent_MakeAvailable</span><span class="p">(</span><span class="s">googletest</span><span class="p">)</span>

<span class="c"># CUDAæµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="s">cuda_tests</span>
<span class="w">    </span><span class="s">tests/test_kernels.cu</span>
<span class="w">    </span><span class="s">tests/test_memory.cu</span>
<span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">cuda_tests</span><span class="w"> </span><span class="s">PRIVATE</span>
<span class="w">    </span><span class="s">cuda_kernels</span>
<span class="w">    </span><span class="s">gtest_main</span>
<span class="w">    </span><span class="s">CUDA::cudart</span>
<span class="p">)</span>

<span class="c"># æ³¨å†Œæµ‹è¯•</span>
<span class="nb">add_test</span><span class="p">(</span><span class="s">NAME</span><span class="w"> </span><span class="s">CUDATests</span><span class="w"> </span><span class="s">COMMAND</span><span class="w"> </span><span class="s">cuda_tests</span><span class="p">)</span>

<span class="c"># æ€§èƒ½åŸºå‡†æµ‹è¯•</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="s">benchmarks</span>
<span class="w">    </span><span class="s">benchmarks/bench_gemm.cu</span>
<span class="w">    </span><span class="s">benchmarks/bench_reduce.cu</span>
<span class="p">)</span>

<span class="c"># è‡ªå®šä¹‰æµ‹è¯•å‘½ä»¤</span>
<span class="nb">add_custom_target</span><span class="p">(</span><span class="s">benchmark</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="s">benchmarks</span><span class="w"> </span><span class="s">--benchmark_format=json</span><span class="w"> </span><span class="s">&gt;</span><span class="w"> </span><span class="s">results.json</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">benchmarks</span>
<span class="w">    </span><span class="s">COMMENT</span><span class="w"> </span><span class="s2">&quot;Running performance benchmarks&quot;</span>
<span class="p">)</span>

<span class="c">## 27.4 Nsightå…¨å®¶æ—å·¥å…·ç²¾é€š</span>

<span class="c">### 27.4.1 Nsight Systemsç³»ç»Ÿçº§åˆ†æ</span>

<span class="err">Nsight</span><span class="w"> </span><span class="err">Systemsæä¾›å…¨ç³»ç»Ÿçš„æ€§èƒ½æ—¶é—´çº¿åˆ†æï¼š</span>

<span class="err">```bash</span>
<span class="c"># åŸºç¡€ä½¿ç”¨</span>
<span class="err">nsys</span><span class="w"> </span><span class="err">profile</span><span class="w"> </span><span class="err">./my_cuda_app</span>
<span class="err">nsys</span><span class="w"> </span><span class="err">profile</span><span class="w"> </span><span class="err">-o</span><span class="w"> </span><span class="err">report</span><span class="w"> </span><span class="err">./my_cuda_app</span><span class="w">  </span><span class="c"># æŒ‡å®šè¾“å‡ºæ–‡ä»¶</span>

<span class="c"># é«˜çº§é€‰é¡¹</span>
<span class="err">nsys</span><span class="w"> </span><span class="err">profile</span><span class="w"> </span><span class="err">\</span>
<span class="w">    </span><span class="err">--trace=cuda,nvtx,osrt,cudnn,cublas</span><span class="w"> </span><span class="err">\</span><span class="w">  </span><span class="c"># è¿½è¸ªç»„ä»¶</span>
<span class="w">    </span><span class="err">--sample=cpu</span><span class="w"> </span><span class="err">\</span><span class="w">                          </span><span class="c"># CPUé‡‡æ ·</span>
<span class="w">    </span><span class="err">--cuda-memory-usage=true</span><span class="w"> </span><span class="err">\</span><span class="w">              </span><span class="c"># å†…å­˜ä½¿ç”¨è¿½è¸ª</span>
<span class="w">    </span><span class="err">--cuda-um-cpu-page-faults=true</span><span class="w"> </span><span class="err">\</span><span class="w">        </span><span class="c"># ç»Ÿä¸€å†…å­˜ç¼ºé¡µ</span>
<span class="w">    </span><span class="err">--output=profile</span><span class="w"> </span><span class="err">\</span><span class="w">                      </span><span class="c"># è¾“å‡ºå‰ç¼€</span>
<span class="w">    </span><span class="err">--export=json</span><span class="w"> </span><span class="err">\</span><span class="w">                         </span><span class="c"># å¯¼å‡ºæ ¼å¼</span>
<span class="w">    </span><span class="err">./my_cuda_app</span>

<span class="c"># å‘½ä»¤è¡ŒæŠ¥å‘Šç”Ÿæˆ</span>
<span class="err">nsys</span><span class="w"> </span><span class="err">stats</span><span class="w"> </span><span class="err">profile.nsys-rep</span><span class="w">              </span><span class="c"># ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š</span>
<span class="err">nsys</span><span class="w"> </span><span class="err">export</span><span class="w"> </span><span class="err">-t</span><span class="w"> </span><span class="err">json</span><span class="w"> </span><span class="err">profile.nsys-rep</span><span class="w">     </span><span class="c"># å¯¼å‡ºä¸ºJSON</span>
</code></pre></div>

<p>NVTXæ ‡è®°ç”¨äºè‡ªå®šä¹‰æ€§èƒ½åŒºåŸŸï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;nvtx3/nvToolsExt.h&gt;</span>

<span class="c1">// ç®€å•æ ‡è®°</span>
<span class="n">nvtxRangePush</span><span class="p">(</span><span class="s">&quot;Matrix Multiplication&quot;</span><span class="p">);</span>
<span class="c1">// ... CUDA kernel launch ...</span>
<span class="n">nvtxRangePop</span><span class="p">();</span>

<span class="c1">// å¸¦é¢œè‰²å’Œæ¶ˆæ¯çš„æ ‡è®°</span>
<span class="n">nvtxEventAttributes_t</span><span class="w"> </span><span class="n">eventAttrib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="n">eventAttrib</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NVTX_VERSION</span><span class="p">;</span>
<span class="n">eventAttrib</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NVTX_EVENT_ATTRIB_STRUCT_SIZE</span><span class="p">;</span>
<span class="n">eventAttrib</span><span class="p">.</span><span class="n">colorType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NVTX_COLOR_ARGB</span><span class="p">;</span>
<span class="n">eventAttrib</span><span class="p">.</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF00FF00</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç»¿è‰²</span>
<span class="n">eventAttrib</span><span class="p">.</span><span class="n">messageType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NVTX_MESSAGE_TYPE_ASCII</span><span class="p">;</span>
<span class="n">eventAttrib</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">ascii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Critical Section&quot;</span><span class="p">;</span>
<span class="n">nvtxRangePushEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eventAttrib</span><span class="p">);</span>
<span class="c1">// ... å…³é”®ä»£ç  ...</span>
<span class="n">nvtxRangePop</span><span class="p">();</span>

<span class="c1">// C++å°è£…</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NVTXTracer</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">NVTXTracer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">nvtxRangePush</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="o">~</span><span class="n">NVTXTracer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">nvtxRangePop</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NVTX_SCOPE(name) NVTXTracer _tracer(name)</span>
</code></pre></div>

<h3 id="2742-nsight-compute">27.4.2 Nsight Computeå†…æ ¸çº§åˆ†æ</h3>
<p>Nsight Computeä¸“æ³¨äºå•ä¸ªå†…æ ¸çš„æ·±åº¦åˆ†æï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŸºç¡€å†…æ ¸åˆ†æ</span>
ncu<span class="w"> </span>./my_cuda_app<span class="w">                        </span><span class="c1"># åˆ†ææ‰€æœ‰å†…æ ¸</span>
ncu<span class="w"> </span>--kernel-name<span class="w"> </span>gemm<span class="w"> </span>./my_cuda_app<span class="w">     </span><span class="c1"># æŒ‡å®šå†…æ ¸</span>
ncu<span class="w"> </span>--launch-skip<span class="w"> </span><span class="m">10</span><span class="w"> </span>--launch-count<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\ </span><span class="w"> </span><span class="c1"># è·³è¿‡å‰10æ¬¡å¯åŠ¨</span>
<span class="w">    </span>./my_cuda_app

<span class="c1"># è¯¦ç»†åˆ†æé›†</span>
ncu<span class="w"> </span>--set<span class="w"> </span>full<span class="w"> </span>./my_cuda_app<span class="w">             </span><span class="c1"># å®Œæ•´åˆ†æ</span>
ncu<span class="w"> </span>--set<span class="w"> </span>detailed<span class="w"> </span>./my_cuda_app<span class="w">         </span><span class="c1"># è¯¦ç»†åˆ†æ</span>
ncu<span class="w"> </span>--set<span class="w"> </span>roofline<span class="w"> </span>./my_cuda_app<span class="w">         </span><span class="c1"># Rooflineæ¨¡å‹</span>

<span class="c1"># è‡ªå®šä¹‰æŒ‡æ ‡</span>
ncu<span class="w"> </span>--metrics<span class="w"> </span>sm__cycles_elapsed.avg,<span class="se">\</span>
<span class="w">    </span>sm__warps_active.avg.pct_of_peak_sustained,<span class="se">\</span>
<span class="w">    </span>l1tex__throughput.avg.pct_of_peak_sustained,<span class="se">\</span>
<span class="w">    </span>lts__throughput.avg.pct_of_peak_sustained<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>./my_cuda_app

<span class="c1"># æºç å…³è”</span>
ncu<span class="w"> </span>--target-processes<span class="w"> </span>all<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--kernel-name-base<span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--launch-skip-before-match<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--section<span class="w"> </span>SourceCounters<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>./my_cuda_app
</code></pre></div>

<p>è§„åˆ™å¼•å¯¼çš„ä¼˜åŒ–å»ºè®®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Nsight Computeè§„åˆ™ç¤ºä¾‹</span>
<span class="n">Memory</span><span class="w"> </span><span class="n">Workload</span><span class="w"> </span><span class="n">Analysis</span><span class="p">:</span>

<span class="o">-</span><span class="w"> </span><span class="n">L1</span><span class="o">/</span><span class="n">TEX</span><span class="w"> </span><span class="n">Cache</span><span class="p">:</span><span class="w"> </span><span class="mi">45</span><span class="o">%</span><span class="w"> </span><span class="n">hit</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="p">(</span><span class="err">ä½äºé¢„æœŸ</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="n">Cache</span><span class="p">:</span><span class="w"> </span><span class="mi">78</span><span class="o">%</span><span class="w"> </span><span class="n">hit</span><span class="w"> </span><span class="n">rate</span>
<span class="o">-</span><span class="w"> </span><span class="err">å»ºè®®ï¼šè€ƒè™‘æ•°æ®å±€éƒ¨æ€§ä¼˜åŒ–æˆ–ä½¿ç”¨å…±äº«å†…å­˜</span>

<span class="n">Compute</span><span class="w"> </span><span class="n">Workload</span><span class="w"> </span><span class="n">Analysis</span><span class="p">:</span>

<span class="o">-</span><span class="w"> </span><span class="n">SM</span><span class="w"> </span><span class="n">Activity</span><span class="p">:</span><span class="w"> </span><span class="mi">89</span><span class="o">%</span><span class="w"> </span>
<span class="o">-</span><span class="w"> </span><span class="n">Eligible</span><span class="w"> </span><span class="n">Warps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Scheduler</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="p">(</span><span class="err">ä½</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="err">å»ºè®®ï¼šå¢åŠ å¹¶è¡Œåº¦æˆ–å‡å°‘å¯„å­˜å™¨ä½¿ç”¨</span>

<span class="n">Launch</span><span class="w"> </span><span class="n">Statistics</span><span class="p">:</span>

<span class="o">-</span><span class="w"> </span><span class="n">Block</span><span class="w"> </span><span class="n">Size</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span>
<span class="o">-</span><span class="w"> </span><span class="n">Grid</span><span class="w"> </span><span class="n">Size</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="o">-</span><span class="w"> </span><span class="n">Occupancy</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="err">ç†è®ºæœ€å¤§</span><span class="p">:</span><span class="w"> </span><span class="mi">75</span><span class="o">%</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="err">å»ºè®®ï¼šè°ƒæ•´</span><span class="n">blockå¤§å°ä¸º192ä»¥æé«˜å ç”¨ç‡</span>
</code></pre></div>

<h3 id="2743-nsight-vscode-extension">27.4.3 Nsight VSCode Extension</h3>
<p>åœ¨VSCodeä¸­é›†æˆCUDAå¼€å‘ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// .vscode/launch.json</span>
<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.2.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;configurations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CUDA C++: Launch&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cuda-gdb&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;launch&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;program&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${workspaceFolder}/build/my_app&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;stopAtEntry&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${workspaceFolder}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;environment&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;externalConsole&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;MIMode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cuda-gdb&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;cudaGdbPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/usr/local/cuda/bin/cuda-gdb&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;setupCommands&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;set cuda memcheck on&quot;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;set cuda api_failures stop&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>

<span class="c1">// .vscode/tasks.json</span>
<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;tasks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Build CUDA&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nvcc&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;-g&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;-G&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;-arch=sm_86&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;-o&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;${workspaceFolder}/build/${fileBasenameNoExtension}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;${file}&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;isDefault&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Profile with Nsight&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nsys&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;profile&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;--output=${workspaceFolder}/profiles/${fileBasenameNoExtension}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;${workspaceFolder}/build/${fileBasenameNoExtension}&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2744">27.4.4 æ€§èƒ½åˆ†æå·¥ä½œæµé›†æˆ</h3>
<p>å»ºç«‹å®Œæ•´çš„æ€§èƒ½åˆ†ææµç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># performance_workflow.py</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">class</span> <span class="nc">CUDAPerformanceAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">executable</span>

    <span class="k">def</span> <span class="nf">system_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;profiles&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç³»ç»Ÿçº§æ€§èƒ½è¿½è¸ª&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nsys&quot;</span><span class="p">,</span> <span class="s2">&quot;profile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--trace=cuda,nvtx,osrt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/system&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--export&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executable</span>
        <span class="p">]</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># è§£æJSONç»“æœ</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/system.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_system_trace</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kernel_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å†…æ ¸çº§æ·±åº¦åˆ†æ&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ncu&quot;</span><span class="p">,</span> <span class="s2">&quot;--csv&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">kernel_name</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--kernel-name&quot;</span><span class="p">,</span> <span class="n">kernel_name</span><span class="p">])</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_kernel_metrics</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">roofline_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rooflineæ¨¡å‹åˆ†æ&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ncu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--set&quot;</span><span class="p">,</span> <span class="s2">&quot;roofline&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--csv&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executable</span>
        <span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_roofline_plot</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆç»¼åˆæ€§èƒ½æŠ¥å‘Š&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_trace</span><span class="p">(),</span>
            <span class="s2">&quot;kernels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_analysis</span><span class="p">(),</span>
            <span class="s2">&quot;roofline&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">roofline_analysis</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># ç”ŸæˆHTMLæŠ¥å‘Š</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_html_report</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<h2 id="275-cicd">27.5 CI/CDæµæ°´çº¿æ­å»º</h2>
<h3 id="2751-dockercuda">27.5.1 Dockerå®¹å™¨åŒ–CUDAå¼€å‘</h3>
<p>åˆ›å»ºå¯é‡å¤çš„CUDAå¼€å‘ç¯å¢ƒï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">nvidia/cuda:12.0-devel-ubuntu22.04</span>

<span class="c"># å®‰è£…å¼€å‘å·¥å…·</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>build-essential<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>cmake<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>git<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>wget<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python3-pip<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ninja-build<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*

<span class="c"># å®‰è£…Nsightå·¥å…·</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>nsight-compute-2023.1.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>nsight-systems-2023.1.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*

<span class="c"># è®¾ç½®å·¥ä½œç›®å½•</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/workspace</span>

<span class="c"># å®‰è£…Pythonä¾èµ–</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># å¤åˆ¶é¡¹ç›®æ–‡ä»¶</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="c"># æ„å»ºé¡¹ç›®</span>
<span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>cmake<span class="w"> </span>-GNinja<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="s2">&quot;70;75;80;86&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ninja

<span class="c"># è¿è¡Œæµ‹è¯•</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ctest&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--output-on-failure&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Docker Composeå¤šå®¹å™¨ç¼–æ’ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># docker-compose.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cuda-dev</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="w">    </span><span class="nt">runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NVIDIA_VISIBLE_DEVICES=all</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CUDA_VISIBLE_DEVICES=0,1</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.:/workspace</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda-cache:/root/.cache</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>

<span class="w">  </span><span class="nt">benchmark</span><span class="p">:</span>
<span class="w">    </span><span class="nt">extends</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda-dev</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;./build/benchmarks&quot;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">extends</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda-dev</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ctest&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--output-on-failure&quot;</span><span class="p p-Indicator">]</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cuda-cache</span><span class="p">:</span>
</code></pre></div>

<h3 id="2752-github-actions-cuda-ci">27.5.2 GitHub Actions CUDA CI</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/cuda-ci.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CUDA CI/CD Pipeline</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build-and-test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">container</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia/cuda:12.0-devel-ubuntu22.04</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--gpus all</span>

<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">cuda_arch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">70</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">75</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">80</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">86</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">build_type</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Debug</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Release</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">apt-get update</span>
<span class="w">        </span><span class="no">apt-get install -y cmake ninja-build</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure CMake</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">cmake -B build -G Ninja \</span>
<span class="w">          </span><span class="no">-DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \</span>
<span class="w">          </span><span class="no">-DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cuda_arch }}</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake --build build --config ${{ matrix.build_type }}</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Test</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">cd build</span>
<span class="w">        </span><span class="no">ctest -C ${{ matrix.build_type }} --output-on-failure</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Benchmark</span>
<span class="w">      </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix.build_type == &#39;Release&#39;</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">./build/benchmarks --benchmark_format=json \</span>
<span class="w">          </span><span class="no">&gt; benchmark_results.json</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload benchmark results</span>
<span class="w">      </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix.build_type == &#39;Release&#39;</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">benchmark-sm${{ matrix.cuda_arch }}</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">benchmark_results.json</span>

<span class="w">  </span><span class="nt">performance-regression</span><span class="p">:</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build-and-test</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download current benchmarks</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/download-artifact@v3</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">current/</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download baseline benchmarks</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dawidd6/action-download-artifact@v2</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">workflow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda-ci.yml</span>
<span class="w">        </span><span class="nt">branch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">baseline/</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Compare performance</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">python3 scripts/compare_benchmarks.py \</span>
<span class="w">          </span><span class="no">baseline/ current/ \</span>
<span class="w">          </span><span class="no">--threshold 0.05 \</span>
<span class="w">          </span><span class="no">--output performance_report.html</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Comment PR</span>
<span class="w">      </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.event_name == &#39;pull_request&#39;</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/github-script@v6</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">const fs = require(&#39;fs&#39;);</span>
<span class="w">          </span><span class="no">const report = fs.readFileSync(&#39;performance_report.html&#39;, &#39;utf8&#39;);</span>
<span class="w">          </span><span class="no">github.rest.issues.createComment({</span>
<span class="w">            </span><span class="no">issue_number: context.issue.number,</span>
<span class="w">            </span><span class="no">owner: context.repo.owner,</span>
<span class="w">            </span><span class="no">repo: context.repo.repo,</span>
<span class="w">            </span><span class="no">body: report</span>
<span class="w">          </span><span class="no">});</span>
</code></pre></div>

<h3 id="2753">27.5.3 æ€§èƒ½å›å½’æ£€æµ‹</h3>
<p>è‡ªåŠ¨åŒ–æ€§èƒ½å›å½’æ£€æµ‹ç³»ç»Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># scripts/performance_regression.py</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span> <span class="nc">PerformanceRegression</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline_path</span><span class="p">,</span> <span class="n">current_path</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_benchmarks</span><span class="p">(</span><span class="n">baseline_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_benchmarks</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regressions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_load_benchmarks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">detect_regressions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">benchmark</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;benchmarks&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">[</span><span class="s1">&#39;real_time&#39;</span><span class="p">]</span>

            <span class="c1"># æŸ¥æ‰¾åŸºçº¿</span>
            <span class="n">baseline_bench</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">[</span><span class="s1">&#39;benchmarks&#39;</span><span class="p">]</span> 
                 <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">baseline_bench</span><span class="p">:</span>
                <span class="n">baseline_time</span> <span class="o">=</span> <span class="n">baseline_bench</span><span class="p">[</span><span class="s1">&#39;real_time&#39;</span><span class="p">]</span>
                <span class="n">regression</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">baseline_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">baseline_time</span>

                <span class="k">if</span> <span class="n">regression</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">regressions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">baseline_time</span><span class="p">,</span>
                        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                        <span class="s1">&#39;regression&#39;</span><span class="p">:</span> <span class="n">regression</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressions</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;âŒ Performance Regressions Detected:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;regression&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% slower&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Baseline: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Current:  </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;âœ… No performance regressions detected&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="n">PerformanceRegression</span><span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
        <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.05</span>
    <span class="p">)</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">detect_regressions</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">detector</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>

<h3 id="2754">27.5.4 è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶</h3>
<p>æ„å»ºå…¨é¢çš„CUDAæµ‹è¯•æ¡†æ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// tests/cuda_test_framework.h</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gtest/gtest.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;random&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CUDATest</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Test</span><span class="w"> </span><span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SetUp</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆå§‹åŒ–CUDAç¯å¢ƒ</span>
<span class="w">        </span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaDeviceProp</span><span class="w"> </span><span class="n">prop</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaGetDeviceProperties</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">sm_count_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">multiProcessorCount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">TearDown</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ¸…ç†CUDAç¯å¢ƒ</span>
<span class="w">        </span><span class="n">cudaDeviceReset</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// éªŒè¯å†…æ ¸é”™è¯¯</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">CheckCudaError</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaError_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaGetLastError</span><span class="p">();</span>
<span class="w">        </span><span class="n">ASSERT_EQ</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span>
<span class="w">                                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cudaGetErrorString</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ€§èƒ½åŸºå‡†æµ‹è¯•</span>
<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Kernel</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">BenchmarkKernel</span><span class="p">(</span><span class="n">Kernel</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é¢„çƒ­</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">kernel</span><span class="p">();</span>

<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">kernel</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventSynchronize</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">ms</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaEventElapsedTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sm_count_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// å‚æ•°åŒ–æµ‹è¯•å®</span>
<span class="cp">#define CUDA_TEST_P(test_suite, test_name) \</span>
<span class="cp">    TEST_P(test_suite, test_name)</span>

<span class="c1">// æ€§èƒ½å›å½’æµ‹è¯•å®</span>
<span class="cp">#define PERFORMANCE_TEST(test_name, baseline_ms) \</span>
<span class="cp">    TEST_F(CUDATest, test_name) { \</span>
<span class="cp">        float actual_ms = BenchmarkKernel([&amp;](){ \</span>
<span class="cp">            </span><span class="cm">/* å†…æ ¸è°ƒç”¨ */</span><span class="cp"> \</span>
<span class="cp">        }); \</span>
<span class="cp">        EXPECT_LE(actual_ms, baseline_ms * 1.05) \</span>
<span class="cp">            &lt;&lt; &quot;Performance regression detected&quot;; \</span>
<span class="cp">    }</span>
</code></pre></div>

<h2 id="276">27.6 æ¡ˆä¾‹ï¼šå¤§å‹é¡¹ç›®çš„å·¥ç¨‹åŒ–å®è·µ</h2>
<h3 id="2761">27.6.1 é¡¹ç›®ç»“æ„è®¾è®¡</h3>
<p>å¤§å‹CUDAé¡¹ç›®çš„æ ‡å‡†åŒ–ç›®å½•ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code>cuda_project/
â”œâ”€â”€ CMakeLists.txt              # æ ¹æ„å»ºé…ç½®
â”œâ”€â”€ README.md                   # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/             # CI/CDé…ç½®
â”‚       â”œâ”€â”€ build.yml
â”‚       â”œâ”€â”€ test.yml
â”‚       â””â”€â”€ benchmark.yml
â”œâ”€â”€ cmake/                      # CMakeæ¨¡å—
â”‚   â”œâ”€â”€ FindCUDAToolkit.cmake
â”‚   â”œâ”€â”€ CUDAConfig.cmake
â”‚   â””â”€â”€ Utilities.cmake
â”œâ”€â”€ include/                    # å…¬å…±å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ kernels/
â”‚   â”œâ”€â”€ utils/
â”‚   â””â”€â”€ api/
â”œâ”€â”€ src/                        # æºä»£ç 
â”‚   â”œâ”€â”€ kernels/               # CUDAå†…æ ¸
â”‚   â”‚   â”œâ”€â”€ gemm.cu
â”‚   â”‚   â”œâ”€â”€ conv.cu
â”‚   â”‚   â””â”€â”€ reduce.cu
â”‚   â”œâ”€â”€ host/                  # ä¸»æœºä»£ç 
â”‚   â”‚   â”œâ”€â”€ memory_pool.cpp
â”‚   â”‚   â””â”€â”€ scheduler.cpp
â”‚   â””â”€â”€ bindings/              # è¯­è¨€ç»‘å®š
â”‚       â”œâ”€â”€ python/
â”‚       â””â”€â”€ julia/
â”œâ”€â”€ tests/                      # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ performance/
â”œâ”€â”€ benchmarks/                 # æ€§èƒ½åŸºå‡†
â”‚   â”œâ”€â”€ micro/
â”‚   â””â”€â”€ end_to_end/
â”œâ”€â”€ scripts/                    # è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ setup.sh
â”‚   â”œâ”€â”€ profile.py
â”‚   â””â”€â”€ deploy.sh
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ tutorials/
â”‚   â””â”€â”€ design/
â””â”€â”€ third_party/               # ç¬¬ä¸‰æ–¹ä¾èµ–
    â”œâ”€â”€ cutlass/
    â””â”€â”€ cub/
</code></pre></div>

<h3 id="2762">27.6.2 æ¨¡å—åŒ–å†…æ ¸ç®¡ç†</h3>
<p>å®ç°å¯æ‰©å±•çš„å†…æ ¸æ³¨å†Œç³»ç»Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel_registry.h</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unordered_map&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;functional&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">KernelRegistry</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">KernelLauncher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">KernelRegistry</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">Instance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">KernelRegistry</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ³¨å†Œå†…æ ¸</span>
<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Kernel</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">RegisterKernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Kernel</span><span class="w"> </span><span class="n">kernel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kernels_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">kernel</span><span class="p">](</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">kernel</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å¯åŠ¨å†…æ ¸</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">LaunchKernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                      </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">kernels_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Kernel not found: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ€§èƒ½åˆ†æ</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">ProfileKernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">int</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernels_</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>

<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">kernel</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventSynchronize</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">ms</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaEventElapsedTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="n">profile_results_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è·å–æ€§èƒ½æ•°æ®</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetProfileResults</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">profile_results_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">KernelLauncher</span><span class="o">&gt;</span><span class="w"> </span><span class="n">kernels_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">profile_results_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// è‡ªåŠ¨æ³¨å†Œå®</span>
<span class="cp">#define REGISTER_KERNEL(name, kernel) \</span>
<span class="cp">    static bool _##name##_registered = []() { \</span>
<span class="cp">        KernelRegistry::Instance().RegisterKernel(#name, kernel); \</span>
<span class="cp">        return true; \</span>
<span class="cp">    }();</span>
</code></pre></div>

<h3 id="2763">27.6.3 å†…å­˜æ± ä¸èµ„æºç®¡ç†</h3>
<p>å®ç°é«˜æ•ˆçš„GPUå†…å­˜æ± ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// memory_pool.h</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CUDAMemoryPool</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">CUDAMemoryPool</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">initial_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="c1">// 1GB</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">total_size_</span><span class="p">(</span><span class="n">initial_size</span><span class="p">),</span><span class="w"> </span><span class="n">used_size_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_ptr_</span><span class="p">,</span><span class="w"> </span><span class="n">total_size_</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ–ç©ºé—²å—</span>
<span class="w">        </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">total_size_</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">~</span><span class="n">CUDAMemoryPool</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">base_ptr_</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">Allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">alignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¯¹é½å¤§å°</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alignment</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">alignment</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">alignment</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æŸ¥æ‰¾åˆé€‚çš„ç©ºé—²å—</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">({</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Out of memory&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ç§»é™¤ç©ºé—²å—</span>
<span class="w">        </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆ†é…å†…å­˜</span>
<span class="w">        </span><span class="n">allocated_blocks_</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å¦‚æœå—å¤§äºè¯·æ±‚å¤§å°ï¼Œåˆ›å»ºæ–°çš„ç©ºé—²å—</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">used_size_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base_ptr_</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Deallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>
<span class="w">                       </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base_ptr_</span><span class="p">);</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocated_blocks_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allocated_blocks_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ— æ•ˆæŒ‡é’ˆ</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">        </span><span class="n">allocated_blocks_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆå¹¶ç›¸é‚»ç©ºé—²å—</span>
<span class="w">        </span><span class="n">MergeFreeBlocks</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">        </span><span class="n">used_size_</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">GetUsedSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">used_size_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">GetTotalSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">total_size_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">MergeFreeBlocks</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æŸ¥æ‰¾ç›¸é‚»å—å¹¶åˆå¹¶</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">next_it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">find</span><span class="p">({</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next_it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">next_it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<span class="w">            </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">next_it</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æŸ¥æ‰¾å‰ä¸€ä¸ªå—</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span>
<span class="w">             </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">                </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<span class="w">                </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">free_blocks_</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">base_ptr_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">total_size_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">used_size_</span><span class="p">;</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">free_blocks_</span><span class="p">;</span><span class="w"> </span><span class="c1">// {size, offset}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allocated_blocks_</span><span class="p">;</span><span class="w"> </span><span class="c1">// {offset, size}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mutex_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2764">27.6.4 è‡ªåŠ¨è°ƒä¼˜æ¡†æ¶</h3>
<p>å®ç°å†…æ ¸å‚æ•°è‡ªåŠ¨è°ƒä¼˜ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># auto_tuning.py</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TuningParameter</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>

<span class="nd">@dataclass</span>  
<span class="k">class</span> <span class="nc">TuningResult</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">performance</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">class</span> <span class="nc">AutoTuner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">executable</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_name</span> <span class="o">=</span> <span class="n">kernel_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">executable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_performance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ·»åŠ è°ƒä¼˜å‚æ•°&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TuningParameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">evaluate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¯„ä¼°ç‰¹å®šé…ç½®çš„æ€§èƒ½&quot;&quot;&quot;</span>
        <span class="c1"># è®¾ç½®ç¯å¢ƒå˜é‡ä¼ é€’å‚æ•°</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;TUNE_</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># è¿è¡ŒåŸºå‡†æµ‹è¯•</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;--kernel=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># è§£ææ€§èƒ½ç»“æœ</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_performance</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">performance</span>

    <span class="k">def</span> <span class="nf">tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TuningResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰§è¡Œè‡ªåŠ¨è°ƒä¼˜&quot;&quot;&quot;</span>
        <span class="c1"># ç”Ÿæˆæ‰€æœ‰å‚æ•°ç»„åˆ</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="n">param_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>

        <span class="n">configurations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">param_values</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">max_iterations</span><span class="p">:</span>
            <span class="n">configurations</span> <span class="o">=</span> <span class="n">configurations</span><span class="p">[:</span><span class="n">max_iterations</span><span class="p">]</span>

        <span class="c1"># è¯„ä¼°æ¯ä¸ªé…ç½®</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">configurations</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing configuration </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">configurations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TuningResult</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">performance</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">performance</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_performance</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_performance</span> <span class="o">=</span> <span class="n">performance</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1"># ä¿å­˜ç»“æœ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TuningResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_performance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è§£ææ€§èƒ½è¾“å‡º&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Time:&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TuningResult</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¿å­˜è°ƒä¼˜ç»“æœ&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_name</span><span class="p">,</span>
            <span class="s1">&#39;best_config&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">,</span>
            <span class="s1">&#39;best_performance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_performance</span><span class="p">,</span>
            <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">performance</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_name</span><span class="si">}</span><span class="s1">_tuning.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">tuner</span> <span class="o">=</span> <span class="n">AutoTuner</span><span class="p">(</span><span class="s2">&quot;gemm&quot;</span><span class="p">,</span> <span class="s2">&quot;./build/benchmark_gemm&quot;</span><span class="p">)</span>

    <span class="c1"># æ·»åŠ è°ƒä¼˜å‚æ•°</span>
    <span class="n">tuner</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s2">&quot;block_size&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">])</span>
    <span class="n">tuner</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s2">&quot;tile_size&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">])</span>
    <span class="n">tuner</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s2">&quot;unroll_factor&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>

    <span class="c1"># æ‰§è¡Œè°ƒä¼˜</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">tune</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best configuration: </span><span class="si">{</span><span class="n">best</span><span class="o">.</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best performance: </span><span class="si">{</span><span class="n">best</span><span class="o">.</span><span class="n">performance</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ms&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2765">27.6.5 å¤šè¯­è¨€ç»‘å®šæ”¯æŒ</h3>
<p>ä¸ºCUDAä»£ç æä¾›Pythonå’ŒJuliaç»‘å®šï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// python_bindings.cpp</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybind11/pybind11.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybind11/numpy.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybind11/stl.h&gt;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">pybind11</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CUDAKernel</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">CUDAKernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">name_</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆå§‹åŒ–CUDAä¸Šä¸‹æ–‡</span>
<span class="w">        </span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">params</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è·å–è¾“å…¥æ•°æ®</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åˆ†é…GPUå†…å­˜</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">d_input</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_output</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_input</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_output</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// å¤åˆ¶æ•°æ®åˆ°GPU</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_input</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span>
<span class="w">                  </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¯åŠ¨å†…æ ¸</span>
<span class="w">        </span><span class="n">LaunchKernel</span><span class="p">(</span><span class="n">d_input</span><span class="p">,</span><span class="w"> </span><span class="n">d_output</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆ›å»ºè¾“å‡ºæ•°ç»„</span>
<span class="w">        </span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">out_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">out_buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¤åˆ¶ç»“æœå›ä¸»æœº</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">out_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">d_output</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                  </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ¸…ç†</span>
<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_input</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_output</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">LaunchKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name_</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">cuda_kernels</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">doc</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;CUDA kernel Python bindings&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">CUDAKernel</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CUDAKernel&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&gt;</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;execute&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CUDAKernel</span><span class="o">::</span><span class="n">execute</span><span class="p">,</span>
<span class="w">             </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">),</span>
<span class="w">             </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;params&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="p">{},</span>
<span class="w">             </span><span class="s">&quot;Execute CUDA kernel on input array&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è¾…åŠ©å‡½æ•°</span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;get_device_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaGetDeviceCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;get_device_properties&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="kt">int</span><span class="w"> </span><span class="n">device</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaDeviceProp</span><span class="w"> </span><span class="n">prop</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaGetDeviceProperties</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;name&quot;</span><span class="n">_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;compute_capability&quot;</span><span class="n">_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">minor</span><span class="p">),</span>
<span class="w">            </span><span class="s">&quot;total_memory&quot;</span><span class="n">_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">totalGlobalMem</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;sm_count&quot;</span><span class="n">_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">multiProcessorCount</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="277">27.7 æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†CUDAå¼€å‘ç¯å¢ƒçš„ä¸“ä¸šé…ç½®å’Œå·¥å…·é“¾ä¼˜åŒ–ã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š</p>
<ol>
<li>
<p><strong>å·¥å…·é“¾é…ç½®</strong>ï¼šæŒæ¡äº†CUDA Toolkitå„ç»„ä»¶çš„åŠŸèƒ½ã€ç¯å¢ƒå˜é‡é…ç½®ç­–ç•¥ã€å¤šç‰ˆæœ¬ç®¡ç†å’Œé©±åŠ¨å…¼å®¹æ€§å¤„ç†</p>
</li>
<li>
<p><strong>ç¼–è¯‘ä¼˜åŒ–</strong>ï¼šæ·±å…¥ç†è§£äº†nvccç¼–è¯‘é€‰é¡¹ã€æ¶æ„ç›®æ ‡é€‰æ‹©ã€ä¼˜åŒ–çº§åˆ«è®¾ç½®å’Œåˆ†ç¦»ç¼–è¯‘æŠ€æœ¯</p>
</li>
<li>
<p><strong>æ„å»ºç³»ç»Ÿ</strong>ï¼šå­¦ä¹ äº†CMakeä¸CUDAçš„ç°ä»£é›†æˆæ–¹å¼ã€ä¾èµ–ç®¡ç†å’Œæ··åˆç¼–è¯‘é…ç½®</p>
</li>
<li>
<p><strong>æ€§èƒ½åˆ†æ</strong>ï¼šç²¾é€šäº†Nsight Systemsç³»ç»Ÿçº§åˆ†æã€Nsight Computeå†…æ ¸çº§åˆ†æã€NVTXæ ‡è®°å’Œæ€§èƒ½å·¥ä½œæµé›†æˆ</p>
</li>
<li>
<p><strong>CI/CDå®è·µ</strong>ï¼šå®ç°äº†Dockerå®¹å™¨åŒ–å¼€å‘ã€GitHub Actionsè‡ªåŠ¨åŒ–æµ‹è¯•ã€æ€§èƒ½å›å½’æ£€æµ‹å’Œè‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶</p>
</li>
<li>
<p><strong>å·¥ç¨‹åŒ–å®è·µ</strong>ï¼šæ„å»ºäº†æ¨¡å—åŒ–å†…æ ¸ç®¡ç†ã€å†…å­˜æ± å®ç°ã€è‡ªåŠ¨è°ƒä¼˜æ¡†æ¶å’Œå¤šè¯­è¨€ç»‘å®šæ”¯æŒ</p>
</li>
</ol>
<p>è¿™äº›å·¥ç¨‹å®è·µæŠ€èƒ½å¯¹äºç®¡ç†å¤§å‹CUDAé¡¹ç›®ã€ç¡®ä¿ä»£ç è´¨é‡å’Œä¼˜åŒ–å¼€å‘æ•ˆç‡è‡³å…³é‡è¦ã€‚é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»å…·å¤‡äº†æ„å»ºä¸“ä¸šçº§CUDAå¼€å‘ç¯å¢ƒå’Œå®æ–½å·¥ç¨‹åŒ–æœ€ä½³å®è·µçš„èƒ½åŠ›ã€‚</p>
<h2 id="278">27.8 ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>ç¯å¢ƒé…ç½®ç»ƒä¹ </strong>
   - é…ç½®ä¸€ä¸ªæ”¯æŒCUDA 11.8å’Œ12.0åŒç‰ˆæœ¬åˆ‡æ¢çš„å¼€å‘ç¯å¢ƒ
   - ç¼–å†™è„šæœ¬å®ç°ç‰ˆæœ¬è‡ªåŠ¨æ£€æµ‹å’Œåˆ‡æ¢
   - <strong>Hint</strong>: ä½¿ç”¨update-alternativesæˆ–ç¯å¢ƒå˜é‡ç®¡ç†</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>åˆ›å»ºç‰ˆæœ¬ç®¡ç†è„šæœ¬ï¼Œé€šè¿‡ä¿®æ”¹ç¯å¢ƒå˜é‡å®ç°ç‰ˆæœ¬åˆ‡æ¢ã€‚å…³é”®æ˜¯æ­£ç¡®è®¾ç½®CUDA_HOMEã€PATHå’ŒLD_LIBRARY_PATHã€‚ä½¿ç”¨å‡½æ•°å°è£…ç‰ˆæœ¬åˆ‡æ¢é€»è¾‘ï¼Œå¹¶æä¾›ç‰ˆæœ¬éªŒè¯åŠŸèƒ½ã€‚</p>
</details>
<ol start="2">
<li><strong>ç¼–è¯‘ä¼˜åŒ–å®éªŒ</strong>
   - å¯¹åŒä¸€ä¸ªå†…æ ¸ä½¿ç”¨ä¸åŒä¼˜åŒ–çº§åˆ«ç¼–è¯‘
   - æ¯”è¾ƒç”Ÿæˆä»£ç çš„å¯„å­˜å™¨ä½¿ç”¨å’Œæ€§èƒ½å·®å¼‚
   - <strong>Hint</strong>: ä½¿ç”¨--ptxas-options=-væŸ¥çœ‹èµ„æºä½¿ç”¨</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä½¿ç”¨-O0ã€-O2ã€-O3åˆ†åˆ«ç¼–è¯‘ï¼Œé€šè¿‡cuobjdumpåˆ†ææ±‡ç¼–ä»£ç ã€‚-O3é€šå¸¸äº§ç”Ÿæ›´å¥½çš„æŒ‡ä»¤è°ƒåº¦ä½†å¯èƒ½å¢åŠ å¯„å­˜å™¨å‹åŠ›ã€‚ä½¿ç”¨-use_fast_mathå¯ä»¥è¿›ä¸€æ­¥æå‡æ€§èƒ½ä½†ç‰ºç‰²ç²¾åº¦ã€‚</p>
</details>
<ol start="3">
<li><strong>CMakeé¡¹ç›®æ­å»º</strong>
   - åˆ›å»ºä¸€ä¸ªåŒ…å«CUDAå’ŒC++æ··åˆç¼–è¯‘çš„CMakeé¡¹ç›®
   - å®ç°è‡ªåŠ¨æ¶æ„æ£€æµ‹å’Œä¼˜åŒ–é€‰é¡¹è®¾ç½®
   - <strong>Hint</strong>: ä½¿ç”¨CMAKE_CUDA_ARCHITECTURESå˜é‡</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä½¿ç”¨find_package(CUDAToolkit)æŸ¥æ‰¾CUDAï¼Œé€šè¿‡cuda_select_nvcc_arch_flagsè‡ªåŠ¨æ£€æµ‹GPUæ¶æ„ã€‚è®¾ç½®åˆ†ç¦»ç¼–è¯‘é€‰é¡¹CUDA_SEPARABLE_COMPILATIONï¼Œä¸ºä¸åŒé…ç½®è®¾ç½®ä¸åŒçš„ç¼–è¯‘æ ‡å¿—ã€‚</p>
</details>
<ol start="4">
<li><strong>Nsight Systemsåˆ†æ</strong>
   - ä½¿ç”¨Nsight Systemsåˆ†æä¸€ä¸ªCUDAç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆ
   - æ·»åŠ NVTXæ ‡è®°å¹¶ç”Ÿæˆæ—¶é—´çº¿æŠ¥å‘Š
   - <strong>Hint</strong>: ä½¿ç”¨nvtxRangePush/Popæ ‡è®°å…³é”®åŒºåŸŸ</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>åœ¨ä»£ç ä¸­æ·»åŠ NVTXæ ‡è®°è¯†åˆ«ä¸åŒé˜¶æ®µï¼Œä½¿ç”¨nsys profile --trace=cuda,nvtxæ”¶é›†æ•°æ®ã€‚åˆ†ææ—¶é—´çº¿æ‰¾å‡ºCPU-GPUåŒæ­¥ç‚¹ã€å†…å­˜ä¼ è¾“ç“¶é¢ˆå’Œå†…æ ¸æ‰§è¡Œé—´éš™ã€‚</p>
</details>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<ol start="5">
<li><strong>è‡ªåŠ¨åŒ–æ€§èƒ½å›å½’ç³»ç»Ÿ</strong>
   - å®ç°ä¸€ä¸ªå®Œæ•´çš„æ€§èƒ½å›å½’æ£€æµ‹ç³»ç»Ÿ
   - æ”¯æŒå¤šä¸ªåŸºå‡†æµ‹è¯•å’Œå¯é…ç½®çš„é˜ˆå€¼
   - è‡ªåŠ¨ç”Ÿæˆæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š
   - <strong>Hint</strong>: ç»“åˆCI/CDå’ŒåŸºå‡†æµ‹è¯•æ¡†æ¶</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ„å»ºåŸºå‡†æµ‹è¯•å¥—ä»¶ï¼Œä½¿ç”¨JSONå­˜å‚¨å†å²æ€§èƒ½æ•°æ®ã€‚åœ¨CIä¸­è¿è¡Œæµ‹è¯•å¹¶ä¸åŸºçº¿æ¯”è¾ƒï¼Œæ£€æµ‹è¶…è¿‡é˜ˆå€¼çš„æ€§èƒ½ä¸‹é™ã€‚ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Šæ˜¾ç¤ºæ€§èƒ½è¶‹åŠ¿ï¼Œå¹¶åœ¨PRä¸­è‡ªåŠ¨è¯„è®ºæ€§èƒ½å½±å“ã€‚</p>
</details>
<ol start="6">
<li><strong>å†…æ ¸è‡ªåŠ¨è°ƒä¼˜å·¥å…·</strong>
   - å¼€å‘ä¸€ä¸ªè‡ªåŠ¨è°ƒä¼˜æ¡†æ¶ï¼Œæ”¯æŒç½‘æ ¼æœç´¢å’Œè´å¶æ–¯ä¼˜åŒ–
   - å®ç°å‚æ•°ç©ºé—´å‰ªæå’Œæ—©åœæœºåˆ¶
   - <strong>Hint</strong>: ä½¿ç”¨scikit-optimizeæˆ–Optuna</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å®šä¹‰å‚æ•°ç©ºé—´ï¼ˆblockå¤§å°ã€tileå¤§å°ã€å±•å¼€å› å­ç­‰ï¼‰ï¼Œä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–æ™ºèƒ½æ¢ç´¢ã€‚å®ç°æ€§èƒ½æ¨¡å‹é¢„æµ‹ï¼Œé€šè¿‡æ—©åœé¿å…è¯„ä¼°ä½æ€§èƒ½é…ç½®ã€‚ä¿å­˜æœ€ä¼˜é…ç½®å¹¶ç”Ÿæˆé…ç½®å¤´æ–‡ä»¶ã€‚</p>
</details>
<ol start="7">
<li><strong>åˆ†å¸ƒå¼ç¼–è¯‘ç³»ç»Ÿ</strong>
   - è®¾è®¡ä¸€ä¸ªæ”¯æŒå¤šæœºåˆ†å¸ƒå¼ç¼–è¯‘çš„ç³»ç»Ÿ
   - å®ç°ç¼–è¯‘ç¼“å­˜å’Œå¢é‡æ„å»º
   - <strong>Hint</strong>: å‚è€ƒccacheå’Œdistccçš„è®¾è®¡</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä½¿ç”¨å“ˆå¸Œè¯†åˆ«ç›¸åŒç¼–è¯‘å•å…ƒï¼Œå®ç°åˆ†å¸ƒå¼ç¼“å­˜å…±äº«ã€‚é€šè¿‡ä¾èµ–åˆ†æå®ç°å¹¶è¡Œç¼–è¯‘ä»»åŠ¡åˆ†å‘ã€‚ä½¿ç”¨å®¹å™¨ç¡®ä¿ç¼–è¯‘ç¯å¢ƒä¸€è‡´æ€§ï¼Œå®ç°ç¼–è¯‘ç»“æœçš„éªŒè¯å’Œå›é€€æœºåˆ¶ã€‚</p>
</details>
<ol start="8">
<li><strong>å¤šè¯­è¨€ç»Ÿä¸€æ¥å£</strong>
   - è®¾è®¡å¹¶å®ç°æ”¯æŒPythonã€Juliaã€MATLABçš„ç»Ÿä¸€CUDAæ¥å£
   - å®ç°è‡ªåŠ¨å†…å­˜ç®¡ç†å’Œé”™è¯¯å¤„ç†
   - æ”¯æŒå¼‚æ­¥æ‰§è¡Œå’Œæµç®¡ç†
   - <strong>Hint</strong>: ä½¿ç”¨SWIGæˆ–æ‰‹å·¥ç¼–å†™ç»‘å®š</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è®¾è®¡è¯­è¨€æ— å…³çš„C APIä½œä¸ºåŸºç¡€å±‚ï¼Œä¸ºæ¯ç§è¯­è¨€ç¼–å†™ç‰¹å®šçš„åŒ…è£…å™¨ã€‚å®ç°å¼•ç”¨è®¡æ•°çš„å†…å­˜ç®¡ç†ï¼Œæä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚ä½¿ç”¨å›è°ƒæ”¯æŒå¼‚æ­¥æ“ä½œï¼Œé€šè¿‡ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¤„ç†èµ„æºç”Ÿå‘½å‘¨æœŸã€‚</p>
</details>
<h2 id="279-gotchas">27.9 å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<ol>
<li>
<p><strong>ç‰ˆæœ¬å…¼å®¹æ€§é™·é˜±</strong>
   - é”™è¯¯ï¼šå‡è®¾æ‰€æœ‰CUDAç‰ˆæœ¬å‘åå…¼å®¹
   - æ­£ç¡®ï¼šæ£€æŸ¥é©±åŠ¨ç‰ˆæœ¬æ”¯æŒçš„æœ€é«˜CUDAç‰ˆæœ¬ï¼Œä½¿ç”¨PTXç¡®ä¿å‰å‘å…¼å®¹</p>
</li>
<li>
<p><strong>ç¼–è¯‘é€‰é¡¹è¯¯ç”¨</strong>
   - é”™è¯¯ï¼šç›²ç›®ä½¿ç”¨-use_fast_math
   - æ­£ç¡®ï¼šè¯„ä¼°ç²¾åº¦è¦æ±‚ï¼Œå…³é”®è®¡ç®—é¿å…å¿«é€Ÿæ•°å­¦å‡½æ•°</p>
</li>
<li>
<p><strong>CMakeé…ç½®é”™è¯¯</strong>
   - é”™è¯¯ï¼šæ··ç”¨æ—§ç‰ˆFindCUDAå’Œæ–°ç‰ˆCUDAè¯­è¨€æ”¯æŒ
   - æ­£ç¡®ï¼šCMake 3.18+ä½¿ç”¨enable_language(CUDA)</p>
</li>
<li>
<p><strong>æ€§èƒ½åˆ†æè¯¯åŒº</strong>
   - é”™è¯¯ï¼šåªå…³æ³¨å†…æ ¸æ‰§è¡Œæ—¶é—´
   - æ­£ç¡®ï¼šåˆ†ææ•´ä¸ªæ‰§è¡Œæµç¨‹ï¼ŒåŒ…æ‹¬å†…å­˜ä¼ è¾“å’ŒåŒæ­¥å¼€é”€</p>
</li>
<li>
<p><strong>CI/CDèµ„æºæµªè´¹</strong>
   - é”™è¯¯ï¼šæ¯æ¬¡æäº¤éƒ½è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
   - æ­£ç¡®ï¼šå®ç°åˆ†å±‚æµ‹è¯•ç­–ç•¥ï¼Œä½¿ç”¨ç¼“å­˜å‡å°‘æ„å»ºæ—¶é—´</p>
</li>
<li>
<p><strong>å†…å­˜æ± ä½¿ç”¨ä¸å½“</strong>
   - é”™è¯¯ï¼šé¢‘ç¹åˆ›å»ºé”€æ¯å†…å­˜æ± 
   - æ­£ç¡®ï¼šä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œåˆç†è®¾ç½®åˆå§‹å¤§å°</p>
</li>
<li>
<p><strong>è‡ªåŠ¨è°ƒä¼˜è¿‡æ‹Ÿåˆ</strong>
   - é”™è¯¯ï¼šåªåœ¨ç‰¹å®šè¾“å…¥ä¸Šè°ƒä¼˜
   - æ­£ç¡®ï¼šä½¿ç”¨å¤šç§ä»£è¡¨æ€§è¾“å…¥ï¼ŒéªŒè¯æ³›åŒ–æ€§èƒ½</p>
</li>
<li>
<p><strong>è°ƒè¯•ä¿¡æ¯æ³„éœ²</strong>
   - é”™è¯¯ï¼šç”Ÿäº§ç¯å¢ƒä¿ç•™-Gè°ƒè¯•æ ‡å¿—
   - æ­£ç¡®ï¼šä½¿ç”¨æ¡ä»¶ç¼–è¯‘ï¼ŒReleaseç‰ˆæœ¬ç§»é™¤è°ƒè¯•ä¿¡æ¯</p>
</li>
</ol>
<h2 id="2710">27.10 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_3">å¼€å‘ç¯å¢ƒé…ç½®</h3>
<ul>
<li>[ ] é…ç½®äº†å®Œæ•´çš„CUDAå·¥å…·é“¾å’Œç¯å¢ƒå˜é‡</li>
<li>[ ] å®ç°äº†å¤šç‰ˆæœ¬CUDAç®¡ç†æœºåˆ¶</li>
<li>[ ] è®¾ç½®äº†åˆé€‚çš„ç¼–è¯‘ç¼“å­˜ç­–ç•¥</li>
<li>[ ] é…ç½®äº†IDEé›†æˆå’Œè°ƒè¯•ç¯å¢ƒ</li>
</ul>
<h3 id="_4">ç¼–è¯‘ä¼˜åŒ–</h3>
<ul>
<li>[ ] é€‰æ‹©äº†æ­£ç¡®çš„ç›®æ ‡æ¶æ„</li>
<li>[ ] å¹³è¡¡äº†ä¼˜åŒ–çº§åˆ«å’Œæ•°å€¼ç²¾åº¦</li>
<li>[ ] å¯ç”¨äº†å¿…è¦çš„ç¼–è¯‘å™¨è¯Šæ–­</li>
<li>[ ] å®ç°äº†åˆ†ç¦»ç¼–è¯‘å’Œé“¾æ¥æ—¶ä¼˜åŒ–</li>
</ul>
<h3 id="_5">æ„å»ºç³»ç»Ÿ</h3>
<ul>
<li>[ ] ä½¿ç”¨ç°ä»£CMake CUDAæ”¯æŒ</li>
<li>[ ] æ­£ç¡®ç®¡ç†äº†ä¾èµ–å…³ç³»</li>
<li>[ ] å®ç°äº†å¢é‡æ„å»º</li>
<li>[ ] é…ç½®äº†å¤šé…ç½®æ„å»ºæ”¯æŒ</li>
</ul>
<h3 id="_6">æ€§èƒ½åˆ†æ</h3>
<ul>
<li>[ ] å»ºç«‹äº†å®Œæ•´çš„æ€§èƒ½åˆ†ææµç¨‹</li>
<li>[ ] æ·»åŠ äº†é€‚å½“çš„NVTXæ ‡è®°</li>
<li>[ ] é…ç½®äº†è‡ªåŠ¨æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ</li>
<li>[ ] å®ç°äº†æ€§èƒ½æ•°æ®æŒä¹…åŒ–</li>
</ul>
<h3 id="cicd">CI/CDæµç¨‹</h3>
<ul>
<li>[ ] å®ç°äº†è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•</li>
<li>[ ] é…ç½®äº†æ€§èƒ½å›å½’æ£€æµ‹</li>
<li>[ ] è®¾ç½®äº†ä»£ç è´¨é‡æ£€æŸ¥</li>
<li>[ ] å»ºç«‹äº†éƒ¨ç½²æµæ°´çº¿</li>
</ul>
<h3 id="_7">å·¥ç¨‹å®è·µ</h3>
<ul>
<li>[ ] å®ç°äº†æ¨¡å—åŒ–çš„ä»£ç ç»„ç»‡</li>
<li>[ ] å»ºç«‹äº†å®Œå–„çš„æµ‹è¯•æ¡†æ¶</li>
<li>[ ] é…ç½®äº†è‡ªåŠ¨è°ƒä¼˜æœºåˆ¶</li>
<li>[ ] æä¾›äº†å¤šè¯­è¨€æ”¯æŒ</li>
</ul>
<h3 id="_8">æ–‡æ¡£å’Œç»´æŠ¤</h3>
<ul>
<li>[ ] ç¼–å†™äº†å®Œæ•´çš„æ„å»ºæ–‡æ¡£</li>
<li>[ ] è®°å½•äº†æ€§èƒ½åŸºå‡†å’Œä¼˜åŒ–å†å²</li>
<li>[ ] å»ºç«‹äº†é—®é¢˜è¿½è¸ªæœºåˆ¶</li>
<li>[ ] åˆ¶å®šäº†ç‰ˆæœ¬å‘å¸ƒæµç¨‹</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter26.html" class="nav-link prev">â† ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</a><a href="CLAUDE.html" class="nav-link next">Untitled â†’</a></nav>
        </main>
    </div>
</body>
</html>