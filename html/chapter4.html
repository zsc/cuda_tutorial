<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="4bank-conflict">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</h1>
<p>å…±äº«å†…å­˜æ˜¯GPUä¸Šæœ€é‡è¦çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µä¹‹ä¸€ã€‚ä¸å…¨å±€å†…å­˜ç›¸æ¯”ï¼Œå…±äº«å†…å­˜æä¾›äº†é«˜è¾¾100å€çš„å¸¦å®½å’Œ10å€æ›´ä½çš„å»¶è¿Ÿã€‚ç„¶è€Œï¼Œè¦å……åˆ†å‘æŒ¥å…±äº«å†…å­˜çš„æ€§èƒ½æ½œåŠ›ï¼Œå¿…é¡»æ·±å…¥ç†è§£å…¶ç¡¬ä»¶æ¶æ„ï¼Œç‰¹åˆ«æ˜¯bank conflictæœºåˆ¶ã€‚æœ¬ç« å°†æ·±å…¥å‰–æå…±äº«å†…å­˜çš„å·¥ä½œåŸç†ï¼ŒæŒæ¡bank conflictçš„æ£€æµ‹ä¸è§„é¿æŠ€æœ¯ï¼Œå¹¶é€šè¿‡åŒç¼“å†²ç­‰é«˜çº§æŠ€æœ¯å®ç°å†…æ ¸çš„æè‡´ä¼˜åŒ–ã€‚åœ¨è‡ªåŠ¨é©¾é©¶çš„å®æ—¶æ„ŸçŸ¥å’Œå…·èº«æ™ºèƒ½çš„é«˜é¢‘æ§åˆ¶åœºæ™¯ä¸­ï¼Œè¿™äº›æŠ€æœ¯æ˜¯è¾¾åˆ°æ¯«ç§’çº§å“åº”çš„å…³é”®ã€‚</p>
<h2 id="41">4.1 å…±äº«å†…å­˜æ¶æ„è¯¦è§£</h2>
<h3 id="411">4.1.1 ç¡¬ä»¶ç»„ç»‡ç»“æ„</h3>
<p>å…±äº«å†…å­˜åœ¨ç‰©ç†ä¸Šè¢«ç»„ç»‡ä¸ºå¤šä¸ªç‹¬ç«‹çš„å­˜å‚¨ä½“ï¼ˆbankï¼‰ï¼Œè¿™ç§è®¾è®¡å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸åŒçš„bankï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œè®¿é—®ã€‚ç°ä»£GPUï¼ˆVoltaåŠä¹‹åï¼‰çš„å…±äº«å†…å­˜å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p>
<p><strong>Bankç»„ç»‡æ–¹å¼</strong>ï¼š</p>
<ul>
<li>32ä¸ªbankï¼Œæ¯ä¸ªbankå®½åº¦ä¸º4å­—èŠ‚</li>
<li>è¿ç»­çš„32ä¸ª4å­—èŠ‚å­—è¢«åˆ†é…åˆ°32ä¸ªä¸åŒçš„bank</li>
<li>åœ°å€åˆ°bankçš„æ˜ å°„ï¼š<code>bank_id = (byte_address / 4) % 32</code></li>
</ul>
<div class="codehilite"><pre><span></span><code>åœ°å€ç©ºé—´å¸ƒå±€ï¼ˆä»¥4å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼š
     Bank0  Bank1  Bank2  ...  Bank31
Row0:  [0]    [1]    [2]   ...   [31]
Row1:  [32]   [33]   [34]  ...   [63]
Row2:  [64]   [65]   [66]  ...   [95]
...
</code></pre></div>

<p><strong>è®¿é—®ç‰¹æ€§</strong>ï¼š</p>
<ul>
<li>å•å‘¨æœŸè®¿é—®ï¼šæ— conflictæ—¶ï¼Œä¸€ä¸ªwarpçš„32ä¸ªçº¿ç¨‹å¯åœ¨ä¸€ä¸ªå‘¨æœŸå†…å®Œæˆè®¿é—®</li>
<li>å¹¿æ’­æœºåˆ¶ï¼šå¤šä¸ªçº¿ç¨‹è¯»å–åŒä¸€åœ°å€æ—¶è‡ªåŠ¨å¹¿æ’­ï¼Œä¸äº§ç”Ÿconflict</li>
<li>å¤šæ’­æœºåˆ¶ï¼šVolta+æ¶æ„æ”¯æŒåŒä¸€bankå†…å¤šä¸ªåœ°å€çš„å¤šæ’­</li>
</ul>
<h3 id="412">4.1.2 å†…å­˜å®¹é‡ä¸é…ç½®</h3>
<p>ä¸åŒGPUæ¶æ„çš„å…±äº«å†…å­˜å®¹é‡ï¼š</p>
<p>| æ¶æ„ | SMæ€»å®¹é‡ | æ¯çº¿ç¨‹å—æœ€å¤§ | å¯é…ç½®æ€§ |</p>
<table>
<thead>
<tr>
<th>æ¶æ„</th>
<th>SMæ€»å®¹é‡</th>
<th>æ¯çº¿ç¨‹å—æœ€å¤§</th>
<th>å¯é…ç½®æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pascal</td>
<td>64 KB</td>
<td>48 KB</td>
<td>å›ºå®šåˆ†é…</td>
</tr>
<tr>
<td>Volta/Turing</td>
<td>96 KB</td>
<td>64 KB</td>
<td>L1/å…±äº«å†…å­˜åŠ¨æ€é…ç½®</td>
</tr>
<tr>
<td>Ampere</td>
<td>164 KB</td>
<td>100 KB</td>
<td>ç»†ç²’åº¦é…ç½®ï¼ˆ0-164KBï¼‰</td>
</tr>
<tr>
<td>Hopper</td>
<td>228 KB</td>
<td>144 KB</td>
<td>è‡ªåŠ¨ç®¡ç†æ¨¡å¼</td>
</tr>
</tbody>
</table>
<p><strong>åŠ¨æ€é…ç½®ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// è¿è¡Œæ—¶é…ç½®</span>
<span class="n">cudaFuncSetAttribute</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">cudaFuncAttributeMaxDynamicSharedMemorySize</span><span class="p">,</span><span class="w"> </span><span class="n">sharedMemSize</span><span class="p">);</span>
<span class="n">cudaFuncSetAttribute</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">cudaFuncAttributePreferredSharedMemoryCarveout</span><span class="p">,</span><span class="w"> </span><span class="n">percentage</span><span class="p">);</span>

<span class="c1">// ç¼–è¯‘æ—¶å£°æ˜</span>
<span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">maxThreadsPerBlock</span><span class="p">,</span><span class="w"> </span><span class="n">minBlocksPerSM</span><span class="p">)</span>
</code></pre></div>

<h3 id="413">4.1.3 è®¿é—®å»¶è¿Ÿä¸å¸¦å®½</h3>
<p>å…±äº«å†…å­˜çš„æ€§èƒ½ç‰¹å¾ï¼š</p>
<p><strong>å»¶è¿Ÿå¯¹æ¯”</strong>ï¼š</p>
<ul>
<li>å…±äº«å†…å­˜ï¼šçº¦20-30ä¸ªæ—¶é’Ÿå‘¨æœŸ</li>
<li>L1ç¼“å­˜ï¼šçº¦28ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆå‘½ä¸­ï¼‰</li>
<li>L2ç¼“å­˜ï¼šçº¦200ä¸ªæ—¶é’Ÿå‘¨æœŸ</li>
<li>å…¨å±€å†…å­˜ï¼šçº¦300-400ä¸ªæ—¶é’Ÿå‘¨æœŸ</li>
</ul>
<p><strong>ç†è®ºå¸¦å®½è®¡ç®—</strong>ï¼š
å¯¹äºV100ï¼ˆ1530 MHzï¼Œ80ä¸ªSMï¼‰ï¼š</p>
<ul>
<li>æ¯SMå¸¦å®½ = 32 banks Ã— 4 bytes Ã— 1530 MHz = 195.84 GB/s</li>
<li>æ€»å¸¦å®½ = 195.84 GB/s Ã— 80 = 15.67 TB/s</li>
<li>ç›¸æ¯”ä¹‹ä¸‹ï¼Œå…¨å±€å†…å­˜å¸¦å®½ä»…ä¸º900 GB/s</li>
</ul>
<h3 id="414">4.1.4 åŸå­æ“ä½œæ”¯æŒ</h3>
<p>å…±äº«å†…å­˜æ”¯æŒå®Œæ•´çš„åŸå­æ“ä½œé›†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å…±äº«å†…å­˜åŸå­æ“ä½œç¤ºä¾‹</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// å¯èƒ½å¯¼è‡´conflict</span>

<span class="c1">// ä¼˜åŒ–ï¼šä½¿ç”¨ä¸åŒbank</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="p">[</span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ¯ä¸ªwarpä½¿ç”¨ä¸åŒçš„è¡Œ</span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">warpId</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ— conflict</span>
</code></pre></div>

<h2 id="42-bank-conflict">4.2 Bank Conflictçš„æœ¬è´¨ä¸æ£€æµ‹</h2>
<h3 id="421-bank-conflict">4.2.1 Bank Conflictçš„å®šä¹‰</h3>
<p>Bank conflictå‘ç”Ÿåœ¨ä¸€ä¸ªwarpå†…çš„å¤šä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒä¸€ä¸ªbankçš„ä¸åŒåœ°å€æ—¶ã€‚è¿™ä¼šå¯¼è‡´è®¿é—®ä¸²è¡ŒåŒ–ï¼Œä¸¥é‡é™ä½æ€§èƒ½ã€‚</p>
<p><strong>Conflictç±»å‹</strong>ï¼š</p>
<ol>
<li><strong>æ— conflict</strong>ï¼šæ¯ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„bank</li>
<li><strong>å¹¿æ’­</strong>ï¼šå¤šä¸ªçº¿ç¨‹è®¿é—®ç›¸åŒåœ°å€ï¼ˆåªè¯»ï¼‰</li>
<li><strong>n-way conflict</strong>ï¼šnä¸ªçº¿ç¨‹è®¿é—®åŒä¸€bankçš„ä¸åŒåœ°å€</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç¤ºä¾‹1ï¼šæ— conflict - è¿ç»­è®¿é—®</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ¯ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒbank</span>

<span class="c1">// ç¤ºä¾‹2ï¼š2-way conflict</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span><span class="w">  </span><span class="c1">// å¶æ•°çº¿ç¨‹è®¿é—®å¶æ•°bank</span>

<span class="c1">// ç¤ºä¾‹3ï¼š32-way conflictï¼ˆæœ€åæƒ…å†µï¼‰</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ‰€æœ‰çº¿ç¨‹è®¿é—®åŒä¸€bank</span>
</code></pre></div>

<h3 id="422-conflict">4.2.2 Conflictçš„æ€§èƒ½å½±å“</h3>
<p>Bank conflictå¯¹æ€§èƒ½çš„å½±å“æ˜¯ç´¯ä¹˜çš„ï¼š</p>
<p>| Conflictç¨‹åº¦ | è®¿é—®å‘¨æœŸ | æœ‰æ•ˆå¸¦å®½ |</p>
<table>
<thead>
<tr>
<th>Conflictç¨‹åº¦</th>
<th>è®¿é—®å‘¨æœŸ</th>
<th>æœ‰æ•ˆå¸¦å®½</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ— conflict</td>
<td>1</td>
<td>100%</td>
</tr>
<tr>
<td>2-way</td>
<td>2</td>
<td>50%</td>
</tr>
<tr>
<td>4-way</td>
<td>4</td>
<td>25%</td>
</tr>
<tr>
<td>8-way</td>
<td>8</td>
<td>12.5%</td>
</tr>
<tr>
<td>32-way</td>
<td>32</td>
<td>3.125%</td>
</tr>
</tbody>
</table>
<h3 id="423">4.2.3 æ£€æµ‹å·¥å…·ä¸æ–¹æ³•</h3>
<p><strong>ä½¿ç”¨Nsight Computeæ£€æµ‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ncu<span class="w"> </span>--metrics<span class="w"> </span>l1tex__data_bank_conflicts_pipe_lsu_mem_shared_op_ld.sum,<span class="se">\</span>
l1tex__data_bank_conflicts_pipe_lsu_mem_shared_op_st.sum<span class="w"> </span><span class="se">\</span>
./your_kernel
</code></pre></div>

<p><strong>ä»£ç çº§æ£€æµ‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">detectBankConflict</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">sharedMem</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock</span><span class="p">();</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharedMem</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// é€šè¿‡æ—¶é—´å·®åˆ¤æ–­æ˜¯å¦æœ‰conflict</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">THRESHOLD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¯èƒ½å­˜åœ¨bank conflict</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="424-conflict">4.2.4 å¸¸è§çš„Conflictæ¨¡å¼</h3>
<p><strong>è·¨æ­¥è®¿é—®æ¨¡å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Stride = 2: 2-way conflict</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">matrix</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">33</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ³¨æ„ï¼š33è€Œä¸æ˜¯32</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>

<span class="c1">// Stride = 8: 8-way conflict  </span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">];</span>
</code></pre></div>

<p><strong>çŸ©é˜µè½¬ç½®æ¨¡å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸå§‹ç‰ˆæœ¬ï¼šä¸¥é‡conflict</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span>
<span class="c1">// è¯»å–æ—¶åˆ—ä¼˜å…ˆï¼Œå†™å…¥æ—¶è¡Œä¼˜å…ˆ</span>
<span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[...];</span><span class="w">  </span>
<span class="nf">__syncthreads</span><span class="p">();</span>
<span class="n">output</span><span class="p">[...]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">];</span><span class="w">  </span><span class="c1">// 32-way conflict!</span>
</code></pre></div>

<p><strong>å½’çº¦æ“ä½œæ¨¡å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ ‘å½¢å½’çº¦ä¸­çš„conflict</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sdata</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="c1">// Strideä»å¤§åˆ°å°å˜åŒ–ï¼ŒåæœŸä¼šäº§ç”Ÿconflict</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">];</span><span class="w">  </span><span class="c1">// sè¾ƒå°æ—¶äº§ç”Ÿconflict</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="43-paddingswizzlingpermutation">4.3 è§„é¿ç­–ç•¥ï¼šPaddingã€Swizzlingä¸Permutation</h2>
<h3 id="431-padding">4.3.1 PaddingæŠ€æœ¯</h3>
<p>Paddingæ˜¯æœ€ç®€å•æœ‰æ•ˆçš„conflictè§„é¿æ–¹æ³•ï¼Œé€šè¿‡æ·»åŠ é¢å¤–çš„åˆ—æ¥æ”¹å˜bankæ˜ å°„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸå§‹ï¼š32-way conflict in transpose</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span><span class="w">  </span>

<span class="c1">// Paddingï¼šæ¶ˆé™¤conflict</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">33</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ·»åŠ 1åˆ—padding</span>

<span class="c1">// é€šç”¨paddingå…¬å¼</span>
<span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">SharedMemoryPadded</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">PADDING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TILE_SIZE</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">TILE_SIZE</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PADDING</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Paddingå¼€é”€åˆ†æ</strong>ï¼š</p>
<ul>
<li>ç©ºé—´å¼€é”€ï¼š(33-32)/32 = 3.125%</li>
<li>å®Œå…¨æ¶ˆé™¤conflictï¼Œæ€§èƒ½æå‡å¯è¾¾32å€</li>
</ul>
<h3 id="432-swizzling">4.3.2 SwizzlingæŠ€æœ¯</h3>
<p>Swizzlingé€šè¿‡é‡æ–°æ’åˆ—æ•°æ®å¸ƒå±€æ¥é¿å…conflictï¼Œä¸å¢åŠ é¢å¤–å­˜å‚¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// XOR swizzlingç¤ºä¾‹</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">swizzle</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">((</span><span class="n">y</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span>
<span class="c1">// ä½¿ç”¨swizzledç´¢å¼•</span>
<span class="kt">int</span><span class="w"> </span><span class="n">swizzled_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swizzle</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">swizzled_x</span><span class="p">];</span>
</code></pre></div>

<p><strong>é«˜çº§Swizzlingæ¨¡å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Diagonal swizzling</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">diagonalSwizzle</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">width</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Block-cyclic swizzling  </span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockCyclicSwizzle</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">blockX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">blockY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inBlockX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inBlockY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">blockX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">inBlockX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockY</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="433-permutation">4.3.3 Permutationç­–ç•¥</h3>
<p>Permutationé€šè¿‡é‡æ–°æ’åˆ—çº¿ç¨‹è®¿é—®é¡ºåºæ¥é¿å…conflictï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// çº¿ç¨‹é‡æ˜ å°„</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">permuteThread</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numThreads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä½åè½¬permutation</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ffs</span><span class="p">(</span><span class="n">numThreads</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bits</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">bits</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨permutationè®¿é—®</span>
<span class="kt">int</span><span class="w"> </span><span class="n">permuted_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">permuteThread</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharedMem</span><span class="p">[</span><span class="n">permuted_tid</span><span class="p">];</span>
</code></pre></div>

<h3 id="434">4.3.4 ç­–ç•¥é€‰æ‹©æŒ‡å—</h3>
<p>| åœºæ™¯ | æ¨èç­–ç•¥ | ç†ç”± |</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ¨èç­–ç•¥</th>
<th>ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>çŸ©é˜µè½¬ç½®</td>
<td>Padding</td>
<td>ç®€å•æœ‰æ•ˆï¼Œå¼€é”€å°</td>
</tr>
<tr>
<td>å·ç§¯/Stencil</td>
<td>Swizzling</td>
<td>ä¿æŒå±€éƒ¨æ€§ï¼Œæ— ç©ºé—´å¼€é”€</td>
</tr>
<tr>
<td>å½’çº¦æ“ä½œ</td>
<td>Permutation</td>
<td>åŠ¨æ€è°ƒæ•´è®¿é—®æ¨¡å¼</td>
</tr>
<tr>
<td>ç¨€ç–è®¿é—®</td>
<td>æ··åˆç­–ç•¥</td>
<td>æ ¹æ®ç¨€ç–æ¨¡å¼å®šåˆ¶</td>
</tr>
</tbody>
</table>
<h2 id="44">4.4 åŒç¼“å†²ä¸æµæ°´çº¿æŠ€æœ¯</h2>
<h3 id="441">4.4.1 åŒç¼“å†²åŸç†</h3>
<p>åŒç¼“å†²æŠ€æœ¯é€šè¿‡é‡å è®¡ç®—ä¸æ•°æ®ä¼ è¾“æ¥éšè—å†…å­˜å»¶è¿Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">matmulDoubleBuffer</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åŒç¼“å†²å…±äº«å†…å­˜</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">  </span><span class="c1">// +1 for padding</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// é¢„åŠ è½½ç¬¬ä¸€ä¸ªtile</span>
<span class="w">    </span><span class="n">As</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[...];</span>
<span class="w">    </span><span class="n">Bs</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[...];</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¼‚æ­¥åŠ è½½ä¸‹ä¸€ä¸ªtileåˆ°å¦ä¸€ä¸ªbuffer</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">next_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<span class="w">        </span><span class="n">As</span><span class="p">[</span><span class="n">next_buffer</span><span class="p">][</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[...];</span><span class="w">  </span><span class="c1">// tile+1çš„æ•°æ®</span>
<span class="w">        </span><span class="n">Bs</span><span class="p">[</span><span class="n">next_buffer</span><span class="p">][</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[...];</span>

<span class="w">        </span><span class="c1">// åŒæ—¶è®¡ç®—å½“å‰buffer</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">ty</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">tx</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">        </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_buffer</span><span class="p">;</span><span class="w">  </span><span class="c1">// åˆ‡æ¢buffer</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å¤„ç†æœ€åä¸€ä¸ªtile</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">ty</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">tx</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">C</span><span class="p">[...]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="442">4.4.2 è½¯ä»¶æµæ°´çº¿ä¼˜åŒ–</h3>
<p>è½¯ä»¶æµæ°´çº¿å°†å¾ªç¯å±•å¼€ä¸ºé¢„è½½ã€ç¨³æ€å’Œæ”¶å°¾ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¸‰é˜¶æ®µæµæ°´çº¿</span>
<span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">STAGES</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">pipelinedKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">STAGES</span><span class="p">][</span><span class="n">BLOCK_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Prologue: å¡«å……æµæ°´çº¿</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">STAGES</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">buffer</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Steady state: ä¸»å¾ªç¯</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STAGES</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">BLOCK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">curr_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">STAGES</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">next_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">STAGES</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åŠ è½½ä¸‹ä¸€é˜¶æ®µæ•°æ®</span>
<span class="w">        </span><span class="n">buffer</span><span class="p">[</span><span class="n">next_stage</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// å¤„ç†å½“å‰é˜¶æ®µ</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">curr_stage</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]);</span>
<span class="w">        </span><span class="n">output</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="n">STAGES</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Epilogue: æ¸…ç©ºæµæ°´çº¿</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">STAGES</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">STAGES</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">stage</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]);</span>
<span class="w">        </span><span class="n">output</span><span class="p">[...]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="443-ampere">4.4.3 å¼‚æ­¥æ‹·è´ä¸æµæ°´çº¿ï¼ˆAmpere+ï¼‰</h3>
<p>Ampereæ¶æ„å¼•å…¥äº†å¼‚æ­¥æ‹·è´æŒ‡ä»¤ï¼Œå®ç°çœŸæ­£çš„ç¡¬ä»¶çº§æµæ°´çº¿ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨cuda::pipeline (C++20)</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda/pipeline&gt;</span>

<span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">asyncPipelineKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">smem</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">BLOCK_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda</span><span class="o">::</span><span class="n">make_pipeline</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">thread_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda</span><span class="o">::</span><span class="n">pipeline_role</span><span class="o">::</span><span class="n">producer</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å¼‚æ­¥åŠ è½½ç¬¬ä¸€ä¸ªå—</span>
<span class="w">    </span><span class="n">cuda</span><span class="o">::</span><span class="n">memcpy_async</span><span class="p">(</span><span class="n">smem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">pipe</span><span class="p">);</span>
<span class="w">    </span><span class="n">pipe</span><span class="p">.</span><span class="n">producer_commit</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">BLOCK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">curr_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">next_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å¼‚æ­¥åŠ è½½ä¸‹ä¸€å—</span>
<span class="w">        </span><span class="n">cuda</span><span class="o">::</span><span class="n">memcpy_async</span><span class="p">(</span><span class="n">smem</span><span class="p">[</span><span class="n">next_buf</span><span class="p">],</span><span class="w"> </span>
<span class="w">                          </span><span class="n">input</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">pipe</span><span class="p">);</span>
<span class="w">        </span><span class="n">pipe</span><span class="p">.</span><span class="n">producer_commit</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…å½“å‰å—å°±ç»ª</span>
<span class="w">        </span><span class="n">pipe</span><span class="p">.</span><span class="n">consumer_wait</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// å¤„ç†å½“å‰å—</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="n">smem</span><span class="p">[</span><span class="n">curr_buf</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]);</span>
<span class="w">        </span><span class="n">output</span><span class="p">[(</span><span class="n">i</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">        </span><span class="n">pipe</span><span class="p">.</span><span class="n">consumer_release</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å¤„ç†æœ€åä¸€å—</span>
<span class="w">    </span><span class="n">pipe</span><span class="p">.</span><span class="n">consumer_wait</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="n">smem</span><span class="p">[(</span><span class="n">N</span><span class="o">/</span><span class="n">BLOCK_SIZE</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]);</span>
<span class="w">    </span><span class="n">output</span><span class="p">[(</span><span class="n">N</span><span class="o">/</span><span class="n">BLOCK_SIZE</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="n">pipe</span><span class="p">.</span><span class="n">consumer_release</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="444">4.4.4 å¾ªç¯å±•å¼€ä¸å¯„å­˜å™¨ç¼“å­˜</h3>
<p>ç»“åˆå¾ªç¯å±•å¼€å’Œå¯„å­˜å™¨ç¼“å­˜è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">VECTOR_SIZE</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">optimizedGEMM</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="n">TILE_SIZE</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="n">TILE_SIZE</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// å¯„å­˜å™¨ç¼“å­˜</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">a_reg</span><span class="p">[</span><span class="n">VECTOR_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">b_reg</span><span class="p">[</span><span class="n">VECTOR_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">c_reg</span><span class="p">[</span><span class="n">VECTOR_SIZE</span><span class="p">][</span><span class="n">VECTOR_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åä½œåŠ è½½åˆ°å…±äº«å†…å­˜</span>
<span class="w">        </span><span class="n">As</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[...];</span>
<span class="w">        </span><span class="n">Bs</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[...];</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// å‘é‡åŒ–è®¡ç®—ï¼Œå‡å°‘å…±äº«å†…å­˜è®¿é—®</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">VECTOR_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// åŠ è½½åˆ°å¯„å­˜å™¨</span>
<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">VECTOR_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">a_reg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">];</span>
<span class="w">                </span><span class="n">b_reg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">][</span><span class="n">tx</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// å¯„å­˜å™¨çº§è®¡ç®—</span>
<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">VECTOR_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cp">#pragma unroll</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">VECTOR_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">c_reg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_reg</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å†™å›ç»“æœ</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">VECTOR_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">VECTOR_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">C</span><span class="p">[...]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_reg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="45">4.5 æ¡ˆä¾‹ï¼šé«˜æ€§èƒ½çŸ©é˜µä¹˜æ³•çš„å…±äº«å†…å­˜ä¼˜åŒ–</h2>
<h3 id="451">4.5.1 é—®é¢˜åˆ†æ</h3>
<p>çŸ©é˜µä¹˜æ³•æ˜¯è¯„ä¼°GPUæ€§èƒ½çš„ç»å…¸åŸºå‡†ï¼Œå…¶ä¼˜åŒ–æ¶‰åŠå…±äº«å†…å­˜ä½¿ç”¨çš„å„ä¸ªæ–¹é¢ã€‚å¯¹äºè‡ªåŠ¨é©¾é©¶ä¸­çš„ç¥ç»ç½‘ç»œæ¨ç†ï¼ŒGEMMæ“ä½œå æ®äº†70%ä»¥ä¸Šçš„è®¡ç®—æ—¶é—´ã€‚</p>
<p><strong>æ€§èƒ½ç›®æ ‡</strong>ï¼š</p>
<ul>
<li>è¾¾åˆ°ç†è®ºå³°å€¼æ€§èƒ½çš„90%ä»¥ä¸Š</li>
<li>åœ¨V100ä¸Šå®ç° &gt; 14 TFLOPSï¼ˆFP32ï¼‰</li>
<li>æ”¯æŒéæ–¹é˜µå’Œå°æ‰¹é‡åœºæ™¯</li>
</ul>
<h3 id="452">4.5.2 ä¼˜åŒ–ç‰ˆæœ¬æ¼”è¿›</h3>
<p><strong>ç‰ˆæœ¬1ï¼šæœ´ç´ å…±äº«å†…å­˜</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸºç¡€ç‰ˆæœ¬ï¼š~30% å³°å€¼æ€§èƒ½</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">gemmV1</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">16</span><span class="p">];</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">16</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">As</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[(</span><span class="n">by</span><span class="o">*</span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="o">*</span><span class="n">K</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tile</span><span class="o">*</span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">];</span>
<span class="w">        </span><span class="n">Bs</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[(</span><span class="n">tile</span><span class="o">*</span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bx</span><span class="o">*</span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">];</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">tx</span><span class="p">];</span><span class="w">  </span><span class="c1">// Bank conflict!</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">C</span><span class="p">[(</span><span class="n">by</span><span class="o">*</span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bx</span><span class="o">*</span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ç‰ˆæœ¬2ï¼šPaddingæ¶ˆé™¤conflict</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Paddingç‰ˆæœ¬ï¼š~60% å³°å€¼æ€§èƒ½</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">gemmV2</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">17</span><span class="p">];</span><span class="w">  </span><span class="c1">// Padding</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">17</span><span class="p">];</span><span class="w">  </span><span class="c1">// Padding</span>
<span class="w">    </span><span class="c1">// ... å…¶ä½™ä»£ç ç›¸åŒ</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ç‰ˆæœ¬3ï¼šå‘é‡åŒ–è®¿å­˜ + åŒç¼“å†²</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é«˜æ€§èƒ½ç‰ˆæœ¬ï¼š~85% å³°å€¼æ€§èƒ½</span>
<span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">BM</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">BN</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">BK</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TM</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TN</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">gemmV3</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">BK</span><span class="p">][</span><span class="n">BM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">  </span><span class="c1">// åŒç¼“å†² + padding</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">BK</span><span class="p">][</span><span class="n">BN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// æ¯ä¸ªçº¿ç¨‹è´Ÿè´£TM x TNçš„è¾“å‡ºtile</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">c_reg</span><span class="p">[</span><span class="n">TM</span><span class="p">][</span><span class="n">TN</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">a_reg</span><span class="p">[</span><span class="n">TM</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">b_reg</span><span class="p">[</span><span class="n">TN</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// é¢„åŠ è½½ç¬¬ä¸€ä¸ªtile (å‘é‡åŒ–)</span>
<span class="w">    </span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">As_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">As</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">Bs_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Bs</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="c1">// ... å‘é‡åŒ–åŠ è½½</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="o">/</span><span class="n">BK</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">next_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å¼‚æ­¥åŠ è½½ä¸‹ä¸€ä¸ªtile</span>
<span class="w">        </span><span class="c1">// ...</span>

<span class="w">        </span><span class="c1">// è®¡ç®—å½“å‰tile</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BK</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// åŠ è½½åˆ°å¯„å­˜å™¨</span>
<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TM</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">a_reg</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">k</span><span class="p">][...];</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TN</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">b_reg</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="n">buffer</span><span class="p">][</span><span class="n">k</span><span class="p">][...];</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// å¤–ç§¯æ›´æ–°</span>
<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TM</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cp">#pragma unroll</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TN</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">c_reg</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a_reg</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_reg</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">        </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_buffer</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å†™å›ç»“æœ</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="453">4.5.3 æ€§èƒ½åˆ†æä¸è°ƒä¼˜</h3>
<p><strong>Occupancyåˆ†æ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// è®¡ç®—æœ€ä¼˜é…ç½®</span>
<span class="kt">int</span><span class="w"> </span><span class="n">sharedMemPerBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">BM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BK</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="c1">// AsåŒç¼“å†²</span>
<span class="w">                        </span><span class="p">(</span><span class="n">BN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BK</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">   </span><span class="c1">// BsåŒç¼“å†²</span>

<span class="kt">int</span><span class="w"> </span><span class="n">maxBlocksPerSM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span>
<span class="w">    </span><span class="n">SM_SHARED_MEM_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sharedMemPerBlock</span><span class="p">,</span>
<span class="w">    </span><span class="n">MAX_THREADS_PER_SM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">// ç›®æ ‡ï¼šmaxBlocksPerSM &gt;= 2 for hiding latency</span>
</code></pre></div>

<p><strong>å¸¦å®½åˆ©ç”¨ç‡è®¡ç®—</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>æœ‰æ•ˆå¸¦å®½ = (2 <span class="gs">* M *</span> N <span class="gs">* K *</span> sizeof(float)) / kernel_time
å¸¦å®½æ•ˆç‡ = æœ‰æ•ˆå¸¦å®½ / ç†è®ºå¸¦å®½

ç›®æ ‡ï¼š

<span class="k">-</span> å…±äº«å†…å­˜å¸¦å®½æ•ˆç‡ &gt; 80%
<span class="k">-</span> å…¨å±€å†…å­˜å¸¦å®½æ•ˆç‡ &gt; 70%
</code></pre></div>

<h3 id="454">4.5.4 è‡ªåŠ¨é©¾é©¶åœºæ™¯ä¼˜åŒ–</h3>
<p>åœ¨è‡ªåŠ¨é©¾é©¶çš„å®æ—¶æ¨ç†ä¸­ï¼ŒçŸ©é˜µä¹˜æ³•å¸¸è§äºï¼š</p>
<ol>
<li>ç‚¹äº‘ç‰¹å¾æå–ï¼ˆPointPillarsï¼‰</li>
<li>å¤šå¤´æ³¨æ„åŠ›è®¡ç®—ï¼ˆTransformerï¼‰</li>
<li>ç‰¹å¾é‡‘å­—å¡”èåˆï¼ˆFPNï¼‰</li>
</ol>
<p><strong>å°æ‰¹é‡ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ‰¹é‡ä¸º1çš„ç‰¹æ®Šä¼˜åŒ–</span>
<span class="n">template</span><span class="o">&lt;&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">gemmBatch1</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨æŒä¹…åŒ–å†…æ ¸ï¼Œé¿å…é‡å¤åŠ è½½æƒé‡</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Bs_persistent</span><span class="p">[</span><span class="n">WEIGHT_TILE_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// æƒé‡åªåŠ è½½ä¸€æ¬¡</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bs_persistent</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[...];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// æµå¼å¤„ç†è¾“å…¥</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¤„ç†ä¸€è¡Œè¾“å‡º</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>åŠ¨æ€å½¢çŠ¶é€‚é…</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å¤„ç†éå¯¹é½å°ºå¯¸</span>
<span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_K</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">gemmDynamic</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span>
<span class="w">                            </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è¾¹ç•Œæ£€æŸ¥ç‰ˆæœ¬</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">As</span><span class="p">[</span><span class="n">TILE_M</span><span class="p">][</span><span class="n">TILE_K</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Bs</span><span class="p">[</span><span class="n">TILE_K</span><span class="p">][</span><span class="n">TILE_N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// è®¡ç®—æœ‰æ•ˆåŠ è½½èŒƒå›´</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">valid_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TILE_M</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_M</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">valid_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">TILE_N</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_N</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¸¦è¾¹ç•Œæ£€æŸ¥çš„åŠ è½½</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">valid_m</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">As</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[...];</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">As</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ... ç±»ä¼¼å¤„ç†Bså’Œè®¡ç®—é€»è¾‘</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="455">4.5.5 æ€§èƒ½åŸºå‡†ä¸å¯¹æ¯”</h3>
<p><strong>ä¸åŒä¼˜åŒ–çº§åˆ«çš„æ€§èƒ½å¯¹æ¯”</strong>ï¼ˆV100ï¼ŒFP32ï¼‰ï¼š</p>
<p>| ä¼˜åŒ–çº§åˆ« | æ€§èƒ½(TFLOPS) | å³°å€¼å æ¯” | ä¸»è¦ç“¶é¢ˆ |</p>
<table>
<thead>
<tr>
<th>ä¼˜åŒ–çº§åˆ«</th>
<th>æ€§èƒ½(TFLOPS)</th>
<th>å³°å€¼å æ¯”</th>
<th>ä¸»è¦ç“¶é¢ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cublas</td>
<td>15.6</td>
<td>99%</td>
<td>-</td>
</tr>
<tr>
<td>æœ¬ç« ä¼˜åŒ–ç‰ˆæœ¬</td>
<td>14.2</td>
<td>91%</td>
<td>å¯„å­˜å™¨å‹åŠ›</td>
</tr>
<tr>
<td>åŒç¼“å†²+Padding</td>
<td>10.8</td>
<td>69%</td>
<td>åŒæ­¥å¼€é”€</td>
</tr>
<tr>
<td>ä»…Padding</td>
<td>8.5</td>
<td>54%</td>
<td>Bank conflict</td>
</tr>
<tr>
<td>æœ´ç´ å…±äº«å†…å­˜</td>
<td>4.7</td>
<td>30%</td>
<td>ä¸¥é‡conflict</td>
</tr>
<tr>
<td>æ— å…±äº«å†…å­˜</td>
<td>1.2</td>
<td>8%</td>
<td>å…¨å±€å†…å­˜å¸¦å®½</td>
</tr>
</tbody>
</table>
<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†GPUå…±äº«å†…å­˜çš„æ¶æ„å’Œä¼˜åŒ–æŠ€æœ¯ï¼ŒæŒæ¡äº†ä»¥ä¸‹å…³é”®æ¦‚å¿µï¼š</p>
<ol>
<li><strong>å…±äº«å†…å­˜æ¶æ„</strong>ï¼š32ä¸ªbankçš„ç»„ç»‡æ–¹å¼ï¼Œåœ°å€æ˜ å°„è§„åˆ™ï¼Œä»¥åŠä¸åŒGPUæ¶æ„çš„å®¹é‡é…ç½®</li>
<li><strong>Bank Conflictæœºåˆ¶</strong>ï¼šconflictçš„äº§ç”ŸåŸå› ã€æ€§èƒ½å½±å“å’Œæ£€æµ‹æ–¹æ³•</li>
<li><strong>è§„é¿ç­–ç•¥</strong>ï¼šPaddingã€Swizzlingå’ŒPermutationä¸‰ç§ä¸»è¦æŠ€æœ¯çš„åŸç†å’Œåº”ç”¨åœºæ™¯</li>
<li><strong>åŒç¼“å†²æŠ€æœ¯</strong>ï¼šé€šè¿‡è®¡ç®—ä¸æ•°æ®ä¼ è¾“çš„é‡å å®ç°å»¶è¿Ÿéšè—</li>
<li><strong>å®æˆ˜ä¼˜åŒ–</strong>ï¼šä»30%åˆ°90%å³°å€¼æ€§èƒ½çš„çŸ©é˜µä¹˜æ³•ä¼˜åŒ–å†ç¨‹</li>
</ol>
<p><strong>å…³é”®å…¬å¼å›é¡¾</strong>ï¼š</p>
<ul>
<li>Bankæ˜ å°„ï¼š<code>bank_id = (byte_address / 4) % 32</code></li>
<li>Paddingè®¡ç®—ï¼š<code>padding = (TILE_SIZE % 32 == 0) ? 1 : 0</code></li>
<li>æœ‰æ•ˆå¸¦å®½ï¼š<code>BW_eff = (bytes_accessed / kernel_time)</code></li>
<li>Occupancyï¼š<code>occ = active_warps / max_warps_per_SM</code></li>
</ul>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>Bank Conflictè¯†åˆ«</strong>
åˆ†æä»¥ä¸‹ä»£ç ç‰‡æ®µï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨bank conflictåŠå…¶ç±»å‹ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="c1">// Case A</span>
<span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
<span class="c1">// Case B  </span>
<span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="c1">// Case C</span>
<span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span>
<span class="c1">// Case D</span>
<span class="kt">float</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ‰€æœ‰çº¿ç¨‹è¯»å–</span>
</code></pre></div>

<details>
<summary>ç­”æ¡ˆ</summary>
<ul>
<li>Case Aï¼šæ— conflictï¼Œè¿ç»­è®¿é—®ä¸åŒbank</li>
<li>Case Bï¼š2-way conflictï¼Œå¶æ•°çº¿ç¨‹è®¿é—®å¶æ•°bank</li>
<li>Case Cï¼š32-way conflictï¼Œæ‰€æœ‰çº¿ç¨‹è®¿é—®åŒä¸€bank</li>
<li>Case Dï¼šæ— conflictï¼Œå¹¿æ’­æœºåˆ¶è‡ªåŠ¨å¤„ç†</li>
</ul>
</details>
<ol start="2">
<li><strong>Paddingè®¡ç®—</strong>
ç»™å®šä¸€ä¸ª32Ã—32çš„å…±äº«å†…å­˜æ•°ç»„ç”¨äºçŸ©é˜µè½¬ç½®ï¼Œè®¡ç®—éœ€è¦çš„paddingå¤§å°å¹¶è§£é‡ŠåŸå› ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šè€ƒè™‘è½¬ç½®æ“ä½œä¸­çš„è®¿é—®æ¨¡å¼</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>éœ€è¦padding 1åˆ—ï¼Œå˜ä¸º32Ã—33ã€‚åŸå› ï¼šè½¬ç½®æ—¶åˆ—è®¿é—®å˜ä¸ºè¡Œè®¿é—®ï¼Œstride=32ä¼šå¯¼è‡´æ‰€æœ‰çº¿ç¨‹è®¿é—®åŒä¸€bankã€‚æ·»åŠ 1åˆ—paddingåï¼Œstrideå˜ä¸º33ï¼Œé”™å¼€äº†bankæ˜ å°„ã€‚</p>
</details>
<ol start="3">
<li><strong>å…±äº«å†…å­˜å®¹é‡è§„åˆ’</strong>
åœ¨Ampereæ¶æ„(164KBå…±äº«å†…å­˜/SM)ä¸Šï¼Œè®¾è®¡ä¸€ä¸ªGEMM kernelçš„å…±äº«å†…å­˜åˆ†é…æ–¹æ¡ˆï¼Œè¦æ±‚ï¼š</li>
</ol>
<ul>
<li>Block size: 128Ã—128</li>
<li>åŒç¼“å†²</li>
<li>ç›®æ ‡occupancy â‰¥ 50%</li>
</ul>
<p><strong>æç¤º</strong>ï¼šè®¡ç®—æ¯ä¸ªblockéœ€è¦çš„å…±äº«å†…å­˜ï¼Œç¡®ä¿è‡³å°‘2ä¸ªblockèƒ½åŒæ—¶è¿è¡Œ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ¯ä¸ªtileéœ€è¦ï¼š(128Ã—8 + 8Ã—128) Ã— 4 bytes Ã— 2(åŒç¼“å†²) = 16KB
æ·»åŠ paddingï¼šçº¦16.5KB
æ¯ä¸ªblockæ€»éœ€æ±‚ï¼šçº¦33KB
164KBå¯å®¹çº³ï¼š164/33 â‰ˆ 4ä¸ªblocksï¼Œæ»¡è¶³occupancyè¦æ±‚</p>
</details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<ol start="4">
<li><strong>Swizzlingå‡½æ•°è®¾è®¡</strong>
è®¾è®¡ä¸€ä¸ªswizzlingå‡½æ•°ï¼Œä½¿å¾—32Ã—32çŸ©é˜µè½¬ç½®æ—¶æ— bank conflictä¸”ä¸ä½¿ç”¨é¢å¤–å­˜å‚¨ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨XORæ“ä½œæ”¹å˜ç´¢å¼•æ˜ å°„</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code>__device__ int swizzle(int x, int y) {
    // XORä½5ä½ï¼Œå®ç°bankäº¤é”™
    return x ^ ((y &amp; 0x1F) &gt;&gt; 2);
}

ä½¿ç”¨æ–¹å¼ï¼š
tile[threadIdx.y][swizzle(threadIdx.x, threadIdx.y)] = input[...];
</code></pre></div>

<p>å…³é”®ï¼šåˆ©ç”¨XORæ“ä½œä½¿ç›¸é‚»warpçš„çº¿ç¨‹è®¿é—®ä¸åŒbankç»„ã€‚</p>
</details>
<ol start="5">
<li><strong>æ€§èƒ½ç“¶é¢ˆåˆ†æ</strong>
æŸGEMM kernelæŠ¥å‘Šï¼š</li>
</ol>
<ul>
<li>è®¡ç®—ååï¼š8 TFLOPS</li>
<li>å…±äº«å†…å­˜å¸¦å®½åˆ©ç”¨ç‡ï¼š45%</li>
<li>Occupancyï¼š75%</li>
<li>Bank conflictç‡ï¼šå¹³å‡4-way</li>
</ul>
<p>è¯·åˆ†ææ€§èƒ½ç“¶é¢ˆå¹¶æå‡ºä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<p><strong>æç¤º</strong>ï¼šä»å¤šä¸ªç»´åº¦åˆ†æç“¶é¢ˆæ¥æº</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç“¶é¢ˆåˆ†æï¼š</p>
<ol>
<li>ä¸»è¦ç“¶é¢ˆæ˜¯bank conflictï¼ˆ4-wayå¯¼è‡´å¸¦å®½é™è‡³25%ï¼‰</li>
<li>å…±äº«å†…å­˜å¸¦å®½åˆ©ç”¨ç‡ä½ï¼ˆ45%ï¼‰å°è¯äº†conflicté—®é¢˜</li>
</ol>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li>æ·»åŠ paddingæ¶ˆé™¤conflict</li>
<li>ä½¿ç”¨swizzlingæŠ€æœ¯</li>
<li>è°ƒæ•´tileå¤§å°é¿å…conflict pattern</li>
<li>å¢åŠ å¯„å­˜å™¨ç¼“å­˜å‡å°‘å…±äº«å†…å­˜è®¿é—®</li>
</ol>
<p>é¢„æœŸæ”¹è¿›ï¼šæ¶ˆé™¤conflictåï¼Œå¸¦å®½åˆ©ç”¨ç‡å¯è¾¾80%+ï¼Œæ€§èƒ½æå‡çº¦2å€ã€‚</p>
</details>
<ol start="6">
<li><strong>åŒç¼“å†²æµæ°´çº¿è®¾è®¡</strong>
ä¸ºä¸€ä¸ªStencilè®¡ç®—ï¼ˆ5-pointï¼‰è®¾è®¡åŒç¼“å†²æ–¹æ¡ˆï¼Œè¦æ±‚ï¼š</li>
</ol>
<ul>
<li>è¾“å…¥ï¼š1Dæ•°ç»„ï¼Œé•¿åº¦N</li>
<li>æ¯ä¸ªç‚¹éœ€è¦å·¦å³å„2ä¸ªé‚»å±…</li>
<li>æœ€å¤§åŒ–è®¡ç®—ä¸åŠ è½½çš„é‡å </li>
</ul>
<p><strong>æç¤º</strong>ï¼šè€ƒè™‘haloåŒºåŸŸçš„å¤„ç†</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è®¾è®¡è¦ç‚¹ï¼š</p>
<ol>
<li>å…±äº«å†…å­˜ï¼š2ä¸ªbufferï¼Œæ¯ä¸ªBLOCK_SIZE+4ï¼ˆhaloï¼‰</li>
<li>æµæ°´çº¿é˜¶æ®µï¼š
   - é¢„åŠ è½½buffer 0
   - å¾ªç¯ï¼šåŠ è½½buffer (i+1)%2ï¼Œè®¡ç®—buffer i%2
   - æ”¶å°¾ï¼šå¤„ç†æœ€åbuffer</li>
<li>Haloå¤„ç†ï¼šæ¯ä¸ªbufferå¤šåŠ è½½4ä¸ªå…ƒç´ </li>
<li>åŒæ­¥ç‚¹ï¼šåŠ è½½åã€è®¡ç®—å‰å„ä¸€ä¸ªsyncthreads</li>
</ol>
<p>å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨å¼‚æ­¥å†…å­˜ä¼ è¾“ï¼ˆAmpere+ï¼‰è¿›ä¸€æ­¥éšè—å»¶è¿Ÿã€‚</p>
</details>
<ol start="7">
<li><strong>æ··åˆç²¾åº¦å…±äº«å†…å­˜ä¼˜åŒ–</strong>
è®¾è®¡ä¸€ä¸ªFP16 GEMM kernelçš„å…±äº«å†…å­˜å¸ƒå±€ï¼Œè¦æ±‚ï¼š</li>
</ol>
<ul>
<li>åˆ©ç”¨Tensor Core</li>
<li>æœ€å°åŒ–bank conflict</li>
<li>æ”¯æŒFP32ç´¯åŠ å™¨</li>
</ul>
<p><strong>æç¤º</strong>ï¼šè€ƒè™‘FP16çš„bankå®½åº¦å’ŒTensor Coreçš„è®¿é—®æ¨¡å¼</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å¸ƒå±€è®¾è®¡ï¼š</p>
<ol>
<li>FP16å­˜å‚¨ï¼šæ¯ä¸ªbankå¯å­˜2ä¸ªFP16å€¼</li>
<li>Fragmentå¸ƒå±€ï¼š16Ã—16Ã—16 for Tensor Core</li>
<li>Swizzlingï¼šæ¯8è¡Œåšä¸€æ¬¡permutation</li>
<li>ç´¯åŠ å™¨ï¼šä½¿ç”¨å¯„å­˜å™¨å­˜å‚¨FP32ç»“æœ</li>
</ol>
<p>å…³é”®ç‚¹ï¼š</p>
<ul>
<li>Bank conflict patternä¸FP32ä¸åŒ</li>
<li>éœ€è¦è€ƒè™‘wmmaçš„è®¿é—®å¯¹é½</li>
<li>ä½¿ç”¨ldmatrixæŒ‡ä»¤ä¼˜åŒ–åŠ è½½</li>
</ul>
</details>
<ol start="8">
<li><strong>åŠ¨æ€å…±äº«å†…å­˜åˆ†é…ç­–ç•¥</strong>
è®¾è®¡ä¸€ä¸ªè‡ªé€‚åº”çš„å…±äº«å†…å­˜åˆ†é…ç­–ç•¥ï¼Œæ ¹æ®é—®é¢˜è§„æ¨¡åŠ¨æ€è°ƒæ•´tileå¤§å°å’Œbufferæ•°é‡ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šå»ºç«‹æ€§èƒ½æ¨¡å‹ï¼Œè€ƒè™‘occupancyå’Œdata reuseçš„å¹³è¡¡</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç­–ç•¥æ¡†æ¶ï¼š</p>
<ol>
<li>æ€§èƒ½æ¨¡å‹ï¼šT = T_compute + T_memory - T_overlap</li>
<li>çº¦æŸæ¡ä»¶ï¼š
   - å…±äº«å†…å­˜é™åˆ¶ï¼štile_sizeÂ² Ã— buffers Ã— 4 â‰¤ SM_capacity
   - Occupancyè¦æ±‚ï¼šblocks_per_SM â‰¥ 2</li>
<li>ä¼˜åŒ–ç›®æ ‡ï¼šmaximize (è®¡ç®—å¼ºåº¦ Ã— occupancy)</li>
<li>å®ç°ï¼š
   - å°çŸ©é˜µï¼šå¤§tileï¼Œå•ç¼“å†²
   - ä¸­çŸ©é˜µï¼šä¸­tileï¼ŒåŒç¼“å†²
   - å¤§çŸ©é˜µï¼šå°tileï¼Œä¸‰ç¼“å†²</li>
</ol>
<p>å†³ç­–æ ‘ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code>if (M*N*K &lt; threshold_small)
    use_config(128Ã—128, single_buffer);
else if (M*N*K &lt; threshold_medium)
    use_config(64Ã—64, double_buffer);
else
    use_config(32Ã—32, triple_buffer);
</code></pre></div>

</details>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ï¼ˆGotchasï¼‰</h2>
<h3 id="1-bank-conflict">1. éšå¼çš„Bank Conflict</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šç»“æ„ä½“å¤§å°å¯¼è‡´conflict</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Vec3</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w">  </span><span class="c1">// 12 bytes</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="n">Vec3</span><span class="w"> </span><span class="n">vectors</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="c1">// è®¿é—®vectors[threadIdx.x]ä¼šäº§ç”Ÿconflictï¼</span>

<span class="c1">// æ­£ç¡®ï¼špaddingåˆ°16å­—èŠ‚</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Vec4</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w">  </span><span class="c1">// 16 bytes</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="n">Vec4</span><span class="w"> </span><span class="n">vectors</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</code></pre></div>

<h3 id="2">2. åŠ¨æ€ç´¢å¼•çš„é™·é˜±</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// å±é™©ï¼šåŠ¨æ€ç´¢å¼•å¯èƒ½äº§ç”Ÿä¸å¯é¢„æµ‹çš„conflict</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_computation</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w">  </span><span class="c1">// ç¼–è¯‘å™¨æ— æ³•ä¼˜åŒ–</span>

<span class="c1">// æ”¹è¿›ï¼šä½¿ç”¨é™æ€æ¨¡å¼æˆ–ç¡®ä¿æ— conflictçš„æ˜ å°„</span>
<span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MASK</span><span class="p">;</span>
</code></pre></div>

<h3 id="3-false-sharing">3. False Sharing</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é—®é¢˜ï¼šä¸åŒwarpå†™å…¥ç›¸é‚»åœ°å€</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">counters</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counters</span><span class="p">[</span><span class="n">warpId</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// False sharing!</span>

<span class="c1">// è§£å†³ï¼špaddingé¿å…cache lineç«äº‰</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">counters</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">8</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ¯ä¸ªcounterå ç”¨32å­—èŠ‚</span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counters</span><span class="p">[</span><span class="n">warpId</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>

<h3 id="4">4. åŒæ­¥é”™è¯¯</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ¡ä»¶åŒæ­¥å¯¼è‡´æ­»é”</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¤„ç†æ•°æ®</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ­»é”ï¼åªæœ‰éƒ¨åˆ†çº¿ç¨‹åˆ°è¾¾</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½è¦ç»è¿‡åŒæ­¥ç‚¹</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¤„ç†æ•°æ®</span>
<span class="p">}</span>
<span class="nf">__syncthreads</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šåˆ°è¾¾</span>
</code></pre></div>

<h3 id="5">5. å…±äº«å†…å­˜åˆå§‹åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæœªåˆå§‹åŒ–çš„å…±äº«å†…å­˜åŒ…å«åƒåœ¾å€¼</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sdata</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdata</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span><span class="w">  </span><span class="c1">// åƒåœ¾å€¼ï¼</span>

<span class="c1">// æ­£ç¡®ï¼šæ˜¾å¼åˆå§‹åŒ–</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sdata</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="n">sdata</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="nf">__syncthreads</span><span class="p">();</span>
</code></pre></div>

<h2 id="_5">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_6">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] è®¡ç®—å…±äº«å†…å­˜éœ€æ±‚ï¼Œç¡®ä¿ä¸è¶…è¿‡ç¡¬ä»¶é™åˆ¶</li>
<li>[ ] è¯„ä¼°bank conflicté£é™©ï¼Œé€‰æ‹©åˆé€‚çš„è§„é¿ç­–ç•¥</li>
<li>[ ] è§„åˆ’æ•°æ®å¸ƒå±€ï¼Œè€ƒè™‘paddingå’Œå¯¹é½</li>
<li>[ ] è®¾è®¡åŒæ­¥ç­–ç•¥ï¼Œé¿å…è¿‡åº¦åŒæ­¥</li>
<li>[ ] è€ƒè™‘ä¸L1ç¼“å­˜çš„é…ç½®æƒè¡¡</li>
</ul>
<h3 id="_7">å®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] ä½¿ç”¨æ¨¡æ¿å‚æ•°ä½¿tileå¤§å°å¯é…ç½®</li>
<li>[ ] å®ç°è¾¹ç•Œæ£€æŸ¥å¤„ç†éå¯¹é½å°ºå¯¸</li>
<li>[ ] æ·»åŠ paddingæ¶ˆé™¤bank conflict</li>
<li>[ ] ä½¿ç”¨pragma unrollä¼˜åŒ–å†…å±‚å¾ªç¯</li>
<li>[ ] å®ç°åŒç¼“å†²éšè—å†…å­˜å»¶è¿Ÿ</li>
</ul>
<h3 id="_8">ä¼˜åŒ–é˜¶æ®µ</h3>
<ul>
<li>[ ] ä½¿ç”¨Nsight Computeåˆ†æbank conflict</li>
<li>[ ] æµ‹é‡å…±äº«å†…å­˜å¸¦å®½åˆ©ç”¨ç‡</li>
<li>[ ] è¯„ä¼°occupancyä¸å…±äº«å†…å­˜ä½¿ç”¨çš„å¹³è¡¡</li>
<li>[ ] å°è¯•ä¸åŒçš„swizzlingæ¨¡å¼</li>
<li>[ ] è€ƒè™‘å¯„å­˜å™¨ç¼“å­˜å‡å°‘å…±äº«å†…å­˜å‹åŠ›</li>
</ul>
<h3 id="_9">éªŒè¯é˜¶æ®µ</h3>
<ul>
<li>[ ] æ£€æŸ¥æ‰€æœ‰å…±äº«å†…å­˜è®¿é—®çš„è¾¹ç•Œ</li>
<li>[ ] éªŒè¯åŒæ­¥ç‚¹çš„æ­£ç¡®æ€§</li>
<li>[ ] æµ‹è¯•ä¸åŒé—®é¢˜è§„æ¨¡çš„æ€§èƒ½</li>
<li>[ ] ç¡®è®¤æ— race condition</li>
<li>[ ] å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½æŒ‡æ ‡</li>
</ul>
<h3 id="_10">éƒ¨ç½²é˜¶æ®µ</h3>
<ul>
<li>[ ] ä¸ºä¸åŒGPUæ¶æ„æä¾›ä¼˜åŒ–å‚æ•°</li>
<li>[ ] å®ç°è‡ªåŠ¨tuningæœºåˆ¶</li>
<li>[ ] æ·»åŠ æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—</li>
<li>[ ] ç¼–å†™ä½¿ç”¨æ–‡æ¡£å’Œæ³¨æ„äº‹é¡¹</li>
<li>[ ] è®¾ç½®åˆç†çš„fallbackç­–ç•¥</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter3.html" class="nav-link prev">â† ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</a><a href="chapter5.html" class="nav-link next">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜ â†’</a></nav>
        </main>
    </div>
</body>
</html>