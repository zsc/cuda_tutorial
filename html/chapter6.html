<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="6warp">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</h1>
<p>åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»æŒæ¡äº†CUDAçš„åŸºç¡€ç¼–ç¨‹æ¨¡å‹å’Œå†…å­˜ä¼˜åŒ–æŠ€æœ¯ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨CUDAç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼šwarpçº§ç¼–ç¨‹ã€‚Warpæ˜¯GPUæ‰§è¡Œçš„åŸºæœ¬å•ä½ï¼Œç†è§£å¹¶åˆ©ç”¨warpçº§åŸè¯­å¯ä»¥å®ç°æè‡´çš„æ€§èƒ½ä¼˜åŒ–ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨shuffleã€voteç­‰warpå†…åœ¨å‡½æ•°ï¼ŒæŒæ¡åä½œç»„ï¼ˆCooperative Groupsï¼‰è¿™ä¸€å¼ºå¤§çš„ç¼–ç¨‹æŠ½è±¡ï¼Œå®ç°é«˜æ•ˆçš„å¹¶è¡Œç®—æ³•ï¼Œå¹¶é€šè¿‡æ— é”æ•°æ®ç»“æ„çš„æ¡ˆä¾‹å±•ç¤ºè¿™äº›æŠ€æœ¯åœ¨å®é™…åœºæ™¯ä¸­çš„åº”ç”¨ã€‚</p>
<h2 id="61-warp">6.1 Warpå†…åœ¨å‡½æ•°</h2>
<h3 id="611-warpsimt">6.1.1 Warpæ¦‚å¿µä¸SIMTæ‰§è¡Œæ¨¡å‹</h3>
<p>åœ¨NVIDIA GPUä¸­ï¼Œwarpæ˜¯ç¡¬ä»¶è°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½ï¼ŒåŒ…å«32ä¸ªçº¿ç¨‹ã€‚è¿™32ä¸ªçº¿ç¨‹ä»¥SIMTï¼ˆSingle Instruction Multiple Threadï¼‰æ–¹å¼æ‰§è¡Œï¼Œå³åŒä¸€æ—¶åˆ»æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ï¼Œä½†æ“ä½œä¸åŒçš„æ•°æ®ã€‚</p>
<div class="codehilite"><pre><span></span><code>Warpæ‰§è¡Œæ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Warp (32 threads)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T0 â”‚ T1 â”‚ T2 â”‚ ... â”‚ T30â”‚ T31â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      åŒä¸€æ¡æŒ‡ä»¤ï¼Œä¸åŒæ•°æ®                â”‚
â”‚      Program Counter (PC)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>ç†è§£warpçš„æ‰§è¡Œç‰¹æ€§å¯¹äºæ€§èƒ½ä¼˜åŒ–è‡³å…³é‡è¦ï¼š</p>
<ol>
<li><strong>é”æ­¥æ‰§è¡Œ</strong>ï¼šåŒä¸€warpå†…çš„çº¿ç¨‹å…±äº«æŒ‡ä»¤å•å…ƒï¼Œå¿…é¡»æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤</li>
<li><strong>åˆ†æ”¯åˆ†æ­§</strong>ï¼šå½“warpå†…çº¿ç¨‹æ‰§è¡Œä¸åŒåˆ†æ”¯æ—¶ï¼Œä¼šä¸²è¡Œæ‰§è¡Œå„åˆ†æ”¯ï¼Œé™ä½æ•ˆç‡</li>
<li><strong>æ´»è·ƒæ©ç </strong>ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªæ´»è·ƒä½ï¼Œæ ‡è¯†è¯¥çº¿ç¨‹æ˜¯å¦å‚ä¸å½“å‰æŒ‡ä»¤çš„æ‰§è¡Œ</li>
</ol>
<h3 id="612-shuffle">6.1.2 ShuffleæŒ‡ä»¤æ—è¯¦è§£</h3>
<p>ShuffleæŒ‡ä»¤å…è®¸warpå†…çº¿ç¨‹ç›´æ¥äº¤æ¢å¯„å­˜å™¨æ•°æ®ï¼Œæ— éœ€é€šè¿‡å…±äº«å†…å­˜ï¼Œå…·æœ‰æä½çš„å»¶è¿Ÿï¼ˆä»…1ä¸ªæ—¶é’Ÿå‘¨æœŸï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸºæœ¬shuffleæ“ä½œ</span>
<span class="n">__shfl_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">srcLane</span><span class="p">);</span><span class="w">        </span><span class="c1">// ä»æŒ‡å®šlaneè¯»å–</span>
<span class="n">__shfl_up_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">);</span><span class="w">       </span><span class="c1">// ä»lane_id-deltaè¯»å–</span>
<span class="n">__shfl_down_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">);</span><span class="w">     </span><span class="c1">// ä»lane_id+deltaè¯»å–  </span>
<span class="n">__shfl_xor_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">laneMask</span><span class="p">);</span><span class="w">   </span><span class="c1">// ä»lane_id^laneMaskè¯»å–</span>
</code></pre></div>

<p>å…³é”®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><code>mask</code>ï¼š32ä½æ©ç ï¼ŒæŒ‡å®šå‚ä¸æ“ä½œçš„çº¿ç¨‹</li>
<li><code>var</code>ï¼šè¦äº¤æ¢çš„å˜é‡</li>
<li><code>srcLane/delta/laneMask</code>ï¼šæºçº¿ç¨‹çš„è®¡ç®—æ–¹å¼</li>
</ul>
<p><strong>è¶å½¢äº¤æ¢æ¨¡å¼ç¤ºä¾‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>XORæ¨¡å¼ (laneMask=1)ï¼š
Lane: 0â†â†’1, 2â†â†’3, 4â†â†’5, 6â†â†’7, ...

XORæ¨¡å¼ (laneMask=2)ï¼š
Lane: 0â†â†’2, 1â†â†’3, 4â†â†’6, 5â†â†’7, ...

XORæ¨¡å¼ (laneMask=4)ï¼š
Lane: 0â†â†’4, 1â†â†’5, 2â†â†’6, 3â†â†’7, ...
</code></pre></div>

<p>ShuffleæŒ‡ä»¤çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š</p>
<ol>
<li><strong>Warpçº§å½’çº¦</strong>ï¼šæ— éœ€å…±äº«å†…å­˜çš„å¿«é€Ÿå½’çº¦</li>
<li><strong>æ•°æ®å¹¿æ’­</strong>ï¼šå°†ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®å¹¿æ’­ç»™å…¶ä»–çº¿ç¨‹</li>
<li><strong>çŸ©é˜µè½¬ç½®</strong>ï¼šå°çŸ©é˜µçš„å¯„å­˜å™¨çº§è½¬ç½®</li>
<li><strong>å‰ç¼€å’Œè®¡ç®—</strong>ï¼šé«˜æ•ˆçš„æ‰«æç®—æ³•å®ç°</li>
</ol>
<h3 id="613-vote">6.1.3 VoteæŒ‡ä»¤æ—ä¸åˆ†æ”¯ä¼˜åŒ–</h3>
<p>VoteæŒ‡ä»¤ç”¨äºwarpå†…çº¿ç¨‹é—´çš„æ¡ä»¶æ£€æŸ¥å’ŒåŒæ­¥ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__all_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">predicate</span><span class="p">);</span><span class="w">    </span><span class="c1">// æ‰€æœ‰çº¿ç¨‹çš„predicateéƒ½ä¸ºçœŸæ—¶è¿”å›çœŸ</span>
<span class="n">__any_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">predicate</span><span class="p">);</span><span class="w">    </span><span class="c1">// ä»»ä¸€çº¿ç¨‹çš„predicateä¸ºçœŸæ—¶è¿”å›çœŸ</span>
<span class="n">__ballot_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">predicate</span><span class="p">);</span><span class="w"> </span><span class="c1">// è¿”å›32ä½æ©ç ï¼Œæ¯ä½è¡¨ç¤ºå¯¹åº”çº¿ç¨‹çš„predicateå€¼</span>
<span class="n">__activemask</span><span class="p">();</span><span class="w">                 </span><span class="c1">// è¿”å›å½“å‰æ´»è·ƒçº¿ç¨‹çš„æ©ç </span>
</code></pre></div>

<p><strong>åˆ†æ”¯ä¼˜åŒ–ç¤ºä¾‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½æ•ˆçš„åˆ†æ”¯ä»£ç </span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¯èƒ½é€ æˆwarpåˆ†æ­§</span>
<span class="w">    </span><span class="n">expensive_computation</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨voteä¼˜åŒ–</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ballot_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mask</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// æ•´ä¸ªwarpä¸€èµ·åˆ¤æ–­</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">expensive_computation</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="614-match">6.1.4 MatchæŒ‡ä»¤ä¸åŠ¨æ€åä½œ</h3>
<p>MatchæŒ‡ä»¤ï¼ˆCompute Capability 7.0+ï¼‰æ”¯æŒåŠ¨æ€åˆ†ç»„åä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__match_any_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">   </span><span class="c1">// è¿”å›å…·æœ‰ç›¸åŒvalueçš„çº¿ç¨‹æ©ç </span>
<span class="n">__match_all_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pred</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ£€æŸ¥æ‰€æœ‰çº¿ç¨‹æ˜¯å¦å…·æœ‰ç›¸åŒvalue</span>
</code></pre></div>

<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li><strong>åŠ¨æ€è´Ÿè½½å‡è¡¡</strong>ï¼šæ ¹æ®æ•°æ®å€¼åŠ¨æ€åˆ†ç»„å¤„ç†</li>
<li><strong>ç¨€ç–æ•°æ®å¤„ç†</strong>ï¼šç›¸åŒç´¢å¼•çš„çº¿ç¨‹åä½œ</li>
<li><strong>ç›´æ–¹å›¾è®¡ç®—</strong>ï¼šç›¸åŒbinçš„çº¿ç¨‹åŸå­æ“ä½œåˆå¹¶</li>
</ul>
<h2 id="62-cooperative-groups">6.2 åä½œç»„ï¼ˆCooperative Groupsï¼‰ç¼–ç¨‹</h2>
<h3 id="621">6.2.1 åä½œç»„æŠ½è±¡å±‚æ¬¡</h3>
<p>åä½œç»„ï¼ˆCooperative Groupsï¼‰æ˜¯CUDA 9.0å¼•å…¥çš„ç¼–ç¨‹æ¨¡å‹ï¼Œæä¾›äº†æ›´çµæ´»çš„çº¿ç¨‹åä½œæŠ½è±¡ã€‚å®ƒå…è®¸å¼€å‘è€…å®šä¹‰å’Œæ“ä½œä»»æ„ç²’åº¦çš„çº¿ç¨‹ç»„ï¼Œä»å•ä¸ªçº¿ç¨‹åˆ°æ•´ä¸ªç½‘æ ¼ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cooperative_groups.h&gt;</span>
<span class="n">namespace</span><span class="w"> </span><span class="n">cg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cooperative_groups</span><span class="p">;</span>

<span class="c1">// åä½œç»„å±‚æ¬¡ç»“æ„</span>
<span class="c1">// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c1">// â”‚      Grid Group             â”‚ å¤šä¸ªçº¿ç¨‹å—</span>
<span class="c1">// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c1">// â”‚    Thread Block Group       â”‚ å•ä¸ªçº¿ç¨‹å—</span>
<span class="c1">// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c1">// â”‚    Tiled Partition          â”‚ çº¿ç¨‹å—çš„åˆ†åŒº</span>
<span class="c1">// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c1">// â”‚    Coalesced Group          â”‚ åŠ¨æ€æ´»è·ƒçº¿ç¨‹ç»„</span>
<span class="c1">// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<p>åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">kernel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è·å–å½“å‰çº¿ç¨‹å—</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">thread_block</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">this_thread_block</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºwarpå¤§å°çš„åˆ†åŒº</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">thread_block_tile</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">warp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">tiled_partition</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºæ›´å°çš„åˆ†åŒº</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">thread_block_tile</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tile8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">tiled_partition</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">warp</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è·å–åŠ¨æ€æ´»è·ƒç»„</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">coalesced_group</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">coalesced_threads</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="622">6.2.2 çº¿ç¨‹å—çº§ä¸ç½‘æ ¼çº§åŒæ­¥</h3>
<p>åä½œç»„æä¾›äº†ç»Ÿä¸€çš„åŒæ­¥æ¥å£ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// çº¿ç¨‹å—çº§åŒæ­¥</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">blockSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">thread_block</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">this_thread_block</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// æ‰§è¡Œè®¡ç®—</span>
<span class="w">    </span><span class="n">compute_phase1</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// åŒæ­¥æ•´ä¸ªçº¿ç¨‹å—</span>
<span class="w">    </span><span class="n">block</span><span class="p">.</span><span class="n">sync</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ç»§ç»­è®¡ç®—</span>
<span class="w">    </span><span class="n">compute_phase2</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ç½‘æ ¼çº§åŒæ­¥ï¼ˆéœ€è¦ç‰¹æ®Šå¯åŠ¨ï¼‰</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">gridSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">grid_group</span><span class="w"> </span><span class="n">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">this_grid</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ç¬¬ä¸€é˜¶æ®µè®¡ç®—</span>
<span class="w">    </span><span class="n">compute_global_phase1</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// åŒæ­¥æ•´ä¸ªç½‘æ ¼ï¼ˆæ‰€æœ‰çº¿ç¨‹å—ï¼‰</span>
<span class="w">    </span><span class="n">grid</span><span class="p">.</span><span class="n">sync</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ç¬¬äºŒé˜¶æ®µè®¡ç®—</span>
<span class="w">    </span><span class="n">compute_global_phase2</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ç½‘æ ¼çº§å†…æ ¸å¯åŠ¨</span>
<span class="kt">void</span><span class="w"> </span><span class="n">launchGridSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numBlocksPerSm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>

<span class="w">    </span><span class="n">cudaOccupancyMaxActiveBlocksPerMultiprocessor</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">numBlocksPerSm</span><span class="p">,</span><span class="w"> </span><span class="n">gridSync</span><span class="p">,</span><span class="w"> </span><span class="n">numThreads</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numSMs</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaDeviceGetAttribute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">numSMs</span><span class="p">,</span><span class="w"> </span><span class="n">cudaDevAttrMultiProcessorCount</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="kt">dim3</span><span class="w"> </span><span class="nf">gridDim</span><span class="p">(</span><span class="n">numSMs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numBlocksPerSm</span><span class="p">);</span>
<span class="w">    </span><span class="kt">dim3</span><span class="w"> </span><span class="nf">blockDim</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">kernelArgs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* args */</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">cudaLaunchCooperativeKernel</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">gridSync</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                </span><span class="nb">gridDim</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                </span><span class="n">kernelArgs</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="623">6.2.3 åŠ¨æ€åˆ†åŒºä¸é‡ç»„</h3>
<p>åä½œç»„æ”¯æŒåŠ¨æ€åˆ›å»ºå’Œé‡ç»„çº¿ç¨‹ç»„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dynamicGroups</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">thread_block</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">this_thread_block</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// æ ¹æ®æ¡ä»¶åŠ¨æ€åˆ†ç»„</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">  </span><span class="c1">// åˆ†æˆ3ç»„</span>

<span class="w">    </span><span class="c1">// æ ‡è®°åˆ†åŒº</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">labeled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">labeled_partition</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">group_id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ¯ä¸ªåˆ†ç»„ç‹¬ç«‹æ‰§è¡Œå½’çº¦</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">group_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¤„ç†ç¬¬ä¸€ç»„æ•°æ®</span>
<span class="w">        </span><span class="n">process_group_0</span><span class="p">(</span><span class="n">labeled</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">group_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¤„ç†ç¬¬äºŒç»„æ•°æ®</span>
<span class="w">        </span><span class="n">process_group_1</span><span class="p">(</span><span class="n">labeled</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¤„ç†ç¬¬ä¸‰ç»„æ•°æ®</span>
<span class="w">        </span><span class="n">process_group_2</span><span class="p">(</span><span class="n">labeled</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨binary_partitionè¿›è¡ŒäºŒåˆ†</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">tiled_partition</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">binary_partition</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span><span class="w"> </span><span class="n">condition</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¶æ•°çº¿ç¨‹ç»„å’Œå¥‡æ•°çº¿ç¨‹ç»„åˆ†åˆ«å¤„ç†</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">even_thread_work</span><span class="p">(</span><span class="n">binary</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">odd_thread_work</span><span class="p">(</span><span class="n">binary</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="624-gpu">6.2.4 å¤šGPUåä½œç»„</h3>
<p>åä½œç»„ä¹Ÿæ”¯æŒå¤šGPUç¼–ç¨‹æ¨¡å‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å¤šGPUç½‘æ ¼ç»„</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">multiGPUKernel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cg</span><span class="o">::</span><span class="n">multi_grid_group</span><span class="w"> </span><span class="n">multi_grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">this_multi_grid</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è·å–å…¨å±€ç½‘æ ¼å¤§å°</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">global_rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">multi_grid</span><span class="p">.</span><span class="n">thread_rank</span><span class="p">();</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">global_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">multi_grid</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// å…¨å±€æ•°æ®åˆ†é…</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">data_per_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total_data</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">global_size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">my_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_rank</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data_per_thread</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å±€éƒ¨è®¡ç®—</span>
<span class="w">    </span><span class="n">local_compute</span><span class="p">(</span><span class="n">my_offset</span><span class="p">,</span><span class="w"> </span><span class="n">data_per_thread</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¤šGPUåŒæ­¥</span>
<span class="w">    </span><span class="n">multi_grid</span><span class="p">.</span><span class="n">sync</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// å…¨å±€å½’çº¦æˆ–äº¤æ¢æ•°æ®</span>
<span class="w">    </span><span class="n">global_reduction</span><span class="p">(</span><span class="n">multi_grid</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="63-warp">6.3 Warpçº§å½’çº¦ä¸æ‰«æç®—æ³•</h2>
<h3 id="631-warp">6.3.1 é«˜æ•ˆwarpçº§å½’çº¦å®ç°</h3>
<p>Warpçº§å½’çº¦æ˜¯å¹¶è¡Œç®—æ³•çš„åŸºç¡€æ„å»ºå—ã€‚åˆ©ç”¨shuffleæŒ‡ä»¤å¯ä»¥å®ç°æ— éœ€å…±äº«å†…å­˜çš„é«˜æ•ˆå½’çº¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸºç¡€warpå½’çº¦ï¼ˆæ±‚å’Œï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">warpReduce</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è¶å½¢å½’çº¦æ¨¡å¼</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__shfl_down_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// é€šç”¨warpå½’çº¦æ¨¡æ¿</span>
<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">typename</span><span class="w"> </span><span class="n">Op</span><span class="o">&gt;</span>
<span class="kt">__device__</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">warpReduceGeneric</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">Op</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">T</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_down_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨åä½œç»„çš„å½’çº¦</span>
<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">Group</span><span class="o">&gt;</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">cgReduce</span><span class="p">(</span><span class="n">Group</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">thread_rank</span><span class="p">();</span>

<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">shfl_down</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å½’çº¦æ‰§è¡Œè¿‡ç¨‹ç¤ºæ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>æ­¥éª¤1 (offset=16): çº¿ç¨‹0-15åˆ†åˆ«ä»çº¿ç¨‹16-31è·å–æ•°æ®ç›¸åŠ 
æ­¥éª¤2 (offset=8):  çº¿ç¨‹0-7åˆ†åˆ«ä»çº¿ç¨‹8-15è·å–æ•°æ®ç›¸åŠ 
æ­¥éª¤3 (offset=4):  çº¿ç¨‹0-3åˆ†åˆ«ä»çº¿ç¨‹4-7è·å–æ•°æ®ç›¸åŠ 
æ­¥éª¤4 (offset=2):  çº¿ç¨‹0-1åˆ†åˆ«ä»çº¿ç¨‹2-3è·å–æ•°æ®ç›¸åŠ 
æ­¥éª¤5 (offset=1):  çº¿ç¨‹0ä»çº¿ç¨‹1è·å–æ•°æ®ç›¸åŠ 
ç»“æœ: çº¿ç¨‹0æŒæœ‰æœ€ç»ˆå½’çº¦ç»“æœ
</code></pre></div>

<h3 id="632">6.3.2 å‰ç¼€å’Œï¼ˆæ‰«æï¼‰ç®—æ³•</h3>
<p>å‰ç¼€å’Œæ˜¯è®¸å¤šå¹¶è¡Œç®—æ³•çš„å…³é”®ç»„ä»¶ï¼Œåœ¨è‡ªåŠ¨é©¾é©¶çš„ç‚¹äº‘å¤„ç†å’Œè·¯å¾„è§„åˆ’ä¸­å¹¿æ³›åº”ç”¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Kogge-Stoneå¹¶è¡Œå‰ç¼€å’Œç®—æ³•</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">warpInclusiveScan</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_up_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lane</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ç‹¬å æ‰«æï¼ˆexclusive scanï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">warpExclusiveScan</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å…ˆè¿›è¡ŒåŒ…å«æ‰«æ</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">warpInclusiveScan</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å·¦ç§»ä¸€ä½ï¼Œç¬¬0ä¸ªçº¿ç¨‹è®¾ä¸º0</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__shfl_up_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">scan</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// åˆ†æ®µæ‰«æï¼ˆsegmented scanï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">segmentedScan</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_up_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_up_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lane</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="633">6.3.3 åˆ†æ®µå½’çº¦ä¸æ‰«æ</h3>
<p>åœ¨å¤„ç†ä¸è§„åˆ™æ•°æ®ï¼ˆå¦‚ç¨€ç–çŸ©é˜µã€å˜é•¿åºåˆ—ï¼‰æ—¶ï¼Œåˆ†æ®µæ“ä½œå°¤ä¸ºé‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åˆ†æ®µå½’çº¦ç¤ºä¾‹ï¼šæ¯ä¸ªæ®µç‹¬ç«‹æ±‚å’Œ</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">SegmentedReduce</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">operator</span><span class="p">()(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">segments</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">seg_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">segments</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ‰¾å‡ºåŒä¸€æ®µçš„æ‰€æœ‰çº¿ç¨‹</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">same_segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__match_any_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">seg_id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åœ¨åŒæ®µå†…è¿›è¡Œå½’çº¦</span>
<span class="w">        </span><span class="n">cg</span><span class="o">::</span><span class="n">coalesced_group</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">labeled_partition</span><span class="p">(</span>
<span class="w">            </span><span class="n">cg</span><span class="o">::</span><span class="n">coalesced_threads</span><span class="p">(),</span><span class="w"> </span><span class="n">seg_id</span><span class="p">);</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cgReduce</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åªæœ‰æ¯æ®µçš„ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿”å›ç»“æœ</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">thread_rank</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="634">6.3.4 æ··åˆç²¾åº¦å½’çº¦ä¼˜åŒ–</h3>
<p>åœ¨æ·±åº¦å­¦ä¹ æ¨ç†ä¸­ï¼Œæ··åˆç²¾åº¦è®¡ç®—å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// FP16åˆ°FP32çš„å½’çº¦</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">mixedPrecisionReduce</span><span class="p">(</span><span class="n">__half2</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å…ˆåœ¨FP16ç²¾åº¦ä¸‹å½’çº¦</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__hadd2</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">__shfl_down_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è½¬æ¢ä¸ºFP32è¿›è¡Œæœ€ç»ˆç´¯åŠ </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__half2float</span><span class="p">(</span><span class="n">__low2half</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">           </span><span class="n">__half2float</span><span class="p">(</span><span class="n">__high2half</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// Kahanæ±‚å’Œç®—æ³•å‡å°‘æ•°å€¼è¯¯å·®</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">kahanWarpReduce</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// è¡¥å¿å€¼</span>

<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_down_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="64-independent-thread-scheduling">6.4 ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦ï¼ˆIndependent Thread Schedulingï¼‰</h2>
<h3 id="641-volta">6.4.1 Voltaæ¶æ„çš„è°ƒåº¦æ”¹è¿›</h3>
<p>ä»Voltaæ¶æ„ï¼ˆCompute Capability 7.0ï¼‰å¼€å§‹ï¼ŒNVIDIAå¼•å…¥äº†ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦ï¼ˆITSï¼‰ï¼Œè¿™æ˜¯CUDAç¼–ç¨‹æ¨¡å‹çš„é‡å¤§æ”¹è¿›ï¼š</p>
<p><strong>ä¼ ç»Ÿè°ƒåº¦æ¨¡å‹ vs ITS</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¼ ç»ŸSIMTï¼ˆPre-Voltaï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Warp: 32çº¿ç¨‹é”æ­¥æ‰§è¡Œ         â”‚
â”‚  å…±äº«PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰          â”‚
â”‚  åˆ†æ”¯å¯¼è‡´ä¸²è¡ŒåŒ–               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦ï¼ˆVolta+ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Warp: 32çº¿ç¨‹ç‹¬ç«‹PCå’Œæ ˆ       â”‚
â”‚  ç»†ç²’åº¦åŒæ­¥æ§åˆ¶               â”‚
â”‚  æ›´å¥½çš„åˆ†æ”¯æ•ˆç‡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>å…³é”®æ”¹è¿›ï¼š</p>
<ol>
<li><strong>æ¯çº¿ç¨‹ç¨‹åºè®¡æ•°å™¨</strong>ï¼šæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„PCå’Œè°ƒç”¨æ ˆ</li>
<li><strong>æ”¶æ•›æ …æ </strong>ï¼šè‡ªåŠ¨æ’å…¥åŒæ­¥ç‚¹ä¿è¯æ­£ç¡®æ€§</li>
<li><strong>æ›´çµæ´»çš„æ‰§è¡Œ</strong>ï¼šçº¿ç¨‹å¯ä»¥ç‹¬ç«‹è¿›åº¦ï¼Œæé«˜ç¡¬ä»¶åˆ©ç”¨ç‡</li>
</ol>
<h3 id="642">6.4.2 çº¿ç¨‹åŒæ­¥è¯­ä¹‰å˜åŒ–</h3>
<p>ITSæ”¹å˜äº†åŒæ­¥è¯­ä¹‰ï¼Œéœ€è¦æ˜¾å¼åŒæ­¥æ¥ä¿è¯warpå†…çº¿ç¨‹çš„æ”¶æ•›ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Pre-Voltaè¡Œä¸ºï¼ˆéšå¼æ”¶æ•›ï¼‰</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">oldBehavior</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆ†æ”¯A</span>
<span class="w">        </span><span class="n">computeA</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆ†æ”¯B</span>
<span class="w">        </span><span class="n">computeB</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// éšå¼æ”¶æ•›ç‚¹ï¼šæ‰€æœ‰çº¿ç¨‹è‡ªåŠ¨åŒæ­¥</span>

<span class="w">    </span><span class="c1">// Warpå†…é€šä¿¡å®‰å…¨</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Volta+è¡Œä¸ºï¼ˆéœ€è¦æ˜¾å¼åŒæ­¥ï¼‰</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">newBehavior</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__activemask</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">computeA</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">computeB</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å¿…é¡»æ˜¾å¼åŒæ­¥æ‰èƒ½ä¿è¯æ”¶æ•›</span>
<span class="w">    </span><span class="n">__syncwarp</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç°åœ¨å¯ä»¥å®‰å…¨è¿›è¡Œwarpå†…é€šä¿¡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="643">6.4.3 æ­»é”é¢„é˜²ç­–ç•¥</h3>
<p>ITSå¯èƒ½å¼•å…¥æ–°çš„æ­»é”åœºæ™¯ï¼Œéœ€è¦carefulè®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ½œåœ¨æ­»é”ç¤ºä¾‹</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">deadlockExample</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// çº¿ç¨‹0ç­‰å¾…å…¶ä»–çº¿ç¨‹</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">doWork</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å…¶ä»–çº¿ç¨‹è®¾ç½®flag</span>
<span class="w">        </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">__syncwarp</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ­»é”ï¼çº¿ç¨‹0æœªåˆ°è¾¾åŒæ­¥ç‚¹</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®çš„å®ç°</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correctImplementation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__activemask</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨åä½œç»„é¿å…æ­»é”</span>
<span class="w">        </span><span class="n">cg</span><span class="o">::</span><span class="n">coalesced_group</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">coalesced_threads</span><span class="p">();</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å…è®¸å…¶ä»–çº¿ç¨‹æ‰§è¡Œ</span>
<span class="w">            </span><span class="n">__nanosleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">doWork</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ä»…åŒæ­¥å‚ä¸çš„çº¿ç¨‹</span>
<span class="w">        </span><span class="n">__syncwarp</span><span class="p">(</span><span class="n">active</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ’é™¤çº¿ç¨‹0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="644">6.4.4 æ€§èƒ½å½±å“ä¸ä¼˜åŒ–</h3>
<p>ITSå¯¹æ€§èƒ½çš„å½±å“éœ€è¦case-by-caseåˆ†æï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åˆ©ç”¨ITSä¼˜åŒ–çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</span>
<span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">PRODUCER_MASK</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">producerConsumer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">lane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">lane</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PRODUCER_MASK</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ready_flags</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_producer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç”Ÿäº§è€…ç‹¬ç«‹æ‰§è¡Œ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ITEMS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">produce_data</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">            </span><span class="n">buffer</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">            </span><span class="nf">__threadfence_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ready_flags</span><span class="p">[</span><span class="n">lane</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// ç»§ç»­ç”Ÿäº§ï¼Œæ— éœ€ç­‰å¾…æ¶ˆè´¹</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ¶ˆè´¹è€…ç‹¬ç«‹æ‰§è¡Œ</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">producer_lane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_producer</span><span class="p">(</span><span class="n">lane</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ITEMS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ç­‰å¾…æ•°æ®å°±ç»ª</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ready_flags</span><span class="p">[</span><span class="n">producer_lane</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">producer_lane</span><span class="p">];</span>
<span class="w">            </span><span class="n">consume_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ€§èƒ½ç›‘æµ‹ä¸åˆ†æ</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">performanceAnalysis</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æµ‹é‡åˆ†æ”¯åˆ†æ­§æˆæœ¬</span>
<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¥‡æ•°çº¿ç¨‹è·¯å¾„</span>
<span class="w">        </span><span class="n">expensive_path_a</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¶æ•°çº¿ç¨‹è·¯å¾„</span>
<span class="w">        </span><span class="n">expensive_path_b</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">__syncwarp</span><span class="p">();</span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è®°å½•æ‰§è¡Œæ—¶é—´ç”¨äºåˆ†æ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">divergence_cost</span><span class="p">[</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä¼˜åŒ–å»ºè®®</strong>ï¼š</p>
<ol>
<li><strong>æœ€å°åŒ–åˆ†æ”¯åˆ†æ­§</strong>ï¼šå°½ç®¡ITSæ”¹å–„äº†åˆ†æ”¯æ•ˆç‡ï¼Œç»Ÿä¸€çš„æ§åˆ¶æµä»ç„¶æœ€ä¼˜</li>
<li><strong>æ˜¾å¼åŒæ­¥</strong>ï¼šåœ¨éœ€è¦warpæ”¶æ•›çš„åœ°æ–¹ä½¿ç”¨<code>__syncwarp()</code></li>
<li><strong>åˆ©ç”¨ç‹¬ç«‹è¿›åº¦</strong>ï¼šè®¾è®¡ç®—æ³•å…è®¸çº¿ç¨‹ç‹¬ç«‹å‰è¿›</li>
<li><strong>ä½¿ç”¨åä½œç»„</strong>ï¼šæä¾›æ›´æ¸…æ™°çš„åŒæ­¥è¯­ä¹‰</li>
</ol>
<h2 id="65">6.5 æ¡ˆä¾‹ï¼šæ— é”æ•°æ®ç»“æ„å®ç°</h2>
<h3 id="651">6.5.1 æ— é”é˜Ÿåˆ—è®¾è®¡</h3>
<p>æ— é”æ•°æ®ç»“æ„åœ¨è‡ªåŠ¨é©¾é©¶çš„å®æ—¶ç³»ç»Ÿä¸­è‡³å…³é‡è¦ï¼Œå¯ä»¥é¿å…ä¼ ç»Ÿé”å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„æ— é”FIFOé˜Ÿåˆ—ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ— é”é˜Ÿåˆ—èŠ‚ç‚¹</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç´¢å¼•</span>
<span class="p">};</span>

<span class="c1">// æ— é”FIFOé˜Ÿåˆ—</span>
<span class="n">class</span><span class="w"> </span><span class="n">LockFreeQueue</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span><span class="w">          </span><span class="c1">// èŠ‚ç‚¹æ± </span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">free_list</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç©ºé—²èŠ‚ç‚¹åˆ—è¡¨</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w">            </span><span class="c1">// é˜Ÿåˆ—å¤´ç´¢å¼•</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span><span class="w">            </span><span class="c1">// é˜Ÿåˆ—å°¾ç´¢å¼•</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">free_head</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç©ºé—²åˆ—è¡¨å¤´</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span>

<span class="n">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cap</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// åˆå§‹åŒ–ç©ºé—²åˆ—è¡¨</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">nodes</span><span class="p">[</span><span class="n">capacity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">        </span><span class="n">free_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">allocate_node</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">old_head</span><span class="p">,</span><span class="w"> </span><span class="n">new_head</span><span class="p">;</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_head</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_head</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ²¡æœ‰ç©ºé—²èŠ‚ç‚¹</span>

<span class="w">            </span><span class="n">new_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">old_head</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_head</span><span class="p">,</span><span class="w"> </span><span class="n">old_head</span><span class="p">,</span><span class="w"> </span><span class="n">new_head</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old_head</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">old_head</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">free_node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">old_head</span><span class="p">;</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_head</span><span class="p">;</span>
<span class="w">            </span><span class="n">nodes</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_head</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free_head</span><span class="p">,</span><span class="w"> </span><span class="n">old_head</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old_head</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enqueue</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">node_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocate_node</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node_idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">        </span><span class="n">nodes</span><span class="p">[</span><span class="n">node_idx</span><span class="p">].</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">nodes</span><span class="p">[</span><span class="n">node_idx</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">old_tail</span><span class="p">;</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_tail</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// é˜Ÿåˆ—ä¸ºç©ºï¼ŒCASæ›´æ–°headå’Œtail</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">node_idx</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_idx</span><span class="p">;</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nodes</span><span class="p">[</span><span class="n">old_tail</span><span class="p">].</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">node_idx</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ›´æ–°tailæŒ‡é’ˆ</span>
<span class="w">        </span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span><span class="w"> </span><span class="n">old_tail</span><span class="p">,</span><span class="w"> </span><span class="n">node_idx</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">dequeue</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">old_head</span><span class="p">,</span><span class="w"> </span><span class="n">new_head</span><span class="p">;</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_head</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// é˜Ÿåˆ—ä¸ºç©º</span>

<span class="w">            </span><span class="n">new_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">old_head</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">old_head</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">old_head</span><span class="p">,</span><span class="w"> </span><span class="n">new_head</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old_head</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¦‚æœé˜Ÿåˆ—å˜ç©ºï¼Œæ›´æ–°tail</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_head</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span><span class="w"> </span><span class="n">old_head</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">free_node</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="652">6.5.2 åŸå­æ“ä½œä¸å†…å­˜åº</h3>
<p>CUDAæä¾›äº†ä¸°å¯Œçš„åŸå­æ“ä½œå’Œå†…å­˜åºä¿è¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å†…å­˜æ …æ ç¡®ä¿æ­£ç¡®çš„å†…å­˜åº</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">memory_ordering_example</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç”Ÿäº§è€…</span>
<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_value</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ç¡®ä¿dataå†™å…¥å¯¹å…¶ä»–çº¿ç¨‹å¯è§</span>
<span class="w">        </span><span class="nf">__threadfence_block</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// è®¾ç½®æ ‡å¿—</span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ¶ˆè´¹è€…</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…æ ‡å¿—</span>

<span class="w">        </span><span class="c1">// ç¡®ä¿è¯»å–æœ€æ–°çš„dataå€¼</span>
<span class="w">        </span><span class="nf">__threadfence_block</span><span class="p">();</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">        </span><span class="n">process</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨åŸå­æ“ä½œå®ç°è‡ªæ—‹é”</span>
<span class="n">class</span><span class="w"> </span><span class="n">SpinLock</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>

<span class="n">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">acquire</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é€€é¿ç­–ç•¥å‡å°‘ç«äº‰</span>
<span class="w">            </span><span class="n">__nanosleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">__threadfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// è·å–é”åçš„å†…å­˜æ …æ </span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">release</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nf">__threadfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// é‡Šæ”¾é”å‰çš„å†…å­˜æ …æ </span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="653-aba">6.5.3 ABAé—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
<p>ABAé—®é¢˜æ˜¯æ— é”ç¼–ç¨‹çš„ç»å…¸é—®é¢˜ï¼Œéœ€è¦ä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ ‡è®°æŒ‡é’ˆè§£å†³ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ç‰ˆæœ¬å·è§£å†³ABAé—®é¢˜</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">VersionedPointer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w">     </span><span class="c1">// 16ä½ç´¢å¼•</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">   </span><span class="c1">// 16ä½ç‰ˆæœ¬å·</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="nf">VersionedPointer</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">version</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="nf">VersionedPointer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ver</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span><span class="w"> </span><span class="n">version</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pack</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span><span class="n">version</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">VersionedPointer</span><span class="w"> </span><span class="n">unpack</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">VersionedPointer</span><span class="p">(</span>
<span class="w">            </span><span class="n">packed</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">,</span>
<span class="w">            </span><span class="n">packed</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="n">class</span><span class="w"> </span><span class="n">ABAFreeStack</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">top_packed</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ‰“åŒ…çš„é¡¶éƒ¨æŒ‡é’ˆï¼ˆç´¢å¼•+ç‰ˆæœ¬ï¼‰</span>

<span class="n">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">push</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">node_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocate_node</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node_idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">        </span><span class="n">nodes</span><span class="p">[</span><span class="n">node_idx</span><span class="p">].</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">old_packed</span><span class="p">,</span><span class="w"> </span><span class="n">new_packed</span><span class="p">;</span>
<span class="w">        </span><span class="n">VersionedPointer</span><span class="w"> </span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">new_top</span><span class="p">;</span>

<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_packed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_packed</span><span class="p">;</span>
<span class="w">            </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VersionedPointer</span><span class="o">::</span><span class="n">unpack</span><span class="p">(</span><span class="n">old_packed</span><span class="p">);</span>

<span class="w">            </span><span class="n">nodes</span><span class="p">[</span><span class="n">node_idx</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>

<span class="w">            </span><span class="n">new_top</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_idx</span><span class="p">;</span>
<span class="w">            </span><span class="n">new_top</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¢åŠ ç‰ˆæœ¬å·</span>
<span class="w">            </span><span class="n">new_packed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_top</span><span class="p">.</span><span class="n">pack</span><span class="p">();</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top_packed</span><span class="p">,</span><span class="w"> </span><span class="n">old_packed</span><span class="p">,</span><span class="w"> </span><span class="n">new_packed</span><span class="p">)</span><span class="w"> </span>
<span class="w">                 </span><span class="o">!=</span><span class="w"> </span><span class="n">old_packed</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">pop</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">old_packed</span><span class="p">,</span><span class="w"> </span><span class="n">new_packed</span><span class="p">;</span>
<span class="w">        </span><span class="n">VersionedPointer</span><span class="w"> </span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">new_top</span><span class="p">;</span>

<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_packed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_packed</span><span class="p">;</span>
<span class="w">            </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VersionedPointer</span><span class="o">::</span><span class="n">unpack</span><span class="p">(</span><span class="n">old_packed</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_top</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ ˆç©º</span>

<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">old_top</span><span class="p">.</span><span class="n">index</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>

<span class="w">            </span><span class="n">new_top</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">old_top</span><span class="p">.</span><span class="n">index</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
<span class="w">            </span><span class="n">new_top</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¢åŠ ç‰ˆæœ¬å·</span>
<span class="w">            </span><span class="n">new_packed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_top</span><span class="p">.</span><span class="n">pack</span><span class="p">();</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top_packed</span><span class="p">,</span><span class="w"> </span><span class="n">old_packed</span><span class="p">,</span><span class="w"> </span><span class="n">new_packed</span><span class="p">)</span><span class="w"> </span>
<span class="w">                 </span><span class="o">!=</span><span class="w"> </span><span class="n">old_packed</span><span class="p">);</span>

<span class="w">        </span><span class="n">free_node</span><span class="p">(</span><span class="n">old_top</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="654">6.5.4 æ€§èƒ½æµ‹è¯•ä¸å¯¹æ¯”</h3>
<p>å®é™…åº”ç”¨ä¸­çš„æ€§èƒ½æµ‹è¯•æ¡†æ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ€§èƒ½æµ‹è¯•å†…æ ¸</span>
<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">DataStructure</span><span class="o">&gt;</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">performance_test</span><span class="p">(</span>
<span class="w">    </span><span class="n">DataStructure</span><span class="o">*</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">timings</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num_ops</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">num_ops</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operations</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å†™æ“ä½œ</span>
<span class="w">        </span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">enqueue</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è¯»æ“ä½œ</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">dequeue</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>
<span class="w">    </span><span class="n">timings</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// å¯¹æ¯”æµ‹è¯•ï¼šæ— é” vs æœ‰é”</span>
<span class="kt">void</span><span class="w"> </span><span class="n">benchmark</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NUM_OPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">THREADS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">BLOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">NUM_OPS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">THREADS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">THREADS</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æµ‹è¯•æ— é”é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">LockFreeQueue</span><span class="o">*</span><span class="w"> </span><span class="n">lf_queue</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lf_queue</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">LockFreeQueue</span><span class="p">));</span>

<span class="w">    </span><span class="n">performance_test</span><span class="o">&lt;&lt;&lt;</span><span class="n">BLOCKS</span><span class="p">,</span><span class="w"> </span><span class="n">THREADS</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">        </span><span class="n">lf_queue</span><span class="p">,</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">timings_lockfree</span><span class="p">,</span><span class="w"> </span><span class="n">NUM_OPS</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æµ‹è¯•æœ‰é”é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">LockedQueue</span><span class="o">*</span><span class="w"> </span><span class="n">locked_queue</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked_queue</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">LockedQueue</span><span class="p">));</span>

<span class="w">    </span><span class="n">performance_test</span><span class="o">&lt;&lt;&lt;</span><span class="n">BLOCKS</span><span class="p">,</span><span class="w"> </span><span class="n">THREADS</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">        </span><span class="n">locked_queue</span><span class="p">,</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">timings_locked</span><span class="p">,</span><span class="w"> </span><span class="n">NUM_OPS</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åˆ†æç»“æœ</span>
<span class="w">    </span><span class="n">analyze_performance</span><span class="p">(</span><span class="n">timings_lockfree</span><span class="p">,</span><span class="w"> </span><span class="n">timings_locked</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†CUDAç¼–ç¨‹ä¸­çš„warpçº§ç¼–ç¨‹æŠ€æœ¯å’Œåä½œç»„æœºåˆ¶ï¼Œè¿™äº›æ˜¯å®ç°é«˜æ€§èƒ½GPUç¨‹åºçš„å…³é”®æŠ€æœ¯ã€‚æˆ‘ä»¬å­¦ä¹ äº†ï¼š</p>
<h3 id="_2">æ ¸å¿ƒæ¦‚å¿µå›é¡¾</h3>
<ol>
<li>
<p><strong>Warpå†…åœ¨å‡½æ•°</strong>
   - ShuffleæŒ‡ä»¤æ—å®ç°å¯„å­˜å™¨çº§æ•°æ®äº¤æ¢ï¼Œå»¶è¿Ÿä»…1ä¸ªæ—¶é’Ÿå‘¨æœŸ
   - VoteæŒ‡ä»¤ç”¨äºwarpå†…æ¡ä»¶æ£€æŸ¥å’Œåˆ†æ”¯ä¼˜åŒ–
   - MatchæŒ‡ä»¤æ”¯æŒåŠ¨æ€åˆ†ç»„åä½œ
   - å…³é”®ä¼˜åŠ¿ï¼šé¿å…å…±äº«å†…å­˜è®¿é—®ï¼Œå‡å°‘åŒæ­¥å¼€é”€</p>
</li>
<li>
<p><strong>åä½œç»„ç¼–ç¨‹æ¨¡å‹</strong>
   - æä¾›ä»å•çº¿ç¨‹åˆ°æ•´ä¸ªç½‘æ ¼çš„çµæ´»çº¿ç¨‹ç»„ç»‡æŠ½è±¡
   - æ”¯æŒåŠ¨æ€åˆ†åŒºå’Œé‡ç»„ï¼Œé€‚åº”ä¸è§„åˆ™å¹¶è¡Œæ¨¡å¼
   - ç½‘æ ¼çº§åŒæ­¥å®ç°è·¨çº¿ç¨‹å—åä½œ
   - å¤šGPUåä½œç»„æ‰©å±•åˆ°åˆ†å¸ƒå¼è®¡ç®—</p>
</li>
<li>
<p><strong>Warpçº§ç®—æ³•ä¼˜åŒ–</strong>
   - å½’çº¦ç®—æ³•ï¼šO(log N)å¤æ‚åº¦ï¼Œæ— éœ€å…±äº«å†…å­˜
   - æ‰«æç®—æ³•ï¼šKogge-Stoneå¹¶è¡Œå‰ç¼€å’Œ
   - åˆ†æ®µæ“ä½œï¼šå¤„ç†å˜é•¿å’Œä¸è§„åˆ™æ•°æ®
   - æ··åˆç²¾åº¦ï¼šFP16è®¡ç®— + FP32ç´¯åŠ </p>
</li>
<li>
<p><strong>ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦ï¼ˆITSï¼‰</strong>
   - Voltaæ¶æ„å¼•å…¥çš„é‡å¤§æ”¹è¿›
   - æ¯çº¿ç¨‹ç‹¬ç«‹PCå’Œè°ƒç”¨æ ˆ
   - éœ€è¦æ˜¾å¼åŒæ­¥ä¿è¯warpæ”¶æ•›
   - æä¾›æ›´å¥½çš„åˆ†æ”¯æ•ˆç‡å’Œç¡¬ä»¶åˆ©ç”¨ç‡</p>
</li>
<li>
<p><strong>æ— é”æ•°æ®ç»“æ„</strong>
   - åŸå­æ“ä½œå®ç°çº¿ç¨‹å®‰å…¨
   - ç‰ˆæœ¬å·è§£å†³ABAé—®é¢˜
   - å†…å­˜æ …æ ä¿è¯æ­£ç¡®çš„å†…å­˜åº
   - æ€§èƒ½ä¼˜åŠ¿ï¼šé¿å…é”ç«äº‰ï¼Œæé«˜å¹¶å‘åº¦</p>
</li>
</ol>
<h3 id="_3">å…³é”®å…¬å¼ä¸æ€§èƒ½æŒ‡æ ‡</h3>
<p><strong>Warpçº§å½’çº¦å¤æ‚åº¦</strong>ï¼š</p>
<ul>
<li>æ—¶é—´å¤æ‚åº¦ï¼šO(logâ‚‚ 32) = O(5)</li>
<li>ç©ºé—´å¤æ‚åº¦ï¼šO(1)ï¼ˆä»…ä½¿ç”¨å¯„å­˜å™¨ï¼‰</li>
</ul>
<p><strong>ShuffleæŒ‡ä»¤ååé‡</strong>ï¼š</p>
<ul>
<li>å»¶è¿Ÿï¼š1ä¸ªæ—¶é’Ÿå‘¨æœŸ</li>
<li>ååé‡ï¼šæ¯SMæ¯å‘¨æœŸ32ä¸ªshuffleæ“ä½œ</li>
</ul>
<p><strong>åä½œç»„åŒæ­¥å¼€é”€</strong>ï¼š</p>
<ul>
<li>çº¿ç¨‹å—åŒæ­¥ï¼š~10ä¸ªæ—¶é’Ÿå‘¨æœŸ</li>
<li>ç½‘æ ¼çº§åŒæ­¥ï¼š~100ä¸ªæ—¶é’Ÿå‘¨æœŸ</li>
<li>WarpåŒæ­¥ï¼š1-2ä¸ªæ—¶é’Ÿå‘¨æœŸ</li>
</ul>
<p><strong>æ— é”vsæœ‰é”æ€§èƒ½å¯¹æ¯”</strong>ï¼ˆå…¸å‹åœºæ™¯ï¼‰ï¼š</p>
<ul>
<li>ä½ç«äº‰ï¼šæ— é”å¿«2-3å€</li>
<li>é«˜ç«äº‰ï¼šæ— é”å¿«5-10å€</li>
<li>å†…å­˜å¼€é”€ï¼šæ— é”éœ€è¦é¢å¤–ç‰ˆæœ¬å·å­˜å‚¨</li>
</ul>
<h3 id="_4">å®è·µè¦ç‚¹</h3>
<ol>
<li><strong>ä¼˜å…ˆä½¿ç”¨warpåŸè¯­</strong>ï¼šæ¯”å…±äº«å†…å­˜æ›´å¿«</li>
<li><strong>æ˜¾å¼åŒæ­¥</strong>ï¼šITSæ¶æ„éœ€è¦æ˜ç¡®çš„åŒæ­¥ç‚¹</li>
<li><strong>é¿å…åˆ†æ”¯åˆ†æ­§</strong>ï¼šç»Ÿä¸€çš„æ§åˆ¶æµä»æ˜¯æœ€ä¼˜é€‰æ‹©</li>
<li><strong>é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„</strong>ï¼šæ ¹æ®ç«äº‰ç¨‹åº¦é€‰æ‹©æœ‰é”/æ— é”å®ç°</li>
<li><strong>æµ‹è¯•éªŒè¯</strong>ï¼šæ— é”ç®—æ³•éœ€è¦å……åˆ†çš„æ­£ç¡®æ€§æµ‹è¯•</li>
</ol>
<h2 id="_5">ç»ƒä¹ é¢˜</h2>
<h3 id="_6">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  6.1ï¼šWarpçº§æ±‚å’Œ</strong>
å®ç°ä¸€ä¸ªä½¿ç”¨shuffleæŒ‡ä»¤çš„warpçº§æµ®ç‚¹æ•°ç»„æ±‚å’Œå‡½æ•°ï¼Œè¦æ±‚æ”¯æŒä»»æ„é•¿åº¦ï¼ˆä¸ä»…ä»…æ˜¯32çš„å€æ•°ï¼‰ã€‚</p>
<p><em>æç¤ºï¼šè€ƒè™‘å¦‚ä½•å¤„ç†ä¸å®Œæ•´çš„warpå’Œæ•°ç»„è¾¹ç•Œæ¡ä»¶ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>éœ€è¦è€ƒè™‘ä¸‰ä¸ªå…³é”®ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨shuffle_downè¿›è¡Œè¶å½¢å½’çº¦</li>
<li>å¤„ç†æ•°ç»„é•¿åº¦ä¸æ˜¯32å€æ•°çš„æƒ…å†µ</li>
<li>å¤šä¸ªwarpçš„ç»“æœéœ€è¦é€šè¿‡å…±äº«å†…å­˜æˆ–åŸå­æ“ä½œåˆå¹¶</li>
</ol>
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ul>
<li>æ¯ä¸ªçº¿ç¨‹åŠ è½½ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li>
<li>warpå†…ä½¿ç”¨shuffleå½’çº¦</li>
<li>warp 0çš„çº¿ç¨‹0æ”¶é›†æœ€ç»ˆç»“æœ</li>
<li>è€ƒè™‘ä½¿ç”¨Kahanæ±‚å’Œå‡å°‘æµ®ç‚¹è¯¯å·®</li>
</ul>
</details>
<p><strong>ç»ƒä¹  6.2ï¼šåä½œç»„åˆ†åŒº</strong>
ä½¿ç”¨åä½œç»„APIå®ç°ä¸€ä¸ªå‡½æ•°ï¼Œå°†çº¿ç¨‹å—åŠ¨æ€åˆ†æˆ4ä¸ªç»„ï¼Œæ¯ç»„ç‹¬ç«‹è®¡ç®—å…¶è´Ÿè´£æ•°æ®çš„æœ€å¤§å€¼ã€‚</p>
<p><em>æç¤ºï¼šä½¿ç”¨tiled_partitionåˆ›å»ºå›ºå®šå¤§å°çš„åˆ†åŒºã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å…³é”®å®ç°è¦ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨<code>tiled_partition&lt;8&gt;</code>åˆ›å»º8çº¿ç¨‹çš„tilesï¼ˆå‡è®¾32çº¿ç¨‹çš„warpï¼‰</li>
<li>æ¯ä¸ªtileç‹¬ç«‹è¿›è¡Œæœ€å¤§å€¼å½’çº¦</li>
<li>ä½¿ç”¨<code>tile.shfl</code>è¿›è¡Œtileå†…é€šä¿¡</li>
<li>æœ€ååˆå¹¶4ä¸ªç»„çš„ç»“æœ</li>
</ol>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>ç¡®ä¿çº¿ç¨‹å—å¤§å°æ˜¯åˆ†åŒºå¤§å°çš„å€æ•°</li>
<li>æ­£ç¡®å¤„ç†tileè¾¹ç•Œ</li>
<li>ä½¿ç”¨tile.sync()è¿›è¡ŒåŒæ­¥</li>
</ul>
</details>
<p><strong>ç»ƒä¹  6.3ï¼šVoteæŒ‡ä»¤ä¼˜åŒ–</strong>
ç»™å®šä¸€ä¸ªæ¡ä»¶åˆ¤æ–­å‡½æ•°ï¼Œä½¿ç”¨voteæŒ‡ä»¤ä¼˜åŒ–åˆ†æ”¯æ‰§è¡Œï¼Œå‡å°‘warpåˆ†æ­§ã€‚</p>
<p><em>æç¤ºï¼šä½¿ç”¨__ballot_syncæ”¶é›†æ‰€æœ‰çº¿ç¨‹çš„æ¡ä»¶ç»“æœã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ol>
<li>ä½¿ç”¨<code>__ballot_sync</code>è·å–æ‰€æœ‰çº¿ç¨‹çš„æ¡ä»¶æ©ç </li>
<li>æ ¹æ®æ©ç åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çº¿ç¨‹éƒ½èµ°åŒä¸€åˆ†æ”¯</li>
<li>å¦‚æœç»Ÿä¸€ï¼Œåˆ™é¿å…åˆ†æ”¯ï¼›å¦‚æœåˆ†æ­§ï¼Œåˆ™æ­£å¸¸æ‰§è¡Œ</li>
<li>ä½¿ç”¨<code>__popc</code>è®¡ç®—æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹æ•°</li>
</ol>
<p>æ€§èƒ½æå‡ï¼š</p>
<ul>
<li>å®Œå…¨ç»Ÿä¸€çš„åˆ†æ”¯ï¼šé¿å…åˆ†æ­§å¼€é”€</li>
<li>éƒ¨åˆ†åˆ†æ­§ï¼šå¯ä»¥æå‰çŸ¥é“æ´»è·ƒçº¿ç¨‹æ•°</li>
</ul>
</details>
<p><strong>ç»ƒä¹  6.4ï¼šç®€å•æ— é”æ ˆ</strong>
å®ç°ä¸€ä¸ªåŸºç¡€çš„æ— é”æ ˆï¼Œæ”¯æŒpushå’Œpopæ“ä½œï¼Œä¸éœ€è¦å¤„ç†ABAé—®é¢˜ã€‚</p>
<p><em>æç¤ºï¼šä½¿ç”¨atomicCASæ“ä½œæ ˆé¡¶æŒ‡é’ˆã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å®ç°è¦ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨å•ä¸ªæ•´æ•°ä½œä¸ºæ ˆé¡¶ç´¢å¼•</li>
<li>pushï¼šCASæ›´æ–°æ ˆé¡¶ï¼Œæ–°èŠ‚ç‚¹æŒ‡å‘æ—§æ ˆé¡¶</li>
<li>popï¼šCASæ›´æ–°æ ˆé¡¶ä¸ºnextèŠ‚ç‚¹</li>
<li>ä½¿ç”¨é¢„åˆ†é…çš„èŠ‚ç‚¹æ± é¿å…åŠ¨æ€å†…å­˜åˆ†é…</li>
</ol>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>è¿™ä¸ªç®€å•ç‰ˆæœ¬å­˜åœ¨ABAé—®é¢˜</li>
<li>é€‚ç”¨äºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ•°é‡å›ºå®šçš„åœºæ™¯</li>
<li>éœ€è¦å¤„ç†ç©ºæ ˆå’Œæ»¡æ ˆæƒ…å†µ</li>
</ul>
</details>
<h3 id="_7">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  6.5ï¼šé«˜æ•ˆå‰ç¼€å’Œ</strong>
å®ç°ä¸€ä¸ªå¤„ç†å¤§æ•°ç»„ï¼ˆç™¾ä¸‡çº§å…ƒç´ ï¼‰çš„å¹¶è¡Œå‰ç¼€å’Œç®—æ³•ï¼Œè¦æ±‚ï¼š</p>
<ul>
<li>ä½¿ç”¨warpçº§åŸè¯­ä¼˜åŒ–</li>
<li>æ”¯æŒåˆ†æ®µæ‰«æï¼ˆç»™å®šæ®µè¾¹ç•Œæ•°ç»„ï¼‰</li>
<li>è¾¾åˆ°æ¥è¿‘å†…å­˜å¸¦å®½çš„æ€§èƒ½</li>
</ul>
<p><em>æç¤ºï¼šç»“åˆwarpçº§æ‰«æã€å…±äº«å†…å­˜å’Œå¤šçº§å½’çº¦ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>ä¸‰çº§æ‰«ææ¶æ„ï¼š</p>
<ol>
<li><strong>Warpçº§</strong>ï¼šæ¯ä¸ªwarpå¤„ç†32ä¸ªå…ƒç´ ï¼Œä½¿ç”¨shuffle</li>
<li><strong>Blockçº§</strong>ï¼šwarpç»“æœå­˜å…¥å…±äº«å†…å­˜ï¼Œè¿›è¡Œblockçº§æ‰«æ</li>
<li><strong>Gridçº§</strong>ï¼šblockç»“æœå­˜å…¥å…¨å±€å†…å­˜ï¼Œé€’å½’æˆ–å•ç‹¬kernelå¤„ç†</li>
</ol>
<p>åˆ†æ®µæ‰«æå¤„ç†ï¼š</p>
<ul>
<li>æ®µè¾¹ç•Œä½œä¸ºæ‰«æé‡ç½®ç‚¹</li>
<li>ä½¿ç”¨æ ‡å¿—æ•°ç»„æ ‡è®°æ®µèµ·å§‹</li>
<li>warpå†…ä½¿ç”¨æ¡ä»¶shuffleå¤„ç†æ®µè¾¹ç•Œ</li>
</ul>
<p>ä¼˜åŒ–æŠ€å·§ï¼š</p>
<ul>
<li>å‘é‡åŒ–åŠ è½½ï¼ˆfloat4ï¼‰æé«˜å¸¦å®½åˆ©ç”¨</li>
<li>åŒç¼“å†²éšè—å†…å­˜å»¶è¿Ÿ</li>
<li>ä½¿ç”¨__ldgè¿›è¡Œåªè¯»ç¼“å­˜</li>
</ul>
</details>
<p><strong>ç»ƒä¹  6.6ï¼šåŠ¨æ€ä»»åŠ¡è°ƒåº¦å™¨</strong>
è®¾è®¡ä¸€ä¸ªåŸºäºåä½œç»„çš„åŠ¨æ€ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæ”¯æŒï¼š</p>
<ul>
<li>ä»»åŠ¡åŠ¨æ€ç”Ÿæˆå’Œæ¶ˆè´¹</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>ä¼˜å…ˆçº§é˜Ÿåˆ—</li>
</ul>
<p><em>æç¤ºï¼šç»“åˆæ— é”é˜Ÿåˆ—å’Œåä½œç»„åŠ¨æ€åˆ†åŒºã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>æ¶æ„è®¾è®¡ï¼š</p>
<ol>
<li><strong>ä»»åŠ¡æ± </strong>ï¼šå¤šä¸ªä¼˜å…ˆçº§çš„æ— é”é˜Ÿåˆ—</li>
<li><strong>å·¥ä½œçªƒå–</strong>ï¼šç©ºé—²çº¿ç¨‹ç»„ä»å…¶ä»–ç»„çªƒå–ä»»åŠ¡</li>
<li><strong>åŠ¨æ€åˆ†ç»„</strong>ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹åŠ¨æ€é‡ç»„åä½œç»„</li>
</ol>
<p>å…³é”®æŠ€æœ¯ï¼š</p>
<ul>
<li>ä½¿ç”¨matchæŒ‡ä»¤è¯†åˆ«ç›¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡</li>
<li>labeled_partitionåˆ›å»ºä»»åŠ¡æ‰§è¡Œç»„</li>
<li>åŸå­æ“ä½œç®¡ç†ä»»åŠ¡è®¡æ•°å™¨</li>
<li>æŒ‡æ•°é€€é¿å‡å°‘ç«äº‰</li>
</ul>
<p>æ€§èƒ½è€ƒè™‘ï¼š</p>
<ul>
<li>æ‰¹é‡è·å–ä»»åŠ¡å‡å°‘åŸå­æ“ä½œ</li>
<li>å±€éƒ¨ä»»åŠ¡ç¼“å­˜å‡å°‘å…¨å±€è®¿é—®</li>
<li>è‡ªé€‚åº”åˆ†ç»„å¤§å°</li>
</ul>
</details>
<p><strong>ç»ƒä¹  6.7ï¼šæ— é”å“ˆå¸Œè¡¨</strong>
å®ç°ä¸€ä¸ªGPUä¸Šçš„é«˜æ€§èƒ½æ— é”å“ˆå¸Œè¡¨ï¼Œè¦æ±‚ï¼š</p>
<ul>
<li>æ”¯æŒå¹¶å‘æ’å…¥ã€æŸ¥æ‰¾å’Œåˆ é™¤</li>
<li>å¤„ç†å“ˆå¸Œå†²çª</li>
<li>è§£å†³ABAé—®é¢˜</li>
</ul>
<p><em>æç¤ºï¼šä½¿ç”¨å¼€æ”¾å¯»å€æ³•å’Œç‰ˆæœ¬å·æŠ€æœ¯ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>è®¾è®¡è¦ç‚¹ï¼š</p>
<ol>
<li><strong>å¼€æ”¾å¯»å€</strong>ï¼šçº¿æ€§æ¢æµ‹æˆ–äºŒæ¬¡æ¢æµ‹</li>
<li><strong>æ§½ä½çŠ¶æ€</strong>ï¼šç©ºé—²ã€å ç”¨ã€å·²åˆ é™¤ï¼ˆå¢“ç¢‘ï¼‰</li>
<li><strong>ç‰ˆæœ¬å·</strong>ï¼šæ¯ä¸ªæ§½ä½åŒ…å«ç‰ˆæœ¬å·é˜²æ­¢ABA</li>
</ol>
<p>å¹¶å‘æ§åˆ¶ï¼š</p>
<ul>
<li>CASæ“ä½œæ›´æ–°æ§½ä½</li>
<li>ç‰ˆæœ¬å·ä¸é”®å€¼æ‰“åŒ…æˆ64/128ä½</li>
<li>åˆ é™¤ä½¿ç”¨å¢“ç¢‘æ ‡è®°ï¼Œå»¶è¿Ÿå›æ”¶</li>
</ul>
<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ul>
<li>SIMDå¹¶è¡Œæ¢æµ‹å¤šä¸ªæ§½ä½</li>
<li>ä½¿ç”¨__match_any_syncæ‰¾ç›¸åŒé”®çš„çº¿ç¨‹</li>
<li>å±€éƒ¨é‡å“ˆå¸Œå‡å°‘å†²çª</li>
<li>åˆ†æ®µé”é™ä½ç«äº‰ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰</li>
</ul>
</details>
<p><strong>ç»ƒä¹  6.8ï¼šè‡ªåŠ¨é©¾é©¶åœºæ™¯ - ç‚¹äº‘å¹¶è¡Œèšç±»</strong>
å®ç°ä¸€ä¸ªåŸºäºDBSCANçš„å¹¶è¡Œç‚¹äº‘èšç±»ç®—æ³•ï¼Œç”¨äºè‡ªåŠ¨é©¾é©¶ä¸­çš„éšœç¢ç‰©æ£€æµ‹ï¼š</p>
<ul>
<li>è¾“å…¥ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘ï¼ˆ10ä¸‡ç‚¹ï¼‰</li>
<li>ä½¿ç”¨warpçº§åŸè¯­åŠ é€Ÿé‚»åŸŸæœç´¢</li>
<li>æ”¯æŒåŠ¨æ€ç°‡åˆå¹¶</li>
</ul>
<p><em>æç¤ºï¼šç»“åˆç©ºé—´å“ˆå¸Œã€warpçº§å½’çº¦å’Œæ— é”å¹¶æŸ¥é›†ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>ç®—æ³•æµç¨‹ï¼š</p>
<ol>
<li><strong>ç©ºé—´åˆ’åˆ†</strong>ï¼šæ„å»º3Dç½‘æ ¼å“ˆå¸Œ</li>
<li><strong>é‚»åŸŸæœç´¢</strong>ï¼šwarpåä½œæœç´¢é‚»è¿‘ä½“ç´ </li>
<li><strong>æ ¸å¿ƒç‚¹è¯†åˆ«</strong>ï¼šä½¿ç”¨voteæŒ‡ä»¤å¿«é€Ÿåˆ¤æ–­</li>
<li><strong>ç°‡æ‰©å±•</strong>ï¼šæ— é”å¹¶æŸ¥é›†åˆå¹¶è¿é€šåˆ†é‡</li>
</ol>
<p>å…³é”®ä¼˜åŒ–ï¼š</p>
<ul>
<li>Warpçº§å¹¶è¡Œå¤„ç†ä¸€ä¸ªä½“ç´ çš„æ‰€æœ‰ç‚¹</li>
<li>Shuffleäº¤æ¢é‚»åŸŸä¿¡æ¯</li>
<li>MatchæŒ‡ä»¤ç»„ç»‡ç›¸åŒç°‡çš„çº¿ç¨‹</li>
<li>åŸå­æ“ä½œæ›´æ–°ç°‡æ ‡ç­¾</li>
</ul>
<p>æ€§èƒ½æŒ‡æ ‡ï¼š</p>
<ul>
<li>ç›®æ ‡ï¼š10mså¤„ç†10ä¸‡ç‚¹</li>
<li>å†…å­˜è®¿é—®åˆå¹¶æå‡å¸¦å®½åˆ©ç”¨</li>
<li>å‡å°‘åŸå­æ“ä½œç«äº‰</li>
<li>å……åˆ†åˆ©ç”¨çº¹ç†ç¼“å­˜åŠ é€Ÿé‚»åŸŸæŸ¥è¯¢</li>
</ul>
</details>
<h2 id="_8">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1-shuffle">1. ShuffleæŒ‡ä»¤çš„åŒæ­¥é—®é¢˜</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæœªä½¿ç”¨_syncç‰ˆæœ¬</span>
<span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">srcLane</span><span class="p">);</span><span class="w">  </span><span class="c1">// å·²åºŸå¼ƒï¼Œå¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸º</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨_syncç‰ˆæœ¬å¹¶æŒ‡å®šmask</span>
<span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">srcLane</span><span class="p">);</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šä»CUDA 9.0å¼€å§‹ï¼Œé_syncç‰ˆæœ¬å·²åºŸå¼ƒã€‚å¿…é¡»ä½¿ç”¨_syncç‰ˆæœ¬å¹¶æ˜ç¡®æŒ‡å®šå‚ä¸çº¿ç¨‹çš„maskã€‚</p>
<h3 id="2">2. åä½œç»„çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šåœ¨æ¡ä»¶åˆ†æ”¯ä¸­åˆ›å»ºåä½œç»„</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">tiled_partition</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cg</span><span class="o">::</span><span class="n">this_thread_block</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// åªæœ‰éƒ¨åˆ†çº¿ç¨‹åˆ›å»ºäº†tileï¼Œå¯¼è‡´æ­»é”</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½åˆ›å»ºåä½œç»„ï¼Œç„¶åæ¡ä»¶ä½¿ç”¨</span>
<span class="k">auto</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">tiled_partition</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cg</span><span class="o">::</span><span class="n">this_thread_block</span><span class="p">());</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨tile</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šåä½œç»„çš„åˆ›å»ºå¿…é¡»ç”±æ‰€æœ‰å‚ä¸çº¿ç¨‹æ‰§è¡Œï¼Œå¦åˆ™ä¼šå¯¼è‡´æ­»é”æˆ–æœªå®šä¹‰è¡Œä¸ºã€‚</p>
<h3 id="3-its">3. ITSæ¶æ„ä¸‹çš„éšå¼å‡è®¾</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šå‡è®¾warpè‡ªåŠ¨æ”¶æ•›</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">compute_a</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">compute_b</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">// å±é™©ï¼šå‡è®¾æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾è¿™é‡Œ</span>
<span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// æ­£ç¡®ï¼šæ˜¾å¼åŒæ­¥</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__activemask</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">compute_a</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">compute_b</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">__syncwarp</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç¡®ä¿æ”¶æ•›</span>
<span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__shfl_sync</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šVolta+æ¶æ„ä¸ä¿è¯åˆ†æ”¯åçš„è‡ªåŠ¨æ”¶æ•›ï¼Œå¿…é¡»æ˜¾å¼åŒæ­¥ã€‚</p>
<h3 id="4-aba">4. åŸå­æ“ä½œçš„ABAé—®é¢˜</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// å±é™©ï¼šç®€å•CASå¯èƒ½é­é‡ABAé—®é¢˜</span>
<span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
<span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">new_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="c1">// å¦‚æœè¿™æœŸé—´topè¢«popåˆpushå›æ¥...</span>
<span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">new_top</span><span class="p">);</span><span class="w">  </span><span class="c1">// é”™è¯¯åœ°æˆåŠŸ</span>

<span class="c1">// è§£å†³ï¼šä½¿ç”¨ç‰ˆæœ¬å·</span>
<span class="n">VersionedPtr</span><span class="w"> </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
<span class="n">VersionedPtr</span><span class="w"> </span><span class="nf">new_top</span><span class="p">(</span><span class="n">old_top</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">old_top</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">old_top</span><span class="p">.</span><span class="n">packed</span><span class="p">,</span><span class="w"> </span><span class="n">new_top</span><span class="p">.</span><span class="n">packed</span><span class="p">);</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šæ— é”æ•°æ®ç»“æ„å¿…é¡»è€ƒè™‘ABAé—®é¢˜ï¼Œä½¿ç”¨ç‰ˆæœ¬å·æˆ–hazard pointeræŠ€æœ¯ã€‚</p>
<h3 id="5-matchmask">5. MatchæŒ‡ä»¤çš„maskè¯¯ç”¨</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šä½¿ç”¨å…¨maskä½†ä¸æ˜¯æ‰€æœ‰çº¿ç¨‹éƒ½æ´»è·ƒ</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="n">peers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__match_any_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨å®é™…æ´»è·ƒçš„çº¿ç¨‹mask</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__activemask</span><span class="p">();</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="n">peers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__match_any_sync</span><span class="p">(</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šmatchæŒ‡ä»¤çš„maskå¿…é¡»å‡†ç¡®åæ˜ æ´»è·ƒçº¿ç¨‹ï¼Œå¦åˆ™ä¼šhangã€‚</p>
<h3 id="6">6. ç½‘æ ¼çº§åŒæ­¥çš„å¯åŠ¨è¦æ±‚</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ™®é€šå†…æ ¸å¯åŠ¨</span>
<span class="n">kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">();</span>

<span class="c1">// æ­£ç¡®ï¼šåä½œå†…æ ¸å¯åŠ¨</span>
<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg2</span><span class="p">};</span>
<span class="n">cudaLaunchCooperativeKernel</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šç½‘æ ¼çº§åŒæ­¥éœ€è¦ç‰¹æ®Šçš„åä½œå†…æ ¸å¯åŠ¨APIã€‚</p>
<h3 id="7-warp">7. Warpçº§å½’çº¦çš„è¾¹ç•Œå¤„ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæœªå¤„ç†é32å€æ•°çš„æƒ…å†µ</span>
<span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">warpReduce</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span><span class="w">  </span><span class="c1">// tid &gt;= Næ—¶è®¿é—®è¶Šç•Œ</span>

<span class="c1">// æ­£ç¡®ï¼šæ·»åŠ è¾¹ç•Œæ£€æŸ¥</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">warpReduce</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šwarpçº§æ“ä½œå¿…é¡»è€ƒè™‘æ•°ç»„è¾¹ç•Œå’Œä¸å®Œæ•´warpã€‚</p>
<h3 id="8">8. å†…å­˜æ …æ çš„è¿‡åº¦ä½¿ç”¨</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½æ•ˆï¼šä¸å¿…è¦çš„å…¨å±€æ …æ </span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="nf">__threadfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// è¿‡åº¦åŒæ­¥</span>

<span class="c1">// ä¼˜åŒ–ï¼šæ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„æ …æ </span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shared_counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="nf">__threadfence_block</span><span class="p">();</span><span class="w">  </span><span class="c1">// ä»…å—å†…åŒæ­¥</span>
</code></pre></div>

<p><strong>é™·é˜±è¯´æ˜</strong>ï¼šé€‰æ‹©åˆé€‚ç²’åº¦çš„å†…å­˜æ …æ ï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½æŸå¤±ã€‚</p>
<h3 id="_9">è°ƒè¯•æŠ€å·§</h3>
<ol>
<li><strong>ä½¿ç”¨assertæ£€æŸ¥mask</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">assert</span><span class="p">(</span><span class="n">__popc</span><span class="p">(</span><span class="n">__activemask</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected_threads</span><span class="p">);</span>
</code></pre></div>

<ol start="2">
<li><strong>æ‰“å°è°ƒè¯•ä¿¡æ¯</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Active mask: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__activemask</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li>
<p><strong>ä½¿ç”¨Nsight Computeåˆ†æ</strong>ï¼š
- æ£€æŸ¥warpå ç”¨ç‡
- åˆ†æåˆ†æ”¯æ•ˆç‡
- æŸ¥çœ‹åŸå­æ“ä½œç«äº‰</p>
</li>
<li>
<p><strong>æ¸è¿›å¼æµ‹è¯•</strong>ï¼š
- å…ˆæµ‹è¯•å•warp
- å†æµ‹è¯•å•block
- æœ€åæµ‹è¯•å®Œæ•´grid</p>
</li>
</ol>
<h2 id="_10">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_11">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>é€‰æ‹©åˆé€‚çš„å¹¶è¡Œç²’åº¦</strong></li>
<li>Warpçº§æ“ä½œé€‚åˆç»†ç²’åº¦å¹¶è¡Œ</li>
<li>åä½œç»„é€‚åˆçµæ´»çš„çº¿ç¨‹ç»„ç»‡</li>
<li>
<p>è¯„ä¼°åˆ†æ”¯åˆ†æ­§çš„å½±å“</p>
</li>
<li>
<p>[ ] <strong>æ•°æ®ç»“æ„é€‰æ‹©</strong></p>
</li>
<li>é«˜ç«äº‰åœºæ™¯ä¼˜å…ˆè€ƒè™‘æ— é”ç»“æ„</li>
<li>ä½ç«äº‰åœºæ™¯å¯ä»¥ä½¿ç”¨ç®€å•çš„åŸå­æ“ä½œ</li>
<li>
<p>è€ƒè™‘ABAé—®é¢˜å’Œå†…å­˜åºè¦æ±‚</p>
</li>
<li>
<p>[ ] <strong>ç®—æ³•è®¾è®¡</strong></p>
</li>
<li>ä¼˜å…ˆä½¿ç”¨warpçº§åŸè¯­ï¼ˆshuffleã€voteï¼‰</li>
<li>è®¾è®¡æ—¶è€ƒè™‘32çº¿ç¨‹çš„warpå¤§å°</li>
<li>åˆ©ç”¨åä½œç»„å®ç°çµæ´»çš„å¹¶è¡Œæ¨¡å¼</li>
</ul>
<h3 id="_12">å®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>Warpæ“ä½œæ­£ç¡®æ€§</strong></li>
<li>æ‰€æœ‰warpåŸè¯­ä½¿ç”¨_syncç‰ˆæœ¬</li>
<li>æ­£ç¡®è®¾ç½®å‚ä¸çº¿ç¨‹çš„mask</li>
<li>
<p>å¤„ç†ä¸å®Œæ•´warpçš„è¾¹ç•Œæƒ…å†µ</p>
</li>
<li>
<p>[ ] <strong>åä½œç»„ä½¿ç”¨</strong></p>
</li>
<li>æ‰€æœ‰çº¿ç¨‹å‚ä¸åä½œç»„åˆ›å»º</li>
<li>ä½¿ç”¨åˆé€‚çš„åŒæ­¥ç²’åº¦</li>
<li>
<p>æ­£ç¡®å¤„ç†åŠ¨æ€åˆ†åŒº</p>
</li>
<li>
<p>[ ] <strong>ITSå…¼å®¹æ€§</strong></p>
</li>
<li>åˆ†æ”¯åæ˜¾å¼åŒæ­¥</li>
<li>ä½¿ç”¨__activemask()è·å–æ´»è·ƒçº¿ç¨‹</li>
<li>
<p>é¿å…éšå¼æ”¶æ•›å‡è®¾</p>
</li>
<li>
<p>[ ] <strong>åŸå­æ“ä½œä¼˜åŒ–</strong></p>
</li>
<li>ä½¿ç”¨åˆé€‚çš„å†…å­˜æ …æ </li>
<li>è€ƒè™‘ä½¿ç”¨warpçº§èšåˆå‡å°‘ç«äº‰</li>
<li>å®ç°é€€é¿ç­–ç•¥å‡å°‘å†²çª</li>
</ul>
<h3 id="_13">ä¼˜åŒ–é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ€§èƒ½åˆ†æ</strong></li>
<li>æµ‹é‡warpæ‰§è¡Œæ•ˆç‡</li>
<li>åˆ†æåˆ†æ”¯åˆ†æ­§ç¨‹åº¦</li>
<li>
<p>æ£€æŸ¥åŸå­æ“ä½œç«äº‰</p>
</li>
<li>
<p>[ ] <strong>å†…å­˜è®¿é—®ä¼˜åŒ–</strong></p>
</li>
<li>Shuffleæ“ä½œæ›¿ä»£å…±äº«å†…å­˜</li>
<li>åˆå¹¶å…¨å±€å†…å­˜è®¿é—®</li>
<li>
<p>ä½¿ç”¨é€‚å½“çš„ç¼“å­˜ç­–ç•¥</p>
</li>
<li>
<p>[ ] <strong>è´Ÿè½½å‡è¡¡</strong></p>
</li>
<li>åŠ¨æ€ä»»åŠ¡åˆ†é…</li>
<li>å·¥ä½œçªƒå–ç­–ç•¥</li>
<li>è‡ªé€‚åº”åˆ†ç»„å¤§å°</li>
</ul>
<h3 id="_14">æµ‹è¯•é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>åŠŸèƒ½æµ‹è¯•</strong></li>
<li>å•warpæµ‹è¯•</li>
<li>å¤šwarpåä½œæµ‹è¯•</li>
<li>
<p>è¾¹ç•Œæ¡ä»¶æµ‹è¯•</p>
</li>
<li>
<p>[ ] <strong>å¹¶å‘æµ‹è¯•</strong></p>
</li>
<li>é«˜ç«äº‰åœºæ™¯æµ‹è¯•</li>
<li>ABAé—®é¢˜éªŒè¯</li>
<li>
<p>æ­»é”æ£€æµ‹</p>
</li>
<li>
<p>[ ] <strong>æ€§èƒ½æµ‹è¯•</strong></p>
</li>
<li>ä¸åŒæ•°æ®è§„æ¨¡</li>
<li>ä¸åŒGPUæ¶æ„</li>
<li>ä¸å…¶ä»–å®ç°å¯¹æ¯”</li>
</ul>
<h3 id="_15">éƒ¨ç½²é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ¶æ„å…¼å®¹æ€§</strong></li>
<li>æ£€æŸ¥Compute Capabilityè¦æ±‚</li>
<li>æä¾›Pre-Voltaå…¼å®¹ç‰ˆæœ¬</li>
<li>
<p>è¿è¡Œæ—¶æ¶æ„æ£€æµ‹</p>
</li>
<li>
<p>[ ] <strong>é”™è¯¯å¤„ç†</strong></p>
</li>
<li>åŸå­æ“ä½œå¤±è´¥é‡è¯•</li>
<li>èµ„æºè€—å°½å¤„ç†</li>
<li>
<p>è¶…æ—¶æœºåˆ¶</p>
</li>
<li>
<p>[ ] <strong>ç›‘æ§æŒ‡æ ‡</strong></p>
</li>
<li>Warpæ•ˆç‡ç›‘æ§</li>
<li>åŸå­æ“ä½œå†²çªç‡</li>
<li>å†…å­˜å¸¦å®½åˆ©ç”¨ç‡</li>
</ul>
<h3 id="_16">ä»£ç å®¡æŸ¥è¦ç‚¹</h3>
<ol>
<li><strong>åŒæ­¥æ­£ç¡®æ€§</strong>ï¼šæ¯ä¸ªwarpæ“ä½œéƒ½æœ‰æ­£ç¡®çš„åŒæ­¥</li>
<li><strong>Maskå‡†ç¡®æ€§</strong>ï¼š__activemask()ä½¿ç”¨æ­£ç¡®</li>
<li><strong>è¾¹ç•Œå¤„ç†</strong>ï¼šå¤„ç†äº†æ‰€æœ‰è¾¹ç•Œæƒ…å†µ</li>
<li><strong>èµ„æºç®¡ç†</strong>ï¼šæ— é”ç»“æ„çš„å†…å­˜ç®¡ç†æ­£ç¡®</li>
<li><strong>æ€§èƒ½ç“¶é¢ˆ</strong>ï¼šè¯†åˆ«å¹¶ä¼˜åŒ–äº†å…³é”®è·¯å¾„</li>
</ol>
<h3 id="_17">æ–‡æ¡£è¦æ±‚</h3>
<ul>
<li>[ ] è®°å½•ç®—æ³•çš„å¹¶è¡Œç­–ç•¥</li>
<li>[ ] è¯´æ˜æ¶æ„è¦æ±‚å’Œé™åˆ¶</li>
<li>[ ] æä¾›æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ</li>
<li>[ ] åŒ…å«ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ</li>
<li>[ ] åˆ—å‡ºå·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter5.html" class="nav-link prev">â† ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</a><a href="chapter7.html" class="nav-link next">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­ â†’</a></nav>
        </main>
    </div>
</body>
</html>