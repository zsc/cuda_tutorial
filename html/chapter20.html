<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="20cuda-graph">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</h1>
<p>åœ¨ç°ä»£AIæ¨ç†ç³»ç»Ÿä¸­ï¼Œå•ä¸ªå†…æ ¸çš„ä¼˜åŒ–å·²ç»æ¥è¿‘ç¡¬ä»¶æé™ï¼Œè€Œç³»ç»Ÿçº§çš„ä¼˜åŒ–æˆä¸ºäº†æå‡æ€§èƒ½çš„å…³é”®ã€‚CUDA Graphé€šè¿‡æ¶ˆé™¤CPU-GPUåŒæ­¥å¼€é”€å®ç°äº†æ‰§è¡Œæµçš„æè‡´ä¼˜åŒ–ï¼Œè€Œå†…æ ¸èåˆåˆ™é€šè¿‡å‡å°‘å†…å­˜è®¿é—®æ¬¡æ•°å¤§å¹…æå‡äº†ç®—å­æ•ˆç‡ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨è¿™ä¸¤é¡¹å…³é”®æŠ€æœ¯ï¼Œå¹¶ç»“åˆJITç¼–è¯‘å’Œè‡ªåŠ¨è°ƒä¼˜æ¡†æ¶ï¼Œå¸®åŠ©ä½ æ„å»ºç«¯åˆ°ç«¯çš„é«˜æ€§èƒ½æ¨ç†ç³»ç»Ÿã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œä½ å°†æŒæ¡å°†ç¦»æ•£çš„CUDAå†…æ ¸ç»„ç»‡æˆé«˜æ•ˆæ‰§è¡Œå›¾çš„æ–¹æ³•ï¼Œç†è§£ä¸åŒå±‚æ¬¡çš„èåˆç­–ç•¥ï¼Œå¹¶èƒ½å¤Ÿé’ˆå¯¹ç‰¹å®šç¡¬ä»¶å’Œå·¥ä½œè´Ÿè½½è¿›è¡Œè‡ªåŠ¨ä¼˜åŒ–ã€‚</p>
<h2 id="201-cuda-graph">20.1 CUDA Graphæ„å»ºä¸ä¼˜åŒ–</h2>
<h3 id="2011-graph">20.1.1 GraphåŸºæœ¬æ¦‚å¿µä¸æ‰§è¡Œæ¨¡å‹</h3>
<p>CUDA Graphæ˜¯CUDA 10å¼•å…¥çš„é©å‘½æ€§ç‰¹æ€§ï¼Œå®ƒå°†ä¸€ç³»åˆ—CUDAæ“ä½œï¼ˆå†…æ ¸å¯åŠ¨ã€å†…å­˜æ‹·è´ã€åŒæ­¥ç­‰ï¼‰å°è£…æˆä¸€ä¸ªå¯é‡å¤æ‰§è¡Œçš„å›¾ç»“æ„ã€‚ä¸ä¼ ç»Ÿçš„æµå¼æ‰§è¡Œç›¸æ¯”ï¼ŒGraphæ¨¡å¼å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol>
<li><strong>æä½çš„å¯åŠ¨å¼€é”€</strong>ï¼šGraphå®ä¾‹åŒ–åï¼Œæ•´ä¸ªæ‰§è¡Œåºåˆ—é€šè¿‡å•æ¬¡APIè°ƒç”¨å®Œæˆï¼Œé¿å…äº†åå¤çš„å†…æ ¸å¯åŠ¨å¼€é”€</li>
<li><strong>ä¼˜åŒ–çš„è°ƒåº¦</strong>ï¼šé©±åŠ¨ç¨‹åºå¯ä»¥é¢„å…ˆåˆ†ææ•´ä¸ªæ‰§è¡Œå›¾ï¼Œè¿›è¡Œå…¨å±€ä¼˜åŒ–</li>
<li><strong>ç¡®å®šæ€§æ‰§è¡Œ</strong>ï¼šå›ºå®šçš„æ‰§è¡Œæ¨¡å¼æœ‰åˆ©äºæ€§èƒ½é¢„æµ‹å’Œè°ƒè¯•</li>
</ol>
<p>Graphçš„æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>èŠ‚ç‚¹ï¼ˆNodeï¼‰</strong>ï¼šä»£è¡¨å•ä¸ªæ“ä½œï¼Œå¦‚å†…æ ¸å¯åŠ¨ã€memcpyã€eventè®°å½•ç­‰</li>
<li><strong>è¾¹ï¼ˆEdgeï¼‰</strong>ï¼šå®šä¹‰èŠ‚ç‚¹é—´çš„ä¾èµ–å…³ç³»</li>
<li><strong>å›¾æ¨¡æ¿ï¼ˆGraph Templateï¼‰</strong>ï¼šå®šä¹‰æ‰§è¡Œæ‹“æ‰‘çš„è“å›¾</li>
<li><strong>å›¾å®ä¾‹ï¼ˆExecutable Graphï¼‰</strong>ï¼šå¯ä»¥å®é™…æ‰§è¡Œçš„å›¾å¯¹è±¡</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">Graphæ‰§è¡Œæµç¨‹</span><span class="err">ï¼š</span>
<span class="w">     </span><span class="err">åˆ›å»º</span><span class="w">           </span><span class="err">å®ä¾‹åŒ–</span><span class="w">            </span><span class="err">æ‰§è¡Œ</span>
<span class="n">Template</span><span class="w"> </span><span class="o">-----&gt;</span><span class="w"> </span><span class="n">Executable</span><span class="w"> </span><span class="o">-----&gt;</span><span class="w"> </span><span class="n">Launch</span>
<span class="w">  </span><span class="nf">Graph</span><span class="w">           </span><span class="nf">Graph</span><span class="w">           </span><span class="p">(</span><span class="err">é‡å¤</span><span class="p">)</span>
<span class="w">    </span><span class="o">|</span><span class="w">               </span><span class="o">|</span><span class="w">                </span><span class="o">|</span>
<span class="w">  </span><span class="err">å®šä¹‰æ‹“æ‰‘</span><span class="w">        </span><span class="err">èµ„æºåˆ†é…</span><span class="w">         </span><span class="err">é«˜æ•ˆæ‰§è¡Œ</span>
</code></pre></div>

<h3 id="2012">20.1.2 æµæ•è·æœºåˆ¶è¯¦è§£</h3>
<p>æµæ•è·ï¼ˆStream Captureï¼‰æ˜¯æ„å»ºCUDA Graphæœ€ä¾¿æ·çš„æ–¹å¼ï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨è®°å½•æµä¸Šçš„æ“ä½œåºåˆ—ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸºæœ¬æµæ•è·æ¨¡å¼</span>
<span class="n">cudaGraph_t</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span>
<span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>

<span class="c1">// å¼€å§‹æ•è·</span>
<span class="n">cudaStreamBeginCapture</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStreamCaptureModeGlobal</span><span class="p">);</span>

<span class="c1">// è®°å½•æ“ä½œåºåˆ—</span>
<span class="n">kernel1</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>
<span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
<span class="n">kernel2</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid2</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>

<span class="c1">// ç»“æŸæ•è·</span>
<span class="n">cudaStreamEndCapture</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">graph</span><span class="p">);</span>

<span class="c1">// å®ä¾‹åŒ–å›¾</span>
<span class="n">cudaGraphExec_t</span><span class="w"> </span><span class="n">graphExec</span><span class="p">;</span>
<span class="n">cudaGraphInstantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// æ‰§è¡Œå›¾ï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cudaGraphLaunch</span><span class="p">(</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>æµæ•è·æ”¯æŒä¸‰ç§æ¨¡å¼ï¼š</p>
<ul>
<li><strong>Globalæ¨¡å¼</strong>ï¼šæ•è·æ‰€æœ‰ç›¸å…³æµçš„æ“ä½œ</li>
<li><strong>Localæ¨¡å¼</strong>ï¼šä»…æ•è·æŒ‡å®šæµçš„æ“ä½œ</li>
<li><strong>Relaxedæ¨¡å¼</strong>ï¼šå…è®¸æŸäº›æ“ä½œé€ƒé€¸æ•è·</li>
</ul>
<p>å¯¹äºå¤æ‚çš„å¤šæµåœºæ™¯ï¼Œéœ€è¦carefulå¤„ç†æµé—´åŒæ­¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å¤šæµæ•è·ä¸åŒæ­¥</span>
<span class="n">cudaStreamBeginCapture</span><span class="p">(</span><span class="n">stream1</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStreamCaptureModeGlobal</span><span class="p">);</span>

<span class="n">kernel_a</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream1</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>
<span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">event1</span><span class="p">,</span><span class="w"> </span><span class="n">stream1</span><span class="p">);</span>

<span class="c1">// stream2ç­‰å¾…stream1</span>
<span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">stream2</span><span class="p">,</span><span class="w"> </span><span class="n">event1</span><span class="p">);</span>
<span class="n">kernel_b</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream2</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>

<span class="c1">// åˆå¹¶å›ä¸»æµ</span>
<span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">event2</span><span class="p">,</span><span class="w"> </span><span class="n">stream2</span><span class="p">);</span>
<span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">stream1</span><span class="p">,</span><span class="w"> </span><span class="n">event2</span><span class="p">);</span>
<span class="n">kernel_c</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream1</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>

<span class="n">cudaStreamEndCapture</span><span class="p">(</span><span class="n">stream1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">graph</span><span class="p">);</span>
</code></pre></div>

<h3 id="2013-graph">20.1.3 æ‰‹åŠ¨Graphæ„å»ºä¸èŠ‚ç‚¹ç®¡ç†</h3>
<p>å¯¹äºéœ€è¦ç²¾ç»†æ§åˆ¶çš„åœºæ™¯ï¼Œæ‰‹åŠ¨æ„å»ºGraphæä¾›äº†æœ€å¤§çš„çµæ´»æ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ‰‹åŠ¨åˆ›å»ºGraphèŠ‚ç‚¹</span>
<span class="n">cudaGraph_t</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span>
<span class="n">cudaGraphCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// æ·»åŠ å†…æ ¸èŠ‚ç‚¹</span>
<span class="n">cudaGraphNode_t</span><span class="w"> </span><span class="n">kernelNode1</span><span class="p">,</span><span class="w"> </span><span class="n">kernelNode2</span><span class="p">;</span>
<span class="n">cudaKernelNodeParams</span><span class="w"> </span><span class="n">kernelParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="n">kernelParams</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">myKernel</span><span class="p">;</span>
<span class="n">kernelParams</span><span class="p">.</span><span class="n">gridDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gridDim</span><span class="p">;</span>
<span class="n">kernelParams</span><span class="p">.</span><span class="n">blockDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockDim</span><span class="p">;</span>
<span class="n">kernelParams</span><span class="p">.</span><span class="n">sharedMemBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">kernelParams</span><span class="p">.</span><span class="n">kernelParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernelArgs</span><span class="p">;</span>

<span class="n">cudaGraphAddKernelNode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernelNode1</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kernelParams</span><span class="p">);</span>

<span class="c1">// æ·»åŠ å†…å­˜æ‹·è´èŠ‚ç‚¹</span>
<span class="n">cudaGraphNode_t</span><span class="w"> </span><span class="n">memcpyNode</span><span class="p">;</span>
<span class="n">cudaMemcpy3DParms</span><span class="w"> </span><span class="n">memcpyParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="c1">// é…ç½®memcpyParams...</span>
<span class="n">cudaGraphAddMemcpyNode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memcpyNode</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kernelNode1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">memcpyParams</span><span class="p">);</span>

<span class="c1">// è®¾ç½®ä¾èµ–å…³ç³»</span>
<span class="n">cudaGraphNode_t</span><span class="w"> </span><span class="n">dependencies</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">kernelNode1</span><span class="p">,</span><span class="w"> </span><span class="n">memcpyNode</span><span class="p">};</span>
<span class="n">cudaGraphAddKernelNode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernelNode2</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="n">dependencies</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kernelParams2</span><span class="p">);</span>
</code></pre></div>

<p>Graphæ”¯æŒçš„èŠ‚ç‚¹ç±»å‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>KernelèŠ‚ç‚¹ï¼šGPUå†…æ ¸æ‰§è¡Œ</li>
<li>MemcpyèŠ‚ç‚¹ï¼šå†…å­˜ä¼ è¾“æ“ä½œ</li>
<li>MemsetèŠ‚ç‚¹ï¼šå†…å­˜åˆå§‹åŒ–</li>
<li>HostèŠ‚ç‚¹ï¼šCPUå›è°ƒå‡½æ•°</li>
<li>Child GraphèŠ‚ç‚¹ï¼šåµŒå¥—å­å›¾</li>
<li>EventèŠ‚ç‚¹ï¼šäº‹ä»¶è®°å½•ä¸ç­‰å¾…</li>
<li>ConditionalèŠ‚ç‚¹ï¼šæ¡ä»¶æ‰§è¡Œï¼ˆCUDA 12.3+ï¼‰</li>
</ul>
<h3 id="2014-graph">20.1.4 Graphæ›´æ–°ä¸æ¡ä»¶æ‰§è¡Œ</h3>
<p>åŠ¨æ€æ›´æ–°Graphå‚æ•°æ˜¯å®ç°çµæ´»æ‰§è¡Œçš„å…³é”®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ›´æ–°å†…æ ¸å‚æ•°</span>
<span class="n">cudaKernelNodeParams</span><span class="w"> </span><span class="n">updatedParams</span><span class="p">;</span>
<span class="n">cudaGraphKernelNodeGetParams</span><span class="p">(</span><span class="n">kernelNode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">updatedParams</span><span class="p">);</span>
<span class="n">updatedParams</span><span class="p">.</span><span class="n">kernelParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span>
<span class="n">cudaGraphExecKernelNodeSetParams</span><span class="p">(</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">kernelNode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">updatedParams</span><span class="p">);</span>

<span class="c1">// æ‰¹é‡æ›´æ–°å¤šä¸ªèŠ‚ç‚¹</span>
<span class="n">cudaGraphExecUpdate</span><span class="p">(</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">updateResult</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updateResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaGraphExecUpdateSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// éœ€è¦é‡æ–°å®ä¾‹åŒ–</span>
<span class="w">    </span><span class="n">cudaGraphExecDestroy</span><span class="p">(</span><span class="n">graphExec</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaGraphInstantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>CUDA 12.3å¼•å…¥çš„æ¡ä»¶èŠ‚ç‚¹æ”¯æŒåŠ¨æ€æ§åˆ¶æµï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åˆ›å»ºæ¡ä»¶èŠ‚ç‚¹</span>
<span class="n">cudaGraphNode_t</span><span class="w"> </span><span class="n">conditionalNode</span><span class="p">;</span>
<span class="n">cudaGraphConditionalHandle</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
<span class="n">cudaGraphAddConditionalNode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conditionalNode</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">numDeps</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>

<span class="c1">// è®¾ç½®æ¡ä»¶åˆ†æ”¯</span>
<span class="n">cudaGraph_t</span><span class="w"> </span><span class="n">graphIf</span><span class="p">,</span><span class="w"> </span><span class="n">graphElse</span><span class="p">;</span>
<span class="c1">// æ„å»ºåˆ†æ”¯å›¾...</span>
<span class="n">cudaGraphConditionalNodeSetParams</span><span class="p">(</span><span class="n">conditionalNode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">graphIf</span><span class="p">,</span><span class="w"> </span><span class="n">graphElse</span><span class="p">);</span>
</code></pre></div>

<h3 id="2015">20.1.5 æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3>
<p>Graphä¼˜åŒ–çš„å…³é”®åœ¨äºæœ€å¤§åŒ–å¹¶è¡Œåº¦å’Œæœ€å°åŒ–åŒæ­¥ç‚¹ï¼š</p>
<ol>
<li><strong>åˆå¹¶å°å†…æ ¸</strong>ï¼šå°†å¤šä¸ªå°å†…æ ¸åˆå¹¶æˆä¸€ä¸ªèŠ‚ç‚¹ï¼Œå‡å°‘è°ƒåº¦å¼€é”€</li>
<li><strong>å¼‚æ­¥æ“ä½œé“¾</strong>ï¼šå°½å¯èƒ½ä½¿ç”¨å¼‚æ­¥æ“ä½œï¼Œé¿å…éšå¼åŒæ­¥</li>
<li><strong>é¢„åˆ†é…èµ„æº</strong>ï¼šGraphå®ä¾‹åŒ–æ—¶é¢„åˆ†é…æ‰€æœ‰èµ„æºï¼Œé¿å…è¿è¡Œæ—¶åˆ†é…</li>
<li><strong>å›¾åˆ†åŒº</strong>ï¼šå°†å¤§å›¾åˆ†è§£ä¸ºå¤šä¸ªå­å›¾ï¼Œä¾¿äºå¹¶è¡Œæ‰§è¡Œå’Œæ›´æ–°</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¼˜åŒ–ç¤ºä¾‹ï¼šä½¿ç”¨æŒä¹…åŒ–å†…æ ¸å‡å°‘å¯åŠ¨å¼€é”€</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">persistentKernel</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ‰§è¡Œå·¥ä½œ</span>
<span class="w">        </span><span class="n">processWork</span><span class="p">();</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>æ€§èƒ½åˆ†æè¦ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨Nsight SystemsæŸ¥çœ‹Graphæ‰§è¡Œæ—¶é—´çº¿</li>
<li>ç›‘æ§Graphå®ä¾‹åŒ–å¼€é”€</li>
<li>åˆ†æèŠ‚ç‚¹é—´çš„ä¾èµ–å…³ç³»æ˜¯å¦åˆç†</li>
<li>è¯„ä¼°Graphæ›´æ–°é¢‘ç‡å¯¹æ€§èƒ½çš„å½±å“</li>
</ul>
<h2 id="202">20.2 å†…æ ¸èåˆç­–ç•¥</h2>
<h3 id="2021">20.2.1 èåˆçš„åŠ¨æœºä¸æ”¶ç›Šåˆ†æ</h3>
<p>å†…æ ¸èåˆæ˜¯ä¼˜åŒ–GPUç¨‹åºçš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ï¼Œå…¶ä¸»è¦åŠ¨æœºåŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>å‡å°‘å†…å­˜è®¿é—®</strong>ï¼šä¸­é—´ç»“æœä¿æŒåœ¨å¯„å­˜å™¨æˆ–å…±äº«å†…å­˜ä¸­ï¼Œé¿å…å…¨å±€å†…å­˜å¾€è¿”</li>
<li><strong>é™ä½å¯åŠ¨å¼€é”€</strong>ï¼šå‡å°‘å†…æ ¸å¯åŠ¨æ¬¡æ•°ï¼Œç‰¹åˆ«æ˜¯å¯¹å°è§„æ¨¡é—®é¢˜</li>
<li><strong>æé«˜æ•°æ®å±€éƒ¨æ€§</strong>ï¼šèåˆåçš„å†…æ ¸èƒ½æ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜</li>
<li><strong>å¢åŠ å¹¶è¡Œæœºä¼š</strong>ï¼šè·¨æ“ä½œçš„å¹¶è¡Œä¼˜åŒ–</li>
</ol>
<p>èåˆæ”¶ç›Šçš„é‡åŒ–åˆ†æï¼š</p>
<div class="codehilite"><pre><span></span><code>æœªèåˆï¼šKernel1(è¯»A,å†™B) + Kernel2(è¯»B,å†™C) + Kernel3(è¯»C,å†™D)
å†…å­˜è®¿é—®ï¼š2N + 2N + 2N = 6N

èåˆåï¼šFusedKernel(è¯»A,å†™D)  
å†…å­˜è®¿é—®ï¼š2N

ç†è®ºåŠ é€Ÿæ¯”ï¼š3xï¼ˆä»…è€ƒè™‘å†…å­˜å¸¦å®½ï¼‰
</code></pre></div>

<p>å®é™…æ”¶ç›Šå—å¤šä¸ªå› ç´ å½±å“ï¼š</p>
<ul>
<li>ç®—æœ¯å¼ºåº¦ï¼ˆcompute/memory ratioï¼‰</li>
<li>å¯„å­˜å™¨å‹åŠ›</li>
<li>å…±äº«å†…å­˜ä½¿ç”¨é‡</li>
<li>å ç”¨ç‡å˜åŒ–</li>
</ul>
<h3 id="2022">20.2.2 å‚ç›´èåˆæŠ€æœ¯</h3>
<p>å‚ç›´èåˆï¼ˆVertical Fusionï¼‰å°†producer-consumerå…³ç³»çš„å†…æ ¸åˆå¹¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æœªèåˆç‰ˆæœ¬</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">relu</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">add_bias</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">bias</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bias</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BIAS_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å‚ç›´èåˆç‰ˆæœ¬</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_relu_bias</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">bias</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span><span class="w">  </span><span class="c1">// ReLU</span>
<span class="w">        </span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bias</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BIAS_SIZE</span><span class="p">];</span><span class="w">  </span><span class="c1">// Add bias</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>é«˜çº§å‚ç›´èåˆæ¨¡å¼ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å¤šå±‚èåˆwithå…±äº«å†…å­˜ä¼˜åŒ–</span>
<span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="o">&gt;</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_conv_bn_relu</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">bn_params</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">H</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="n">TILE_SIZE</span><span class="p">][</span><span class="n">TILE_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// 1. å·ç§¯è®¡ç®—</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">conv_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å·ç§¯é€»è¾‘...</span>

<span class="w">    </span><span class="c1">// 2. BatchNormï¼ˆèåˆåœ¨å¯„å­˜å™¨çº§ï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bn_params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bn_params</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bn_params</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bn_params</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">conv_result</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-5f</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">bn_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">beta</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 3. ReLUæ¿€æ´»</span>
<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">bn_result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2023">20.2.3 æ°´å¹³èåˆæŠ€æœ¯</h3>
<p>æ°´å¹³èåˆï¼ˆHorizontal Fusionï¼‰å°†ç‹¬ç«‹çš„æ“ä½œåˆå¹¶ä»¥æé«˜ç¡¬ä»¶åˆ©ç”¨ç‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ°´å¹³èåˆå¤šä¸ªç‹¬ç«‹çš„GEMVæ“ä½œ</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_multi_gemv</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y1</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A2</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y2</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">sum1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// äº¤é”™æ‰§è¡Œä¸¤ä¸ªGEMVï¼Œæé«˜æŒ‡ä»¤çº§å¹¶è¡Œ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sum1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A1</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x1</span><span class="p">[</span><span class="n">col</span><span class="p">];</span>
<span class="w">            </span><span class="n">sum2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A2</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x2</span><span class="p">[</span><span class="n">col</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">y1</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum1</span><span class="p">;</span>
<span class="w">        </span><span class="n">y2</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>åŠ¨æ€æ‰¹å¤„ç†èåˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å°†å¤šä¸ªå°æ‰¹æ¬¡è¯·æ±‚èåˆæ‰§è¡Œ</span>
<span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_BATCH</span><span class="o">&gt;</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_batch_inference</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">**</span><span class="w"> </span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">**</span><span class="w"> </span><span class="n">outputs</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">sizes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">batch_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">work_assignment</span><span class="p">[</span><span class="n">MAX_BATCH</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// åŠ¨æ€å·¥ä½œåˆ†é…</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">batch_count</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">work_assignment</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">            </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sizes</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// å¹¶è¡Œå¤„ç†å¤šä¸ªæ‰¹æ¬¡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">global_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">batch_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_batch</span><span class="p">(</span><span class="n">global_idx</span><span class="p">,</span><span class="w"> </span><span class="n">work_assignment</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">local_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">work_assignment</span><span class="p">[</span><span class="n">batch_id</span><span class="p">];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">batch_count</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">local_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sizes</span><span class="p">[</span><span class="n">batch_id</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">process_item</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">batch_id</span><span class="p">],</span><span class="w"> </span><span class="n">outputs</span><span class="p">[</span><span class="n">batch_id</span><span class="p">],</span><span class="w"> </span><span class="n">local_idx</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2024-element-wise">20.2.4 Element-wiseæ“ä½œèåˆ</h3>
<p>Element-wiseæ“ä½œæ˜¯èåˆçš„ç†æƒ³ç›®æ ‡ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æ˜¯memory-boundçš„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// èåˆå¤æ‚çš„element-wiseè¡¨è¾¾å¼</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_gelu_dropout_scale</span><span class="p">(</span>
<span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">dropout_mask</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dropout_prob</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// GELU: x * Î¦(x)</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">cdf_const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">sqrt_2_over_pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7978845608028654f</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">fitting_const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.044715f</span><span class="p">;</span>

<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">x_cubed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">tanh_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt_2_over_pi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fitting_const</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_cubed</span><span class="p">);</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">tanh_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tanhf</span><span class="p">(</span><span class="n">tanh_arg</span><span class="p">);</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">gelu_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cdf_const</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tanh_result</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Dropout</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">keep_prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dropout_prob</span><span class="p">;</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">dropout_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dropout_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dropout_prob</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>
<span class="w">                       </span><span class="n">gelu_result</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">keep_prob</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Scale</span>
<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dropout_result</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>å‘é‡åŒ–èåˆä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨å‘é‡åŒ–åŠ è½½/å­˜å‚¨æé«˜å¸¦å®½åˆ©ç”¨ç‡</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_elementwise_vec4</span><span class="p">(</span>
<span class="w">    </span><span class="n">float4</span><span class="o">*</span><span class="w"> </span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">float4</span><span class="o">*</span><span class="w"> </span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">float4</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">float4</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input1</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="w">    </span><span class="n">float4</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input2</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// èåˆå¤šä¸ªæ“ä½œ</span>
<span class="w">    </span><span class="n">float4</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaf</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span><span class="w">  </span><span class="c1">// a*b+1</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaf</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaf</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaf</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ReLU</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">);</span>

<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2025-reduction">20.2.5 ReductionèåˆæŠ€æœ¯</h3>
<p>Reductionæ“ä½œçš„èåˆéœ€è¦ç‰¹æ®Šè€ƒè™‘ï¼Œå› ä¸ºå®ƒä»¬æ”¹å˜äº†æ•°æ®ç»´åº¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// èåˆreductionå’Œåç»­æ“ä½œ</span>
<span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="o">&gt;</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_reduction_softmax</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">shared</span><span class="p">[];</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">row_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shared</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">row_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">shared</span><span class="p">[</span><span class="n">BLOCK_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Phase 1: æ‰¾åˆ°è¡Œæœ€å¤§å€¼ï¼ˆèåˆï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">thread_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">FLT_MAX</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">thread_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">thread_max</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">row_max</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread_max</span><span class="p">;</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// æ ‘å½¢å½’çº¦æ‰¾æœ€å¤§å€¼</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stride</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">row_max</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">row_max</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span><span class="w"> </span><span class="n">row_max</span><span class="p">[</span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stride</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">max_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_max</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Phase 2: è®¡ç®—expå’Œsumï¼ˆèåˆï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">thread_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">exp_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expf</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">max_val</span><span class="p">);</span>
<span class="w">        </span><span class="n">thread_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">exp_val</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// ä¸´æ—¶å­˜å‚¨expå€¼ä»¥å¤ç”¨</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_val</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">row_sum</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread_sum</span><span class="p">;</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// æ ‘å½¢å½’çº¦æ±‚å’Œ</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stride</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">row_sum</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">row_sum</span><span class="p">[</span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stride</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sum_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_sum</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Phase 3: å½’ä¸€åŒ–ï¼ˆèåˆï¼‰</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">sum_val</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="203">20.3 è‡ªåŠ¨è°ƒä¼˜æ¡†æ¶</h2>
<h3 id="2031-profile-guided-optimization">20.3.1 Profile-Guided Optimization</h3>
<p>åŸºäºæ€§èƒ½å‰–æçš„ä¼˜åŒ–æ˜¯è‡ªåŠ¨è°ƒä¼˜çš„åŸºç¡€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AutoTuner</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">KernelConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dim3</span><span class="w"> </span><span class="n">gridDim</span><span class="p">;</span>
<span class="w">        </span><span class="n">dim3</span><span class="w"> </span><span class="n">blockDim</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sharedMem</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">params</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">executionTime</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KernelConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">searchSpace</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">profileKernel</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">**</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">KernelConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Warmup</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaLaunchKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">gridDim</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">,</span>
<span class="w">                           </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">sharedMem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Profile</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaLaunchKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">gridDim</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">,</span>
<span class="w">                           </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">sharedMem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventSynchronize</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">milliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaEventElapsedTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">milliseconds</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="n">executionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">milliseconds</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">;</span>

<span class="w">        </span><span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">findBestConfig</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">**</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">bestConfig</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">bestTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLT_MAX</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">searchSpace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">profileKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">executionTime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bestTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">bestTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">executionTime</span><span class="p">;</span>
<span class="w">                </span><span class="n">bestConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bestConfig</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2032">20.3.2 æœç´¢ç©ºé—´å®šä¹‰ä¸å‰ªæ</h3>
<p>æœ‰æ•ˆçš„æœç´¢ç©ºé—´å®šä¹‰æ˜¯å¿«é€Ÿæ”¶æ•›çš„å…³é”®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SearchSpaceGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Constraints</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">maxThreadsPerBlock</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">maxSharedMemory</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">warpSize</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">smCount</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KernelConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">generateSearchSpace</span><span class="p">(</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">problemSize</span><span class="p">,</span><span class="w"> </span><span class="n">Constraints</span><span class="o">&amp;</span><span class="w"> </span><span class="n">hw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KernelConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configs</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ç”Ÿæˆblock sizeå€™é€‰</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blockSizes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">};</span>

<span class="w">        </span><span class="c1">// ç”Ÿæˆtile sizeå€™é€‰</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tileSizes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">};</span>

<span class="w">        </span><span class="c1">// ç”Ÿæˆunroll factorå€™é€‰</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">unrollFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">};</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blockSizes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">hw</span><span class="p">.</span><span class="n">maxThreadsPerBlock</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tileSizes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">sharedMem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sharedMem</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">hw</span><span class="p">.</span><span class="n">maxSharedMemory</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">uf</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">unrollFactors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="w">                    </span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim3</span><span class="p">(</span><span class="n">bs</span><span class="p">);</span>
<span class="w">                    </span><span class="n">config</span><span class="p">.</span><span class="n">gridDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim3</span><span class="p">((</span><span class="n">problemSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bs</span><span class="p">);</span>
<span class="w">                    </span><span class="n">config</span><span class="p">.</span><span class="n">sharedMem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharedMem</span><span class="p">;</span>
<span class="w">                    </span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;TILE_SIZE&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<span class="w">                    </span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;UNROLL_FACTOR&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uf</span><span class="p">;</span>

<span class="w">                    </span><span class="c1">// å¯å‘å¼å‰ªæ</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isValidConfig</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">hw</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">configs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">configs</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isValidConfig</span><span class="p">(</span><span class="n">KernelConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">Constraints</span><span class="o">&amp;</span><span class="w"> </span><span class="n">hw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å ç”¨ç‡æ£€æŸ¥</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">blocksPerSM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hw</span><span class="p">.</span><span class="n">maxThreadsPerBlock</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blocksPerSM</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å¯„å­˜å™¨å‹åŠ›ä¼°è®¡</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">estimatedRegs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;TILE_SIZE&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">estimatedRegs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2033">20.3.3 è´å¶æ–¯ä¼˜åŒ–ç­–ç•¥</h3>
<p>è´å¶æ–¯ä¼˜åŒ–é€šè¿‡å»ºç«‹æ€§èƒ½æ¨¡å‹æ¥æŒ‡å¯¼æœç´¢ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BayesianOptimizer</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// é«˜æ–¯è¿‡ç¨‹æ¨¡å‹</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">GaussianProcess</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">fit</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KernelConfig</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">configs</span><span class="p">,</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">performances</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// æ„å»ºåæ–¹å·®çŸ©é˜µ</span>
<span class="w">            </span><span class="c1">// ä½¿ç”¨RBFæ ¸å‡½æ•°</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">KernelConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// è¿”å›å‡å€¼å’Œæ–¹å·®</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// è®¡ç®—é¢„æµ‹...</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">variance</span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">GaussianProcess</span><span class="w"> </span><span class="n">gp</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="nf">acquisitionFunction</span><span class="p">(</span><span class="n">KernelConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="p">[</span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">variance</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gp</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Expected Improvement (EI)</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">best_so_far</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getBestPerformance</span><span class="p">();</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">improvement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best_so_far</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">variance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-6f</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">improvement</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">variance</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">ei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">improvement</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">normcdf</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">normpdf</span><span class="p">(</span><span class="n">Z</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ei</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">optimize</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">**</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KernelConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">evaluated</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">performances</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åˆå§‹éšæœºé‡‡æ ·</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">randomSample</span><span class="p">();</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">perf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluateKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
<span class="w">            </span><span class="n">evaluated</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="w">            </span><span class="n">performances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">perf</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è´å¶æ–¯ä¼˜åŒ–è¿­ä»£</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">gp</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">evaluated</span><span class="p">,</span><span class="w"> </span><span class="n">performances</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// é€‰æ‹©ä¸‹ä¸€ä¸ªé‡‡æ ·ç‚¹</span>
<span class="w">            </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">nextConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argmax</span><span class="p">(</span><span class="n">acquisitionFunction</span><span class="p">);</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">perf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluateKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">nextConfig</span><span class="p">);</span>

<span class="w">            </span><span class="n">evaluated</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">nextConfig</span><span class="p">);</span>
<span class="w">            </span><span class="n">performances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">perf</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getBestConfig</span><span class="p">(</span><span class="n">evaluated</span><span class="p">,</span><span class="w"> </span><span class="n">performances</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2034">20.3.4 é—ä¼ ç®—æ³•ä¼˜åŒ–</h3>
<p>é—ä¼ ç®—æ³•é€‚åˆç¦»æ•£çš„å¤§è§„æ¨¡æœç´¢ç©ºé—´ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GeneticOptimizer</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Individual</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">fitness</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Individual</span><span class="o">&gt;</span><span class="w"> </span><span class="n">population</span><span class="p">;</span>

<span class="w">    </span><span class="n">Individual</span><span class="w"> </span><span class="nf">crossover</span><span class="p">(</span><span class="n">Individual</span><span class="o">&amp;</span><span class="w"> </span><span class="n">parent1</span><span class="p">,</span><span class="w"> </span><span class="n">Individual</span><span class="o">&amp;</span><span class="w"> </span><span class="n">parent2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Individual</span><span class="w"> </span><span class="n">child</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å‡åŒ€äº¤å‰</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">child</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent1</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">child</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent2</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å‚æ•°äº¤å‰</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">parent1</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">child</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">child</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent2</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">child</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Individual</span><span class="o">&amp;</span><span class="w"> </span><span class="n">individual</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">mutationRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">randf</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mutationRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// éšæœºæ”¹å˜block size</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">blockSizes</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">};</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">            </span><span class="n">individual</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockSizes</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å‚æ•°çªå˜</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">individual</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">randf</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mutationRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutateParameter</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">KernelConfig</span><span class="w"> </span><span class="n">evolve</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">**</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">generations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">POP_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">MUTATION_RATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ELITE_RATIO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2f</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ–ç§ç¾¤</span>
<span class="w">        </span><span class="n">population</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateRandomPopulation</span><span class="p">(</span><span class="n">POP_SIZE</span><span class="p">);</span>
<span class="w">        </span><span class="n">evaluatePopulation</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">generations</span><span class="p">;</span><span class="w"> </span><span class="n">gen</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">population</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">population</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="w">                     </span><span class="p">[](</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">fitness</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">fitness</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>

<span class="w">            </span><span class="c1">// ç²¾è‹±ä¿ç•™</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">eliteSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POP_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ELITE_RATIO</span><span class="p">;</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Individual</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newPopulation</span><span class="p">(</span>
<span class="w">                </span><span class="n">population</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">population</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eliteSize</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// äº¤å‰å’Œçªå˜</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">newPopulation</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">POP_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Individual</span><span class="w"> </span><span class="n">parent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tournamentSelection</span><span class="p">();</span>
<span class="w">                </span><span class="n">Individual</span><span class="w"> </span><span class="n">parent2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tournamentSelection</span><span class="p">();</span>
<span class="w">                </span><span class="n">Individual</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crossover</span><span class="p">(</span><span class="n">parent1</span><span class="p">,</span><span class="w"> </span><span class="n">parent2</span><span class="p">);</span>
<span class="w">                </span><span class="n">mutate</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">MUTATION_RATE</span><span class="p">);</span>
<span class="w">                </span><span class="n">newPopulation</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">population</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newPopulation</span><span class="p">;</span>
<span class="w">            </span><span class="n">evaluatePopulation</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2035">20.3.5 æ€§èƒ½æ¨¡å‹ä¸é¢„æµ‹</h3>
<p>æ„å»ºå‡†ç¡®çš„æ€§èƒ½æ¨¡å‹å¯ä»¥å‡å°‘å®é™…è¯„ä¼°æ¬¡æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceModel</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">HardwareFeatures</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">peakGFLOPS</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">memoryBandwidth</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">smCount</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">l2CacheSize</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">HardwareFeatures</span><span class="w"> </span><span class="n">hw</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">predictKernelTime</span><span class="p">(</span><span class="n">KernelConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="kt">int</span><span class="w"> </span><span class="n">computeOps</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">memoryOps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Rooflineæ¨¡å‹é¢„æµ‹</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">arithmeticIntensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">computeOps</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">memoryOps</span><span class="p">;</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">computeTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeOps</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">peakGFLOPS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">memoryTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memoryOps</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">memoryBandwidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è€ƒè™‘å ç”¨ç‡</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">threadsPerSM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">,</span><span class="w"> </span><span class="n">threadsPerSM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2048.0f</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è€ƒè™‘ç¼“å­˜æ•ˆæœ</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">cacheHitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimateCacheHitRate</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">effectiveMemTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memoryTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cacheHitRate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.8f</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">computeTime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">occupancy</span><span class="p">,</span><span class="w"> </span><span class="n">effectiveMemTime</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">estimateCacheHitRate</span><span class="p">(</span><span class="n">KernelConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">workingSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;TILE_SIZE&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>
<span class="w">                        </span><span class="n">config</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;TILE_SIZE&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">workingSet</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hw</span><span class="p">.</span><span class="n">l2CacheSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">0.8f</span><span class="p">;</span><span class="w">  </span><span class="c1">// é«˜ç¼“å­˜å‘½ä¸­ç‡</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">0.2f</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä½ç¼“å­˜å‘½ä¸­ç‡</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="204-jit">20.4 JITç¼–è¯‘ä¼˜åŒ–</h2>
<h3 id="2041-nvrtc">20.4.1 NVRTCè¿è¡Œæ—¶ç¼–è¯‘</h3>
<p>NVRTCï¼ˆNVIDIA Runtime Compilationï¼‰å…è®¸åœ¨è¿è¡Œæ—¶ç¼–è¯‘CUDAä»£ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JITCompiler</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">nvrtcProgram</span><span class="w"> </span><span class="n">prog</span><span class="p">;</span>
<span class="w">    </span><span class="n">CUmodule</span><span class="w"> </span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">CUfunction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">functionCache</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">compileKernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">kernelName</span><span class="p">,</span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆ›å»ºç¨‹åº</span>
<span class="w">        </span><span class="n">nvrtcCreateProgram</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                          </span><span class="p">(</span><span class="n">kernelName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.cu&quot;</span><span class="p">).</span><span class="n">c_str</span><span class="p">(),</span>
<span class="w">                          </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç¼–è¯‘é€‰é¡¹</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">opts</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">opts</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ç¼–è¯‘</span>
<span class="w">        </span><span class="n">nvrtcResult</span><span class="w"> </span><span class="n">compileResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nvrtcCompileProgram</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                        </span><span class="n">opts</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                                                        </span><span class="n">opts</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compileResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NVRTC_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">logSize</span><span class="p">;</span>
<span class="w">            </span><span class="n">nvrtcGetProgramLogSize</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">logSize</span><span class="p">);</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">logSize</span><span class="p">);</span>
<span class="w">            </span><span class="n">nvrtcGetProgramLog</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Compilation failed: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                   </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="n">data</span><span class="p">()));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è·å–PTX</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">ptxSize</span><span class="p">;</span>
<span class="w">        </span><span class="n">nvrtcGetPTXSize</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptxSize</span><span class="p">);</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ptx</span><span class="p">(</span><span class="n">ptxSize</span><span class="p">);</span>
<span class="w">        </span><span class="n">nvrtcGetPTX</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="n">ptx</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// åŠ è½½æ¨¡å—</span>
<span class="w">        </span><span class="n">cuModuleLoadDataEx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="n">ptx</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è·å–å‡½æ•°</span>
<span class="w">        </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">kernel</span><span class="p">;</span>
<span class="w">        </span><span class="n">cuModuleGetFunction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="n">kernelName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">        </span><span class="n">functionCache</span><span class="p">[</span><span class="n">kernelName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span><span class="w"> </span><span class="n">Args</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">launchKernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">kernelName</span><span class="p">,</span>
<span class="w">                     </span><span class="n">dim3</span><span class="w"> </span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="n">block</span><span class="p">,</span>
<span class="w">                     </span><span class="n">Args</span><span class="p">...</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">functionCache</span><span class="p">[</span><span class="n">kernelName</span><span class="p">];</span>

<span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">kernelArgs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">...</span><span class="w"> </span><span class="p">};</span>

<span class="w">        </span><span class="n">cuLaunchKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span>
<span class="w">                      </span><span class="n">grid</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                      </span><span class="n">block</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                      </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                      </span><span class="n">kernelArgs</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2042">20.4.2 æ¨¡æ¿å…ƒç¼–ç¨‹ä¸ä»£ç ç”Ÿæˆ</h3>
<p>ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆç‰¹åŒ–çš„å†…æ ¸ä»£ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KernelGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">generateGEMMKernel</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>

<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;#define TILE_M &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TILE_M</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;#define TILE_N &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TILE_N</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;#define TILE_K &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TILE_K</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;__global__ void gemm_kernel(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    const float* __restrict__ A,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    const float* __restrict__ B,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    float* __restrict__ C,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    const int M, const int N, const int K) {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    __shared__ float As[TILE_M][TILE_K];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    __shared__ float Bs[TILE_K][TILE_N];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    int bx = blockIdx.x, by = blockIdx.y;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    int tx = threadIdx.x, ty = threadIdx.y;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    int row = by * TILE_M + ty;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    int col = bx * TILE_N + tx;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    float sum = 0.0f;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ä¸»å¾ªç¯</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    for (int tile = 0; tile &lt; (K + TILE_K - 1) / TILE_K; tile++) {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        // Load tiles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        if (row &lt; M &amp;&amp; tile * TILE_K + tx &lt; K) {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;            As[ty][tx] = A[row * K + tile * TILE_K + tx];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        } else {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;            As[ty][tx] = 0.0f;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        if (col &lt; N &amp;&amp; tile * TILE_K + ty &lt; K) {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;            Bs[ty][tx] = B[(tile * TILE_K + ty) * N + col];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        } else {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;            Bs[ty][tx] = 0.0f;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        __syncthreads();</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// è®¡ç®—</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        #pragma unroll</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        for (int k = 0; k &lt; TILE_K; k++) {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;            sum += As[ty][k] * Bs[k][tx];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        __syncthreads();</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å­˜å‚¨ç»“æœ</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    if (row &lt; M &amp;&amp; col &lt; N) {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;        C[row * N + col] = sum;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">generateOptimizedGEMM</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ ¹æ®é—®é¢˜è§„æ¨¡é€‰æ‹©tile size</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_M</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_N</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_K</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TILE_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TILE_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">            </span><span class="n">TILE_K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TILE_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TILE_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">            </span><span class="n">TILE_K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateGEMMKernel</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                               </span><span class="n">TILE_M</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_N</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_K</span><span class="p">);</span>

<span class="w">        </span><span class="n">JITCompiler</span><span class="w"> </span><span class="n">compiler</span><span class="p">;</span>
<span class="w">        </span><span class="n">compiler</span><span class="p">.</span><span class="n">compileKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;gemm_kernel&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="p">{</span><span class="s">&quot;-arch=sm_80&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-use_fast_math&quot;</span><span class="p">});</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">compiler</span><span class="p">.</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;gemm_kernel&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2043">20.4.3 ç¼“å­˜ç­–ç•¥ä¸æŒä¹…åŒ–</h3>
<p>JITç¼–è¯‘ç»“æœçš„ç¼“å­˜å¯¹æ€§èƒ½è‡³å…³é‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KernelCache</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">CacheEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">source</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ptx</span><span class="p">;</span>
<span class="w">        </span><span class="n">CUmodule</span><span class="w"> </span><span class="k">module</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">CUfunction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">functions</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lastAccess</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">CacheEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cache</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxCacheSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">computeHash</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">                      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">hasher</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">hash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">hasher</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x9e3779b9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">hash</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">evictLRU</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxCacheSize</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">oldest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">lastAccess</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">oldest</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">lastAccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">oldest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">cuModuleUnload</span><span class="p">(</span><span class="n">oldest</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="k">module</span><span class="p">);</span>
<span class="w">        </span><span class="n">cache</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">oldest</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">getOrCompile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">kernelName</span><span class="p">,</span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeHash</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥ç¼“å­˜</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">lastAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">functions</span><span class="p">[</span><span class="n">kernelName</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ç¼–è¯‘æ–°å†…æ ¸</span>
<span class="w">        </span><span class="n">evictLRU</span><span class="p">();</span>

<span class="w">        </span><span class="n">CacheEntry</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
<span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source</span><span class="p">;</span>
<span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">lastAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ç¼–è¯‘å¹¶ç¼“å­˜</span>
<span class="w">        </span><span class="n">compileAndCache</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">kernelName</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="w">        </span><span class="n">cache</span><span class="p">[</span><span class="n">hash</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">functions</span><span class="p">[</span><span class="n">kernelName</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">persistCache</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">numEntries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">numEntries</span><span class="p">),</span><span class="w"> </span>
<span class="w">                  </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numEntries</span><span class="p">));</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ä¿å­˜hash</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hash</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>

<span class="w">            </span><span class="c1">// ä¿å­˜PTX</span>
<span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">ptxSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">ptx</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptxSize</span><span class="p">),</span><span class="w"> </span>
<span class="w">                      </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ptxSize</span><span class="p">));</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">ptx</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">ptxSize</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">loadCache</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">is_open</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">numEntries</span><span class="p">;</span>
<span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">numEntries</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numEntries</span><span class="p">));</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numEntries</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">hash</span><span class="p">;</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hash</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>

<span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">ptxSize</span><span class="p">;</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptxSize</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ptxSize</span><span class="p">));</span>

<span class="w">            </span><span class="n">CacheEntry</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
<span class="w">            </span><span class="n">entry</span><span class="p">.</span><span class="n">ptx</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">ptxSize</span><span class="p">);</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">ptx</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">ptxSize</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// åŠ è½½æ¨¡å—</span>
<span class="w">            </span><span class="n">cuModuleLoadData</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">.</span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">ptx</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">            </span><span class="n">cache</span><span class="p">[</span><span class="n">hash</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2044-kernel-specialization">20.4.4 åŠ¨æ€Kernel Specialization</h3>
<p>æ ¹æ®è¿è¡Œæ—¶å‚æ•°ç”Ÿæˆç‰¹åŒ–ç‰ˆæœ¬ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DynamicKernelSpecializer</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Specialization</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constants</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">generateSpecializedCode</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Specialization</span><span class="o">&amp;</span><span class="w"> </span><span class="n">spec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ›¿æ¢å¸¸é‡</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="n">constants</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">code</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">placeholder</span><span class="p">.</span><span class="n">length</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">                </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">specializeForProblem</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">useTensorCore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Specialization</span><span class="w"> </span><span class="n">spec</span><span class="p">;</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;specialized_gemm&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åŸºç¡€æ¨¡æ¿</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span>
<span class="s">            extern &quot;C&quot; __global__ void specialized_gemm(</span>
<span class="s">                const TYPE* A, const TYPE* B, TYPE* C) {</span>

<span class="s">                const int M = CONST_M;</span>
<span class="s">                const int N = CONST_N;</span>
<span class="s">                const int K = CONST_K;</span>

<span class="s">                // ç‰¹åŒ–çš„å†…å¾ªç¯</span>
<span class="s">                #if USE_TENSOR_CORE</span>
<span class="s">                    // Tensor Coreè·¯å¾„</span>
<span class="s">                    wmma::fragment&lt;...&gt; a_frag, b_frag, c_frag;</span>
<span class="s">                    // ...</span>
<span class="s">                #else</span>
<span class="s">                    // å¸¸è§„è·¯å¾„</span>
<span class="s">                    TYPE sum = 0;</span>
<span class="s">                    #pragma unroll UNROLL_FACTOR</span>
<span class="s">                    for (int k = 0; k &lt; K; k++) {</span>
<span class="s">                        sum += A[...] * B[...];</span>
<span class="s">                    }</span>
<span class="s">                #endif</span>

<span class="s">                C[...] = sum;</span>
<span class="s">            }</span>
<span class="s">        </span><span class="dl">)</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// è®¾ç½®å¸¸é‡</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;TYPE&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;float&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;half&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;CONST_M&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">M</span><span class="p">);</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;CONST_N&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;CONST_K&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">K</span><span class="p">);</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;USE_TENSOR_CORE&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">useTensorCore</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ ¹æ®Kçš„å¤§å°é€‰æ‹©å±•å¼€å› å­</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">unrollFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="n">unrollFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="n">unrollFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="n">unrollFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">        </span><span class="n">spec</span><span class="p">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;UNROLL_FACTOR&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">unrollFactor</span><span class="p">);</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">specializedCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateSpecializedCode</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// JITç¼–è¯‘</span>
<span class="w">        </span><span class="n">JITCompiler</span><span class="w"> </span><span class="n">compiler</span><span class="p">;</span>
<span class="w">        </span><span class="n">compiler</span><span class="p">.</span><span class="n">compileKernel</span><span class="p">(</span><span class="n">specializedCode</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="p">{</span><span class="s">&quot;-arch=sm_80&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-maxrregcount=128&quot;</span><span class="p">});</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">compiler</span><span class="p">.</span><span class="n">getFunction</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2045-ptx">20.4.5 PTXçº§ä¼˜åŒ–</h3>
<p>ç›´æ¥ç”Ÿæˆä¼˜åŒ–çš„PTXä»£ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PTXGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">generateOptimizedPTX</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">operation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ptx</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// PTXå¤´éƒ¨</span>
<span class="w">        </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.version 7.5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.target sm_80</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.address_size 64</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">operation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;fast_exp&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å¿«é€ŸæŒ‡æ•°å‡½æ•°å®ç°</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.visible .entry fast_exp(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    .param .u64 .ptr.global.align 4 input,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    .param .u64 .ptr.global.align 4 output,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    .param .u32 n</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    .reg .f32 %f&lt;4&gt;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    .reg .pred %p&lt;2&gt;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    .reg .b32 %r&lt;8&gt;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    .reg .b64 %rd&lt;8&gt;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// è·å–çº¿ç¨‹ç´¢å¼•</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    mov.u32 %r1, %ctaid.x;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    mov.u32 %r2, %ntid.x;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    mov.u32 %r3, %tid.x;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    mad.lo.s32 %r4, %r1, %r2, %r3;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// è¾¹ç•Œæ£€æŸ¥</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    ld.param.u32 %r5, [n];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    setp.ge.u32 %p1, %r4, %r5;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    @%p1 bra EXIT;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// åŠ è½½æ•°æ®</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    ld.param.u64 %rd1, [input];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    cvta.to.global.u64 %rd2, %rd1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    mul.wide.u32 %rd3, %r4, 4;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    add.s64 %rd4, %rd2, %rd3;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    ld.global.f32 %f1, [%rd4];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// å¿«é€Ÿexpè¿‘ä¼¼ï¼ˆä½¿ç”¨ç¡¬ä»¶ç‰¹æ®Šå‡½æ•°ï¼‰</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    ex2.approx.f32 %f2, %f1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// å­˜å‚¨ç»“æœ</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    ld.param.u64 %rd5, [output];</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    cvta.to.global.u64 %rd6, %rd5;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    add.s64 %rd7, %rd6, %rd3;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    st.global.f32 [%rd7], %f2;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;EXIT:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    ret;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ptx</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">compilePTX</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">operation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ptxCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateOptimizedPTX</span><span class="p">(</span><span class="n">operation</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ä½¿ç”¨cuModuleLoadDataåŠ è½½PTX</span>
<span class="w">        </span><span class="n">CUmodule</span><span class="w"> </span><span class="k">module</span><span class="p">;</span>
<span class="w">        </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">kernel</span><span class="p">;</span>

<span class="w">        </span><span class="n">cuModuleLoadData</span><span class="p">(</span><span class="o">&amp;</span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="n">ptxCode</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">        </span><span class="n">cuModuleGetFunction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="n">operation</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">kernel</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">## 20.5 æ¡ˆä¾‹ï¼šç«¯åˆ°ç«¯æ¨ç†ä¼˜åŒ–</span>

<span class="n">æœ¬èŠ‚å°†ä»¥Transformeræ¨¡å‹çš„æ¨ç†ä¼˜åŒ–ä¸ºä¾‹</span><span class="err">ï¼Œ</span><span class="n">å±•ç¤ºå¦‚ä½•ç»¼åˆè¿ç”¨CUDA</span><span class="w"> </span><span class="n">Graph</span><span class="err">ã€</span><span class="n">å†…æ ¸èåˆ</span><span class="err">ã€</span><span class="n">JITç¼–è¯‘ç­‰æŠ€æœ¯å®ç°ç«¯åˆ°ç«¯çš„æ€§èƒ½ä¼˜åŒ–</span><span class="err">ã€‚</span><span class="n">æˆ‘ä»¬å°†ä»ä¸€ä¸ªæœªä¼˜åŒ–çš„baselineå®ç°å¼€å§‹</span><span class="err">ï¼Œ</span><span class="n">é€æ­¥åº”ç”¨å„ç§ä¼˜åŒ–æŠ€æœ¯</span><span class="err">ï¼Œ</span><span class="n">æœ€ç»ˆå®ç°10xä»¥ä¸Šçš„æ€§èƒ½æå‡</span><span class="err">ã€‚</span>

<span class="cp">### 20.5.1 Baselineå®ç°åˆ†æ</span>

<span class="n">é¦–å…ˆåˆ†ææœªä¼˜åŒ–çš„Transformeræ¨ç†å®ç°</span><span class="err">ï¼š</span>

<span class="err">```</span><span class="n">cpp</span>
<span class="c1">// Baselineå®ç°ï¼šé€å±‚æ‰§è¡Œï¼Œæ— èåˆ</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TransformerBaseline</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// å„å±‚æƒé‡</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">wq</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">wk</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">wv</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">wo</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">w2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">ln1_gamma</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ln1_beta</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">ln2_gamma</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ln2_beta</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">forward</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// ä¸´æ—¶ç¼“å†²åŒº</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">attn_scores</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">attn_output</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">ffn_hidden</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">residual</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Layer Norm 1</span>
<span class="w">        </span><span class="n">layerNorm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">ln1_gamma</span><span class="p">,</span><span class="w"> </span><span class="n">ln1_beta</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="n">residual</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Multi-Head Attention</span>
<span class="w">        </span><span class="c1">// QKVæŠ•å½±ï¼ˆ3ä¸ªç‹¬ç«‹å†…æ ¸ï¼‰</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span><span class="w"> </span><span class="n">wq</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span><span class="w"> </span><span class="n">wk</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span><span class="w"> </span><span class="n">wv</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Attentionè®¡ç®—</span>
<span class="w">        </span><span class="n">computeAttention</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">attn_scores</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// OutputæŠ•å½±</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">attn_scores</span><span class="p">,</span><span class="w"> </span><span class="n">wo</span><span class="p">,</span><span class="w"> </span><span class="n">attn_output</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Residualè¿æ¥</span>
<span class="w">        </span><span class="n">elementwiseAdd</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">attn_output</span><span class="p">,</span><span class="w"> </span><span class="n">residual</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Layer Norm 2</span>
<span class="w">        </span><span class="n">layerNorm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span><span class="w"> </span><span class="n">ln2_gamma</span><span class="p">,</span><span class="w"> </span><span class="n">ln2_beta</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// FFN</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="n">ffn_hidden</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span>
<span class="w">                             </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// GELUæ¿€æ´»</span>
<span class="w">        </span><span class="n">gelu</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">ffn_hidden</span><span class="p">,</span><span class="w"> </span><span class="n">ffn_hidden</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// FFNè¾“å‡º</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">ffn_hidden</span><span class="p">,</span><span class="w"> </span><span class="n">w2</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span>
<span class="w">                             </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æœ€ç»ˆresidual</span>
<span class="w">        </span><span class="n">elementwiseAdd</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// æ€§èƒ½åˆ†æç»“æœï¼š</span>
<span class="c1">// - 12ä¸ªç‹¬ç«‹çš„å†…æ ¸å¯åŠ¨</span>
<span class="c1">// - å¤§é‡ä¸­é—´ç»“æœå†™å…¥å…¨å±€å†…å­˜</span>
<span class="c1">// - æ— å†…æ ¸é—´å¹¶è¡Œ</span>
<span class="c1">// - å°batchæ—¶GPUåˆ©ç”¨ç‡ä½</span>
</code></pre></div>

<h3 id="2052-graph">20.5.2 Graphä¼˜åŒ–å®ç°</h3>
<p>ä½¿ç”¨CUDA Graphå‡å°‘å†…æ ¸å¯åŠ¨å¼€é”€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TransformerGraphOptimized</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">cudaGraph_t</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaGraphExec_t</span><span class="w"> </span><span class="n">graphExec</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// é¢„åˆ†é…çš„ç¼“å†²åŒº</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">BufferPool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">attn_scores</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">attn_output</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">ffn_hidden</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">residual</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">  </span><span class="c1">// åŒç¼“å†²</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">current_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">swap_residual</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">current_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_residual</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">buffers</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildGraph</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¼€å§‹æ•è·</span>
<span class="w">        </span><span class="n">cudaStreamBeginCapture</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStreamCaptureModeGlobal</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ä½¿ç”¨å¤šæµå¹¶è¡Œ</span>
<span class="w">        </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="w">        </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">event_qkv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream_qkv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_qkv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Layer Norm 1</span>
<span class="w">        </span><span class="n">layerNorm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">ln1_gamma</span><span class="p">,</span><span class="w"> </span><span class="n">ln1_beta</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">residual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">            </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¹¶è¡ŒQKVæŠ•å½±</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">event_start</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>

<span class="w">        </span><span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">event_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">buffers</span><span class="p">.</span><span class="n">residual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">wq</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">q</span><span class="p">,</span>
<span class="w">            </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">event_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="w">        </span><span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">event_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">buffers</span><span class="p">.</span><span class="n">residual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">wk</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">k</span><span class="p">,</span>
<span class="w">            </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">event_qkv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">        </span><span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">event_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">gemm</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">buffers</span><span class="p">.</span><span class="n">residual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">wv</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">v</span><span class="p">,</span>
<span class="w">            </span><span class="n">batch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">event_qkv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">stream_qkv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…QKVå®Œæˆ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">event_qkv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Attentionè®¡ç®—</span>
<span class="w">        </span><span class="n">computeAttention</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">buffers</span><span class="p">.</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">attn_scores</span><span class="p">,</span>
<span class="w">            </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç»§ç»­æ‰§è¡Œ...</span>

<span class="w">        </span><span class="c1">// ç»“æŸæ•è·</span>
<span class="w">        </span><span class="n">cudaStreamEndCapture</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">graph</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å®ä¾‹åŒ–</span>
<span class="w">        </span><span class="n">cudaGraphInstantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">forward</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç›´æ¥æ‰§è¡Œé¢„æ„å»ºçš„å›¾</span>
<span class="w">        </span><span class="n">cudaGraphLaunch</span><span class="p">(</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// ä¼˜åŒ–æ•ˆæœï¼š</span>
<span class="c1">// - å•æ¬¡APIè°ƒç”¨æ‰§è¡Œæ•´ä¸ªç½‘ç»œ</span>
<span class="c1">// - QKVæŠ•å½±å¹¶è¡Œæ‰§è¡Œ</span>
<span class="c1">// - æ¶ˆé™¤CPU-GPUåŒæ­¥å¼€é”€</span>
<span class="c1">// - çº¦2xåŠ é€Ÿ</span>
</code></pre></div>

<h3 id="2053">20.5.3 å†…æ ¸èåˆä¼˜åŒ–</h3>
<p>èåˆå¤šä¸ªæ“ä½œå‡å°‘å†…å­˜è®¿é—®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// èåˆçš„Attentionå†…æ ¸</span>
<span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NUM_HEADS</span><span class="o">&gt;</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fusedMultiHeadAttention</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w">      </span><span class="c1">// [batch, seq_len, hidden_dim]</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">wqkv</span><span class="p">,</span><span class="w">       </span><span class="c1">// [hidden_dim, 3 * hidden_dim]</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">wo</span><span class="p">,</span><span class="w">         </span><span class="c1">// [hidden_dim, hidden_dim]</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w">     </span><span class="c1">// [batch, seq_len, hidden_dim]</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">ln_gamma</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">ln_beta</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NUM_HEADS</span><span class="p">;</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">shared_mem</span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// å…±äº«å†…å­˜å¸ƒå±€</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">q_smem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shared_mem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">k_smem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">q_smem</span><span class="p">[</span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">v_smem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">k_smem</span><span class="p">[</span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">attn_smem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v_smem</span><span class="p">[</span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">batch_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">head_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seq_idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">seq_len</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Step 1: LayerNorm + QKVæŠ•å½±ï¼ˆèåˆï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">norm_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">hidden_dim</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®¡ç®—LayerNormç»Ÿè®¡é‡</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                         </span><span class="n">seq_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">mean</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">mean</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                         </span><span class="n">seq_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">var</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-6f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// èåˆLayerNormå’ŒQKVæŠ•å½±</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">q_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">k_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">v_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">[...]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">var</span><span class="p">;</span>
<span class="w">        </span><span class="n">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ln_gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ln_beta</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// ç›´æ¥æŠ•å½±åˆ°QKV</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">qkv_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="p">;</span>
<span class="w">        </span><span class="n">q_val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wqkv</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qkv_offset</span><span class="p">];</span>
<span class="w">        </span><span class="n">k_val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wqkv</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qkv_offset</span><span class="p">];</span>
<span class="w">        </span><span class="n">v_val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wqkv</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qkv_offset</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å­˜å‚¨åˆ°å…±äº«å†…å­˜</span>
<span class="w">    </span><span class="n">q_smem</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q_val</span><span class="p">;</span>
<span class="w">    </span><span class="n">k_smem</span><span class="p">[</span><span class="n">seq_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_val</span><span class="p">;</span>
<span class="w">    </span><span class="n">v_smem</span><span class="p">[</span><span class="n">seq_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v_val</span><span class="p">;</span>

<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Step 2: Attentionè®¡ç®—ï¼ˆèåˆsoftmaxï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">attn_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">max_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">FLT_MAX</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Online softmaxï¼ˆå•passï¼‰</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">seq_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q_smem</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>
<span class="w">                    </span><span class="n">k_smem</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">score</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">norm_scale</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Online softmaxæ›´æ–°</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">old_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_score</span><span class="p">;</span>
<span class="w">        </span><span class="n">max_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">max_score</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">exp_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expf</span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">max_score</span><span class="p">);</span>

<span class="w">        </span><span class="n">attn_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attn_sum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">expf</span><span class="p">(</span><span class="n">old_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">max_score</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">exp_score</span><span class="p">;</span>
<span class="w">        </span><span class="n">attn_smem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_score</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Step 3: åŠ æƒæ±‚å’ŒV + è¾“å‡ºæŠ•å½±ï¼ˆèåˆï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">out_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">seq_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">attn_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attn_smem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">attn_sum</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">out_val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">attn_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v_smem</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è¾“å‡ºæŠ•å½±å’Œresidualè¿æ¥ï¼ˆèåˆï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">out_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batch_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                 </span><span class="n">seq_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">head_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">HEAD_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">proj_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_HEADS</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">proj_val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out_val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wo</span><span class="p">[...];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Residualè¿æ¥</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">out_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">out_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">proj_val</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// èåˆçš„FFNå±‚</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fusedFFN</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">w2</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">ln_gamma</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">ln_beta</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">batch_seq_len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">batch_seq_len</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// èåˆLayerNorm + FFN + GELU + æŠ•å½±</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// LayerNorm</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mean</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">mean</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">var</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-6f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// FFN withèåˆGELU</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">out_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">out_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">out_i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">in_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">in_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">in_i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">in_i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">var</span><span class="p">;</span>
<span class="w">            </span><span class="n">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ln_gamma</span><span class="p">[</span><span class="n">in_i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ln_beta</span><span class="p">[</span><span class="n">in_i</span><span class="p">];</span>
<span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">w1</span><span class="p">[</span><span class="n">in_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">out_i</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// GELUæ¿€æ´»ï¼ˆèåˆï¼‰</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">gelu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tanhf</span><span class="p">(</span><span class="mf">0.7978845608f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>
<span class="w">                    </span><span class="p">(</span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.044715f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sum</span><span class="p">)));</span>

<span class="w">        </span><span class="c1">// ç¬¬äºŒå±‚æŠ•å½±ï¼ˆèåˆï¼‰</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">final_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">final_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">;</span><span class="w"> </span><span class="n">final_i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">final_i</span><span class="p">],</span>
<span class="w">                     </span><span class="n">gelu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">w2</span><span class="p">[</span><span class="n">out_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">final_i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä¼˜åŒ–æ•ˆæœï¼š</span>
<span class="c1">// - å‡å°‘70%çš„å†…å­˜è®¿é—®</span>
<span class="c1">// - æ¶ˆé™¤ä¸­é—´ç»“æœå­˜å‚¨</span>
<span class="c1">// - çº¦5xåŠ é€Ÿ</span>
</code></pre></div>

<h3 id="2054">20.5.4 åŠ¨æ€æ‰¹å¤„ç†ä¼˜åŒ–</h3>
<p>å¤„ç†å¯å˜é•¿åº¦è¾“å…¥çš„ä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DynamicBatchingOptimizer</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Request</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">request_id</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pending_requests</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">queue_mutex</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Paddingç­–ç•¥</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">getPaddedLength</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å‘ä¸Šå–æ•´åˆ°32çš„å€æ•°ï¼ˆwarpå¯¹é½ï¼‰</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">seq_len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">processBatch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="w"> </span><span class="n">batch</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">total_tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">max_seq_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ”¶é›†è¯·æ±‚å½¢æˆæ‰¹æ¬¡</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">queue_mutex</span><span class="p">);</span>

<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pending_requests</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">batch</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Request</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pending_requests</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// æ£€æŸ¥æ˜¯å¦è¶…è¿‡tokené¢„ç®—</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">total_tokens</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">seq_len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>

<span class="w">                </span><span class="n">pending_requests</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">                </span><span class="n">batch</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="w">                </span><span class="n">total_tokens</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">seq_len</span><span class="p">;</span>
<span class="w">                </span><span class="n">max_seq_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">max_seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">seq_len</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åŠ¨æ€é€‰æ‹©æ‰§è¡Œç­–ç•¥</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å•è¯·æ±‚ï¼šä½¿ç”¨ä¸“é—¨ä¼˜åŒ–çš„å°batchå†…æ ¸</span>
<span class="w">            </span><span class="n">executeSingleRequest</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max_seq_len</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// çŸ­åºåˆ—ï¼šä½¿ç”¨èåˆå†…æ ¸</span>
<span class="w">            </span><span class="n">executeShortSequenceBatch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">max_seq_len</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é•¿åºåˆ—ï¼šä½¿ç”¨åˆ†å—å¤„ç†</span>
<span class="w">            </span><span class="n">executeLongSequenceBatch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">max_seq_len</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">executeShortSequenceBatch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">max_seq_len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">padded_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPaddedLength</span><span class="p">(</span><span class="n">max_seq_len</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batch</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// åˆ†é…è¿ç»­å†…å­˜</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">batch_input</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">batch_output</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">batch_input</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padded_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">batch_output</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padded_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// æ‰“åŒ…è¾“å…¥ï¼ˆwith paddingï¼‰</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">batch_size</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaMemcpy2D</span><span class="p">(</span><span class="n">batch_input</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padded_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span>
<span class="w">                        </span><span class="n">padded_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                        </span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">input</span><span class="p">,</span>
<span class="w">                        </span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                        </span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                        </span><span class="n">hidden_dim</span><span class="p">,</span>
<span class="w">                        </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Paddingä½ç½®è®¾ç½®ä¸º0</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">seq_len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">padded_len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cudaMemset</span><span class="p">(</span><span class="n">batch_input</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padded_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                          </span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span>
<span class="w">                          </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                          </span><span class="p">(</span><span class="n">padded_len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">seq_len</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ‰§è¡Œèåˆå†…æ ¸</span>
<span class="w">        </span><span class="n">dim3</span><span class="w"> </span><span class="n">grid</span><span class="p">(</span><span class="n">padded_len</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p">);</span>
<span class="w">        </span><span class="n">dim3</span><span class="w"> </span><span class="nf">block</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span><span class="w">  </span><span class="c1">// warp per sequence position</span>

<span class="w">        </span><span class="n">fusedTransformerKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">batch_input</span><span class="p">,</span><span class="w"> </span><span class="n">batch_output</span><span class="p">,</span>
<span class="w">            </span><span class="n">weights</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">padded_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è§£åŒ…è¾“å‡º</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">batch_size</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaMemcpy2D</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">output</span><span class="p">,</span>
<span class="w">                        </span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                        </span><span class="n">batch_output</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padded_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span>
<span class="w">                        </span><span class="n">padded_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                        </span><span class="n">batch</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">seq_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                        </span><span class="n">hidden_dim</span><span class="p">,</span>
<span class="w">                        </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">batch_input</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">batch_output</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// ä¼˜åŒ–æ•ˆæœï¼š</span>
<span class="c1">// - æé«˜GPUåˆ©ç”¨ç‡</span>
<span class="c1">// - å‡å°‘å†…å­˜ç¢ç‰‡</span>
<span class="c1">// - çº¦3xåŠ é€Ÿï¼ˆç›¸æ¯”é€ä¸ªå¤„ç†ï¼‰</span>
</code></pre></div>

<h3 id="2055">20.5.5 å»¶è¿Ÿéšè—æŠ€æœ¯</h3>
<p>é€šè¿‡æµæ°´çº¿åŒ–éšè—å»¶è¿Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PipelinedTransformer</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="n">NUM_STAGES</span><span class="p">];</span>
<span class="w">    </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">events</span><span class="p">[</span><span class="n">NUM_STAGES</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// ä¸‰çº§æµæ°´çº¿ç¼“å†²</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">PipelineBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">NUM_STAGES</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">current_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="nf">get_current</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">current_stage</span><span class="p">];</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="nf">get_next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">[(</span><span class="n">current_stage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">];</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">advance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="n">current_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">current_stage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">buffers</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">pipelinedForward</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">int</span><span class="w"> </span><span class="n">num_layers</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ–æµæ°´çº¿</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// é¢„çƒ­æµæ°´çº¿</span>
<span class="w">        </span><span class="c1">// Stage 0: ç¬¬1å±‚çš„å‰åŠéƒ¨åˆ†</span>
<span class="w">        </span><span class="n">layerForwardPart1</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="w">        </span><span class="c1">// ä¸»å¾ªç¯ï¼šæµæ°´çº¿æ‰§è¡Œ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_layers</span><span class="p">;</span><span class="w"> </span><span class="n">layer</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">prev_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">next_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// ç­‰å¾…å‰ä¸€é˜¶æ®µ</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">stage</span><span class="p">],</span><span class="w"> </span><span class="n">events</span><span class="p">[</span><span class="n">prev_stage</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// æ‰§è¡Œå½“å‰å±‚</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_layers</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// å¹¶è¡Œæ‰§è¡Œï¼šå½“å‰å±‚ååŠéƒ¨åˆ† + ä¸‹ä¸€å±‚å‰åŠéƒ¨åˆ†</span>

<span class="w">                </span><span class="c1">// å½“å‰å±‚ååŠéƒ¨åˆ†</span>
<span class="w">                </span><span class="n">layerForwardPart2</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">                    </span><span class="n">buffers</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">prev_stage</span><span class="p">],</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">stage</span><span class="p">],</span><span class="w"> </span><span class="n">layer</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// ä¸‹ä¸€å±‚å‰åŠéƒ¨åˆ†ï¼ˆåœ¨ä¸åŒæµä¸Šï¼‰</span>
<span class="w">                </span><span class="n">cudaStreamWaitEvent</span><span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">next_stage</span><span class="p">],</span><span class="w"> </span><span class="n">events</span><span class="p">[</span><span class="n">stage</span><span class="p">]);</span>
<span class="w">                </span><span class="n">layerForwardPart1</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="n">next_stage</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">                    </span><span class="n">buffers</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">stage</span><span class="p">],</span><span class="w"> </span><span class="n">buffers</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">next_stage</span><span class="p">],</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">next_stage</span><span class="p">],</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="n">next_stage</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// æœ€åä¸€å±‚</span>
<span class="w">                </span><span class="n">layerForwardPart2</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">                    </span><span class="n">buffers</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">prev_stage</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">layer</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">stage</span><span class="p">],</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="n">stage</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// åŒæ­¥æ‰€æœ‰æµ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_STAGES</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// ä¼˜åŒ–æ•ˆæœï¼š</span>
<span class="c1">// - éšè—å†…å­˜ä¼ è¾“å»¶è¿Ÿ</span>
<span class="c1">// - æé«˜è®¡ç®—/å†…å­˜é‡å </span>
<span class="c1">// - çº¦1.5xé¢å¤–åŠ é€Ÿ</span>
</code></pre></div>

<h3 id="2056">20.5.6 æ€§èƒ½å¯¹æ¯”ä¸åˆ†æ</h3>
<p>ç»¼åˆæ‰€æœ‰ä¼˜åŒ–æŠ€æœ¯çš„æœ€ç»ˆå®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OptimizedTransformerInference</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// ç»„åˆæ‰€æœ‰ä¼˜åŒ–æŠ€æœ¯</span>
<span class="w">    </span><span class="n">TransformerGraphOptimized</span><span class="w"> </span><span class="n">graph_optimizer</span><span class="p">;</span>
<span class="w">    </span><span class="n">DynamicBatchingOptimizer</span><span class="w"> </span><span class="n">batch_optimizer</span><span class="p">;</span>
<span class="w">    </span><span class="n">PipelinedTransformer</span><span class="w"> </span><span class="n">pipeline_optimizer</span><span class="p">;</span>
<span class="w">    </span><span class="n">JITCompiler</span><span class="w"> </span><span class="n">jit_compiler</span><span class="p">;</span>
<span class="w">    </span><span class="n">KernelCache</span><span class="w"> </span><span class="n">kernel_cache</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">PerformanceMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">baseline_time</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">graph_time</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">fusion_time</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">batching_time</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">pipeline_time</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">combined_time</span><span class="p">;</span>

<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Performance Analysis:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Baseline:        %.2f ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">baseline_time</span><span class="p">);</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;With Graph:      %.2f ms (%.2fx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">graph_time</span><span class="p">,</span><span class="w"> </span><span class="n">baseline_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">graph_time</span><span class="p">);</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;With Fusion:     %.2f ms (%.2fx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">fusion_time</span><span class="p">,</span><span class="w"> </span><span class="n">baseline_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fusion_time</span><span class="p">);</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;With Batching:   %.2f ms (%.2fx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">batching_time</span><span class="p">,</span><span class="w"> </span><span class="n">baseline_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batching_time</span><span class="p">);</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;With Pipeline:   %.2f ms (%.2fx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">pipeline_time</span><span class="p">,</span><span class="w"> </span><span class="n">baseline_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pipeline_time</span><span class="p">);</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Combined:        %.2f ms (%.2fx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">combined_time</span><span class="p">,</span><span class="w"> </span><span class="n">baseline_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">combined_time</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">benchmark</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_layers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æµ‹è¯•å„ç§ä¼˜åŒ–ç»„åˆ</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="p">;</span>
<span class="w">        </span><span class="n">allocateBuffers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Baseline</span>
<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">baseline_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeKernel</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">baselineForward</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">num_layers</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Graphä¼˜åŒ–</span>
<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">graph_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeKernel</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">graph_optimizer</span><span class="p">.</span><span class="n">forward</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// èåˆä¼˜åŒ–</span>
<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">fusion_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeKernel</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fusedForward</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">num_layers</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// æ‰¹å¤„ç†ä¼˜åŒ–</span>
<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">batching_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeKernel</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">batch_optimizer</span><span class="p">.</span><span class="n">processBatch</span><span class="p">();</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// æµæ°´çº¿ä¼˜åŒ–</span>
<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">pipeline_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeKernel</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pipeline_optimizer</span><span class="p">.</span><span class="n">pipelinedForward</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                               </span><span class="n">num_layers</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// ç»„åˆæ‰€æœ‰ä¼˜åŒ–</span>
<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">combined_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeKernel</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">combinedOptimizedForward</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">num_layers</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// è¯¦ç»†æ€§èƒ½åˆ†æ</span>
<span class="w">        </span><span class="n">profileWithNsight</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">combinedOptimizedForward</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
<span class="w">                                 </span><span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_layers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ ¹æ®è¾“å…¥ç‰¹å¾é€‰æ‹©æœ€ä¼˜ç­–ç•¥</span>
<span class="w">        </span><span class="n">OptimizationStrategy</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selectStrategy</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SMALL_BATCH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å°batchï¼šæœ€å¤§åŒ–èåˆ</span>
<span class="w">            </span><span class="n">CUfunction</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jit_compiler</span><span class="p">.</span><span class="n">specializeForProblem</span><span class="p">(</span>
<span class="w">                </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_dim</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">            </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">weights</span><span class="p">};</span>
<span class="w">            </span><span class="n">cuLaunchKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                          </span><span class="n">block</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="w">                          </span><span class="n">shared_mem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LARGE_BATCH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å¤§batchï¼šä½¿ç”¨Tensor Core + Graph</span>
<span class="w">            </span><span class="n">buildTensorCoreGraph</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">);</span>
<span class="w">            </span><span class="n">cudaGraphLaunch</span><span class="p">(</span><span class="n">tc_graph_exec</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LONG_SEQUENCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é•¿åºåˆ—ï¼šåˆ†å—å¤„ç† + æµæ°´çº¿</span>
<span class="w">            </span><span class="n">pipeline_optimizer</span><span class="p">.</span><span class="n">pipelinedForward</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
<span class="w">                                               </span><span class="n">num_layers</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">seq_len</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">profileWithNsight</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨CUPTI APIæ”¶é›†è¯¦ç»†æ€§èƒ½æ•°æ®</span>
<span class="w">        </span><span class="n">CUpti_ProfilerRange</span><span class="w"> </span><span class="n">profiler</span><span class="p">(</span><span class="s">&quot;TransformerInference&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å†…å­˜å¸¦å®½åˆ†æ</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">achieved_bandwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">profiler</span><span class="p">.</span><span class="n">getMetric</span><span class="p">(</span><span class="s">&quot;dram_throughput&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">peak_bandwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">900.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// GB/s for A100</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Memory Bandwidth Utilization: %.1f%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="n">achieved_bandwidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">peak_bandwidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è®¡ç®—ååé‡åˆ†æ</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">achieved_tflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">profiler</span><span class="p">.</span><span class="n">getMetric</span><span class="p">(</span><span class="s">&quot;flop_sp_efficiency&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">peak_tflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">19.5f</span><span class="p">;</span><span class="w">  </span><span class="c1">// TFLOPs for A100</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Compute Utilization: %.1f%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="n">achieved_tflops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">peak_tflops</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å ç”¨ç‡åˆ†æ</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">profiler</span><span class="p">.</span><span class="n">getMetric</span><span class="p">(</span><span class="s">&quot;achieved_occupancy&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Achieved Occupancy: %.1f%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å†…æ ¸æ•ˆç‡åˆ†æ</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">sm_efficiency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">profiler</span><span class="p">.</span><span class="n">getMetric</span><span class="p">(</span><span class="s">&quot;sm_efficiency&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;SM Efficiency: %.1f%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sm_efficiency</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// æœ€ç»ˆä¼˜åŒ–ç»“æœç¤ºä¾‹ï¼š</span>
<span class="c1">// Batch=1, Seq=512, Layers=12:</span>
<span class="c1">//   Baseline:      45.3 ms</span>
<span class="c1">//   Optimized:     3.8 ms (11.9x speedup)</span>
<span class="c1">//</span>
<span class="c1">// Batch=32, Seq=128, Layers=12:</span>
<span class="c1">//   Baseline:      285.6 ms</span>
<span class="c1">//   Optimized:     24.2 ms (11.8x speedup)</span>
</code></pre></div>

<h2 id="206">20.6 æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†CUDA Graphå’Œå†…æ ¸èåˆè¿™ä¸¤é¡¹å…³é”®çš„ç³»ç»Ÿçº§ä¼˜åŒ–æŠ€æœ¯ï¼Œå¹¶ç»“åˆJITç¼–è¯‘å’Œè‡ªåŠ¨è°ƒä¼˜æ¡†æ¶ï¼Œå±•ç¤ºäº†å¦‚ä½•æ„å»ºé«˜æ€§èƒ½çš„ç«¯åˆ°ç«¯æ¨ç†ç³»ç»Ÿã€‚</p>
<h3 id="_1">æ ¸å¿ƒè¦ç‚¹å›é¡¾</h3>
<ol>
<li>
<p><strong>CUDA GraphæŠ€æœ¯</strong>
   - Graphé€šè¿‡æ¶ˆé™¤CPU-GPUåŒæ­¥å¼€é”€ï¼Œå®ç°äº†æ‰§è¡Œæµçš„æè‡´ä¼˜åŒ–
   - æµæ•è·æœºåˆ¶æä¾›äº†ä¾¿æ·çš„Graphæ„å»ºæ–¹å¼ï¼Œè€Œæ‰‹åŠ¨æ„å»ºæä¾›äº†æœ€å¤§çµæ´»æ€§
   - Graphæ›´æ–°å’Œæ¡ä»¶æ‰§è¡Œæ”¯æŒåŠ¨æ€å·¥ä½œè´Ÿè½½
   - æ€§èƒ½æå‡å…³é”®åœ¨äºæœ€å¤§åŒ–å¹¶è¡Œåº¦å’Œæœ€å°åŒ–åŒæ­¥ç‚¹</p>
</li>
<li>
<p><strong>å†…æ ¸èåˆç­–ç•¥</strong>
   - å‚ç›´èåˆå°†producer-consumerå…³ç³»çš„å†…æ ¸åˆå¹¶ï¼Œå‡å°‘ä¸­é—´ç»“æœå­˜å‚¨
   - æ°´å¹³èåˆæé«˜ç¡¬ä»¶åˆ©ç”¨ç‡ï¼Œç‰¹åˆ«é€‚åˆæ‰¹å¤„ç†åœºæ™¯
   - Element-wiseæ“ä½œèåˆèƒ½æ˜¾è‘—å‡å°‘å†…å­˜å¸¦å®½å‹åŠ›
   - Reductionèåˆéœ€è¦ç‰¹æ®Šçš„ç®—æ³•è®¾è®¡ï¼Œå¦‚online softmax</p>
</li>
<li>
<p><strong>è‡ªåŠ¨è°ƒä¼˜æ¡†æ¶</strong>
   - Profile-guided optimizationåŸºäºå®é™…æ€§èƒ½æ•°æ®è¿›è¡Œä¼˜åŒ–
   - æœç´¢ç©ºé—´çš„æœ‰æ•ˆå®šä¹‰å’Œå‰ªææ˜¯å¿«é€Ÿæ”¶æ•›çš„å…³é”®
   - è´å¶æ–¯ä¼˜åŒ–é€šè¿‡å»ºç«‹æ€§èƒ½æ¨¡å‹æŒ‡å¯¼æœç´¢
   - é—ä¼ ç®—æ³•é€‚åˆå¤„ç†ç¦»æ•£çš„å¤§è§„æ¨¡æœç´¢ç©ºé—´</p>
</li>
<li>
<p><strong>JITç¼–è¯‘ä¼˜åŒ–</strong>
   - NVRTCè¿è¡Œæ—¶ç¼–è¯‘å®ç°äº†kernelçš„åŠ¨æ€ç‰¹åŒ–
   - æ¨¡æ¿å…ƒç¼–ç¨‹ç»“åˆä»£ç ç”Ÿæˆæä¾›äº†çµæ´»æ€§
   - ç¼“å­˜ç­–ç•¥å¯¹JITæ€§èƒ½è‡³å…³é‡è¦
   - PTXçº§ä¼˜åŒ–èƒ½å¤Ÿå®ç°æè‡´æ€§èƒ½</p>
</li>
<li>
<p><strong>ç«¯åˆ°ç«¯ä¼˜åŒ–å®è·µ</strong>
   - ä¸åŒä¼˜åŒ–æŠ€æœ¯çš„ç»„åˆä½¿ç”¨èƒ½å¤Ÿäº§ç”Ÿå åŠ æ•ˆåº”
   - åŠ¨æ€æ‰¹å¤„ç†æé«˜äº†ç³»ç»Ÿçš„ååé‡
   - æµæ°´çº¿æŠ€æœ¯æœ‰æ•ˆéšè—äº†å»¶è¿Ÿ
   - ç»¼åˆä¼˜åŒ–å¯ä»¥å®ç°10xä»¥ä¸Šçš„æ€§èƒ½æå‡</p>
</li>
</ol>
<h3 id="_2">å…³é”®å…¬å¼ä¸åº¦é‡</h3>
<ol>
<li><strong>Graphæ‰§è¡Œæ•ˆç‡</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>Efficiency = (Kernel_Execution_Time) / (Total_Graph_Time)
Graph_Overhead = Total_Graph_Time - Kernel_Execution_Time
</code></pre></div>

<ol start="2">
<li><strong>èåˆæ”¶ç›Šè¯„ä¼°</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>Memory_Reduction = 1 - (Fused_Memory_Access / Original_Memory_Access)
Speedup = Original_Time / Fused_Time
</code></pre></div>

<ol start="3">
<li><strong>è‡ªåŠ¨è°ƒä¼˜æ”¶æ•›ç‡</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>Convergence_Rate = (Best_Performance - Current_Performance) / Iterations
</code></pre></div>

<ol start="4">
<li><strong>JITç¼–è¯‘æŠ•èµ„å›æŠ¥</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>ROI = (Specialized_Kernel_Speedup Ã— Reuse_Count - Compilation_Time) / Compilation_Time
</code></pre></div>

<h3 id="_3">æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘</h3>
<div class="codehilite"><pre><span></span><code>è¾“å…¥ç‰¹å¾åˆ†æ
    â”œâ”€ Batch Size
    â”‚   â”œâ”€ å° (&lt; 4) â†’ æœ€å¤§åŒ–èåˆ + JITç‰¹åŒ–
    â”‚   â””â”€ å¤§ (â‰¥ 4) â†’ Graph + Tensor Core
    â”œâ”€ Sequence Length
    â”‚   â”œâ”€ çŸ­ (&lt; 128) â†’ å®Œå…¨èåˆ
    â”‚   â””â”€ é•¿ (â‰¥ 128) â†’ åˆ†å— + æµæ°´çº¿
    â””â”€ è®¡ç®—å¯†åº¦
        â”œâ”€ Memory-bound â†’ èåˆä¼˜å…ˆ
        â””â”€ Compute-bound â†’ å¹¶è¡Œä¼˜å…ˆ
</code></pre></div>

<h2 id="207">20.7 ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹ 1ï¼šGraphåŸºæœ¬æ“ä½œ</strong>
æ„å»ºä¸€ä¸ªCUDA Graphï¼ŒåŒ…å«3ä¸ªä¸²è¡Œçš„çŸ©é˜µä¹˜æ³•æ“ä½œï¼Œæµ‹é‡ç›¸æ¯”ç‹¬ç«‹kernelè°ƒç”¨çš„æ€§èƒ½æå‡ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä½¿ç”¨æµæ•è·æœºåˆ¶è®°å½•æ“ä½œåºåˆ—ï¼Œæ³¨æ„é¢„åˆ†é…æ‰€æœ‰éœ€è¦çš„ç¼“å†²åŒºã€‚æ¯”è¾ƒGraphæ‰§è¡Œå’Œç‹¬ç«‹kernelè°ƒç”¨çš„æ€»æ—¶é—´ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä½¿ç”¨cudaStreamBeginCaptureå¼€å§‹æ•è·ï¼Œä¾æ¬¡è®°å½•3ä¸ªGEMM kernelï¼Œç„¶åcudaStreamEndCaptureç»“æŸæ•è·ã€‚å®ä¾‹åŒ–Graphåï¼Œé€šè¿‡cudaGraphLaunchæ‰§è¡Œã€‚å…¸å‹æƒ…å†µä¸‹ï¼ŒGraphæ‰§è¡Œèƒ½å¤Ÿå‡å°‘50-70%çš„å¯åŠ¨å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå°çŸ©é˜µã€‚å…³é”®åœ¨äºæ¶ˆé™¤äº†kernelé—´çš„CPU-GPUåŒæ­¥ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 2ï¼šç®€å•å†…æ ¸èåˆ</strong>
å°†ä¸€ä¸ªelement-wiseåŠ æ³•æ“ä½œå’ŒReLUæ¿€æ´»å‡½æ•°èåˆæˆå•ä¸ªå†…æ ¸ï¼Œåˆ†æå†…å­˜å¸¦å®½çš„èŠ‚çœã€‚</p>
<details>
<summary>æç¤º</summary>
<p>åŸå§‹ç‰ˆæœ¬éœ€è¦3æ¬¡å†…å­˜è®¿é—®ï¼ˆè¯»Aã€è¯»Bã€å†™Cç”¨äºåŠ æ³•ï¼Œè¯»Cã€å†™Dç”¨äºReLUï¼‰ã€‚èåˆç‰ˆæœ¬åªéœ€è¦2æ¬¡ï¼ˆè¯»Aå’ŒBï¼Œå†™æœ€ç»ˆç»“æœï¼‰ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>èåˆå†…æ ¸ç›´æ¥è®¡ç®—<code>output[i] = max(0.0f, a[i] + b[i])</code>ï¼Œå‡å°‘äº†50%çš„å†…å­˜è®¿é—®ã€‚å¯¹äºmemory-boundçš„æ“ä½œï¼Œè¿™ç›´æ¥è½¬åŒ–ä¸ºçº¦2xçš„æ€§èƒ½æå‡ã€‚å®é™…åŠ é€Ÿæ¯”å–å†³äºç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜å¸¦å®½åˆ©ç”¨ç‡ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 3ï¼šæœç´¢ç©ºé—´å®šä¹‰</strong>
ä¸ºä¸€ä¸ªçŸ©é˜µè½¬ç½®kernelå®šä¹‰åˆç†çš„è°ƒä¼˜æœç´¢ç©ºé—´ï¼ŒåŒ…æ‹¬block sizeå’Œtile sizeçš„å€™é€‰å€¼ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ç¡¬ä»¶çº¦æŸï¼ˆæœ€å¤§çº¿ç¨‹æ•°ã€å…±äº«å†…å­˜å¤§å°ï¼‰å’Œæ€§èƒ½å› ç´ ï¼ˆbank conflictã€å ç”¨ç‡ï¼‰ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>Block sizeå€™é€‰ï¼š{16Ã—16, 32Ã—8, 8Ã—32}ä»¥ä¿æŒ256çº¿ç¨‹ã€‚Tile sizeå€™é€‰ï¼š{16Ã—16, 32Ã—32}è€ƒè™‘å…±äº«å†…å­˜é™åˆ¶ã€‚å¯¹äºé¿å…bank conflictï¼Œtileå®½åº¦åº”è¯¥æ˜¯33è€Œä¸æ˜¯32ã€‚æœç´¢ç©ºé—´å¤§å°ï¼š3Ã—2=6ç§é…ç½®ï¼Œå¯ä»¥å¿«é€Ÿéå†ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 4ï¼šJITç¼–è¯‘åœºæ™¯è¯†åˆ«</strong>
åˆ—ä¸¾3ä¸ªé€‚åˆä½¿ç”¨JITç¼–è¯‘çš„åœºæ™¯ï¼Œå¹¶è¯´æ˜åŸå› ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘å“ªäº›æƒ…å†µä¸‹è¿è¡Œæ—¶ä¿¡æ¯èƒ½å¤Ÿå¸¦æ¥æ˜¾è‘—çš„ä¼˜åŒ–æœºä¼šã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<ol>
<li>åŠ¨æ€å½¢çŠ¶çš„çŸ©é˜µè¿ç®—ï¼šå¯ä»¥å°†ç»´åº¦ä½œä¸ºç¼–è¯‘æ—¶å¸¸é‡ï¼Œå¯ç”¨å¾ªç¯å±•å¼€</li>
<li>ç¨€ç–æ¨¡å¼å·²çŸ¥çš„è¿ç®—ï¼šæ ¹æ®ç¨€ç–ç»“æ„ç”Ÿæˆç‰¹åŒ–ä»£ç </li>
<li>ç”¨æˆ·è‡ªå®šä¹‰çš„æ¿€æ´»å‡½æ•°ï¼šé¿å…å‡½æ•°æŒ‡é’ˆè°ƒç”¨å¼€é”€
æ¯ç§åœºæ™¯éƒ½èƒ½é€šè¿‡ç‰¹åŒ–è·å¾—20-50%çš„æ€§èƒ½æå‡ã€‚</li>
</ol>
</details>
<h3 id="_5">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹ 5ï¼šå¤æ‚Graphä¼˜åŒ–</strong>
è®¾è®¡ä¸€ä¸ªåŒ…å«æ¡ä»¶åˆ†æ”¯çš„CUDA Graphï¼Œå®ç°åŠ¨æ€é€‰æ‹©ä¸åŒç²¾åº¦ï¼ˆFP32/FP16ï¼‰çš„è®¡ç®—è·¯å¾„ã€‚æµ‹é‡ä¸åŒç²¾åº¦ä¸‹çš„æ€§èƒ½å·®å¼‚ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä½¿ç”¨CUDA 12.3çš„æ¡ä»¶èŠ‚ç‚¹åŠŸèƒ½ï¼Œæˆ–è€…é¢„æ„å»ºä¸¤ä¸ªå­å›¾ï¼Œè¿è¡Œæ—¶é€‰æ‹©æ‰§è¡Œã€‚éœ€è¦è€ƒè™‘ç²¾åº¦è½¬æ¢çš„å¼€é”€ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>åˆ›å»ºä¸¤ä¸ªå­å›¾ï¼Œä¸€ä¸ªç”¨äºFP32è·¯å¾„ï¼Œä¸€ä¸ªç”¨äºFP16è·¯å¾„ã€‚ä½¿ç”¨æ¡ä»¶èŠ‚ç‚¹æ ¹æ®è¾“å…¥æ•°æ®çš„ç‰¹å¾ï¼ˆå¦‚æ•°å€¼èŒƒå›´ï¼‰åŠ¨æ€é€‰æ‹©ã€‚FP16è·¯å¾„é€šå¸¸èƒ½æä¾›2xçš„å†…å­˜å¸¦å®½ä¼˜åŠ¿å’ŒTensor CoreåŠ é€Ÿï¼Œä½†éœ€è¦å¤„ç†æº¢å‡ºå’Œç²¾åº¦æŸå¤±ã€‚å…³é”®æ˜¯åœ¨Graphæ„å»ºæ—¶å°±ç¡®å®šå¥½æ‰€æœ‰å¯èƒ½çš„æ‰§è¡Œè·¯å¾„ï¼Œé¿å…è¿è¡Œæ—¶é‡æ„ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 6ï¼šå¤šå±‚èåˆç­–ç•¥</strong>
è®¾è®¡ä¸€ä¸ªèåˆç­–ç•¥ï¼Œå°†LayerNormã€GEMMå’Œæ¿€æ´»å‡½æ•°ä¸‰ä¸ªæ“ä½œèåˆï¼Œå¹¶å¤„ç†å¥½æ•°å€¼ç¨³å®šæ€§é—®é¢˜ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>LayerNorméœ€è¦ä¸¤æ¬¡éå†æ•°æ®ï¼ˆè®¡ç®—ç»Ÿè®¡é‡å’Œå½’ä¸€åŒ–ï¼‰ï¼Œè€ƒè™‘å¦‚ä½•ä¸GEMMçš„è®¡ç®—æ¨¡å¼ç»“åˆã€‚æ³¨æ„åœ¨çº¿ç®—æ³•çš„ä½¿ç”¨ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä½¿ç”¨åˆ†å—ç­–ç•¥ï¼šæ¯ä¸ªblockè´Ÿè´£è¾“å‡ºçš„ä¸€éƒ¨åˆ†è¡Œã€‚å…ˆç”¨ä¸€ä¸ªwarpè®¡ç®—LayerNormç»Ÿè®¡é‡ï¼ˆä½¿ç”¨Welfordç®—æ³•ä¿è¯æ•°å€¼ç¨³å®šï¼‰ï¼ŒåŒæ­¥åæ‰€æœ‰çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œå½’ä¸€åŒ–å’ŒGEMMã€‚å…³é”®ä¼˜åŒ–ï¼š1)ä½¿ç”¨å…±äº«å†…å­˜ç¼“å­˜å½’ä¸€åŒ–åçš„æ•°æ®ï¼›2)å°†GEMMçš„ç´¯åŠ ä¸æ¿€æ´»å‡½æ•°èåˆï¼›3)ä½¿ç”¨å‘é‡åŒ–load/storeã€‚è¿™ç§èåˆèƒ½å‡å°‘75%çš„å…¨å±€å†…å­˜è®¿é—®ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 7ï¼šè‡ªé€‚åº”è°ƒä¼˜ç³»ç»Ÿ</strong>
å®ç°ä¸€ä¸ªè‡ªé€‚åº”çš„è°ƒä¼˜ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ ¹æ®ç¡¬ä»¶ç‰¹æ€§å’Œé—®é¢˜è§„æ¨¡è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„kernelé…ç½®ã€‚ç³»ç»Ÿåº”è¯¥åŒ…å«ç¦»çº¿è®­ç»ƒå’Œåœ¨çº¿é¢„æµ‹ä¸¤ä¸ªé˜¶æ®µã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä½¿ç”¨æœºå™¨å­¦ä¹ æ–¹æ³•å»ºç«‹æ€§èƒ½æ¨¡å‹ã€‚ç‰¹å¾åŒ…æ‹¬ï¼šé—®é¢˜è§„æ¨¡ã€ç¡¬ä»¶è§„æ ¼ã€å†…å­˜è®¿é—®æ¨¡å¼ã€‚å¯ä»¥ä½¿ç”¨ç®€å•çš„å†³ç­–æ ‘æˆ–ç¥ç»ç½‘ç»œã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç¦»çº¿é˜¶æ®µï¼šæ”¶é›†ä¸åŒé…ç½®ä¸‹çš„æ€§èƒ½æ•°æ®ï¼Œæå–ç‰¹å¾ï¼ˆçŸ©é˜µç»´åº¦ã€ç®—æœ¯å¼ºåº¦ã€ç¡¬ä»¶SMæ•°ç­‰ï¼‰ï¼Œè®­ç»ƒä¸€ä¸ªè½»é‡çº§MLPé¢„æµ‹æœ€ä¼˜é…ç½®ã€‚åœ¨çº¿é˜¶æ®µï¼šå¯¹æ–°é—®é¢˜æå–ç‰¹å¾ï¼Œæ¨¡å‹é¢„æµ‹top-3é…ç½®ï¼Œå¿«é€Ÿè¯„ä¼°åé€‰æ‹©æœ€ä¼˜ã€‚å…³é”®æ˜¯ç‰¹å¾å·¥ç¨‹ï¼šåŒ…æ‹¬è®¡ç®—å¯†åº¦ã€å†…å­˜è®¿é—®æ¨¡å¼ã€æ•°æ®å¤ç”¨åº¦ç­‰ã€‚è¿™ç§æ–¹æ³•ç›¸æ¯”æš´åŠ›æœç´¢èƒ½å‡å°‘90%çš„è°ƒä¼˜æ—¶é—´ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 8ï¼šç«¯åˆ°ç«¯ä¼˜åŒ–å®æˆ˜</strong>
ç»™å®šä¸€ä¸ªåŒ…å«Conv-BN-ReLU-Poolçš„CNNå±‚ï¼Œè®¾è®¡å¹¶å®ç°ä¸€ä¸ªå®Œæ•´çš„ä¼˜åŒ–æ–¹æ¡ˆï¼ŒåŒ…æ‹¬Graphæ„å»ºã€å†…æ ¸èåˆå’Œè‡ªåŠ¨è°ƒä¼˜ï¼Œç›®æ ‡æ˜¯è¾¾åˆ°cuDNN 80%çš„æ€§èƒ½ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>åˆ†ææ•°æ®æµå’Œå¤ç”¨æœºä¼šã€‚Convå’ŒBNå¯ä»¥èåˆï¼ŒReLUå¯ä»¥ä¸BNè¾“å‡ºé˜¶æ®µèåˆï¼ŒPoolå¯èƒ½éœ€è¦å•ç‹¬å¤„ç†ã€‚ä½¿ç”¨im2colæˆ–implicit GEMMæ–¹æ³•ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li>ä½¿ç”¨implicit GEMMå®ç°Convï¼Œé¿å…im2colçš„å†…å­˜å¼€é”€</li>
<li>å°†BNçš„ç»Ÿè®¡é‡é¢„è®¡ç®—å¹¶èå…¥Convçš„epilogue</li>
<li>ReLUç›´æ¥åœ¨å†™å‡ºæ—¶åº”ç”¨</li>
<li>Poolä½¿ç”¨å•ç‹¬çš„kernelä½†é€šè¿‡Graphä¸²è”ï¼Œé¿å…åŒæ­¥</li>
<li>ä½¿ç”¨è‡ªåŠ¨è°ƒä¼˜æ‰¾åˆ°æœ€ä¼˜çš„tile sizeå’Œblocké…ç½®</li>
<li>å¯¹äºå¸¸è§çš„å±‚é…ç½®ï¼Œä½¿ç”¨JITç”Ÿæˆç‰¹åŒ–ä»£ç </li>
</ol>
<p>å…³é”®å®ç°ç»†èŠ‚ï¼š</p>
<ul>
<li>Convä½¿ç”¨1x1ã€3x3ã€5x5ç­‰ä¸“é—¨ä¼˜åŒ–çš„æ¨¡æ¿</li>
<li>BNå‚æ•°æå‰fuseæˆscaleå’Œbias</li>
<li>ä½¿ç”¨Tensor Coreï¼ˆå¦‚æœé€‚ç”¨ï¼‰</li>
<li>å†…å­˜å¸ƒå±€ä¼˜åŒ–ï¼ˆNCHW vs NHWCï¼‰</li>
</ul>
<p>é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼Œå¯ä»¥è¾¾åˆ°cuDNN 75-85%çš„æ€§èƒ½ï¼Œå·®è·ä¸»è¦åœ¨äºcuDNNä½¿ç”¨äº†æ›´å¤šç¡¬ä»¶ç‰¹å®šçš„ä¼˜åŒ–å’Œæ±‡ç¼–çº§è°ƒä¼˜ã€‚</p>
</details>
<h2 id="208">20.8 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="graph">Graphç›¸å…³é™·é˜±</h3>
<ol>
<li><strong>Graphæ›´æ–°å¤±è´¥</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šå‡è®¾æ›´æ–°æ€»æ˜¯æˆåŠŸ</span>
<span class="n">cudaGraphExecKernelNodeSetParams</span><span class="p">(</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>

<span class="c1">// æ­£ç¡®ï¼šæ£€æŸ¥æ›´æ–°ç»“æœ</span>
<span class="n">cudaGraphExecUpdateResult</span><span class="w"> </span><span class="n">updateResult</span><span class="p">;</span>
<span class="n">cudaGraphExecUpdate</span><span class="p">(</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">updateResult</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updateResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaGraphExecUpdateSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// éœ€è¦é‡æ–°å®ä¾‹åŒ–</span>
<span class="w">    </span><span class="n">cudaGraphExecDestroy</span><span class="p">(</span><span class="n">graphExec</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaGraphInstantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graphExec</span><span class="p">,</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>æµæ•è·æ³„æ¼</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ•è·æœŸé—´ä½¿ç”¨äº†é»˜è®¤æµ</span>
<span class="n">cudaStreamBeginCapture</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStreamCaptureModeGlobal</span><span class="p">);</span>
<span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">);</span><span class="w"> </span><span class="c1">// ä½¿ç”¨é»˜è®¤æµï¼</span>

<span class="c1">// æ­£ç¡®ï¼šæ‰€æœ‰æ“ä½œéƒ½ä½¿ç”¨æ•è·æµ</span>
<span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
</code></pre></div>

<ol start="3">
<li><strong>Graphèµ„æºç®¡ç†</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ²¡æœ‰é‡Šæ”¾Graphèµ„æº</span>
<span class="n">cudaGraph_t</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span>
<span class="n">cudaGraphCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="c1">// ä½¿ç”¨graph...</span>

<span class="c1">// æ­£ç¡®ï¼šæ­£ç¡®é‡Šæ”¾</span>
<span class="n">cudaGraphDestroy</span><span class="p">(</span><span class="n">graph</span><span class="p">);</span>
<span class="n">cudaGraphExecDestroy</span><span class="p">(</span><span class="n">graphExec</span><span class="p">);</span>
</code></pre></div>

<h3 id="_6">èåˆç›¸å…³é™·é˜±</h3>
<ol start="4">
<li><strong>å¯„å­˜å™¨å‹åŠ›è¿‡å¤§</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šè¿‡åº¦èåˆå¯¼è‡´å¯„å­˜å™¨æº¢å‡º</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">overFusedKernel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span><span class="w">  </span><span class="c1">// å¤ªå¤šå¯„å­˜å™¨å˜é‡</span>
<span class="w">    </span><span class="c1">// å¯¼è‡´å¯„å­˜å™¨æº¢å‡ºåˆ°æœ¬åœ°å†…å­˜</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šå¹³è¡¡èåˆç¨‹åº¦</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">balancedFusion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w">  </span><span class="c1">// é€‚åº¦çš„å¯„å­˜å™¨ä½¿ç”¨</span>
<span class="p">}</span>
</code></pre></div>

<ol start="5">
<li><strong>å…±äº«å†…å­˜bank conflict</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šèåˆåäº§ç”Ÿbank conflict</span>
<span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">shared</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span><span class="w">  </span><span class="c1">// 32-way bank conflict</span>

<span class="c1">// æ­£ç¡®ï¼špaddingé¿å…conflict</span>
<span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">shared</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">33</span><span class="p">];</span><span class="w">  </span><span class="c1">// é¿å…bank conflict</span>
</code></pre></div>

<h3 id="jit">JITç›¸å…³é™·é˜±</h3>
<ol start="6">
<li><strong>ç¼–è¯‘é”™è¯¯å¤„ç†ä¸å½“</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šä¸æ£€æŸ¥ç¼–è¯‘ç»“æœ</span>
<span class="n">nvrtcCompileProgram</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="c1">// æ­£ç¡®ï¼šæ£€æŸ¥å¹¶è·å–é”™è¯¯ä¿¡æ¯</span>
<span class="n">nvrtcResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nvrtcCompileProgram</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NVRTC_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">logSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">nvrtcGetProgramLogSize</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">logSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">logSize</span><span class="p">];</span>
<span class="w">    </span><span class="n">nvrtcGetProgramLog</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Compilation error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">log</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="7">
<li><strong>ç¼“å­˜å¤±æ•ˆé—®é¢˜</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šä¸è€ƒè™‘æ¶æ„å·®å¼‚</span>
<span class="c1">// åœ¨SM_70ä¸Šç¼–è¯‘çš„ä»£ç åœ¨SM_80ä¸Šè¿è¡Œ</span>

<span class="c1">// æ­£ç¡®ï¼šåŒ…å«æ¶æ„ä¿¡æ¯åœ¨ç¼“å­˜é”®ä¸­</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">cacheKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceHash</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_sm&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">smVersion</span><span class="p">);</span>
</code></pre></div>

<h3 id="_7">è°ƒè¯•æŠ€å·§</h3>
<ol>
<li><strong>ä½¿ç”¨Nsight Computeåˆ†æGraph</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>ncu<span class="w"> </span>--target-processes<span class="w"> </span>all<span class="w"> </span>--graph-profiling<span class="o">=</span>node<span class="w"> </span>./app
</code></pre></div>

<ol start="2">
<li><strong>èåˆæ•ˆæœéªŒè¯</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ·»åŠ éªŒè¯ä»£ç </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">verifyFusion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è¿è¡Œæœªèåˆç‰ˆæœ¬</span>
<span class="w">    </span><span class="n">runUnfused</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">expected_output</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è¿è¡Œèåˆç‰ˆæœ¬</span>
<span class="w">    </span><span class="n">runFused</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">actual_output</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ¯”è¾ƒç»“æœ</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">maxError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compareResults</span><span class="p">(</span><span class="n">expected_output</span><span class="p">,</span><span class="w"> </span><span class="n">actual_output</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">maxError</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-5f</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>JITç¼–è¯‘æ—¶é—´ç›‘æ§</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompilationMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">compilationTimes</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">recordCompilation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">compilationTimes</span><span class="p">[</span><span class="n">kernel</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// è¶…è¿‡1ç§’</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Warning: %s compilation took %.2f ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">kernel</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="209">20.9 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="graph_1">Graphä¼˜åŒ–æ£€æŸ¥æ¸…å•</h3>
<ul>
<li>[ ] <strong>Graphæ„å»º</strong></li>
<li>â–¡ é¢„åˆ†é…æ‰€æœ‰éœ€è¦çš„ç¼“å†²åŒº</li>
<li>â–¡ ä½¿ç”¨æµæ•è·vsæ‰‹åŠ¨æ„å»ºçš„æƒè¡¡</li>
<li>â–¡ æ­£ç¡®å¤„ç†å¤šæµåŒæ­¥</li>
<li>
<p>â–¡ Graphæ›´æ–°ç­–ç•¥æ˜ç¡®</p>
</li>
<li>
<p>[ ] <strong>æ€§èƒ½ä¼˜åŒ–</strong></p>
</li>
<li>â–¡ æœ€å°åŒ–Graphä¸­çš„åŒæ­¥ç‚¹</li>
<li>â–¡ åˆå¹¶å°kernelå‡å°‘èŠ‚ç‚¹æ•°</li>
<li>â–¡ ä½¿ç”¨å¼‚æ­¥æ“ä½œ</li>
<li>
<p>â–¡ è€ƒè™‘Graphåˆ†åŒºforå¤§è§„æ¨¡å›¾</p>
</li>
<li>
<p>[ ] <strong>èµ„æºç®¡ç†</strong></p>
</li>
<li>â–¡ æ­£ç¡®é‡Šæ”¾Graphå’ŒGraphExec</li>
<li>â–¡ é¿å…Graphå®ä¾‹åŒ–çš„å†…å­˜æ³„æ¼</li>
<li>â–¡ ç›‘æ§Graphæ‰§è¡Œæ—¶é—´</li>
</ul>
<h3 id="_8">å†…æ ¸èåˆæ£€æŸ¥æ¸…å•</h3>
<ul>
<li>[ ] <strong>èåˆç­–ç•¥</strong></li>
<li>â–¡ è¯†åˆ«producer-consumerå…³ç³»</li>
<li>â–¡ è¯„ä¼°å†…å­˜å¸¦å®½èŠ‚çœ</li>
<li>â–¡ è€ƒè™‘å¯„å­˜å™¨å‹åŠ›</li>
<li>
<p>â–¡ å¹³è¡¡èåˆç²’åº¦</p>
</li>
<li>
<p>[ ] <strong>å®ç°è´¨é‡</strong></p>
</li>
<li>â–¡ é¿å…bank conflict</li>
<li>â–¡ ä½¿ç”¨å‘é‡åŒ–è®¿å­˜</li>
<li>â–¡ æ­£ç¡®å¤„ç†è¾¹ç•Œæ¡ä»¶</li>
<li>
<p>â–¡ æ•°å€¼ç¨³å®šæ€§éªŒè¯</p>
</li>
<li>
<p>[ ] <strong>æ€§èƒ½éªŒè¯</strong></p>
</li>
<li>â–¡ å¯¹æ¯”èåˆå‰åçš„å†…å­˜è®¿é—®</li>
<li>â–¡ æµ‹é‡å®é™…åŠ é€Ÿæ¯”</li>
<li>â–¡ åˆ†æå ç”¨ç‡å˜åŒ–</li>
<li>â–¡ æ£€æŸ¥ç¼“å­˜åˆ©ç”¨ç‡</li>
</ul>
<h3 id="jit_1">JITä¼˜åŒ–æ£€æŸ¥æ¸…å•</h3>
<ul>
<li>[ ] <strong>ç¼–è¯‘ç­–ç•¥</strong></li>
<li>â–¡ è¯†åˆ«é€‚åˆJITçš„åœºæ™¯</li>
<li>â–¡ è®¾è®¡åˆç†çš„æ¨¡æ¿</li>
<li>â–¡ å®ç°ç¼–è¯‘ç¼“å­˜</li>
<li>
<p>â–¡ å¤„ç†ç¼–è¯‘å¤±è´¥</p>
</li>
<li>
<p>[ ] <strong>æ€§èƒ½è€ƒè™‘</strong></p>
</li>
<li>â–¡ å¹³è¡¡ç¼–è¯‘æ—¶é—´å’Œæ‰§è¡Œæ—¶é—´</li>
<li>â–¡ ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§</li>
<li>â–¡ å†…å­˜ä½¿ç”¨æ§åˆ¶</li>
<li>
<p>â–¡ å¤šæ¶æ„æ”¯æŒ</p>
</li>
<li>
<p>[ ] <strong>ä»£ç ç”Ÿæˆ</strong></p>
</li>
<li>â–¡ ç”Ÿæˆé«˜æ•ˆçš„ä»£ç </li>
<li>â–¡ åˆ©ç”¨ç¼–è¯‘æ—¶å¸¸é‡</li>
<li>â–¡ é€‚å½“çš„å¾ªç¯å±•å¼€</li>
<li>â–¡ å‘é‡åŒ–ä¼˜åŒ–</li>
</ul>
<h3 id="_9">è‡ªåŠ¨è°ƒä¼˜æ£€æŸ¥æ¸…å•</h3>
<ul>
<li>[ ] <strong>æœç´¢ç©ºé—´</strong></li>
<li>â–¡ å®šä¹‰å®Œæ•´ä½†ç²¾ç®€çš„æœç´¢ç©ºé—´</li>
<li>â–¡ æœ‰æ•ˆçš„å‰ªæç­–ç•¥</li>
<li>â–¡ ç¡¬ä»¶çº¦æŸè€ƒè™‘</li>
<li>
<p>â–¡ å¢é‡å¼æœç´¢</p>
</li>
<li>
<p>[ ] <strong>è°ƒä¼˜ç®—æ³•</strong></p>
</li>
<li>â–¡ é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–ç®—æ³•</li>
<li>â–¡ æ€§èƒ½æ¨¡å‹å‡†ç¡®æ€§</li>
<li>â–¡ æ”¶æ•›é€Ÿåº¦ç›‘æ§</li>
<li>
<p>â–¡ è¿‡æ‹Ÿåˆé¢„é˜²</p>
</li>
<li>
<p>[ ] <strong>å®ç”¨æ€§</strong></p>
</li>
<li>â–¡ è°ƒä¼˜æ—¶é—´é¢„ç®—</li>
<li>â–¡ ç»“æœå¯é‡ç°æ€§</li>
<li>â–¡ è·¨å¹³å°ç§»æ¤æ€§</li>
<li>â–¡ è°ƒä¼˜ç»“æœæŒä¹…åŒ–
```</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter19.html" class="nav-link prev">â† ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</a><a href="chapter21.html" class="nav-link next">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰ â†’</a></nav>
        </main>
    </div>
</body>
</html>