<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="26cuda">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</h1>
<p>è°ƒè¯•CUDAç¨‹åºæ˜¯é«˜æ€§èƒ½è®¡ç®—å¼€å‘ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ä¹‹ä¸€ã€‚ä¸ä¼ ç»ŸCPUç¨‹åºä¸åŒï¼ŒGPUç¨‹åºçš„å¤§è§„æ¨¡å¹¶è¡Œç‰¹æ€§ä½¿å¾—é”™è¯¯å®šä½å’Œæ€§èƒ½é—®é¢˜è¯Šæ–­å˜å¾—æå…¶å¤æ‚ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨CUDAè°ƒè¯•çš„æ–¹æ³•è®ºã€å·¥å…·é“¾å’Œå®æˆ˜æŠ€å·§ï¼Œå¸®åŠ©ä½ æŒæ¡ä»å†…å­˜é”™è¯¯åˆ°ç«æ€æ¡ä»¶ã€ä»æ­»é”åˆ°æ•°å€¼ç²¾åº¦é—®é¢˜çš„å…¨æ–¹ä½è°ƒè¯•èƒ½åŠ›ã€‚é€šè¿‡è‡ªåŠ¨é©¾é©¶å’Œå…·èº«æ™ºèƒ½åœºæ™¯çš„çœŸå®æ¡ˆä¾‹ï¼Œä½ å°†å­¦ä¼šå¦‚ä½•ç³»ç»Ÿåœ°è¯Šæ–­å’Œè§£å†³å¤æ‚CUDAç³»ç»Ÿä¸­çš„å„ç±»é—®é¢˜ã€‚</p>
<h2 id="261-cuda-gdbcuda-memcheck">26.1 cuda-gdbä¸cuda-memcheckä½¿ç”¨</h2>
<h3 id="2611-cuda-gdb">26.1.1 cuda-gdbåŸºç¡€</h3>
<p>cuda-gdbæ˜¯NVIDIAæä¾›çš„GPUè°ƒè¯•å™¨ï¼ŒåŸºäºGNU gdbæ‰©å±•è€Œæ¥ï¼Œæ”¯æŒåŒæ—¶è°ƒè¯•ä¸»æœºä»£ç å’Œè®¾å¤‡ä»£ç ã€‚å®ƒæä¾›äº†æ–­ç‚¹è®¾ç½®ã€å•æ­¥æ‰§è¡Œã€å˜é‡æ£€æŸ¥ç­‰ä¼ ç»Ÿè°ƒè¯•åŠŸèƒ½ï¼Œå¹¶é’ˆå¯¹CUDAçš„å¹¶è¡Œæ‰§è¡Œæ¨¡å‹è¿›è¡Œäº†ç‰¹æ®Šä¼˜åŒ–ã€‚</p>
<p><strong>åŸºæœ¬è°ƒè¯•æµç¨‹</strong></p>
<p>ç¼–è¯‘æ—¶éœ€è¦æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code>nvcc<span class="w"> </span>-g<span class="w"> </span>-G<span class="w"> </span>-O0<span class="w"> </span>mykernel.cu<span class="w"> </span>-o<span class="w"> </span>myapp
</code></pre></div>

<p>å…¶ä¸­-gç”Ÿæˆä¸»æœºè°ƒè¯•ä¿¡æ¯ï¼Œ-Gç”Ÿæˆè®¾å¤‡è°ƒè¯•ä¿¡æ¯ï¼Œ-O0ç¦ç”¨ä¼˜åŒ–ä»¥ä¿æŒä»£ç ä¸æºç çš„å¯¹åº”å…³ç³»ã€‚</p>
<p>cuda-gdbçš„æ ¸å¿ƒå‘½ä»¤æ‰©å±•åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>cuda kernel</code> - æ˜¾ç¤ºå½“å‰æ´»åŠ¨çš„kernel</li>
<li><code>cuda thread</code> - åˆ‡æ¢å’ŒæŸ¥çœ‹çº¿ç¨‹ä¿¡æ¯</li>
<li><code>cuda block</code> - åˆ‡æ¢å’ŒæŸ¥çœ‹blockä¿¡æ¯</li>
<li><code>cuda sm</code> - æŸ¥çœ‹SMï¼ˆæµå¤šå¤„ç†å™¨ï¼‰çŠ¶æ€</li>
<li><code>info cuda threads</code> - åˆ—å‡ºæ‰€æœ‰CUDAçº¿ç¨‹</li>
</ul>
<p><strong>çº¿ç¨‹èšç„¦ä¸æ¡ä»¶æ–­ç‚¹</strong></p>
<p>åœ¨è°ƒè¯•æ•°åƒä¸ªå¹¶è¡Œçº¿ç¨‹æ—¶ï¼Œèšç„¦ç‰¹å®šçº¿ç¨‹è‡³å…³é‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="ss">(</span><span class="nv">cuda</span><span class="o">-</span><span class="nv">gdb</span><span class="ss">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="nv">mykernel</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">threadIdx</span>.<span class="nv">x</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">blockIdx</span>.<span class="nv">x</span><span class="o">==</span><span class="mi">10</span>
<span class="ss">(</span><span class="nv">cuda</span><span class="o">-</span><span class="nv">gdb</span><span class="ss">)</span><span class="w"> </span><span class="nv">cuda</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="ss">(</span><span class="mi">32</span>,<span class="mi">0</span>,<span class="mi">0</span><span class="ss">)</span><span class="w"> </span><span class="nv">block</span><span class="w"> </span><span class="ss">(</span><span class="mi">10</span>,<span class="mi">0</span>,<span class="mi">0</span><span class="ss">)</span>
<span class="ss">(</span><span class="nv">cuda</span><span class="o">-</span><span class="nv">gdb</span><span class="ss">)</span><span class="w"> </span><span class="nv">print</span><span class="w"> </span><span class="nv">sharedMem</span>[<span class="nv">threadIdx</span>.<span class="nv">x</span>]
</code></pre></div>

<p>è¿™ç§æ–¹å¼å…è®¸ä½ ç²¾ç¡®å®šä½åˆ°ç‰¹å®šçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ£€æŸ¥å±€éƒ¨å˜é‡ã€å…±äº«å†…å­˜å’Œå¯„å­˜å™¨çŠ¶æ€ã€‚</p>
<h3 id="2612-cuda-memcheck">26.1.2 cuda-memcheckå†…å­˜æ£€æŸ¥å™¨</h3>
<p>cuda-memcheckæ˜¯CUDAçš„å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·ï¼Œèƒ½å¤Ÿæ£€æµ‹å¤šç§å†…å­˜è®¿é—®é”™è¯¯ï¼š</p>
<p><strong>æ”¯æŒçš„æ£€æŸ¥ç±»å‹</strong></p>
<ol>
<li>
<p><strong>è¶Šç•Œè®¿é—®æ£€æµ‹</strong> (--tool memcheck)
   - å…¨å±€å†…å­˜è¶Šç•Œ
   - å…±äº«å†…å­˜è¶Šç•Œ
   - å±€éƒ¨å†…å­˜è¶Šç•Œ</p>
</li>
<li>
<p><strong>ç«æ€æ¡ä»¶æ£€æµ‹</strong> (--tool racecheck)
   - å…±äº«å†…å­˜ç«æ€
   - å…¨å±€å†…å­˜ç«æ€</p>
</li>
<li>
<p><strong>åŒæ­¥é”™è¯¯æ£€æµ‹</strong> (--tool synccheck)
   - éæ³•çš„__syncthreads()è°ƒç”¨
   - æ­»é”æ£€æµ‹</p>
</li>
<li>
<p><strong>åˆå§‹åŒ–æ£€æµ‹</strong> (--tool initcheck)
   - æœªåˆå§‹åŒ–çš„å…¨å±€å†…å­˜è¯»å–
   - æœªåˆå§‹åŒ–çš„å…±äº«å†…å­˜è®¿é—®</p>
</li>
</ol>
<p><strong>é«˜çº§ä½¿ç”¨æŠ€å·§</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å®Œæ•´çš„å†…å­˜æ£€æŸ¥</span>
cuda-memcheck<span class="w"> </span>--leak-check<span class="w"> </span>full<span class="w"> </span>--show-backtrace<span class="w"> </span>all<span class="w"> </span>./myapp

<span class="c1"># ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š</span>
cuda-memcheck<span class="w"> </span>--save<span class="w"> </span>report.dat<span class="w"> </span>--print-level<span class="w"> </span>info<span class="w"> </span>./myapp

<span class="c1"># æ£€æŸ¥ç‰¹å®škernel</span>
cuda-memcheck<span class="w"> </span>--filter-kernel-name<span class="w"> </span><span class="s2">&quot;myKernel*&quot;</span><span class="w"> </span>./myapp
</code></pre></div>

<p>å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå¯ä»¥é€šè¿‡APIè¿›è¡Œç¨‹åºåŒ–æ£€æŸ¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">checkMemory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cudaError_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaGetLastError</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;CUDA Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cudaGetErrorString</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// è®°å½•åˆ°æ—¥å¿—ç³»ç»Ÿ</span>
<span class="w">        </span><span class="n">logError</span><span class="p">(</span><span class="s">&quot;Memory check failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2613">26.1.3 è°ƒè¯•ä¿¡æ¯çš„ä¼˜åŒ–ä¿ç•™</h3>
<p>åœ¨ä¼˜åŒ–ä»£ç çš„åŒæ—¶ä¿ç•™è°ƒè¯•èƒ½åŠ›æ˜¯ä¸€ä¸ªé‡è¦æŠ€å·§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨æ¡ä»¶ç¼–è¯‘ä¿ç•™è°ƒè¯•è·¯å¾„</span>
<span class="cp">#ifdef DEBUG_MODE</span>
<span class="w">    </span><span class="cp">#define CUDA_CHECK(call) do { \</span>
<span class="cp">        cudaError_t error = call; \</span>
<span class="cp">        if (error != cudaSuccess) { \</span>
<span class="cp">            printf(&quot;CUDA error at %s:%d - %s\n&quot;, \</span>
<span class="cp">                   __FILE__, __LINE__, \</span>
<span class="cp">                   cudaGetErrorString(error)); \</span>
<span class="cp">            exit(1); \</span>
<span class="cp">        } \</span>
<span class="cp">    } while(0)</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="cp">#define CUDA_CHECK(call) call</span>
<span class="cp">#endif</span>
</code></pre></div>

<p><strong>å†…å­˜æ …æ æ’å…¥</strong></p>
<p>åœ¨è°ƒè¯•å†…å­˜ä¸€è‡´æ€§é—®é¢˜æ—¶ï¼Œå¯ä»¥æ’å…¥å†…å­˜æ …æ æ¥å¼ºåˆ¶åŒæ­¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">debugMemoryFence</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#ifdef DEBUG_MEMORY</span>
<span class="w">        </span><span class="n">__threadfence_system</span><span class="p">();</span><span class="w">  </span><span class="c1">// æœ€å¼ºçš„å†…å­˜æ …æ </span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread %d: Memory fence at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="262">26.2 ç«æ€æ¡ä»¶æ£€æµ‹ä¸ä¿®å¤</h2>
<h3 id="2621">26.2.1 ç«æ€æ¡ä»¶çš„æœ¬è´¨</h3>
<p>CUDAç¨‹åºä¸­çš„ç«æ€æ¡ä»¶æºäºå¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„éåŒæ­¥è®¿é—®ã€‚ä¸CPUå¤šçº¿ç¨‹ä¸åŒï¼ŒGPUçš„SIMTæ‰§è¡Œæ¨¡å‹ä½¿å¾—ç«æ€æ¡ä»¶æ›´åŠ éšè”½å’Œéš¾ä»¥é‡ç°ã€‚</p>
<p><strong>å¸¸è§ç«æ€åœºæ™¯</strong></p>
<ol>
<li><strong>å…±äº«å†…å­˜ç«æ€</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">racyKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharedData</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// é”™è¯¯ï¼šæ²¡æœ‰åŒæ­¥çš„å†™-è¯»æ“ä½œ</span>
<span class="w">    </span><span class="n">sharedData</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// ç¼ºå°‘ __syncthreads();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharedData</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharedData</span><span class="p">[(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å…¨å±€å†…å­˜ç«æ€</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">globalRace</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// é”™è¯¯ï¼šéåŸå­çš„è¯»-æ”¹-å†™</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">oldVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">counter</span><span class="p">;</span>
<span class="w">    </span><span class="n">oldVal</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldVal</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¤šä¸ªçº¿ç¨‹å¯èƒ½å†™å…¥ç›¸åŒçš„å€¼</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>Warpå†…ç«æ€</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">warpRace</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">laneId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// é”™è¯¯ï¼šå‡è®¾warpå†…çº¿ç¨‹åŒæ­¥æ‰§è¡Œ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">laneId</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="n">laneId</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">laneId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦å¯èƒ½å¯¼è‡´è¿™é‡Œè¯»åˆ°æœªåˆå§‹åŒ–çš„å€¼</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">laneId</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2622">26.2.2 ç³»ç»ŸåŒ–çš„ç«æ€æ£€æµ‹æ–¹æ³•</h3>
<p><strong>é™æ€åˆ†æ</strong></p>
<p>é€šè¿‡ä»£ç å®¡æŸ¥è¯†åˆ«æ½œåœ¨ç«æ€ï¼š</p>
<ul>
<li>æŸ¥æ‰¾æ‰€æœ‰å…±äº«å†…å­˜è®¿é—®ç‚¹</li>
<li>éªŒè¯æ¯ä¸ªå†™-è¯»åºåˆ—é—´çš„åŒæ­¥</li>
<li>æ£€æŸ¥åŸå­æ“ä½œçš„å¿…è¦æ€§</li>
</ul>
<p><strong>åŠ¨æ€æ£€æµ‹</strong></p>
<p>ä½¿ç”¨cuda-memcheckçš„racecheckå·¥å…·ï¼š</p>
<div class="codehilite"><pre><span></span><code>cuda-memcheck<span class="w"> </span>--tool<span class="w"> </span>racecheck<span class="w"> </span>--racecheck-report<span class="w"> </span>all<span class="w"> </span>./myapp
</code></pre></div>

<p>racecheckä¼šæŠ¥å‘Šï¼š</p>
<ul>
<li>Hazardç±»å‹ï¼ˆWARã€WAWã€RAWï¼‰</li>
<li>æ¶‰åŠçš„å†…å­˜åœ°å€</li>
<li>å†²çªçš„çº¿ç¨‹ID</li>
<li>æºä»£ç ä½ç½®ï¼ˆå¦‚æœæœ‰è°ƒè¯•ä¿¡æ¯ï¼‰</li>
</ul>
<p><strong>è‡ªå®šä¹‰ç«æ€æ£€æµ‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RaceDetector</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">AccessInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">threadId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">blockId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lineNumber</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">isWrite</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AccessInfo</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">accessLog</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">logAccess</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">isWrite</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#ifdef RACE_DETECTION</span>
<span class="w">        </span><span class="n">AccessInfo</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">threadId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">blockId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">lineNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">isWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isWrite</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åŸå­åœ°è®°å½•è®¿é—®</span>
<span class="w">        </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">accessCount</span><span class="p">[</span><span class="n">ptr</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">analyzeRaces</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åå¤„ç†åˆ†æå†²çªè®¿é—®æ¨¡å¼</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">accesses</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">accessLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">detectConflicts</span><span class="p">(</span><span class="n">accesses</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2623">26.2.3 ç«æ€æ¡ä»¶çš„ä¿®å¤ç­–ç•¥</h3>
<ol>
<li><strong>æ­£ç¡®çš„åŒæ­¥æ’å…¥</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fixedKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharedData</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// å†™å…¥é˜¶æ®µ</span>
<span class="w">    </span><span class="n">sharedData</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// å…³é”®ï¼šç¡®ä¿æ‰€æœ‰çº¿ç¨‹å®Œæˆå†™å…¥</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è¯»å–é˜¶æ®µ</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharedData</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sharedData</span><span class="p">[(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>åŸå­æ“ä½œæ›¿æ¢</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">atomicFix</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">histogram</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeBin</span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨åŸå­æ“ä½œé¿å…ç«æ€</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histogram</span><span class="p">[</span><span class="n">bin</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¯¹äºå¤æ‚æ•°æ®ç»“æ„ï¼Œä½¿ç”¨CASå¾ªç¯</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">complexStruct</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">assumed</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">assumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="w">        </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicCAS</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">assumed</span><span class="p">,</span><span class="w"> </span><span class="n">updateValue</span><span class="p">(</span><span class="n">assumed</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">assumed</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>ç®—æ³•é‡æ„</strong></li>
</ol>
<p>æœ‰æ—¶é‡æ–°è®¾è®¡ç®—æ³•æ¯”ä¿®å¤ç«æ€æ›´æœ‰æ•ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸå§‹æœ‰ç«æ€çš„å½’çº¦</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">racyReduction</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¤šä¸ªblockå†™å…¥åŒä¸€ä½ç½®</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">localSum</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ€§èƒ½ç“¶é¢ˆ</span>
<span class="p">}</span>

<span class="c1">// é‡æ„åçš„ä¸¤é˜¶æ®µå½’çº¦</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">safeReduction</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">partialSums</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ç¬¬ä¸€é˜¶æ®µï¼šæ¯ä¸ªblockç‹¬ç«‹å½’çº¦</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sharedSum</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// ... å±€éƒ¨å½’çº¦ ...</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">partialSums</span><span class="p">[</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharedSum</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">finalReduction</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">partialSums</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numBlocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ç¬¬äºŒé˜¶æ®µï¼šå•ä¸ªblockå½’çº¦æ‰€æœ‰éƒ¨åˆ†å’Œ</span>
<span class="w">    </span><span class="c1">// ... æœ€ç»ˆå½’çº¦ ...</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2624">26.2.4 è‡ªåŠ¨é©¾é©¶åœºæ™¯çš„ç«æ€æ¡ˆä¾‹</h3>
<p>åœ¨æ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶æ›´æ–°åŒä¸€ä¸ªä½“ç´ ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">voxelization</span><span class="p">(</span><span class="n">Point</span><span class="o">*</span><span class="w"> </span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">Voxel</span><span class="o">*</span><span class="w"> </span><span class="n">voxels</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numPoints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numPoints</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">voxelIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeVoxelIndex</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç«æ€ï¼šå¤šä¸ªç‚¹å¯èƒ½æ˜ å°„åˆ°åŒä¸€ä½“ç´ </span>
<span class="w">    </span><span class="c1">// é”™è¯¯æ–¹å¼ï¼š</span>
<span class="w">    </span><span class="c1">// voxels[voxelIdx].count++;</span>
<span class="w">    </span><span class="c1">// voxels[voxelIdx].sumX += p.x;</span>

<span class="w">    </span><span class="c1">// æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨åŸå­æ“ä½œ</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voxels</span><span class="p">[</span><span class="n">voxelIdx</span><span class="p">].</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voxels</span><span class="p">[</span><span class="n">voxelIdx</span><span class="p">].</span><span class="n">sumX</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voxels</span><span class="p">[</span><span class="n">voxelIdx</span><span class="p">].</span><span class="n">sumY</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voxels</span><span class="p">[</span><span class="n">voxelIdx</span><span class="p">].</span><span class="n">sumZ</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æˆ–è€…ä½¿ç”¨é”</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voxels</span><span class="p">[</span><span class="n">voxelIdx</span><span class="p">].</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">voxels</span><span class="p">[</span><span class="n">voxelIdx</span><span class="p">].</span><span class="n">addPoint</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voxels</span><span class="p">[</span><span class="n">voxelIdx</span><span class="p">].</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="263">26.3 æ­»é”åˆ†æä¸é¢„é˜²</h2>
<h3 id="2631-cuda">26.3.1 CUDAä¸­çš„æ­»é”ç±»å‹</h3>
<ol>
<li><strong>åŒæ­¥æ­»é”</strong></li>
</ol>
<p>æœ€å¸¸è§çš„æ­»é”å‘ç”Ÿåœ¨æ¡ä»¶æ€§çš„__syncthreads()è°ƒç”¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">deadlockKernel</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åªæœ‰éƒ¨åˆ†çº¿ç¨‹æ‰§è¡ŒåŒæ­¥</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ­»é”ï¼</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>èµ„æºç«äº‰æ­»é”</strong></li>
</ol>
<p>å¤šä¸ªçº¿ç¨‹ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">lock1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lock2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">resourceDeadlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// çº¿ç¨‹0,2,4...å…ˆè·å–lock1</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">__threadfence</span><span class="p">();</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…lock2</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// çº¿ç¨‹1,3,5...å…ˆè·å–lock2</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">__threadfence</span><span class="p">();</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…lock1</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>åµŒå¥—å¹¶è¡Œæ­»é”</strong></li>
</ol>
<p>åŠ¨æ€å¹¶è¡Œä¸­çš„çˆ¶å­kernelåŒæ­¥é—®é¢˜ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">parentKernel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">childKernel</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="o">&gt;&gt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// é”™è¯¯ï¼šåœ¨å­kernelå®Œæˆå‰åŒæ­¥</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span><span class="w">  </span><span class="c1">// å¯èƒ½æ­»é”</span>
<span class="w">        </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2632">26.3.2 æ­»é”æ£€æµ‹æŠ€æœ¯</h3>
<p><strong>è¶…æ—¶æ£€æµ‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DeadlockDetector</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">startEvent</span><span class="p">,</span><span class="w"> </span><span class="n">endEvent</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// 5ç§’è¶…æ—¶</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">checkKernel</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">kernel</span><span class="p">)(...),</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">startEvent</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endEvent</span><span class="p">);</span>

<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">startEvent</span><span class="p">);</span>
<span class="w">        </span><span class="n">kernel</span><span class="o">&lt;&lt;&lt;</span><span class="p">...</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>
<span class="w">        </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">endEvent</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// éé˜»å¡ç­‰å¾…</span>
<span class="w">        </span><span class="n">cudaError_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaEventQuery</span><span class="p">(</span><span class="n">endEvent</span><span class="p">);</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cudaErrorNotReady</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">milli</span><span class="o">&gt;</span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Potential deadlock detected in kernel!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// è§¦å‘è°ƒè¯•æˆ–æ—¥å¿—è®°å½•</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaEventQuery</span><span class="p">(</span><span class="n">endEvent</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ä¾èµ–å›¾åˆ†æ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DependencyGraph</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">resourceId</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">waitingFor</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">heldBy</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">detectCycle</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨DFSæ£€æµ‹å¾ªç¯ä¾èµ–</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visited</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">recStack</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">graph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">detectCycleUtil</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">recStack</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">  </span><span class="c1">// å‘ç°æ­»é”</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">detectCycleUtil</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">recStack</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">visited</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="w">        </span><span class="n">recStack</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">neighbor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">graph</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">waitingFor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recStack</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">neighbor</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">visited</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">neighbor</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">detectCycleUtil</span><span class="p">(</span><span class="n">neighbor</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">recStack</span><span class="p">))</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">recStack</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2633">26.3.3 æ­»é”é¢„é˜²ç­–ç•¥</h3>
<ol>
<li><strong>é¿å…æ¡ä»¶åŒæ­¥</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// å±é™©çš„æ¡ä»¶åŒæ­¥</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">unsafeSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span><span class="w">  </span><span class="c1">// å±é™©ï¼</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å®‰å…¨çš„é‡æ„</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">safeSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ–¹æ³•1ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡ŒåŒæ­¥</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">localCondition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">condition</span><span class="p">;</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">localCondition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ‰§è¡Œæ¡ä»¶ä»£ç </span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ–¹æ³•2ï¼šä½¿ç”¨åä½œç»„</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">tiled_partition</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cg</span><span class="o">::</span><span class="n">this_thread_block</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tile</span><span class="p">.</span><span class="n">sync</span><span class="p">();</span><span class="w">  </span><span class="c1">// åªåŒæ­¥å­ç»„</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>èµ„æºæœ‰åºè·å–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">getLockOrder</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">lockId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å®šä¹‰å…¨å±€é”é¡ºåº</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lockId</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">orderedLocking</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lock1_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lock2_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lock1_id</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å§‹ç»ˆæŒ‰ç…§ç›¸åŒé¡ºåºè·å–é”</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getLockOrder</span><span class="p">(</span><span class="n">lock1_id</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">getLockOrder</span><span class="p">(</span><span class="n">lock2_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">acquireLock</span><span class="p">(</span><span class="n">lock1_id</span><span class="p">);</span>
<span class="w">        </span><span class="n">acquireLock</span><span class="p">(</span><span class="n">lock2_id</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">acquireLock</span><span class="p">(</span><span class="n">lock2_id</span><span class="p">);</span>
<span class="w">        </span><span class="n">acquireLock</span><span class="p">(</span><span class="n">lock1_id</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>è¶…æ—¶é‡Šæ”¾æœºåˆ¶</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">tryAcquireWithTimeout</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout_cycles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">clock_t</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock</span><span class="p">();</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">clock_t</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout_cycles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// è·å–å¤±è´¥</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">  </span><span class="c1">// æˆåŠŸè·å–</span>
<span class="p">}</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">timeoutLocking</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">locks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TIMEOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ—¶é’Ÿå‘¨æœŸ</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tryAcquireWithTimeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">TIMEOUT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tryAcquireWithTimeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">TIMEOUT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// æˆåŠŸè·å–ä¸¤ä¸ªé”</span>
<span class="w">            </span><span class="n">doWork</span><span class="p">();</span>
<span class="w">            </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œé¿å…æ­»é”</span>
<span class="w">            </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// å¯ä»¥é€‰æ‹©é‡è¯•æˆ–æ”¾å¼ƒ</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="264">26.4 å†…å­˜é”™è¯¯å®šä½</h2>
<h3 id="2641">26.4.1 å¸¸è§å†…å­˜é”™è¯¯ç±»å‹</h3>
<ol>
<li><strong>è¶Šç•Œè®¿é—®</strong></li>
</ol>
<p>è¶Šç•Œè®¿é—®æ˜¯CUDAç¨‹åºä¸­æœ€å¸¸è§çš„é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´é™é»˜çš„æ•°æ®æŸåæˆ–ç¨‹åºå´©æºƒï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">outOfBounds</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// é”™è¯¯1ï¼šå¿˜è®°è¾¹ç•Œæ£€æŸ¥</span>
<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// tidå¯èƒ½è¶…è¿‡size</span>

<span class="w">    </span><span class="c1">// é”™è¯¯2ï¼šé”™è¯¯çš„ç´¢å¼•è®¡ç®—</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// idxå¯èƒ½è¿œè¶…æ•°ç»„è¾¹ç•Œ</span>

<span class="w">    </span><span class="c1">// é”™è¯¯3ï¼šå…±äº«å†…å­˜è¶Šç•Œ</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">shared</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="n">shared</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span><span class="w">  </span><span class="c1">// threadIdx.xå¯èƒ½æ˜¯255</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å†…å­˜æ³„æ¼</strong></li>
</ol>
<p>GPUå†…å­˜æ³„æ¼æ¯”CPUæ›´éšè”½ï¼Œå› ä¸ºæ²¡æœ‰è¿›ç¨‹ç»“æŸæ—¶çš„è‡ªåŠ¨æ¸…ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MemoryLeaker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_data</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é”™è¯¯ï¼šé‡å¤åˆ†é…è€Œä¸é‡Šæ”¾</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">~</span><span class="n">MemoryLeaker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é”™è¯¯ï¼šå¿˜è®°åœ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾</span>
<span class="w">        </span><span class="c1">// cudaFree(d_data);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<ol start="3">
<li><strong>éå¯¹é½è®¿é—®</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">misalignedAccess</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// é”™è¯¯ï¼šéå¯¹é½çš„floatè®¿é—®</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">floatPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">floatPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.14f</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¦‚æœthreadIdx.xä¸æ˜¯4çš„å€æ•°ï¼Œåˆ™éå¯¹é½</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2642">26.4.2 é«˜çº§å†…å­˜é”™è¯¯æ£€æµ‹</h3>
<p><strong>è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CudaMemoryTracker</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">AllocationInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">line</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">AllocationInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allocations</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">allocMutex</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">totalAllocated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">peakAllocated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaError_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">allocMutex</span><span class="p">);</span>
<span class="w">            </span><span class="n">allocations</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">            </span><span class="n">totalAllocated</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">            </span><span class="n">peakAllocated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">peakAllocated</span><span class="p">,</span><span class="w"> </span><span class="n">totalAllocated</span><span class="p">);</span>

<span class="w">            </span><span class="cp">#ifdef DEBUG_MEMORY</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Allocated %zu bytes at %p from %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">);</span>
<span class="w">            </span><span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">allocMutex</span><span class="p">);</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocations</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allocations</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR: Freeing untracked pointer %p at %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">totalAllocated</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
<span class="w">        </span><span class="n">allocations</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">checkLeaks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">allocMutex</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">allocations</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Memory leaks detected:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">allocations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %zu bytes at %p from %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Peak memory usage: %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">peakAllocated</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define CUDA_MALLOC(ptr, size) \</span>
<span class="cp">    tracker.allocate(size, __FILE__, __LINE__)</span>
<span class="cp">#define CUDA_FREE(ptr) \</span>
<span class="cp">    tracker.deallocate(ptr, __FILE__, __LINE__)</span>
</code></pre></div>

<p><strong>è¾¹ç•Œä¿æŠ¤</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BoundsProtectedArray</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">d_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="n">d_guardFront</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="n">d_guardBack</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">GUARD_PATTERN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xDEADBEEF</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åˆ†é…é¢å¤–çš„ä¿æŠ¤ç©ºé—´</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_guardFront</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_guardBack</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ–ä¿æŠ¤å€¼</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_guardFront</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">GUARD_PATTERN</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_guardBack</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">GUARD_PATTERN</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">checkIntegrity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">frontVal</span><span class="p">,</span><span class="w"> </span><span class="n">backVal</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontVal</span><span class="p">,</span><span class="w"> </span><span class="n">d_guardFront</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">backVal</span><span class="p">,</span><span class="w"> </span><span class="n">d_guardBack</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frontVal</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GUARD_PATTERN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Front guard corrupted: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">frontVal</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">backVal</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GUARD_PATTERN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Back guard corrupted: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">backVal</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2643">26.4.3 å†…å­˜é”™è¯¯çš„å®šä½æŠ€æœ¯</h3>
<p><strong>äºŒåˆ†æŸ¥æ‰¾å®šä½</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BinarySearchDebugger</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">KernelFunc</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">findErrorLocation</span><span class="p">(</span><span class="n">KernelFunc</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minIter</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxIter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">minIter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxIter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">minIter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">maxIter</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// è¿è¡Œåˆ°ä¸­é—´è¿­ä»£</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">errorOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runUntilIteration</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errorOccurred</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">maxIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mid</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">minIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error first occurs at iteration %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">minIter</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">runUntilIteration</span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iter</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">kernel</span><span class="p">();</span>
<span class="w">            </span><span class="n">cudaError_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaGetLastError</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>å†…å­˜æ¨¡å¼åˆ†æ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">analyzeMemoryPattern</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è®°å½•è®¿é—®æ¨¡å¼</span>
<span class="w">    </span><span class="cp">#ifdef MEMORY_PATTERN_ANALYSIS</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">accessHistogram</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">HISTOGRAM_SIZE</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ£€æµ‹è·¨æ­¥è®¿é—®</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastAccessIndex</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stride</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nonUnitStrideCount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">lastAccessIndex</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2644">26.4.4 å…·èº«æ™ºèƒ½åœºæ™¯çš„å†…å­˜é”™è¯¯æ¡ˆä¾‹</h3>
<p>åœ¨SLAMç³»ç»Ÿä¸­ï¼Œç‰¹å¾ç‚¹åŒ¹é…çš„å†…å­˜ç®¡ç†å®¹æ˜“å‡ºé”™ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FeatureMatcherDebug</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">FeatureDescriptor</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">desc</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">imageId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">featureId</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">FeatureDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">d_features</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">d_matches</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxFeatures</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">matchFeatures</span><span class="p">(</span><span class="n">FeatureDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">features1</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                  </span><span class="n">FeatureDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">features2</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">matches</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// é”™è¯¯æ£€æŸ¥1ï¼šè¾¹ç•ŒéªŒè¯</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n1</span><span class="p">);</span><span class="w">  </span><span class="c1">// åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¯ç”¨</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">minDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLT_MAX</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n2</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é”™è¯¯æ£€æŸ¥2ï¼šå†…å­˜è®¿é—®éªŒè¯</span>
<span class="w">            </span><span class="cp">#ifdef DEBUG_MEMORY_ACCESS</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">features2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">d_memory_start</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<span class="w">                </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">features2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">d_memory_end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Out of bounds access at thread %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="cp">#endif</span>

<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeDistance</span><span class="p">(</span><span class="n">features1</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span><span class="w"> </span><span class="n">features2</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minDist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">minDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="w">                </span><span class="n">bestMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// é”™è¯¯æ£€æŸ¥3ï¼šå†™å…¥å‰éªŒè¯</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n1</span><span class="p">);</span>
<span class="w">        </span><span class="n">matches</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestMatch</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">validateMatches</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">h_matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">n1</span><span class="p">];</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">h_matches</span><span class="p">,</span><span class="w"> </span><span class="n">d_matches</span><span class="p">,</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h_matches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">h_matches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid match index %d at position %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">h_matches</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">h_matches</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="265">26.5 æ•°å€¼ç²¾åº¦é—®é¢˜è°ƒè¯•</h2>
<h3 id="2651">26.5.1 æµ®ç‚¹ç²¾åº¦é—®é¢˜çš„æ¥æº</h3>
<ol>
<li><strong>å¹¶è¡Œå½’çº¦çš„æ•°å€¼è¯¯å·®</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">numericalErrorDemo</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">shared</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">shared</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="p">];</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// é—®é¢˜ï¼šä¸åŒçš„å½’çº¦é¡ºåºå¯¼è‡´ä¸åŒçš„èˆå…¥è¯¯å·®</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">shared</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">shared</span><span class="p">[</span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">];</span><span class="w">  </span><span class="c1">// æµ®ç‚¹åŠ æ³•ä¸æ»¡è¶³ç»“åˆå¾‹</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">result</span><span class="p">[</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shared</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>æ··åˆç²¾åº¦è®¡ç®—</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mixedPrecisionIssue</span><span class="p">(</span><span class="n">half</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">half</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// é—®é¢˜ï¼šhalfç²¾åº¦èŒƒå›´æœ‰é™</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__half2float</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯èƒ½æº¢å‡º</span>

<span class="w">    </span><span class="c1">// é—®é¢˜ï¼šç²¾åº¦æŸå¤±</span>
<span class="w">    </span><span class="n">half</span><span class="w"> </span><span class="n">h2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__float2half</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__half2float</span><span class="p">(</span><span class="n">h2</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç²¾åº¦å·²æŸå¤±</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2652">26.5.2 æ•°å€¼ç¨³å®šæ€§åˆ†æ</h3>
<p><strong>Kahanæ±‚å’Œç®—æ³•</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">kahanSum</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// è¡¥å¿å€¼</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">     </span><span class="c1">// å‡å»ä¹‹å‰çš„è¯¯å·®</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">          </span><span class="c1">// æ–°çš„å’Œ</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sum</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">          </span><span class="c1">// è®¡ç®—æ–°çš„è¯¯å·®</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">stableReduction</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">shared</span><span class="p">[];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨Kahanæ±‚å’ŒåŠ è½½æ•°æ®</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">localSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gid</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localSum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">localSum</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">        </span><span class="n">localSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">shared</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localSum</span><span class="p">;</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// æ ‘å½¢å½’çº¦æ—¶ä¹Ÿä½¿ç”¨è¡¥å¿</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æ•°å€¼èŒƒå›´æ£€æŸ¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NumericalRangeChecker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">checkRange</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isfinite</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Non-finite value in %s: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1e10f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Large value warning in %s: %e</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-10f</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Small value warning in %s: %e</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">checkGradient</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">GRADIENT_CLIP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">GRADIENT_CLIP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Gradient explosion detected: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">grad</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;NaN gradient detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2653">26.5.3 ç²¾åº¦è°ƒè¯•å·¥å…·</h3>
<p><strong>ULPï¼ˆUnits in Last Placeï¼‰æ¯”è¾ƒ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">floatULP</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__float_as_int</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__float_as_int</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¤„ç†ç¬¦å·ä¸åŒçš„æƒ…å†µ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ia</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">ia</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">almostEqual</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxULP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">floatULP</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxULP</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">precisionTest</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">results1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">results2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results1</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results2</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ulp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">floatULP</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ulp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Large ULP difference at %d: %d ULPs (%.9f vs %.9f)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">ulp</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è¯¯å·®ä¼ æ’­åˆ†æ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ErrorPropagation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ValueWithError</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">T</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">T</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>

<span class="w">        </span><span class="n">__device__</span><span class="w"> </span><span class="n">ValueWithError</span><span class="w"> </span><span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ValueWithError</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
<span class="w">                </span><span class="n">error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">machineEpsilon</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">__device__</span><span class="w"> </span><span class="n">ValueWithError</span><span class="w"> </span><span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ValueWithError</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
<span class="w">                </span><span class="n">fabsf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fabsf</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                </span><span class="n">error</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">machineEpsilon</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">machineEpsilon</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">epsilon</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2654">26.5.4 è‡ªåŠ¨é©¾é©¶åœºæ™¯çš„ç²¾åº¦é—®é¢˜</h3>
<p>åœ¨æ¿€å…‰é›·è¾¾å’Œç›¸æœºèåˆä¸­ï¼Œåæ ‡å˜æ¢çš„ç²¾åº¦è‡³å…³é‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SensorFusionDebug</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Transform3D</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ—‹è½¬çŸ©é˜µ</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w">  </span><span class="c1">// å¹³ç§»å‘é‡</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">transformPointWithErrorCheck</span><span class="p">(</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">Transform3D</span><span class="o">&amp;</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥è¾“å…¥æœ‰æ•ˆæ€§</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isfinite</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid input point[%d]: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ¡ä»¶æ•°æ£€æŸ¥ï¼ˆè¯„ä¼°çŸ©é˜µç¨³å®šæ€§ï¼‰</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">conditionNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeConditionNumber</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">R</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">conditionNumber</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Warning: High condition number %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">conditionNumber</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ä½¿ç”¨è¡¥å¿æ±‚å’Œè¿›è¡Œå˜æ¢</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform</span><span class="p">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">point</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prod</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sum</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">transform</span><span class="p">.</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">            </span><span class="c1">// æ£€æŸ¥è¾“å‡ºèŒƒå›´</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Large transformed value: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">computeConditionNumber</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">matrix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç®€åŒ–çš„æ¡ä»¶æ•°ä¼°è®¡</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">maxNorm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">maxNorm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">maxNorm</span><span class="p">,</span><span class="w"> </span><span class="n">fabsf</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">maxNorm</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç®€åŒ–ç‰ˆæœ¬</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="266">26.6 æ¡ˆä¾‹ï¼šå¤æ‚ç³»ç»Ÿçš„è°ƒè¯•å®æˆ˜</h2>
<h3 id="2661-slam">26.6.1 å¤šä¼ æ„Ÿå™¨SLAMç³»ç»Ÿè°ƒè¯•</h3>
<p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„è§†è§‰-æ¿€å…‰é›·è¾¾SLAMç³»ç»Ÿæ¡ˆä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ç³»ç»Ÿåœ°è°ƒè¯•å¤æ‚çš„CUDAåº”ç”¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VLSLAMDebugger</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// è°ƒè¯•é…ç½®</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">DebugConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">enableMemoryCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">enableRaceDetection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">enablePrecisionCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">dumpIntermediateResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">verboseLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ€§èƒ½è®¡æ—¶å™¨</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Timer</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">        </span><span class="n">Timer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">name</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
<span class="w">            </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>
<span class="w">            </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">~</span><span class="n">Timer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">            </span><span class="n">cudaEventSynchronize</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">ms</span><span class="p">;</span>
<span class="w">            </span><span class="n">cudaEventElapsedTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">);</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[TIMING] %s: %.3f ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">ms</span><span class="p">);</span>
<span class="w">            </span><span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="w">            </span><span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">debugFeatureExtraction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">(</span><span class="s">&quot;Feature Extraction&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ­¥éª¤1ï¼šéªŒè¯è¾“å…¥å›¾åƒ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">enableMemoryCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">checkImageValidity</span><span class="p">(</span><span class="n">d_image</span><span class="p">,</span><span class="w"> </span><span class="n">imageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">imageHeight</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ­¥éª¤2ï¼šç‰¹å¾æå–kernel</span>
<span class="w">        </span><span class="n">dim3</span><span class="w"> </span><span class="n">blockSize</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">        </span><span class="n">dim3</span><span class="w"> </span><span class="n">gridSize</span><span class="p">((</span><span class="n">imageWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">imageHeight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ’å…¥åŒæ­¥ç‚¹ä»¥ä¾¿ç²¾ç¡®å®šä½é”™è¯¯</span>
<span class="w">        </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span>
<span class="w">        </span><span class="n">CHECK_CUDA_ERROR</span><span class="p">(</span><span class="s">&quot;Before feature extraction&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">extractFeaturesKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">d_image</span><span class="p">,</span><span class="w"> </span><span class="n">d_features</span><span class="p">,</span><span class="w"> </span><span class="n">imageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">imageHeight</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç«‹å³æ£€æŸ¥kernelé”™è¯¯</span>
<span class="w">        </span><span class="n">CHECK_CUDA_ERROR</span><span class="p">(</span><span class="s">&quot;After feature extraction&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ­¥éª¤3ï¼šéªŒè¯è¾“å‡º</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">enableMemoryCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">validateFeatures</span><span class="p">(</span><span class="n">d_features</span><span class="p">,</span><span class="w"> </span><span class="n">numFeatures</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">debugPointCloudRegistration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">(</span><span class="s">&quot;Point Cloud Registration&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ä½¿ç”¨åˆ†é˜¶æ®µè°ƒè¯•</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxIterations</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">verboseLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ICP Iteration %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// æ­¥éª¤1ï¼šæœ€è¿‘é‚»æœç´¢</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">Timer</span><span class="w"> </span><span class="n">knnTimer</span><span class="p">(</span><span class="s">&quot;KNN Search&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">findNearestNeighbors</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">                    </span><span class="n">d_sourcePoints</span><span class="p">,</span><span class="w"> </span><span class="n">d_targetPoints</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">d_correspondences</span><span class="p">,</span><span class="w"> </span><span class="n">numPoints</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">enableRaceDetection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">checkCorrespondences</span><span class="p">(</span><span class="n">d_correspondences</span><span class="p">,</span><span class="w"> </span><span class="n">numPoints</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// æ­¥éª¤2ï¼šè®¡ç®—å˜æ¢çŸ©é˜µ</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">Timer</span><span class="w"> </span><span class="n">svdTimer</span><span class="p">(</span><span class="s">&quot;SVD Computation&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">computeTransformSVD</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">                    </span><span class="n">d_correspondences</span><span class="p">,</span><span class="w"> </span><span class="n">d_transform</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">enablePrecisionCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">checkTransformStability</span><span class="p">(</span><span class="n">d_transform</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// æ­¥éª¤3ï¼šåº”ç”¨å˜æ¢</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">Timer</span><span class="w"> </span><span class="n">transformTimer</span><span class="p">(</span><span class="s">&quot;Apply Transform&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">applyTransform</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">                    </span><span class="n">d_sourcePoints</span><span class="p">,</span><span class="w"> </span><span class="n">d_transform</span><span class="p">,</span><span class="w"> </span><span class="n">numPoints</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// æ£€æŸ¥æ•°å€¼ç¨³å®šæ€§</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">enablePrecisionCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">checkNumericalStability</span><span class="p">(</span><span class="n">d_sourcePoints</span><span class="p">,</span><span class="w"> </span><span class="n">numPoints</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// æ”¶æ•›æ£€æŸ¥</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeRegistrationError</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">verboseLevel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  Error: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">convergenceThreshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Converged at iteration %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">checkImageValidity</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ£€æŸ¥å›¾åƒæ•°æ®æœ‰æ•ˆæ€§</span>
<span class="w">        </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">d_invalidCount</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_invalidCount</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMemset</span><span class="p">(</span><span class="n">d_invalidCount</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

<span class="w">        </span><span class="n">checkImageKernel</span><span class="o">&lt;&lt;&lt;</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">255</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">d_invalidCount</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">invalidCount</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">invalidCount</span><span class="p">,</span><span class="w"> </span><span class="n">d_invalidCount</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">invalidCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: %d invalid pixels detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">invalidCount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_invalidCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">checkCorrespondences</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">corr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ£€æŸ¥å¯¹åº”å…³ç³»çš„æœ‰æ•ˆæ€§</span>
<span class="w">        </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">h_corr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">h_corr</span><span class="p">,</span><span class="w"> </span><span class="n">corr</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">used</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">duplicates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h_corr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">h_corr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">duplicates</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">used</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">h_corr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duplicates</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: %d duplicate correspondences</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">duplicates</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">h_corr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">checkTransformStability</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">transform</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ£€æŸ¥å˜æ¢çŸ©é˜µçš„æ•°å€¼ç¨³å®šæ€§</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">h_transform</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">h_transform</span><span class="p">,</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥æ—‹è½¬éƒ¨åˆ†çš„æ­£äº¤æ€§</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">det</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeDeterminant3x3</span><span class="p">(</span><span class="n">h_transform</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">det</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.01f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: Non-orthogonal rotation matrix, det=%f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">det</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥å¹³ç§»éƒ¨åˆ†çš„åˆç†æ€§</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">h_transform</span><span class="p">[</span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: Large translation: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">h_transform</span><span class="p">[</span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2662">26.6.2 è°ƒè¯•å·¥ä½œæµç¨‹</h3>
<p><strong>ç³»ç»ŸåŒ–çš„è°ƒè¯•æ–¹æ³•è®º</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SystematicDebugger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="nc">DebugLevel</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">NONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="n">ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="n">WARNING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">        </span><span class="n">INFO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">        </span><span class="n">VERBOSE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">DebugState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">currentKernel</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">currentIteration</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">callStack</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">DebugState</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="n">DebugLevel</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INFO</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">runWithDebug</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mainFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é˜¶æ®µ1ï¼šåˆå§‹åŒ–æ£€æŸ¥</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Debug Phase 1: Initialization ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">checkDeviceCapabilities</span><span class="p">();</span>
<span class="w">            </span><span class="n">checkMemoryAvailability</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// é˜¶æ®µ2ï¼šè¾“å…¥éªŒè¯</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Debug Phase 2: Input Validation ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">validateAllInputs</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// é˜¶æ®µ3ï¼šé€æ­¥æ‰§è¡Œ</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Debug Phase 3: Incremental Execution ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">enableIncrementalMode</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// è¿è¡Œä¸»å‡½æ•°</span>
<span class="w">            </span><span class="n">mainFunc</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// é˜¶æ®µ4ï¼šè¾“å‡ºéªŒè¯</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Debug Phase 4: Output Validation ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">validateAllOutputs</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// é˜¶æ®µ5ï¼šæ€§èƒ½åˆ†æ</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Debug Phase 5: Performance Analysis ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">analyzePerformance</span><span class="p">();</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Exception caught: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="w">            </span><span class="n">dumpDebugState</span><span class="p">();</span>
<span class="w">            </span><span class="k">throw</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">checkDeviceCapabilities</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaDeviceProp</span><span class="w"> </span><span class="n">prop</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaGetDeviceProperties</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Device: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Compute Capability: %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Total Memory: %.2f GB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="n">totalGlobalMem</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e9</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥ç‰¹å®šåŠŸèƒ½æ”¯æŒ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">major</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: Tensor Cores not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">.</span><span class="n">cooperativeLaunch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: Cooperative launch not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">dumpDebugState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Debug State Dump ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Current Kernel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">currentKernel</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Current Iteration: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">currentIteration</span><span class="p">);</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Call Stack:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">callStack</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Metrics:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">metrics</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %s: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ä¿å­˜å†…å­˜å¿«ç…§</span>
<span class="w">        </span><span class="n">saveMemorySnapshot</span><span class="p">(</span><span class="s">&quot;debug_snapshot.bin&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="2663">26.6.3 é”™è¯¯æ¢å¤ç­–ç•¥</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ErrorRecovery</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">CheckpointData</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">deviceMemory</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">iteration</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">metric</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CheckpointData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkpoints</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">createCheckpoint</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">CheckpointData</span><span class="w"> </span><span class="n">cp</span><span class="p">;</span>
<span class="w">        </span><span class="n">cp</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">        </span><span class="n">cp</span><span class="p">.</span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">;</span>

<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">deviceMemory</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">deviceMemory</span><span class="p">,</span><span class="w"> </span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">);</span>

<span class="w">        </span><span class="n">checkpoints</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// åªä¿ç•™æœ€è¿‘5ä¸ªæ£€æŸ¥ç‚¹</span>
<span class="w">            </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">deviceMemory</span><span class="p">);</span>
<span class="w">            </span><span class="n">checkpoints</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">recoverFromError</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkpoints</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;No checkpoints available for recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lastCP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkpoints</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastCP</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Checkpoint size mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span><span class="n">lastCP</span><span class="p">.</span><span class="n">deviceMemory</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">);</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Recovered from checkpoint at iteration %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="n">lastCP</span><span class="p">.</span><span class="n">iteration</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">cleanupCheckpoints</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">checkpoints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">deviceMemory</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">checkpoints</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">executeWithRecovery</span><span class="p">(</span><span class="n">Func</span><span class="w"> </span><span class="n">kernelFunc</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ErrorRecovery</span><span class="w"> </span><span class="n">recovery</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">retries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">retries</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">kernelFunc</span><span class="p">();</span>

<span class="w">            </span><span class="n">cudaError_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaGetLastError</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">cudaGetErrorString</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">  </span><span class="c1">// æˆåŠŸæ‰§è¡Œ</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Execution failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">recovery</span><span class="p">.</span><span class="n">recoverFromError</span><span class="p">(</span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span><span class="n">dataSize</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Recovery failed, retry %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">retries</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">retries</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retries</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Max retries exceeded&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†CUDAç¨‹åºè°ƒè¯•çš„æ ¸å¿ƒæŠ€æœ¯å’Œæ–¹æ³•è®ºã€‚æˆ‘ä»¬å­¦ä¹ äº†ä»åŸºç¡€çš„cuda-gdbå’Œcuda-memcheckå·¥å…·ä½¿ç”¨ï¼Œåˆ°å¤æ‚çš„ç«æ€æ¡ä»¶ã€æ­»é”ã€å†…å­˜é”™è¯¯å’Œæ•°å€¼ç²¾åº¦é—®é¢˜çš„è¯Šæ–­ä¸ä¿®å¤ã€‚é€šè¿‡è‡ªåŠ¨é©¾é©¶å’Œå…·èº«æ™ºèƒ½çš„å®é™…æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ç³»ç»Ÿåœ°è°ƒè¯•å¤§è§„æ¨¡å¹¶è¡Œç³»ç»Ÿã€‚</p>
<p><strong>å…³é”®è¦ç‚¹</strong>ï¼š</p>
<ol>
<li><strong>è°ƒè¯•å·¥å…·é“¾</strong>ï¼šcuda-gdbæä¾›æ–­ç‚¹å’Œå•æ­¥è°ƒè¯•èƒ½åŠ›ï¼Œcuda-memcheckæ£€æµ‹å†…å­˜é”™è¯¯å’Œç«æ€æ¡ä»¶</li>
<li><strong>ç«æ€æ¡ä»¶</strong>ï¼šæºäºéåŒæ­¥çš„å…±äº«èµ„æºè®¿é—®ï¼Œéœ€è¦é€šè¿‡æ­£ç¡®çš„åŒæ­¥åŸè¯­æˆ–ç®—æ³•é‡æ„æ¥è§£å†³</li>
<li><strong>æ­»é”é¢„é˜²</strong>ï¼šé¿å…æ¡ä»¶åŒæ­¥ï¼Œä½¿ç”¨èµ„æºæœ‰åºè·å–å’Œè¶…æ—¶æœºåˆ¶</li>
<li><strong>å†…å­˜é”™è¯¯å®šä½</strong>ï¼šé€šè¿‡è¾¹ç•Œä¿æŠ¤ã€è‡ªå®šä¹‰åˆ†é…å™¨å’ŒäºŒåˆ†æŸ¥æ‰¾ç­‰æŠ€æœ¯ç²¾ç¡®å®šä½é—®é¢˜</li>
<li><strong>æ•°å€¼ç²¾åº¦</strong>ï¼šä½¿ç”¨Kahanæ±‚å’Œã€ULPæ¯”è¾ƒå’Œè¯¯å·®ä¼ æ’­åˆ†æç¡®ä¿è®¡ç®—å‡†ç¡®æ€§</li>
<li><strong>ç³»ç»ŸåŒ–è°ƒè¯•</strong>ï¼šå»ºç«‹åˆ†é˜¶æ®µçš„è°ƒè¯•æµç¨‹ï¼Œä½¿ç”¨æ£€æŸ¥ç‚¹å’Œé”™è¯¯æ¢å¤æœºåˆ¶æé«˜é²æ£’æ€§</li>
</ol>
<p><strong>æ ¸å¿ƒå…¬å¼</strong>ï¼š</p>
<ul>
<li>Kahanæ±‚å’Œè¯¯å·®è¡¥å¿ï¼š<code>c = (t - sum) - y</code></li>
<li>ULPè·ç¦»è®¡ç®—ï¼š<code>|float_as_int(a) - float_as_int(b)|</code></li>
<li>æ¡ä»¶æ•°ä¼°è®¡ï¼š<code>Îº(A) = ||A|| Â· ||A^(-1)||</code></li>
</ul>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹ 26.1</strong>ï¼šä½¿ç”¨cuda-gdbè°ƒè¯•ä¸€ä¸ªç®€å•çš„çŸ©é˜µä¹˜æ³•kernel
è®¾ç½®æ¡ä»¶æ–­ç‚¹ï¼Œåªåœ¨ç‰¹å®šçš„çº¿ç¨‹å—å’Œçº¿ç¨‹ä¸Šåœæ­¢ï¼Œæ£€æŸ¥å…±äº«å†…å­˜çš„å€¼ã€‚</p>
<p><em>æç¤º</em>ï¼šä½¿ç”¨<code>break kernel if blockIdx.x==1 &amp;&amp; threadIdx.x==0</code>è®¾ç½®æ¡ä»¶æ–­ç‚¹</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç¼–è¯‘æ—¶ä½¿ç”¨<code>-g -G</code>é€‰é¡¹ç”Ÿæˆè°ƒè¯•ä¿¡æ¯ã€‚åœ¨cuda-gdbä¸­ä½¿ç”¨<code>cuda thread</code>å’Œ<code>cuda block</code>å‘½ä»¤åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨<code>print</code>å‘½ä»¤æ£€æŸ¥å˜é‡å€¼ã€‚æ¡ä»¶æ–­ç‚¹å¯ä»¥å¸®åŠ©èšç„¦ç‰¹å®šçš„æ‰§è¡Œè·¯å¾„ï¼Œé¿å…åœ¨æ•°åƒä¸ªçº¿ç¨‹ä¸­è¿·å¤±ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 26.2</strong>ï¼šè¯†åˆ«å¹¶ä¿®å¤å…±äº«å†…å­˜ç«æ€æ¡ä»¶
ç»™å®šä¸€ä¸ªåŒ…å«ç«æ€æ¡ä»¶çš„å½’çº¦kernelï¼Œä½¿ç”¨cuda-memcheckæ£€æµ‹å¹¶ä¿®å¤é—®é¢˜ã€‚</p>
<p><em>æç¤º</em>ï¼šä½¿ç”¨<code>--tool racecheck</code>é€‰é¡¹è¿è¡Œcuda-memcheck</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç«æ€æ¡ä»¶é€šå¸¸å‘ç”Ÿåœ¨ç¼ºå°‘<code>__syncthreads()</code>çš„ä½ç½®ã€‚åœ¨å…±äº«å†…å­˜å†™å…¥åã€è¯»å–å‰å¿…é¡»åŒæ­¥ã€‚ä¿®å¤æ–¹æ³•æ˜¯åœ¨é€‚å½“ä½ç½®æ·»åŠ åŒæ­¥å±éšœï¼Œæˆ–é‡æ„ç®—æ³•ä½¿ç”¨åŸå­æ“ä½œã€‚</p>
</details>
<p><strong>ç»ƒä¹ 26.3</strong>ï¼šå®ç°å†…å­˜æ³„æ¼æ£€æµ‹å™¨
åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„CUDAå†…å­˜åˆ†é…å™¨ï¼Œè·Ÿè¸ªæ‰€æœ‰åˆ†é…å’Œé‡Šæ”¾ï¼Œåœ¨ç¨‹åºç»“æŸæ—¶æŠ¥å‘Šæ³„æ¼ã€‚</p>
<p><em>æç¤º</em>ï¼šä½¿ç”¨std::unordered_mapè®°å½•åˆ†é…ä¿¡æ¯</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>é‡è½½cudaMallocå’ŒcudaFreeï¼Œåœ¨mapä¸­è®°å½•æ¯æ¬¡åˆ†é…çš„åœ°å€ã€å¤§å°å’Œè°ƒç”¨ä½ç½®ã€‚ç¨‹åºç»“æŸæ—¶éå†mapï¼Œæœªé‡Šæ”¾çš„é¡¹å³ä¸ºæ³„æ¼ã€‚å¯ä»¥æ·»åŠ æ ˆå›æº¯ä¿¡æ¯å¸®åŠ©å®šä½æ³„æ¼æºã€‚</p>
</details>
<p><strong>ç»ƒä¹ 26.4</strong>ï¼šè°ƒè¯•æµ®ç‚¹ç²¾åº¦é—®é¢˜
å®ç°å¹¶æ¯”è¾ƒnaiveæ±‚å’Œä¸Kahanæ±‚å’Œåœ¨å¤§è§„æ¨¡æ•°æ®ä¸Šçš„ç²¾åº¦å·®å¼‚ã€‚</p>
<p><em>æç¤º</em>ï¼šä½¿ç”¨å…·æœ‰ä¸åŒæ•°é‡çº§çš„æµ®ç‚¹æ•°æµ‹è¯•</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>åˆ›å»ºåŒ…å«1e8ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œå…ƒç´ å€¼ä»1e-8åˆ°1e8ã€‚Naiveæ±‚å’Œä¼šç´¯ç§¯èˆå…¥è¯¯å·®ï¼Œè€ŒKahanæ±‚å’Œé€šè¿‡è¯¯å·®è¡¥å¿ä¿æŒç²¾åº¦ã€‚å¯ä»¥è®¡ç®—ä¸åŒç²¾åº¦å‚è€ƒå€¼çš„ç›¸å¯¹è¯¯å·®æ¥é‡åŒ–æ”¹è¿›ã€‚</p>
</details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹ 26.5</strong>ï¼šè®¾è®¡ç«æ€æ¡ä»¶è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿ
å®ç°ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿï¼Œè‡ªåŠ¨æ£€æµ‹å¹¶æŠ¥å‘ŠCUDAç¨‹åºä¸­çš„æ•°æ®ç«æ€ã€‚</p>
<p><em>æç¤º</em>ï¼šä½¿ç”¨shadow memoryæŠ€æœ¯è®°å½•æ¯ä¸ªå†…å­˜ä½ç½®çš„è®¿é—®å†å²</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¸ºæ¯ä¸ªå†…å­˜åœ°å€ç»´æŠ¤è®¿é—®å…ƒæ•°æ®ï¼ˆçº¿ç¨‹IDã€æ—¶é—´æˆ³ã€è¯»/å†™ç±»å‹ï¼‰ã€‚åœ¨æ¯æ¬¡è®¿é—®æ—¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†²çªï¼ˆä¸åŒçº¿ç¨‹çš„å†™-å†™æˆ–è¯»-å†™å†²çªï¼‰ã€‚å¯ä»¥ä½¿ç”¨åŸå­æ“ä½œæ›´æ–°å…ƒæ•°æ®ï¼Œé€šè¿‡æ—¶é—´æˆ³åˆ¤æ–­happens-beforeå…³ç³»ã€‚å®ç°éœ€è¦è€ƒè™‘æ€§èƒ½å¼€é”€å’Œå†…å­˜æ¶ˆè€—çš„å¹³è¡¡ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 26.6</strong>ï¼šå®ç°æ­»é”æ¢å¤æœºåˆ¶
è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿæ£€æµ‹GPU kernelæ­»é”å¹¶è‡ªåŠ¨æ¢å¤æ‰§è¡Œã€‚</p>
<p><em>æç¤º</em>ï¼šä½¿ç”¨watchdog timerå’Œcheckpointæœºåˆ¶</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>åˆ›å»ºç›‘æ§çº¿ç¨‹å®šæœŸæ£€æŸ¥kernelæ‰§è¡ŒçŠ¶æ€ã€‚å¦‚æœè¶…æ—¶æœªå®Œæˆï¼Œè§¦å‘æ¢å¤æµç¨‹ï¼š1)ç»ˆæ­¢å½“å‰kernelï¼Œ2)ä»æœ€è¿‘æ£€æŸ¥ç‚¹æ¢å¤æ•°æ®ï¼Œ3)è°ƒæ•´æ‰§è¡Œå‚æ•°ï¼ˆå¦‚å‡å°‘å¹¶è¡Œåº¦ï¼‰ï¼Œ4)é‡æ–°æ‰§è¡Œã€‚éœ€è¦è€ƒè™‘æ£€æŸ¥ç‚¹é¢‘ç‡ä¸å¼€é”€çš„æƒè¡¡ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 26.7</strong>ï¼šæ„å»ºæ€§èƒ½å›å½’æ£€æµ‹æ¡†æ¶
å¼€å‘ä¸€ä¸ªæ¡†æ¶ï¼Œè‡ªåŠ¨æ£€æµ‹ä»£ç ä¿®æ”¹å¯¼è‡´çš„æ€§èƒ½å›å½’ã€‚</p>
<p><em>æç¤º</em>ï¼šç»“åˆæ€§èƒ½profilingå’Œç»Ÿè®¡åˆ†æ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å»ºç«‹åŸºå‡†æ€§èƒ½æ•°æ®åº“ï¼Œè®°å½•æ¯ä¸ªkernelçš„æ‰§è¡Œæ—¶é—´åˆ†å¸ƒã€‚æ–°ç‰ˆæœ¬è¿è¡Œæ—¶ï¼Œä½¿ç”¨ç»Ÿè®¡æ£€éªŒï¼ˆå¦‚t-testï¼‰åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ˜¾è‘—æ€§èƒ½å˜åŒ–ã€‚è€ƒè™‘GPUæ¸©åº¦ã€é¢‘ç‡ç­‰ç¯å¢ƒå› ç´ çš„å½±å“ã€‚å¯ä»¥é›†æˆåˆ°CI/CDæµç¨‹ä¸­è‡ªåŠ¨åŒ–æ£€æµ‹ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 26.8</strong>ï¼šå®ç°åˆ†å¸ƒå¼è°ƒè¯•åè°ƒå™¨
ä¸ºå¤šGPUç³»ç»Ÿè®¾è®¡è°ƒè¯•åŸºç¡€è®¾æ–½ï¼Œæ”¯æŒè·¨è®¾å¤‡çš„æ–­ç‚¹å’Œæ•°æ®æ£€æŸ¥ã€‚</p>
<p><em>æç¤º</em>ï¼šä½¿ç”¨MPIæˆ–NCCLè¿›è¡ŒGPUé—´é€šä¿¡åè°ƒ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å®ç°ä¸­å¤®è°ƒè¯•æœåŠ¡å™¨åè°ƒæ‰€æœ‰GPUçš„è°ƒè¯•çŠ¶æ€ã€‚æ”¯æŒå…¨å±€æ–­ç‚¹ï¼ˆæ‰€æœ‰GPUåŒæ—¶åœæ­¢ï¼‰ã€æ¡ä»¶æ–­ç‚¹ï¼ˆåŸºäºå…¨å±€çŠ¶æ€ï¼‰ã€åˆ†å¸ƒå¼æ•°æ®æ£€æŸ¥ï¼ˆæ”¶é›†å¹¶å±•ç¤ºè·¨GPUçš„æ•°æ®ç»“æ„ï¼‰ã€‚éœ€è¦å¤„ç†GPUé—´çš„åŒæ­¥å’Œé€šä¿¡å»¶è¿Ÿé—®é¢˜ã€‚</p>
</details>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<ol>
<li>
<p><strong>printfè°ƒè¯•çš„é™åˆ¶</strong>
   - GPU printfç¼“å†²åŒºæœ‰é™ï¼ˆé»˜è®¤1MBï¼‰ï¼Œå¤§é‡è¾“å‡ºä¼šå¯¼è‡´ä¸¢å¤±
   - printfæ˜¯å¼‚æ­¥çš„ï¼Œè¾“å‡ºé¡ºåºå¯èƒ½ä¸æ‰§è¡Œé¡ºåºä¸åŒ
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ¡ä»¶æ‰“å°ï¼Œé™åˆ¶è¾“å‡ºçº¿ç¨‹æ•°é‡</p>
</li>
<li>
<p><strong>Heisenbugç°è±¡</strong>
   - æ·»åŠ è°ƒè¯•ä»£ç æ”¹å˜äº†å†…å­˜å¸ƒå±€æˆ–æ—¶åºï¼Œå¯¼è‡´bugæ¶ˆå¤±
   - -Gé€‰é¡¹ç¦ç”¨ä¼˜åŒ–ï¼Œå¯èƒ½æ©ç›–ä¼˜åŒ–ç›¸å…³çš„é—®é¢˜
   - å»ºè®®ï¼šä½¿ç”¨æœ€å°ä¾µå…¥å¼è°ƒè¯•ï¼Œä¿æŒå‘å¸ƒç‰ˆæœ¬çš„ç¼–è¯‘é€‰é¡¹</p>
</li>
<li>
<p><strong>æ–­ç‚¹å¯¹æ€§èƒ½çš„å½±å“</strong>
   - ç¡¬ä»¶æ–­ç‚¹æ•°é‡æœ‰é™ï¼Œè½¯ä»¶æ–­ç‚¹ä¸¥é‡å½±å“æ€§èƒ½
   - æ¡ä»¶æ–­ç‚¹åœ¨æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè¯„ä¼°æ¡ä»¶ï¼Œå¼€é”€å·¨å¤§
   - ä¼˜åŒ–ï¼šä½¿ç”¨ç¡¬ä»¶æ–­ç‚¹ï¼Œç²¾ç¡®è®¾ç½®æ–­ç‚¹ä½ç½®</p>
</li>
<li>
<p><strong>ç«æ€æ£€æµ‹çš„å‡é˜³æ€§</strong>
   - cuda-memcheckå¯èƒ½æŠ¥å‘Šè‰¯æ€§ç«æ€ï¼ˆå¦‚åŸå­è®¡æ•°å™¨ï¼‰
   - å·¥å…·æ— æ³•ç†è§£é«˜å±‚è¯­ä¹‰å’ŒåŒæ­¥åè®®
   - éœ€è¦äººå·¥åˆ†æåŒºåˆ†çœŸå®é—®é¢˜å’Œè¯¯æŠ¥</p>
</li>
<li>
<p><strong>å†…å­˜é”™è¯¯çš„å»¶è¿Ÿè¡¨ç°</strong>
   - è¶Šç•Œå†™å…¥å¯èƒ½å¾ˆä¹…åæ‰å¯¼è‡´å´©æºƒ
   - ä½¿ç”¨ç»Ÿä¸€å†…å­˜æ—¶é”™è¯¯å¯èƒ½åœ¨CPUç«¯è¡¨ç°
   - å»ºè®®ï¼šå°½æ—©å¯ç”¨å†…å­˜æ£€æŸ¥ï¼Œä½¿ç”¨guard pattern</p>
</li>
<li>
<p><strong>æµ®ç‚¹æ¯”è¾ƒçš„é™·é˜±</strong>
   - ç›´æ¥ç”¨==æ¯”è¾ƒæµ®ç‚¹æ•°å‡ ä¹æ€»æ˜¯é”™è¯¯çš„
   - ä¸åŒçš„å½’çº¦é¡ºåºäº§ç”Ÿä¸åŒä½†éƒ½"æ­£ç¡®"çš„ç»“æœ
   - ä½¿ç”¨ç›¸å¯¹è¯¯å·®æˆ–ULPè·ç¦»è¿›è¡Œæ¯”è¾ƒ</p>
</li>
</ol>
<h2 id="_5">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_6">å¼€å‘é˜¶æ®µ</h3>
<ul>
<li>[ ] å¯ç”¨æ‰€æœ‰ç¼–è¯‘è­¦å‘Šï¼ˆ-Wall -Wextraï¼‰</li>
<li>[ ] ä½¿ç”¨é™æ€åˆ†æå·¥å…·ï¼ˆclang-tidy, PVS-Studioï¼‰</li>
<li>[ ] å®ç°è‡ªå®šä¹‰assertå®ï¼ŒåŒ…å«è®¾å¤‡ç«¯æ–­è¨€</li>
<li>[ ] æ·»åŠ è¿è¡Œæ—¶å‚æ•°éªŒè¯å’Œè¾¹ç•Œæ£€æŸ¥</li>
<li>[ ] ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è·Ÿè¸ªæ€§èƒ½åŸºå‡†</li>
</ul>
<h3 id="_7">æµ‹è¯•é˜¶æ®µ</h3>
<ul>
<li>[ ] ä½¿ç”¨cuda-memcheckå®Œæ•´æµ‹è¯•å¥—ä»¶</li>
<li>[ ] åœ¨ä¸åŒGPUæ¶æ„ä¸Šæµ‹è¯•å…¼å®¹æ€§</li>
<li>[ ] è¿›è¡Œå‹åŠ›æµ‹è¯•å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•</li>
<li>[ ] éªŒè¯æ•°å€¼ç²¾åº¦å’Œç¨³å®šæ€§</li>
<li>[ ] æµ‹è¯•é”™è¯¯æ¢å¤è·¯å¾„</li>
</ul>
<h3 id="_8">è°ƒè¯•ç­–ç•¥</h3>
<ul>
<li>[ ] å»ºç«‹å¯é‡ç°çš„æµ‹è¯•ç”¨ä¾‹</li>
<li>[ ] ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ç¼©å°é—®é¢˜èŒƒå›´</li>
<li>[ ] ä¿å­˜ä¸­é—´ç»“æœç”¨äºå¯¹æ¯”åˆ†æ</li>
<li>[ ] è®°å½•è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—</li>
<li>[ ] ä½¿ç”¨è‡ªåŠ¨åŒ–å›å½’æµ‹è¯•</li>
</ul>
<h3 id="_9">ç”Ÿäº§éƒ¨ç½²</h3>
<ul>
<li>[ ] å®ç°å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤</li>
<li>[ ] æ·»åŠ æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦</li>
<li>[ ] ä¿ç•™è°ƒè¯•ç¬¦å·çš„ç‹¬ç«‹æ–‡ä»¶</li>
<li>[ ] å®ç°æ ¸å¿ƒè½¬å‚¨å’Œé”™è¯¯æŠ¥å‘Š</li>
<li>[ ] å‡†å¤‡å›æ»šè®¡åˆ’å’Œé™çº§ç­–ç•¥</li>
</ul>
<h3 id="_10">æ–‡æ¡£è¦æ±‚</h3>
<ul>
<li>[ ] è®°å½•å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ³•</li>
<li>[ ] ç»´æŠ¤è°ƒè¯•æŠ€å·§çŸ¥è¯†åº“</li>
<li>[ ] åˆ›å»ºæ•…éšœæ’æŸ¥æµç¨‹å›¾</li>
<li>[ ] ç¼–å†™æ€§èƒ½è°ƒä¼˜æŒ‡å—</li>
<li>[ ] ä¿æŒè°ƒè¯•å·¥å…·ä½¿ç”¨æ–‡æ¡£æ›´æ–°
```</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter25.html" class="nav-link prev">â† ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</a><a href="chapter27.html" class="nav-link next">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½® â†’</a></nav>
        </main>
    </div>
</body>
</html>