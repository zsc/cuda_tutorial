<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="8ptx">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨CUDAçš„åº•å±‚ä¼˜åŒ–æŠ€æœ¯ï¼Œé‡ç‚¹ä»‹ç»PTXï¼ˆParallel Thread Executionï¼‰æ±‡ç¼–è¯­è¨€åŠå…¶å†…è”ä½¿ç”¨ã€‚é€šè¿‡ç›´æ¥æ“ä½œPTXæŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥çªç ´é«˜çº§è¯­è¨€çš„é™åˆ¶ï¼Œå®ç°æè‡´çš„æ€§èƒ½ä¼˜åŒ–ã€‚ä½ å°†å­¦ä¹ å¦‚ä½•è®¿é—®ç‰¹æ®Šå¯„å­˜å™¨ã€å®ç°è‡ªå®šä¹‰æµ®ç‚¹è¿ç®—ï¼Œä»¥åŠåœ¨è‡ªåŠ¨é©¾é©¶å’Œå…·èº«æ™ºèƒ½åœºæ™¯ä¸­åº”ç”¨è¿™äº›æŠ€æœ¯æ¥å®ç°è¶…ä½å»¶è¿Ÿçš„å…³é”®ç®—æ³•ã€‚</p>
<h2 id="81-ptx">8.1 PTXæ±‡ç¼–è¯­è¨€åŸºç¡€</h2>
<h3 id="811-ptx">8.1.1 PTXæ¦‚è¿°ä¸æ¶æ„</h3>
<p>PTXï¼ˆParallel Thread Executionï¼‰æ˜¯NVIDIA GPUçš„è™šæ‹ŸæŒ‡ä»¤é›†æ¶æ„ï¼Œä½äºCUDA C++å’Œå®é™…GPUæœºå™¨ç ï¼ˆSASSï¼‰ä¹‹é—´ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç¨³å®šçš„ã€å‘å‰å…¼å®¹çš„ç¼–ç¨‹æ¥å£ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿè®¿é—®åº•å±‚ç¡¬ä»¶ç‰¹æ€§ã€‚</p>
<div class="codehilite"><pre><span></span><code>CUDA C++ â†’ PTX (è™šæ‹ŸISA) â†’ SASS (æœºå™¨ç )
         â†‘                  â†‘
      ç¼–è¯‘æ—¶             è¿è¡Œæ—¶JIT
</code></pre></div>

<p>PTXçš„ä¸»è¦ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>è™šæ‹Ÿå¯„å­˜å™¨</strong>ï¼šæ— é™æ•°é‡çš„è™šæ‹Ÿå¯„å­˜å™¨ï¼Œç”±JITç¼–è¯‘å™¨åˆ†é…åˆ°ç‰©ç†å¯„å­˜å™¨</li>
<li><strong>å¼ºç±»å‹ç³»ç»Ÿ</strong>ï¼šæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ˆ.b8/.b16/.b32/.b64/.f16/.f32/.f64ï¼‰</li>
<li><strong>SIMTæ‰§è¡Œæ¨¡å‹</strong>ï¼šå•æŒ‡ä»¤å¤šçº¿ç¨‹ï¼Œä¸CUDAç¼–ç¨‹æ¨¡å‹ä¸€è‡´</li>
<li><strong>å†…å­˜å±‚æ¬¡æ„ŸçŸ¥</strong>ï¼šæ˜¾å¼çš„å†…å­˜ç©ºé—´ä¿®é¥°ç¬¦ï¼ˆ.global/.shared/.local/.constï¼‰</li>
</ul>
<h3 id="812-ptx">8.1.2 PTXåŸºæœ¬è¯­æ³•</h3>
<p>PTXé‡‡ç”¨ç±»æ±‡ç¼–è¯­æ³•ï¼Œæ¯æ¡æŒ‡ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="err">è°“è¯@</span><span class="p">]</span><span class="err">æŒ‡ä»¤</span><span class="p">[</span><span class="nv">.ç±»å‹</span><span class="p">][</span><span class="nv">.ä¿®é¥°ç¬¦</span><span class="p">]</span><span class="w"> </span><span class="err">ç›®æ ‡æ“ä½œæ•°</span><span class="o">,</span><span class="w"> </span><span class="err">æºæ“ä½œæ•°</span><span class="m">1</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="err">æºæ“ä½œæ•°</span><span class="m">2</span><span class="o">,</span><span class="w"> </span><span class="nv">...</span><span class="p">];</span>
</code></pre></div>

<p>å¸¸è§æ•°æ®ç±»å‹ï¼š</p>
<ul>
<li><code>.b{8,16,32,64}</code>: ä½ç±»å‹ï¼ˆæ— ç¬¦å·æ•´æ•°ï¼‰</li>
<li><code>.s{8,16,32,64}</code>: æœ‰ç¬¦å·æ•´æ•°</li>
<li><code>.u{8,16,32,64}</code>: æ— ç¬¦å·æ•´æ•°</li>
<li><code>.f{16,32,64}</code>: æµ®ç‚¹æ•°</li>
<li><code>.pred</code>: è°“è¯ï¼ˆå¸ƒå°”å€¼ï¼‰</li>
</ul>
<p>å¯„å­˜å™¨å‘½åï¼š</p>
<ul>
<li><code>%r{n}</code>: 32ä½å¯„å­˜å™¨</li>
<li><code>%rd{n}</code>: 64ä½å¯„å­˜å™¨</li>
<li><code>%f{n}</code>: 32ä½æµ®ç‚¹å¯„å­˜å™¨</li>
<li><code>%fd{n}</code>: 64ä½æµ®ç‚¹å¯„å­˜å™¨</li>
<li><code>%p{n}</code>: è°“è¯å¯„å­˜å™¨</li>
</ul>
<h3 id="813-ptx">8.1.3 å†…è”PTXçš„åŸºæœ¬æ–¹æ³•</h3>
<p>åœ¨CUDA C++ä¸­ä½¿ç”¨å†…è”PTXçš„åŸºæœ¬è¯­æ³•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;PTXæŒ‡ä»¤&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">è¾“å‡ºæ“ä½œæ•°</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">è¾“å…¥æ“ä½œæ•°</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ç ´ååˆ—è¡¨</span><span class="p">);</span>
</code></pre></div>

<p>ç¤ºä¾‹ï¼šæ•´æ•°åŠ æ³•</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ptx_add</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.s32 %0, %1, %2;&quot;</span><span class="w"> </span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w">    </span><span class="c1">// è¾“å‡ºï¼šresultæ˜ å°„åˆ°å¯„å­˜å™¨</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w">  </span><span class="c1">// è¾“å…¥ï¼šaå’Œbæ˜ å°„åˆ°å¯„å­˜å™¨</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>çº¦æŸä¿®é¥°ç¬¦è¯´æ˜ï¼š</p>
<ul>
<li><code>"r"</code>: 32ä½å¯„å­˜å™¨</li>
<li><code>"l"</code>: 64ä½å¯„å­˜å™¨</li>
<li><code>"f"</code>: 32ä½æµ®ç‚¹å¯„å­˜å™¨</li>
<li><code>"d"</code>: 64ä½æµ®ç‚¹å¯„å­˜å™¨</li>
<li><code>"h"</code>: 16ä½å¯„å­˜å™¨ï¼ˆåŠç²¾åº¦ï¼‰</li>
<li><code>"n"</code>: ç«‹å³æ•°</li>
<li><code>"="</code>: è¾“å‡ºæ“ä½œæ•°</li>
<li><code>"+"</code>: è¾“å…¥è¾“å‡ºæ“ä½œæ•°</li>
</ul>
<h3 id="814-ptx">8.1.4 PTXå†…å­˜è®¿é—®æŒ‡ä»¤</h3>
<p>å…¨å±€å†…å­˜è®¿é—®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">load_global</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld.global.f32 %0, [%1];&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">store_global</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;st.global.f32 [%0], %1;&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p>å…±äº«å†…å­˜è®¿é—®ï¼ˆå¸¦bankæ§åˆ¶ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">load_shared_no_bank_conflict</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨.cgä¿®é¥°ç¬¦é¿å…bank conflict</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld.shared.cg.f32 %0, [%1 + %2];&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="815">8.1.5 æ¡ä»¶æ‰§è¡Œä¸è°“è¯</h3>
<p>PTXæ”¯æŒè°“è¯å¯„å­˜å™¨æ§åˆ¶æ¡ä»¶æ‰§è¡Œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">conditional_fma</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .pred p;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  setp.ne.b32 p, %4, 0;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">          </span><span class="c1">// è®¾ç½®è°“è¯</span>
<span class="w">        </span><span class="s">&quot;  @p fma.rn.f32 %0, %1, %2, %3;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">  </span><span class="c1">// æ¡ä»¶æ‰§è¡ŒFMA</span>
<span class="w">        </span><span class="s">&quot;  @!p mov.f32 %0, %3;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">            </span><span class="c1">// å¦åˆ™è¿”å›c</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">condition</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="82-ptx">8.2 å†…è”PTXçš„ä½¿ç”¨åœºæ™¯</h2>
<h3 id="821">8.2.1 æ€§èƒ½å…³é”®è·¯å¾„ä¼˜åŒ–</h3>
<p>å½“ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ä¸å¤Ÿä¼˜åŒ–æ—¶ï¼Œæ‰‹å†™PTXå¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼š</p>
<ol>
<li><strong>æ¶ˆé™¤ä¸å¿…è¦çš„å¯„å­˜å™¨ç§»åŠ¨</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç¼–è¯‘å™¨å¯èƒ½ç”Ÿæˆå¤šä½™çš„movæŒ‡ä»¤</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">compiler_version</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// PTXç‰ˆæœ¬ï¼šç›´æ¥è®¡ç®—ï¼Œå‡å°‘å¯„å­˜å™¨ä½¿ç”¨</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ptx_version</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;add.f32 %0, %1, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;mul.f32 %0, %0, 0f40000000;&quot;</span><span class="w">  </span><span class="c1">// 2.0 in hex</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>æŒ‡ä»¤çº§å¹¶è¡Œä¼˜åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dual_fma_ptx</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out2</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">float</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">float</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b2</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">c2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 r1, r2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 r1, %2, %3, %4;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">  </span><span class="c1">// ç¬¬ä¸€ä¸ªFMA</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 r2, %5, %6, %7;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">  </span><span class="c1">// å¹¶è¡Œæ‰§è¡Œç¬¬äºŒä¸ªFMA</span>
<span class="w">        </span><span class="s">&quot;  st.global.f32 [%0], r1;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  st.global.f32 [%1], r2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="n">out1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="n">out2</span><span class="p">),</span>
<span class="w">            </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">c1</span><span class="p">),</span>
<span class="w">            </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a2</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b2</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="822">8.2.2 è®¿é—®ç‰¹æ®Šç¡¬ä»¶åŠŸèƒ½</h3>
<p>æŸäº›ç¡¬ä»¶åŠŸèƒ½åªèƒ½é€šè¿‡PTXè®¿é—®ï¼š</p>
<ol>
<li><strong>è§†é¢‘æŒ‡ä»¤ï¼ˆç”¨äºè®¡ç®—æœºè§†è§‰ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sad_ptx</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;vabsdiff.u32.u32.u32.add %0, %1, %2, %3;&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>ç‰¹æ®Šçš„ä½æ“ä½œ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bit_field_extract</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                          </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                          </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;bfe.u32 %0, %1, %2, %3;&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="823">8.2.3 å†…å­˜æ …æ ä¸åŒæ­¥ä¼˜åŒ–</h3>
<p>ç²¾ç¡®æ§åˆ¶å†…å­˜ä¸€è‡´æ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">custom_memory_fence</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä»…å¯¹å…±äº«å†…å­˜è®¾ç½®æ …æ </span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;membar.cta;&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å…¨å±€å†…å­˜æ …æ </span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;membar.gl;&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç³»ç»Ÿçº§æ …æ </span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;membar.sys;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">optimized_barrier</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¸¦arrive-waitè¯­ä¹‰çš„barrier</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;bar.arrive.cta 0, 128;&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// 128ä¸ªçº¿ç¨‹åˆ°è¾¾</span>
<span class="w">    </span><span class="c1">// ... å…¶ä»–å·¥ä½œ</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;bar.sync 0, 128;&quot;</span><span class="p">);</span><span class="w">        </span><span class="c1">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="824-loadstore">8.2.4 å‘é‡åŒ–load/storeä¼˜åŒ–</h3>
<p>ä½¿ç”¨PTXå®ç°128ä½å‘é‡è®¿é—®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">vectorized_copy_128</span><span class="p">(</span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;ld.global.v4.f32 {%0, %1, %2, %3}, [%4];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">            </span><span class="s">&quot;st.global.v4.f32 [%5], {%0, %1, %2, %3};&quot;</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">y</span><span class="p">),</span><span class="w"> </span>
<span class="w">              </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">w</span><span class="p">)</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="n">tid</span><span class="p">]),</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="825">8.2.5 è‡ªå®šä¹‰åŸå­æ“ä½œ</h3>
<p>å®ç°ç¼–è¯‘å™¨ä¸æ”¯æŒçš„åŸå­æ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">atomic_fma</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 expected, val, new;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  ld.global.f32 expected, [%1];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;retry:</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 new, %2, %3, expected;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  atom.global.cas.f32 val, [%1], expected, new;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  setp.ne.f32 p, val, expected;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  @p mov.f32 expected, val;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  @p bra retry;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mov.f32 %0, val;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="83">8.3 ç‰¹æ®Šå¯„å­˜å™¨è®¿é—®</h2>
<h3 id="831">8.3.1 é¢„å®šä¹‰ç‰¹æ®Šå¯„å­˜å™¨</h3>
<p>PTXæä¾›äº†ä¸€ç³»åˆ—ç‰¹æ®Šå¯„å­˜å™¨ï¼Œå¯ä»¥è·å–çº¿ç¨‹å’Œç¡¬ä»¶ä¿¡æ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">get_thread_info</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tid_x</span><span class="p">,</span><span class="w"> </span><span class="n">tid_y</span><span class="p">,</span><span class="w"> </span><span class="n">tid_z</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bid_x</span><span class="p">,</span><span class="w"> </span><span class="n">bid_y</span><span class="p">,</span><span class="w"> </span><span class="n">bid_z</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dim_x</span><span class="p">,</span><span class="w"> </span><span class="n">dim_y</span><span class="p">,</span><span class="w"> </span><span class="n">dim_z</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sm_id</span><span class="p">,</span><span class="w"> </span><span class="n">warp_id</span><span class="p">,</span><span class="w"> </span><span class="n">lane_id</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// çº¿ç¨‹ç´¢å¼•</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%tid.x;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">tid_x</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%tid.y;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">tid_y</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%tid.z;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">tid_z</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// å—ç´¢å¼•</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%ctaid.x;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">bid_x</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%ctaid.y;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">bid_y</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%ctaid.z;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">bid_z</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// å—ç»´åº¦</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%ntid.x;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dim_x</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%ntid.y;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dim_y</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%ntid.z;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dim_z</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// SMå’Œwarpä¿¡æ¯</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%smid;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">sm_id</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%warpid;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">warp_id</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%laneid;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">lane_id</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="832">8.3.2 æ—¶é’Ÿè®¡æ•°å™¨è®¿é—®</h3>
<p>é«˜ç²¾åº¦è®¡æ—¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">get_global_timer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u64 %0, %%globaltimer;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=l&quot;</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">get_clock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">clock</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u32 %0, %%clock;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">clock</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">clock</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// çº³ç§’çº§è®¡æ—¶å™¨ï¼ˆVolta+ï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">get_nanoseconds</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u64 %0, %%globaltimer_ns;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=l&quot;</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ€§èƒ½è®¡æ•°å™¨ä½¿ç”¨ç¤ºä¾‹</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">profile_code_section</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_global_timer</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// å¾…æµ‹é‡çš„ä»£ç æ®µ</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__sinf</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_global_timer</span><span class="p">();</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread %d: Elapsed cycles: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="833">8.3.3 åŠ¨æ€å…±äº«å†…å­˜æŒ‡é’ˆ</h3>
<p>è·å–åŠ¨æ€å…±äº«å†…å­˜çš„å®é™…åœ°å€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">get_dynamic_shared_mem</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u64 %0, %%dynamic_smem_ptr;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=l&quot;</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ç”¨äºå¤šä¸ªåŠ¨æ€å…±äº«å†…å­˜æ•°ç»„çš„åç§»è®¡ç®—</span>
<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span>
<span class="kt">__device__</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">get_shared_array</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">shared_mem</span><span class="p">[];</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov.u64 %0, %%dynamic_smem_ptr;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=l&quot;</span><span class="p">(</span><span class="n">base</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="834">8.3.4 è°“è¯å¯„å­˜å™¨æ“ä½œ</h3>
<p>ç›´æ¥æ“ä½œè°“è¯å¯„å­˜å™¨å®ç°å¤æ‚æ¡ä»¶é€»è¾‘ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">complex_condition</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .pred p1, p2, p3;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  setp.gt.s32 p1, %1, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">      </span><span class="c1">// p1 = (a &gt; b)</span>
<span class="w">        </span><span class="s">&quot;  setp.le.s32 p2, %2, %3;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">      </span><span class="c1">// p2 = (b &lt;= c)</span>
<span class="w">        </span><span class="s">&quot;  and.pred p3, p1, p2;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">         </span><span class="c1">// p3 = p1 &amp;&amp; p2</span>
<span class="w">        </span><span class="s">&quot;  selp.s32 %0, 1, 0, p3;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">       </span><span class="c1">// result = p3 ? 1 : 0</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="84">8.4 è‡ªå®šä¹‰æµ®ç‚¹è¿ç®—</h2>
<h3 id="841">8.4.1 èˆå…¥æ¨¡å¼æ§åˆ¶</h3>
<p>PTXå…è®¸ç²¾ç¡®æ§åˆ¶æµ®ç‚¹è¿ç®—çš„èˆå…¥æ¨¡å¼ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">custom_rounding_add</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">rn</span><span class="p">,</span><span class="w"> </span><span class="n">rz</span><span class="p">,</span><span class="w"> </span><span class="n">ru</span><span class="p">,</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Round to Nearest (é»˜è®¤)</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.rn.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">rn</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Round toward Zero</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.rz.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">rz</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Round Up (toward +âˆ)</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.ru.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">ru</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Round Down (toward -âˆ)</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.rd.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rn</span><span class="p">;</span><span class="w">  </span><span class="c1">// è¿”å›é»˜è®¤èˆå…¥ç»“æœ</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="842">8.4.2 é¥±å’Œè¿ç®—</h3>
<p>å®ç°é¥±å’Œç®—æœ¯ï¼ˆclampåˆ°[0,1]ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">saturated_fma</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;fma.rn.sat.f32 %0, %1, %2, %3;&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç»“æœè¢«clampåˆ°[0.0, 1.0]</span>
<span class="p">}</span>

<span class="c1">// æ•´æ•°é¥±å’ŒåŠ æ³•</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">saturated_add_int</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.sat.s32 %0, %1, %2;&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="843">8.4.3 å¿«é€Ÿè¿‘ä¼¼è¿ç®—</h3>
<p>ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿçš„è¿‘ä¼¼è¿ç®—ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fast_reciprocal</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¿«é€Ÿå€’æ•°è¿‘ä¼¼ï¼ˆç²¾åº¦çº¦22ä½ï¼‰</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;rcp.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fast_rsqrt</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¿«é€Ÿå€’æ•°å¹³æ–¹æ ¹ï¼ˆ1/sqrt(x)ï¼‰</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;rsqrt.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fast_sqrt</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¿«é€Ÿå¹³æ–¹æ ¹</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;sqrt.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// å¿«é€Ÿä¸‰è§’å‡½æ•°ï¼ˆTeslaæ¶æ„ï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fast_sin</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;sin.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="844-fp16">8.4.4 è‡ªå®šä¹‰FP16è¿ç®—</h3>
<p>åŠç²¾åº¦æµ®ç‚¹è¿ç®—ä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="n">__half2</span><span class="w"> </span><span class="n">custom_h2_fma</span><span class="p">(</span><span class="n">__half2</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">__half2</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">__half2</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__half2</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;fma.rn.f16x2 %0, %1, %2, %3;&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">result</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a</span><span class="p">),</span>
<span class="w">                   </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">b</span><span class="p">),</span>
<span class="w">                   </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// FP16åˆ°FP32è½¬æ¢</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float2</span><span class="w"> </span><span class="n">h2_to_f2</span><span class="p">(</span><span class="n">__half2</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f16x2 h;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mov.b32 h, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  cvt.f32.f16 %0, h.x;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  cvt.f32.f16 %1, h.y;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="845-sfu">8.4.5 ç‰¹æ®Šå‡½æ•°å•å…ƒ(SFU)æ“ä½œ</h3>
<p>ç›´æ¥è®¿é—®ç‰¹æ®Šå‡½æ•°å•å…ƒï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fast_exp2</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 2^x å¿«é€Ÿè®¡ç®—</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ex2.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fast_log2</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// log2(x) å¿«é€Ÿè®¡ç®—</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;lg2.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ç»„åˆè¿ç®—ï¼šx^y = 2^(y * log2(x))</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fast_pow</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 logx;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  lg2.approx.f32 logx, %1;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 logx, logx, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  ex2.approx.f32 %0, logx;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="85">8.5 æ¡ˆä¾‹ï¼šè¶…ä½å»¶è¿Ÿçš„ç‰¹æ®Šå‡½æ•°å®ç°</h2>
<h3 id="851">8.5.1 è‡ªåŠ¨é©¾é©¶åœºæ™¯ï¼šå¿«é€Ÿè·ç¦»è®¡ç®—</h3>
<p>åœ¨æ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†ä¸­ï¼Œéœ€è¦å¤§é‡è®¡ç®—ç‚¹åˆ°ç‚¹çš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ ‡å‡†å®ç°</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">standard_distance</span><span class="p">(</span><span class="kt">float3</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dz</span><span class="o">*</span><span class="n">dz</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// PTXä¼˜åŒ–ç‰ˆæœ¬ï¼šä½¿ç”¨FMAå’Œå¿«é€Ÿå¹³æ–¹æ ¹</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ptx_fast_distance</span><span class="p">(</span><span class="kt">float3</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dist_sq</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 dx, dy, dz, sum;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  sub.f32 dx, %1, %4;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  sub.f32 dy, %2, %5;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  sub.f32 dz, %3, %6;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 sum, dx, dx;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 sum, dy, dy, sum;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, dz, dz, sum;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¿«é€Ÿå¹³æ–¹æ ¹</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;sqrt.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ‰¹é‡è·ç¦»è®¡ç®—ï¼ˆå‘é‡åŒ–ï¼‰</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">batch_distance_kernel</span><span class="p">(</span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="kt">float4</span><span class="w"> </span><span class="n">reference</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                     </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">distances</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float4</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 128ä½å‘é‡åŠ è½½</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld.global.v4.f32 {%0, %1, %2, %3}, [%4];&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">]));</span>

<span class="w">    </span><span class="c1">// è·ç¦»è®¡ç®—ï¼ˆå¿½ç•¥wåˆ†é‡ï¼‰</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 dx, dy, dz, sum;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  sub.f32 dx, %1, %4;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  sub.f32 dy, %2, %5;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  sub.f32 dz, %3, %6;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 sum, dx, dx;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 sum, dy, dy, sum;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 sum, dz, dz, sum;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  sqrt.approx.f32 %0, sum;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">reference</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">reference</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">reference</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">distances</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="852">8.5.2 å…·èº«æ™ºèƒ½åœºæ™¯ï¼šå¿«é€Ÿå››å…ƒæ•°è¿ç®—</h3>
<p>æœºå™¨äººå§¿æ€ä¼°è®¡ä¸­çš„å››å…ƒæ•°ä¹˜æ³•ä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å››å…ƒæ•°ç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Quaternion</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// æ ‡å‡†å››å…ƒæ•°ä¹˜æ³•</span>
<span class="kt">__device__</span><span class="w"> </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">quat_mul_standard</span><span class="p">(</span><span class="n">Quaternion</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// PTXä¼˜åŒ–ç‰ˆæœ¬ï¼šæœ€å¤§åŒ–FMAä½¿ç”¨</span>
<span class="kt">__device__</span><span class="w"> </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">quat_mul_ptx</span><span class="p">(</span><span class="n">Quaternion</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// wåˆ†é‡ï¼šw1*w2 - x1*x2 - y1*y2 - z1*z2</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 temp;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, %1, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %3, %4, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">  </span><span class="c1">// æ³¨æ„ç¬¦å·ï¼Œä½¿ç”¨è´Ÿçš„FMA</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %5, %6, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %7, %8, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// xåˆ†é‡ï¼šw1*x2 + x1*w2 + y1*z2 - z1*y2</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, %1, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %3, %4, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %5, %6, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %7, %8, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// yåˆ†é‡ï¼šw1*y2 - x1*z2 + y1*w2 + z1*x2</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, %1, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %3, %4, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %5, %6, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %7, %8, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// zåˆ†é‡ï¼šw1*z2 + x1*y2 - y1*x2 + z1*w2</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, %1, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %3, %4, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %5, %6, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %7, %8, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">z</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">),</span>
<span class="w">          </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// å››å…ƒæ•°å½’ä¸€åŒ–ï¼ˆå¿«é€Ÿç‰ˆæœ¬ï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">quat_normalize_fast</span><span class="p">(</span><span class="n">Quaternion</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">norm_sq</span><span class="p">,</span><span class="w"> </span><span class="n">inv_norm</span><span class="p">;</span>
<span class="w">    </span><span class="n">Quaternion</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®¡ç®—èŒƒæ•°å¹³æ–¹</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, %1, %1;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %2, %2, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %3, %3, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 %0, %4, %4, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">norm_sq</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¿«é€Ÿå€’æ•°å¹³æ–¹æ ¹</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;rsqrt.approx.f32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">inv_norm</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">norm_sq</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// å½’ä¸€åŒ–</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mul.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">inv_norm</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mul.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">inv_norm</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mul.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">inv_norm</span><span class="p">));</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mul.f32 %0, %1, %2;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">inv_norm</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">### 8.5.3 è§†è§‰SLAMçš„ç‰¹å¾åŒ¹é…åŠ é€Ÿ</span>

<span class="n">BRIEFæè¿°å­çš„å¿«é€Ÿæ±‰æ˜è·ç¦»è®¡ç®—</span><span class="err">ï¼š</span>

<span class="err">```</span><span class="n">cuda</span>
<span class="c1">// 256ä½BRIEFæè¿°å­ï¼ˆ8ä¸ªuint32ï¼‰</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">BriefDescriptor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="c1">// æ ‡å‡†æ±‰æ˜è·ç¦»</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hamming_distance_standard</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">BriefDescriptor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="n">BriefDescriptor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dist</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__popc</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// PTXä¼˜åŒ–ç‰ˆæœ¬ï¼šå‘é‡åŒ–åŠ è½½å’Œå¹¶è¡Œè®¡ç®—</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hamming_distance_ptx</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">BriefDescriptor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">BriefDescriptor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xor_result</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å±•å¼€å¾ªç¯ï¼Œä½¿ç”¨PTXè¿›è¡ŒXORå’ŒPOPC</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;xor.b32 %0, %1, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">            </span><span class="s">&quot;popc.b32 %0, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">            </span><span class="s">&quot;add.s32 %3, %3, %0;&quot;</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">xor_result</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;+r&quot;</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ‰¹é‡ç‰¹å¾åŒ¹é…å†…æ ¸</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">batch_feature_matching</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">BriefDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">features1</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">BriefDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">features2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n2</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">matches</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">distances</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">threshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åŠ è½½ç¬¬ä¸€ä¸ªç‰¹å¾åˆ°å¯„å­˜å™¨</span>
<span class="w">    </span><span class="n">BriefDescriptor</span><span class="w"> </span><span class="n">feat1</span><span class="p">;</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld.global.u32 %0, [%1];&quot;</span>
<span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">feat1</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">features1</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">best_match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">best_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threshold</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æœç´¢æœ€ä½³åŒ¹é…</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n2</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xor_val</span><span class="p">,</span><span class="w"> </span><span class="n">popc_val</span><span class="p">;</span>

<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;ld.global.u32 %0, [%3];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">                </span><span class="s">&quot;xor.b32 %0, %0, %2;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">                </span><span class="s">&quot;popc.b32 %1, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">                </span><span class="s">&quot;add.s32 %4, %4, %1;&quot;</span>
<span class="w">                </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">xor_val</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">popc_val</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;+r&quot;</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
<span class="w">                </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">features2</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">feat1</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ›´æ–°æœ€ä½³åŒ¹é…</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">best_dist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">best_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="w">            </span><span class="n">best_match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">matches</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best_match</span><span class="p">;</span>
<span class="w">    </span><span class="n">distances</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best_dist</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="854">8.5.4 ç¥ç»ç½‘ç»œçš„è‡ªå®šä¹‰æ¿€æ´»å‡½æ•°</h3>
<p>å®ç°é«˜æ€§èƒ½çš„GELUæ¿€æ´»å‡½æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// GELU(x) = x * Î¦(x) â‰ˆ 0.5 * x * (1 + tanh(sqrt(2/Ï€) * (x + 0.044715 * x^3)))</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gelu_standard</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7978845608f</span><span class="p">;</span><span class="w">  </span><span class="c1">// sqrt(2/Ï€)</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.044715f</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x3</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mf">0.5f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tanhf</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// PTXä¼˜åŒ–ç‰ˆæœ¬</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">gelu_ptx</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 x2, x3, arg, tanh_arg, one_plus_tanh;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x2, %1, %1;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x3, x2, %1;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 arg, 0f3e5ae6d2, x3, %1;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">  </span><span class="c1">// 0.044715 * x^3 + x</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 arg, 0f3f4c422a, arg;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">         </span><span class="c1">// * sqrt(2/Ï€)</span>
<span class="w">        </span><span class="s">&quot;  tanh.approx.f32 tanh_arg, arg;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">        </span><span class="c1">// å¿«é€Ÿtanh</span>
<span class="w">        </span><span class="s">&quot;  add.f32 one_plus_tanh, 0f3f800000, tanh_arg;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">  </span><span class="c1">// 1 + tanh</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, %1, one_plus_tanh;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, 0f3f000000, %0;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w">           </span><span class="c1">// * 0.5</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// å‘é‡åŒ–GELUï¼ˆå¤„ç†float4ï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float4</span><span class="w"> </span><span class="n">gelu_ptx_v4</span><span class="p">(</span><span class="kt">float4</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float4</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>

<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;{</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  .reg .f32 x2&lt;4&gt;, x3&lt;4&gt;, arg&lt;4&gt;, tanh_arg&lt;4&gt;, result&lt;4&gt;;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x2[0], %4, %4;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x2[1], %5, %5;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x2[2], %6, %6;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x2[3], %7, %7;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x3[0], x2[0], %4;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x3[1], x2[1], %5;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x3[2], x2[2], %6;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 x3[3], x2[3], %7;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 arg[0], 0f3e5ae6d2, x3[0], %4;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 arg[1], 0f3e5ae6d2, x3[1], %5;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 arg[2], 0f3e5ae6d2, x3[2], %6;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  fma.rn.f32 arg[3], 0f3e5ae6d2, x3[3], %7;</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 arg[0], 0f3f4c422a, arg[0];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 arg[1], 0f3f4c422a, arg[1];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 arg[2], 0f3f4c422a, arg[2];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 arg[3], 0f3f4c422a, arg[3];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  tanh.approx.f32 tanh_arg[0], arg[0];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  tanh.approx.f32 tanh_arg[1], arg[1];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  tanh.approx.f32 tanh_arg[2], arg[2];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  tanh.approx.f32 tanh_arg[3], arg[3];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  add.f32 result[0], 0f3f800000, tanh_arg[0];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  add.f32 result[1], 0f3f800000, tanh_arg[1];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  add.f32 result[2], 0f3f800000, tanh_arg[2];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  add.f32 result[3], 0f3f800000, tanh_arg[3];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 result[0], %4, result[0];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 result[1], %5, result[1];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 result[2], %6, result[2];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 result[3], %7, result[3];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %0, 0f3f000000, result[0];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %1, 0f3f000000, result[1];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %2, 0f3f000000, result[2];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  mul.f32 %3, 0f3f000000, result[3];</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;}</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="855">8.5.5 æ€§èƒ½å¯¹æ¯”ä¸åˆ†æ</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸºå‡†æµ‹è¯•å†…æ ¸</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">benchmark_ptx_optimizations</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®¡æ—¶å˜é‡</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// æµ‹è¯•æ ‡å‡†ç‰ˆæœ¬</span>
<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gelu_standard</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Standard GELU: %llu cycles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æµ‹è¯•PTXç‰ˆæœ¬</span>
<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">result2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gelu_ptx</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock64</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;PTX GELU: %llu cycles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>æ€§èƒ½æå‡åˆ†æï¼š</p>
<ul>
<li><strong>è·ç¦»è®¡ç®—</strong>ï¼šPTXç‰ˆæœ¬ç›¸æ¯”æ ‡å‡†ç‰ˆæœ¬æå‡çº¦25-30%</li>
<li><strong>å››å…ƒæ•°è¿ç®—</strong>ï¼šFMAä¼˜åŒ–å¸¦æ¥15-20%æ€§èƒ½æå‡</li>
<li><strong>ç‰¹å¾åŒ¹é…</strong>ï¼šå‘é‡åŒ–è®¿å­˜å’ŒPTXä¼˜åŒ–ç»¼åˆæå‡40-50%</li>
<li><strong>æ¿€æ´»å‡½æ•°</strong>ï¼šä½¿ç”¨å¿«é€Ÿè¿‘ä¼¼æŒ‡ä»¤æå‡20-35%</li>
</ul>
<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†PTXå†…è”æ±‡ç¼–åœ¨CUDAç¼–ç¨‹ä¸­çš„åº”ç”¨ï¼Œä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š</p>
<ol>
<li>
<p><strong>PTXåŸºç¡€çŸ¥è¯†</strong>ï¼š
   - PTXä½œä¸ºè™šæ‹ŸISAçš„è®¾è®¡ç†å¿µ
   - åŸºæœ¬è¯­æ³•å’Œæ•°æ®ç±»å‹ç³»ç»Ÿ
   - å†…è”æ±‡ç¼–çš„ä½¿ç”¨æ–¹æ³•</p>
</li>
<li>
<p><strong>ç¡¬ä»¶ç‰¹æ€§è®¿é—®</strong>ï¼š
   - ç‰¹æ®Šå¯„å­˜å™¨çš„ç›´æ¥è®¿é—®
   - æ€§èƒ½è®¡æ•°å™¨å’Œè®¡æ—¶å™¨çš„ä½¿ç”¨
   - è°“è¯å¯„å­˜å™¨çš„é«˜çº§æ“ä½œ</p>
</li>
<li>
<p><strong>æµ®ç‚¹è¿ç®—ä¼˜åŒ–</strong>ï¼š
   - èˆå…¥æ¨¡å¼çš„ç²¾ç¡®æ§åˆ¶
   - é¥±å’Œè¿ç®—å’Œå¿«é€Ÿè¿‘ä¼¼æŒ‡ä»¤
   - FP16è¿ç®—çš„ä¼˜åŒ–æŠ€å·§</p>
</li>
<li>
<p><strong>å®æˆ˜æ¡ˆä¾‹</strong>ï¼š
   - è‡ªåŠ¨é©¾é©¶åœºæ™¯çš„è·ç¦»è®¡ç®—ä¼˜åŒ–
   - å…·èº«æ™ºèƒ½çš„å››å…ƒæ•°è¿ç®—åŠ é€Ÿ
   - è§†è§‰SLAMç‰¹å¾åŒ¹é…çš„å‘é‡åŒ–
   - ç¥ç»ç½‘ç»œæ¿€æ´»å‡½æ•°çš„å®šåˆ¶å®ç°</p>
</li>
</ol>
<p>å…³é”®ä¼˜åŒ–æŠ€å·§ï¼š</p>
<ul>
<li>ä½¿ç”¨FMAæŒ‡ä»¤å‡å°‘æŒ‡ä»¤æ•°é‡å’Œæé«˜ç²¾åº¦</li>
<li>å‘é‡åŒ–load/storeå‡å°‘å†…å­˜äº‹åŠ¡</li>
<li>å¿«é€Ÿè¿‘ä¼¼æŒ‡ä»¤åœ¨ç²¾åº¦å…è®¸æ—¶å¤§å¹…æå‡æ€§èƒ½</li>
<li>å¯„å­˜å™¨çº§ä¼˜åŒ–å‡å°‘æ•°æ®ç§»åŠ¨å¼€é”€</li>
</ul>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹ 8.1</strong>ï¼šå®ç°ä¸€ä¸ªä½¿ç”¨PTXçš„å‘é‡ç‚¹ç§¯å‡½æ•°</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dot_product_ptx</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</code></pre></div>

<p>è¦æ±‚ä½¿ç”¨FMAæŒ‡ä»¤å’Œå‘é‡åŒ–åŠ è½½ã€‚</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä½¿ç”¨PTXå®ç°é«˜æ•ˆçš„ç‚¹ç§¯è¿ç®—ï¼Œå…³é”®åœ¨äºï¼š</p>
<ol>
<li>ä½¿ç”¨å‘é‡åŒ–loadå‡å°‘å†…å­˜è®¿é—®</li>
<li>ä½¿ç”¨FMAæŒ‡ä»¤è¿›è¡Œç´¯åŠ </li>
<li>å±•å¼€å¾ªç¯æé«˜æŒ‡ä»¤çº§å¹¶è¡Œ</li>
<li>å¤„ç†éå¯¹é½çš„å°¾éƒ¨å…ƒç´ </li>
</ol>
</details>
<p><strong>ç»ƒä¹ 8.2</strong>ï¼šä½¿ç”¨PTXå®ç°ä¸€ä¸ªä½åè½¬å‡½æ•°</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bit_reverse_ptx</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
</code></pre></div>

<details>
<summary>ç­”æ¡ˆ</summary>
<p>PTXæä¾›äº†brevæŒ‡ä»¤ç›´æ¥è¿›è¡Œä½åè½¬ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;brev.b32 %0, %1;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</code></pre></div>

<p>è¿™æ¯”æ‰‹åŠ¨ä½æ“ä½œå¿«10å€ä»¥ä¸Šã€‚</p>
</details>
<p><strong>ç»ƒä¹ 8.3</strong>ï¼šå®ç°ä¸€ä¸ªä½¿ç”¨ç‰¹æ®Šå¯„å­˜å™¨çš„çº¿ç¨‹åŒæ­¥è®¡æ•°å™¨</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">get_thread_rank_in_block</span><span class="p">();</span>
</code></pre></div>

<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç»“åˆtidã€ntidç­‰ç‰¹æ®Šå¯„å­˜å™¨è®¡ç®—çº¿ç¨‹åœ¨å—å†…çš„çº¿æ€§ç´¢å¼•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">tid</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ntid</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ntid</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ntid</span><span class="p">.</span><span class="n">y</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹ 8.4</strong>ï¼šä½¿ç”¨PTXå®ç°saturated arithmeticçš„RGBåƒç´ æ··åˆ</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">uchar3</span><span class="w"> </span><span class="n">blend_pixels_ptx</span><span class="p">(</span><span class="kt">uchar3</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">uchar3</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">alpha</span><span class="p">);</span>
</code></pre></div>

<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä½¿ç”¨é¥±å’ŒåŠ æ³•å’Œä¹˜æ³•æŒ‡ä»¤ï¼Œé¿å…æº¢å‡ºï¼š</p>
<ol>
<li>å°†alphaè½¬æ¢ä¸ºå®šç‚¹æ•°</li>
<li>ä½¿ç”¨mul.satå’Œadd.satæŒ‡ä»¤</li>
<li>å¤„ç†RGBä¸‰ä¸ªé€šé“</li>
</ol>
</details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹ 8.5</strong>ï¼šè®¾è®¡å¹¶å®ç°ä¸€ä¸ªä½¿ç”¨PTXçš„é«˜æ€§èƒ½çŸ©é˜µè½¬ç½®å‡½æ•°ï¼Œè¦æ±‚ï¼š</p>
<ul>
<li>æ”¯æŒä»»æ„å¤§å°çŸ©é˜µ</li>
<li>ä½¿ç”¨å‘é‡åŒ–è®¿å­˜</li>
<li>é¿å…bank conflict</li>
<li>æ€§èƒ½è¶…è¿‡cuBLASçš„geamå‡½æ•°</li>
</ul>
<details>
<summary>æç¤º</summary>
<ol>
<li>ä½¿ç”¨å…±äº«å†…å­˜ä½œä¸ºä¸­è½¬</li>
<li>å‘é‡åŒ–load/storeï¼ˆfloat4ï¼‰</li>
<li>ä½¿ç”¨paddingé¿å…bank conflict</li>
<li>è€ƒè™‘warpçº§çš„åä½œ</li>
<li>å¤„ç†éå¯¹é½çš„è¾¹ç•Œæƒ…å†µ</li>
</ol>
</details>
<p><strong>ç»ƒä¹ 8.6</strong>ï¼šå®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æ··åˆç²¾åº¦GEMMå†…æ ¸ï¼Œè¦æ±‚ï¼š</p>
<ul>
<li>è¾“å…¥ä¸ºFP16ï¼Œç´¯åŠ ç”¨FP32</li>
<li>ä½¿ç”¨PTXå®ç°æ ¸å¿ƒè®¡ç®—å¾ªç¯</li>
<li>æ€§èƒ½è¾¾åˆ°ç†è®ºå³°å€¼çš„80%ä»¥ä¸Š</li>
</ul>
<details>
<summary>æç¤º</summary>
<ol>
<li>ä½¿ç”¨h2få’Œf2hè½¬æ¢æŒ‡ä»¤</li>
<li>å¯„å­˜å™¨åˆ†å—æŠ€æœ¯</li>
<li>åŒç¼“å†²é¢„å–</li>
<li>FMAæŒ‡ä»¤æµæ°´çº¿ä¼˜åŒ–</li>
<li>è€ƒè™‘Tensor Coreçš„ä½¿ç”¨ï¼ˆå¦‚æœç¡¬ä»¶æ”¯æŒï¼‰</li>
</ol>
</details>
<p><strong>ç»ƒä¹ 8.7</strong>ï¼ˆå¼€æ”¾é¢˜ï¼‰ï¼šä¸ºè‡ªåŠ¨é©¾é©¶åœºæ™¯è®¾è®¡ä¸€ä¸ªç‚¹äº‘ä½“ç´ åŒ–çš„PTXä¼˜åŒ–å®ç°ï¼š</p>
<ul>
<li>è¾“å…¥ï¼šNä¸ª3Dç‚¹</li>
<li>è¾“å‡ºï¼šç¨€ç–ä½“ç´ ç½‘æ ¼</li>
<li>è¦æ±‚ï¼šå¤„ç†ç™¾ä¸‡çº§ç‚¹äº‘ï¼Œå»¶è¿Ÿ&lt;10ms</li>
</ul>
<details>
<summary>æ€è·¯</summary>
<ol>
<li>ç©ºé—´å“ˆå¸Œé¿å…å†²çª</li>
<li>åŸå­æ“ä½œå¤„ç†å¹¶å‘å†™å…¥</li>
<li>å‘é‡åŒ–åæ ‡è½¬æ¢</li>
<li>ä½¿ç”¨ä½æ“ä½œç¼–ç ä½“ç´ ç´¢å¼•</li>
<li>è€ƒè™‘åŠ¨æ€å¹¶è¡Œå¤„ç†ç¨€ç–åŒºåŸŸ</li>
</ol>
</details>
<p><strong>ç»ƒä¹ 8.8</strong>ï¼ˆç ”ç©¶é¢˜ï¼‰ï¼šæ¢è®¨PTXä¼˜åŒ–åœ¨ä¸åŒGPUæ¶æ„ä¸Šçš„å¯ç§»æ¤æ€§ï¼š</p>
<ul>
<li>æ¯”è¾ƒVoltaã€Turingã€Ampereæ¶æ„çš„å·®å¼‚</li>
<li>åˆ†æå“ªäº›PTXä¼˜åŒ–æ˜¯æ¶æ„æ— å…³çš„</li>
<li>æå‡ºä¸€ä¸ªè‡ªé€‚åº”ä¼˜åŒ–ç­–ç•¥</li>
</ul>
<details>
<summary>ç ”ç©¶æ–¹å‘</summary>
<ol>
<li>æŒ‡ä»¤å»¶è¿Ÿçš„æ¶æ„å·®å¼‚</li>
<li>æ–°æŒ‡ä»¤é›†çš„åˆ©ç”¨ï¼ˆå¦‚Ampereçš„å¼‚æ­¥æ‹·è´ï¼‰</li>
<li>å¯„å­˜å™¨æ–‡ä»¶å¤§å°çš„å½±å“</li>
<li>ç¼“å­˜å±‚æ¬¡çš„å˜åŒ–</li>
<li>ç¼–å†™æ¶æ„æ„ŸçŸ¥çš„ä»£ç ç”Ÿæˆå™¨</li>
</ol>
</details>
<h2 id="_5">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1">1. å¯„å­˜å™¨åˆ†é…é—®é¢˜</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šè¿‡å¤šçš„è¾“å…¥è¾“å‡ºæ“ä½œæ•°</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="n">ä¸ªè¾“å‡º</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="n">ä¸ªè¾“å…¥</span><span class="p">]);</span><span class="w">  </span><span class="c1">// å¯èƒ½è¶…å‡ºé™åˆ¶</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨ä¸´æ—¶å˜é‡å‡å°‘æ“ä½œæ•°</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
</code></pre></div>

<h3 id="2">2. å†…å­˜å¯¹é½é”™è¯¯</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šéå¯¹é½çš„å‘é‡è®¿é—®</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld.global.v4.f32 {...}, [%0];&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="n">unaligned_ptr</span><span class="p">));</span>

<span class="c1">// æ­£ç¡®ï¼šæ£€æŸ¥å¯¹é½æˆ–ä½¿ç”¨æ ‡é‡è®¿é—®</span>
<span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">ptr</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å‘é‡è®¿é—®</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ ‡é‡è®¿é—®</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3">3. æŒ‡ä»¤å…¼å®¹æ€§</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šä½¿ç”¨äº†ç‰¹å®šæ¶æ„çš„æŒ‡ä»¤</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;wmma.mma.sync.m16n16k16.f32.f16 ...&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// éœ€è¦Volta+</span>

<span class="c1">// æ­£ç¡®ï¼šæ£€æŸ¥è®¡ç®—èƒ½åŠ›</span>
<span class="cp">#if __CUDA_ARCH__ &gt;= 700</span>
<span class="w">    </span><span class="c1">// Tensor CoreæŒ‡ä»¤</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="c1">// fallbackå®ç°</span>
<span class="cp">#endif</span>
</code></pre></div>

<h3 id="4">4. ç ´åå¯„å­˜å™¨çŠ¶æ€</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ²¡æœ‰å£°æ˜clobberåˆ—è¡¨</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// å¯èƒ½ç ´åå…¶ä»–å˜é‡</span>

<span class="c1">// æ­£ç¡®ï¼šå£°æ˜æ‰€æœ‰è¢«ä¿®æ”¹çš„å¯„å­˜å™¨</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">);</span>
</code></pre></div>

<h3 id="5">5. æµ®ç‚¹æ•°ç«‹å³æ•°æ ¼å¼</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šä½¿ç”¨åè¿›åˆ¶æµ®ç‚¹æ•°</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.f32 %0, %1, 2.0;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨åå…­è¿›åˆ¶è¡¨ç¤º</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;add.f32 %0, %1, 0f40000000;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</code></pre></div>

<h2 id="_6">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="ptx">PTXä¼˜åŒ–å†³ç­–</h3>
<ul>
<li>[ ] æ˜¯å¦çœŸçš„éœ€è¦PTXä¼˜åŒ–ï¼Ÿå…ˆåˆ†ææ€§èƒ½ç“¶é¢ˆ</li>
<li>[ ] æ˜¯å¦æœ‰æ›´é«˜å±‚çš„è§£å†³æ–¹æ¡ˆï¼ˆå¦‚åº“å‡½æ•°ï¼‰ï¼Ÿ</li>
<li>[ ] PTXä»£ç çš„å¯ç»´æŠ¤æ€§æ˜¯å¦å¯æ¥å—ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è€ƒè™‘äº†ä¸åŒæ¶æ„çš„å…¼å®¹æ€§ï¼Ÿ</li>
</ul>
<h3 id="_7">ä»£ç è´¨é‡</h3>
<ul>
<li>[ ] PTXä»£ç æ˜¯å¦æœ‰å……åˆ†çš„æ³¨é‡Šï¼Ÿ</li>
<li>[ ] æ˜¯å¦æä¾›äº†æ ‡å‡†C++çš„fallbackç‰ˆæœ¬ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è¿›è¡Œäº†æ­£ç¡®æ€§éªŒè¯ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æµ‹è¯•äº†è¾¹ç•Œæ¡ä»¶ï¼Ÿ</li>
</ul>
<h3 id="_8">æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>[ ] æ˜¯å¦ä½¿ç”¨äº†FMAæŒ‡ä»¤ä¼˜åŒ–è®¡ç®—ï¼Ÿ</li>
<li>[ ] æ˜¯å¦åˆ©ç”¨äº†å‘é‡åŒ–load/storeï¼Ÿ</li>
<li>[ ] æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„å¯„å­˜å™¨ç§»åŠ¨ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è€ƒè™‘äº†æŒ‡ä»¤çº§å¹¶è¡Œï¼Ÿ</li>
</ul>
<h3 id="_9">æ¶æ„é€‚é…</h3>
<ul>
<li>[ ] æ˜¯å¦ä½¿ç”¨äº†<code>__CUDA_ARCH__</code>è¿›è¡Œæ¡ä»¶ç¼–è¯‘ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æµ‹è¯•äº†ç›®æ ‡æ¶æ„çš„æ‰€æœ‰å˜ä½“ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è€ƒè™‘äº†æœªæ¥æ¶æ„çš„å…¼å®¹æ€§ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è®°å½•äº†æ¶æ„ç‰¹å®šçš„ä¼˜åŒ–ï¼Ÿ</li>
</ul>
<h3 id="_10">è°ƒè¯•ä¸æµ‹è¯•</h3>
<ul>
<li>[ ] æ˜¯å¦å¯ä»¥è½»æ¾åˆ‡æ¢PTXå’Œæ ‡å‡†ç‰ˆæœ¬ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æœ‰æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Ÿ</li>
<li>[ ] æ˜¯å¦éªŒè¯äº†æ•°å€¼ç²¾åº¦ï¼Ÿ</li>
<li>[ ] æ˜¯å¦å¤„ç†äº†æ‰€æœ‰é”™è¯¯æƒ…å†µï¼Ÿ</li>
</ul>
<h3 id="_11">æ–‡æ¡£åŒ–</h3>
<ul>
<li>[ ] æ˜¯å¦è¯´æ˜äº†PTXä¼˜åŒ–çš„åŸç†ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è®°å½•äº†æ€§èƒ½æå‡æ•°æ®ï¼Ÿ</li>
<li>[ ] æ˜¯å¦åˆ—å‡ºäº†ä½¿ç”¨é™åˆ¶ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æä¾›äº†ä½¿ç”¨ç¤ºä¾‹ï¼Ÿ</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter7.html" class="nav-link prev">â† ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</a><a href="chapter9.html" class="nav-link next">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®— â†’</a></nav>
        </main>
    </div>
</body>
</html>