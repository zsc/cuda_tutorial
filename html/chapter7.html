<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="7">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨CUDAä¸­çš„åŸå­æ“ä½œå’ŒåŒæ­¥æœºåˆ¶ã€‚æˆ‘ä»¬å°†ä»ç¡¬ä»¶å±‚é¢ç†è§£åŸå­æ“ä½œçš„å®ç°åŸç†ï¼ŒæŒæ¡å„ç§åŒæ­¥åŸè¯­çš„ä½¿ç”¨åœºæ™¯ï¼Œå¹¶é€šè¿‡å®ç°é«˜å¹¶å‘å“ˆå¸Œè¡¨æ¥ç»¼åˆè¿ç”¨è¿™äº›æŠ€æœ¯ã€‚å¯¹äºè‡ªåŠ¨é©¾é©¶å’Œå…·èº«æ™ºèƒ½åº”ç”¨ä¸­çš„å¹¶å‘æ•°æ®ç»“æ„è®¾è®¡ï¼Œè¿™äº›çŸ¥è¯†è‡³å…³é‡è¦ã€‚</p>
<h2 id="71">7.1 åŸå­æ“ä½œçš„ç¡¬ä»¶å®ç°</h2>
<h3 id="711">7.1.1 åŸå­æ“ä½œçš„æœ¬è´¨</h3>
<p>åŸå­æ“ä½œä¿è¯äº†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹å…±äº«å†…å­˜ä½ç½®çš„è¯»-æ”¹-å†™æ“ä½œçš„åŸå­æ€§ã€‚åœ¨GPUä¸Šï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å†…å­˜åœ°å€æ—¶ï¼ŒåŸå­æ“ä½œç¡®ä¿æ¯ä¸ªæ“ä½œéƒ½å®Œæ•´æ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚</p>
<p>ç¡¬ä»¶å±‚é¢ï¼ŒåŸå­æ“ä½œé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°ï¼š</p>
<ol>
<li>
<p><strong>L2ç¼“å­˜åŸå­å•å…ƒ</strong>ï¼šä»Fermiæ¶æ„å¼€å§‹ï¼ŒNVIDIA GPUåœ¨L2ç¼“å­˜ä¸­é›†æˆäº†ä¸“é—¨çš„åŸå­æ“ä½œå•å…ƒã€‚è¿™äº›å•å…ƒèƒ½å¤Ÿç›´æ¥åœ¨ç¼“å­˜è¡Œä¸Šæ‰§è¡ŒåŸå­æ“ä½œï¼Œé¿å…äº†æ•°æ®åœ¨å†…å­˜å±‚æ¬¡ç»“æ„ä¸­çš„ç§»åŠ¨ã€‚</p>
</li>
<li>
<p><strong>å†…å­˜æ§åˆ¶å™¨åŸå­å•å…ƒ</strong>ï¼šå¯¹äºå…¨å±€å†…å­˜çš„åŸå­æ“ä½œï¼Œå†…å­˜æ§åˆ¶å™¨åŒ…å«ä¸“é—¨çš„åŸå­æ“ä½œé€»è¾‘ï¼Œå¯ä»¥åœ¨DRAMæ¥å£å¤„ç›´æ¥æ‰§è¡ŒåŸå­æ“ä½œã€‚</p>
</li>
<li>
<p><strong>å…±äº«å†…å­˜åŸå­æ“ä½œ</strong>ï¼šåœ¨SMå†…éƒ¨ï¼Œå…±äº«å†…å­˜çš„åŸå­æ“ä½œé€šè¿‡banké”å®šæœºåˆ¶å®ç°ã€‚å½“ä¸€ä¸ªwarpä¸­çš„çº¿ç¨‹å¯¹åŒä¸€bankæ‰§è¡ŒåŸå­æ“ä½œæ—¶ï¼Œç¡¬ä»¶ä¼šä¸²è¡ŒåŒ–è¿™äº›è®¿é—®ã€‚</p>
</li>
</ol>
<h3 id="712">7.1.2 åŸå­æ“ä½œçš„æ€§èƒ½ç‰¹å¾</h3>
<p>åŸå­æ“ä½œçš„å»¶è¿Ÿç‰¹å¾ï¼š</p>
<div class="codehilite"><pre><span></span><code>æ“ä½œç±»å‹         å»¶è¿Ÿ(cycles)   ååé‡
----------------------------------------
å…¨å±€å†…å­˜åŸå­      200-600       ä½(ä¸²è¡ŒåŒ–)
å…±äº«å†…å­˜åŸå­      20-40         ä¸­ç­‰
L2ç¼“å­˜åŸå­       100-200       ä¸­ç­‰
å¯„å­˜å™¨åŸå­       ä¸æ”¯æŒ         -
</code></pre></div>

<p>å…³é”®æ€§èƒ½å› ç´ ï¼š</p>
<ol>
<li><strong>åœ°å€å†²çª</strong>ï¼šå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€åœ°å€ä¼šå¯¼è‡´ä¸²è¡ŒåŒ–</li>
<li><strong>å†…å­˜ä½ç½®</strong>ï¼šL2ç¼“å­˜ä¸­çš„åŸå­æ“ä½œæ¯”å…¨å±€å†…å­˜å¿«3-5å€</li>
<li><strong>æ“ä½œç±»å‹</strong>ï¼šç®€å•æ“ä½œ(add)æ¯”å¤æ‚æ“ä½œ(CAS)å¿«</li>
<li><strong>è®¿é—®æ¨¡å¼</strong>ï¼šåˆ†æ•£çš„è®¿é—®æ¨¡å¼ä¼˜äºé›†ä¸­è®¿é—®</li>
</ol>
<h3 id="713">7.1.3 åŸå­æ“ä½œçš„å†…å­˜åº</h3>
<p>CUDAæ”¯æŒå¤šç§å†…å­˜åºæ¨¡å‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é»˜è®¤åŸå­æ“ä½œ - å®½æ¾å†…å­˜åº</span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// ä½¿ç”¨å†…å­˜åºå‚æ•° (CUDA 11.0+)</span>
<span class="n">atomicAdd_system</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç³»ç»ŸèŒƒå›´ä¸€è‡´æ€§</span>
<span class="n">atomicAdd_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">   </span><span class="c1">// å—èŒƒå›´ä¸€è‡´æ€§</span>
</code></pre></div>

<p>å†…å­˜åºå±‚æ¬¡ï¼š</p>
<div class="codehilite"><pre><span></span><code>       ç³»ç»ŸèŒƒå›´ (system)
           â†‘
       è®¾å¤‡èŒƒå›´ (device)  
           â†‘
        å—èŒƒå›´ (block)
           â†‘
       warpèŒƒå›´ (é»˜è®¤)
</code></pre></div>

<h3 id="714">7.1.4 åŸå­æ“ä½œä¼˜åŒ–ç­–ç•¥</h3>
<ol>
<li><strong>æ‰¹é‡åŒ–åŸå­æ“ä½œ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½æ•ˆï¼šæ¯ä¸ªçº¿ç¨‹æ‰§è¡ŒåŸå­æ“ä½œ</span>
<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// é«˜æ•ˆï¼šå…ˆåœ¨warpå†…å½’çº¦</span>
<span class="kt">int</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__activemask</span><span class="p">();</span>
<span class="kt">int</span><span class="w"> </span><span class="n">leader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ffs</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">warp_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__popc</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lane_id</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">leader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_counter</span><span class="p">,</span><span class="w"> </span><span class="n">warp_sum</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>ä½¿ç”¨warpèšåˆå‡½æ•°</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// CUDA 11.0+ æä¾›çš„warpçº§åŸå­èšåˆ</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cooperative_groups/reduce.h&gt;</span>
<span class="n">namespace</span><span class="w"> </span><span class="n">cg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cooperative_groups</span><span class="p">;</span>

<span class="k">auto</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">::</span><span class="n">tiled_partition</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cg</span><span class="o">::</span><span class="n">this_thread_block</span><span class="p">());</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tile</span><span class="p">.</span><span class="n">thread_rank</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="n">tile</span><span class="p">.</span><span class="n">ballot</span><span class="p">(</span><span class="n">predicate</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>åŸå­æ“ä½œåˆå¹¶</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨atomicCASå®ç°å¤æ‚åŸå­æ“ä½œ</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">atomicMax</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">addr_as_uint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">addr_as_uint</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">assumed</span><span class="p">;</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">assumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">old_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__uint_as_float</span><span class="p">(</span><span class="n">assumed</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">new_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">old_value</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicCAS</span><span class="p">(</span><span class="n">addr_as_uint</span><span class="p">,</span><span class="w"> </span><span class="n">assumed</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">__float_as_uint</span><span class="p">(</span><span class="n">new_value</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">assumed</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__uint_as_float</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="72">7.2 è‡ªå®šä¹‰åŸå­æ“ä½œ</h2>
<h3 id="721-cas">7.2.1 åŸºäºCASçš„è‡ªå®šä¹‰åŸå­æ“ä½œ</h3>
<p>Compare-And-Swap (CAS) æ˜¯æ„å»ºè‡ªå®šä¹‰åŸå­æ“ä½œçš„åŸºç¡€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸå­ä¹˜æ³•å®ç°</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">atomicMul</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">assumed</span><span class="p">;</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">assumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="w">        </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicCAS</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">assumed</span><span class="p">,</span><span class="w"> </span><span class="n">assumed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">assumed</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// åŸå­é™¤æ³•å®ç°ï¼ˆéœ€è¦å¤„ç†é™¤é›¶ï¼‰</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">atomicDiv</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">divisor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">divisor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">addr_as_uint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">addr_as_uint</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">assumed</span><span class="p">;</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">assumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">old_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__uint_as_float</span><span class="p">(</span><span class="n">assumed</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">new_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">divisor</span><span class="p">;</span>
<span class="w">        </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicCAS</span><span class="p">(</span><span class="n">addr_as_uint</span><span class="p">,</span><span class="w"> </span><span class="n">assumed</span><span class="p">,</span>
<span class="w">                       </span><span class="n">__float_as_uint</span><span class="p">(</span><span class="n">new_value</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">assumed</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__uint_as_float</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="722">7.2.2 å¤æ‚æ•°æ®ç»“æ„çš„åŸå­æ“ä½œ</h3>
<p>å¯¹äºå¤æ‚æ•°æ®ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨128ä½åŸå­æ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 128ä½åŸå­CAS (ä»…compute capability 7.0+)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Complex</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">real</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">imag</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">magnitude</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">phase</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">atomicUpdateComplex</span><span class="p">(</span><span class="n">Complex</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">Complex</span><span class="w"> </span><span class="n">new_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å°†128ä½æ•°æ®ä½œä¸ºä¸¤ä¸ª64ä½æ•´æ•°å¤„ç†</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="w"> </span><span class="n">addr_as_ull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">old_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_as_ull</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">old_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_as_ull</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">new_low</span><span class="p">,</span><span class="w"> </span><span class="n">new_high</span><span class="p">;</span>

<span class="w">    </span><span class="n">Complex</span><span class="w"> </span><span class="n">old_complex</span><span class="p">,</span><span class="w"> </span><span class="n">assumed_complex</span><span class="p">;</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é‡æ„æ—§å€¼</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assumed_complex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_low</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Complex</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// è®¡ç®—æ–°å€¼</span>
<span class="w">        </span><span class="n">Complex</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeUpdate</span><span class="p">(</span><span class="n">assumed_complex</span><span class="p">,</span><span class="w"> </span><span class="n">new_val</span><span class="p">);</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_low</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">updated</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">));</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_high</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">updated</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// åŸå­æ›´æ–°</span>
<span class="w">        </span><span class="n">old_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_as_ull</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">old_low</span><span class="p">,</span><span class="w"> </span><span class="n">new_low</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_low</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">assumed_complex</span><span class="p">.</span><span class="n">low</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_as_ull</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">old_high</span><span class="p">,</span><span class="w"> </span><span class="n">new_high</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">old_low</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">assumed_complex</span><span class="p">.</span><span class="n">low</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">old_high</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">assumed_complex</span><span class="p">.</span><span class="n">high</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="723">7.2.3 æ— é”æ•°æ®ç»“æ„åŸè¯­</h3>
<p>å®ç°æ— é”æ ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">LockFreeStack</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">push</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">new_node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">old_top</span><span class="p">;</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
<span class="w">            </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">top</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">old_top</span><span class="p">,</span>
<span class="w">                          </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">new_node</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span>
<span class="w">                 </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">old_top</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">pop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">old_top</span><span class="p">;</span>
<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">new_top</span><span class="p">;</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_top</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">nullptr</span><span class="p">;</span>
<span class="w">            </span><span class="n">new_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">top</span><span class="p">,</span>
<span class="w">                          </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">old_top</span><span class="p">,</span>
<span class="w">                          </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">new_top</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span>
<span class="w">                 </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">old_top</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">old_top</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="73">7.3 å†…å­˜æ …æ ä¸ä¸€è‡´æ€§æ¨¡å‹</h2>
<h3 id="731-cuda">7.3.1 CUDAå†…å­˜ä¸€è‡´æ€§æ¨¡å‹</h3>
<p>CUDAé‡‡ç”¨å¼±å†…å­˜ä¸€è‡´æ€§æ¨¡å‹ï¼Œéœ€è¦æ˜¾å¼çš„åŒæ­¥æ¥ä¿è¯å†…å­˜æ“ä½œçš„é¡ºåºï¼š</p>
<div class="codehilite"><pre><span></span><code>çº¿ç¨‹å†…é¡ºåºï¼šç¨‹åºé¡ºåº
çº¿ç¨‹é—´é¡ºåºï¼šéœ€è¦åŒæ­¥åŸè¯­
  â†“
å†…å­˜æ“ä½œé‡æ’åºè§„åˆ™ï¼š

1. Load-Load: å¯é‡æ’åº
2. Load-Store: å¯é‡æ’åº  
3. Store-Load: å¯é‡æ’åº
4. Store-Store: å¯é‡æ’åº
  â†“
éœ€è¦æ …æ æŒ‡ä»¤æ¥é˜²æ­¢é‡æ’åº
</code></pre></div>

<h3 id="732">7.3.2 æ …æ æŒ‡ä»¤å±‚æ¬¡</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// çº¿ç¨‹æ …æ  - ä¿è¯å•ä¸ªçº¿ç¨‹å†…çš„å†…å­˜æ“ä½œé¡ºåº</span>
<span class="nf">__threadfence</span><span class="p">();</span><span class="w">        </span><span class="c1">// è®¾å¤‡èŒƒå›´</span>
<span class="nf">__threadfence_block</span><span class="p">();</span><span class="w">  </span><span class="c1">// å—èŒƒå›´</span>
<span class="nf">__threadfence_system</span><span class="p">();</span><span class="w"> </span><span class="c1">// ç³»ç»ŸèŒƒå›´</span>

<span class="c1">// ç¤ºä¾‹ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">producer</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_value</span><span class="p">();</span>
<span class="w">    </span><span class="nf">__threadfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// ç¡®ä¿dataå†™å…¥åœ¨flagä¹‹å‰å®Œæˆ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// é€šçŸ¥æ¶ˆè´¹è€…æ•°æ®å·²å‡†å¤‡å¥½</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">consumer</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…æ ‡å¿—</span>
<span class="w">    </span><span class="nf">__threadfence</span><span class="p">();</span><span class="w">     </span><span class="c1">// ç¡®ä¿è¯»å–flagåå†è¯»å–data</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
<span class="w">    </span><span class="n">process</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="733">7.3.3 å†…å­˜æ …æ çš„æ€§èƒ½å½±å“</h3>
<p>ä¸åŒæ …æ çš„å¼€é”€ï¼š</p>
<div class="codehilite"><pre><span></span><code>æ …æ ç±»å‹                 å»¶è¿Ÿ(cycles)   å½±å“èŒƒå›´
------------------------------------------------
__threadfence_block()    ~30          å—å†…æ‰€æœ‰çº¿ç¨‹
__threadfence()          ~200         è®¾å¤‡æ‰€æœ‰çº¿ç¨‹
__threadfence_system()   ~500         ç³»ç»Ÿæ‰€æœ‰è®¾å¤‡
</code></pre></div>

<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ol>
<li>å°½é‡ä½¿ç”¨æœ€å°èŒƒå›´çš„æ …æ </li>
<li>æ‰¹é‡æ“ä½œåä½¿ç”¨å•ä¸ªæ …æ </li>
<li>ä½¿ç”¨åä½œç»„çš„åŒæ­¥åŸè¯­æ›¿ä»£</li>
</ol>
<h3 id="734-">7.3.4 å‘å¸ƒ-è·å–è¯­ä¹‰</h3>
<p>CUDA 11.0+æ”¯æŒC++11é£æ ¼çš„å†…å­˜åºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å‘å¸ƒè¯­ä¹‰ - ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹å¯è§</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">release_store</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">__threadfence</span><span class="p">();</span>
<span class="w">    </span><span class="n">atomicExch</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// è·å–è¯­ä¹‰ - ä¹‹åçš„æ‰€æœ‰è¯»æ“ä½œçœ‹åˆ°æœ€æ–°å€¼</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">acquire_load</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// åŸå­è¯»</span>
<span class="w">    </span><span class="nf">__threadfence</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// é¡ºåºä¸€è‡´æ€§</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">seq_cst_operation</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">__threadfence</span><span class="p">();</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="nf">__threadfence</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="74">7.4 è‡ªæ—‹é”ä¸æ— é”ç®—æ³•</h2>
<h3 id="741">7.4.1 é«˜æ•ˆè‡ªæ—‹é”å®ç°</h3>
<p>åŸºç¡€è‡ªæ—‹é”ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">SpinLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">acquire</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// è‡ªæ—‹ç­‰å¾…</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">release</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>ä¼˜åŒ–çš„è‡ªæ—‹é”ï¼ˆå‡å°‘åŸå­æ“ä½œï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">OptimizedSpinLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">acquire</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å…ˆç”¨æ™®é€šè¯»æ£€æŸ¥</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// å°è¯•è·å–é”</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// æŒ‡æ•°é€€é¿</span>
<span class="w">            </span><span class="n">__nanosleep</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">7</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">release</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nf">__threadfence</span><span class="p">();</span><span class="w">  </span><span class="c1">// ç¡®ä¿ä¹‹å‰çš„æ“ä½œå®Œæˆ</span>
<span class="w">        </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">         </span><span class="c1">// æ™®é€šå†™å³å¯</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">### 7.4.2 ç¥¨æ®é”ï¼ˆTicket Lockï¼‰</span>

<span class="n">ç¥¨æ®é”æä¾›å…¬å¹³æ€§ä¿è¯</span><span class="err">ï¼š</span>

<span class="err">```</span><span class="n">cuda</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TicketLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ticket</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">serving</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">acquire</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">my_ticket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ticket</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">serving</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">my_ticket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// è‡ªæ—‹ç­‰å¾…è‡ªå·±çš„ç¥¨å·</span>
<span class="w">            </span><span class="nf">__threadfence_block</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">release</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nf">__threadfence</span><span class="p">();</span>
<span class="w">        </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serving</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="743-mcs">7.4.3 MCSé”ï¼ˆå¯æ‰©å±•æ€§æ›´å¥½ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">MCSNode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">locked</span><span class="p">;</span>
<span class="w">    </span><span class="n">MCSNode</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">MCSLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MCSNode</span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">acquire</span><span class="p">(</span><span class="n">MCSNode</span><span class="o">*</span><span class="w"> </span><span class="n">my_node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">my_node</span><span class="o">-&gt;</span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">my_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">;</span>

<span class="w">        </span><span class="n">MCSNode</span><span class="o">*</span><span class="w"> </span><span class="n">predecessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MCSNode</span><span class="o">*</span><span class="p">)</span><span class="n">atomicExch</span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">my_node</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">predecessor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">predecessor</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_node</span><span class="p">;</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">my_node</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// è‡ªæ—‹åœ¨è‡ªå·±çš„èŠ‚ç‚¹ä¸Š</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">release</span><span class="p">(</span><span class="n">MCSNode</span><span class="o">*</span><span class="w"> </span><span class="n">my_node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">my_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span>
<span class="w">                         </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">my_node</span><span class="p">,</span>

<span class="w">                         </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">my_node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">my_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nullptr</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">my_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="744">7.4.4 æ— é”ç®—æ³•è®¾è®¡åŸåˆ™</h3>
<ol>
<li><strong>ABAé—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ç‰ˆæœ¬å·è§£å†³ABAé—®é¢˜</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">VersionedPointer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">compareAndSwap</span><span class="p">(</span><span class="n">VersionedPointer</span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
<span class="w">                               </span><span class="n">VersionedPointer</span><span class="w"> </span><span class="n">expected</span><span class="p">,</span>
<span class="w">                               </span><span class="n">VersionedPointer</span><span class="w"> </span><span class="n">desired</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="w"> </span><span class="n">addr_as_ull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">expected_ull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">expected</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">desired_ull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">desired</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicCAS</span><span class="p">(</span><span class="n">addr_as_ull</span><span class="p">,</span><span class="w"> </span><span class="n">expected_ull</span><span class="p">,</span><span class="w"> </span><span class="n">desired_ull</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected_ull</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å†…å­˜ç®¡ç†ä¸å±é™©æŒ‡é’ˆ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// å±é™©æŒ‡é’ˆæœºåˆ¶é˜²æ­¢è¿‡æ—©é‡Šæ”¾</span>
<span class="n">template</span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">HazardPointers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">hazard</span><span class="p">[</span><span class="n">MAX_THREADS</span><span class="p">];</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">protect</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">**</span><span class="w"> </span><span class="n">ptr_location</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_location</span><span class="p">;</span>
<span class="w">            </span><span class="n">hazard</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">            </span><span class="nf">__threadfence</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_location</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">clear</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hazard</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_safe_to_delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hazard</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="745">7.4.5 æ— é”é˜Ÿåˆ—å®ç°</h3>
<p>Michael &amp; Scottæ— é”é˜Ÿåˆ—ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">LockFreeQueue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">T</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
<span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">enqueue</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">new_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocate_node</span><span class="p">();</span>
<span class="w">        </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">;</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span>
<span class="w">            </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">last</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
<span class="w">                                 </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">new_node</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span>
<span class="w">                                 </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">last</span><span class="p">,</span>
<span class="w">                                 </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">new_node</span><span class="p">);</span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span>
<span class="w">                             </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">last</span><span class="p">,</span>
<span class="w">                             </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">next</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">dequeue</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
<span class="w">            </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span>
<span class="w">            </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// é˜Ÿåˆ—ä¸ºç©º</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span>
<span class="w">                             </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">last</span><span class="p">,</span>
<span class="w">                             </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">next</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span>
<span class="w">                                 </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">first</span><span class="p">,</span>
<span class="w">                                 </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="o">==</span>
<span class="w">                        </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">free_node</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="75">7.5 æ¡ˆä¾‹ï¼šé«˜å¹¶å‘å“ˆå¸Œè¡¨å®ç°</h2>
<h3 id="751">7.5.1 è®¾è®¡ç›®æ ‡ä¸æŒ‘æˆ˜</h3>
<p>åœ¨è‡ªåŠ¨é©¾é©¶åœºæ™¯ä¸­ï¼Œé«˜å¹¶å‘å“ˆå¸Œè¡¨ç”¨äºï¼š</p>
<ul>
<li>å®æ—¶ç‚¹äº‘ç‰¹å¾åŒ¹é…</li>
<li>åŠ¨æ€å¯¹è±¡è·Ÿè¸ª</li>
<li>ä¼ æ„Ÿå™¨æ•°æ®å…³è”</li>
</ul>
<p>è®¾è®¡æŒ‘æˆ˜ï¼š</p>
<ol>
<li>æé«˜çš„å¹¶å‘åº¦ï¼ˆæ•°åƒçº¿ç¨‹åŒæ—¶è®¿é—®ï¼‰</li>
<li>åŠ¨æ€æ‰©å®¹éœ€æ±‚</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>å†…å­˜æ•ˆç‡</li>
</ol>
<h3 id="752">7.5.2 åˆ†æ®µé”å“ˆå¸Œè¡¨</h3>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">typename</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NUM_SEGMENTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="o">&gt;</span>
<span class="n">class</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Entry</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">valid</span><span class="p">;</span><span class="w">  </span><span class="c1">// 0: empty, 1: valid, -1: deleted</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Segment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">**</span><span class="w"> </span><span class="n">buckets</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">        </span><span class="n">SpinLock</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">Segment</span><span class="w"> </span><span class="n">segments</span><span class="p">[</span><span class="n">NUM_SEGMENTS</span><span class="p">];</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// MurmurHash3çš„ç®€åŒ–ç‰ˆæœ¬</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0x85ebca6b</span><span class="p">;</span>
<span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0xc2b2ae35</span><span class="p">;</span>
<span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">h</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">get_segment</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">NUM_SEGMENTS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">seg_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_segment</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="n">Segment</span><span class="o">&amp;</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">segments</span><span class="p">[</span><span class="n">seg_idx</span><span class="p">];</span>

<span class="w">        </span><span class="n">seg</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">acquire</span><span class="p">();</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">bucket_count</span><span class="p">;</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">seg</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// é”®å·²å­˜åœ¨</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ’å…¥æ–°æ¡ç›®</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">new_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocate_entry</span><span class="p">();</span>
<span class="w">        </span><span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">];</span>
<span class="w">        </span><span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="n">seg</span><span class="p">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_entry</span><span class="p">;</span>
<span class="w">        </span><span class="n">seg</span><span class="p">.</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">bucket_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.75</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">resize_segment</span><span class="p">(</span><span class="n">seg_idx</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">seg</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">seg_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_segment</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="n">Segment</span><span class="o">&amp;</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">segments</span><span class="p">[</span><span class="n">seg_idx</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// è¯»æ“ä½œå¯ä»¥æ›´å®½æ¾</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">bucket_count</span><span class="p">;</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">];</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">remove</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">seg_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_segment</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="n">Segment</span><span class="o">&amp;</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">segments</span><span class="p">[</span><span class="n">seg_idx</span><span class="p">];</span>

<span class="w">        </span><span class="n">seg</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">acquire</span><span class="p">();</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">bucket_count</span><span class="p">;</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">**</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seg</span><span class="p">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">];</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">current</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">current</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ ‡è®°åˆ é™¤</span>
<span class="w">                </span><span class="n">seg</span><span class="p">.</span><span class="n">size</span><span class="o">--</span><span class="p">;</span>
<span class="w">                </span><span class="n">seg</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">seg</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="753">7.5.3 æ— é”å“ˆå¸Œè¡¨å®ç°</h3>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">typename</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span>
<span class="n">class</span><span class="w"> </span><span class="n">LockFreeHashMap</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Bucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">Bucket</span><span class="o">*</span><span class="w"> </span><span class="n">buckets</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// CityHashçš„GPUç‰ˆæœ¬</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">33</span><span class="p">;</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0xff51afd7ed558ccd</span><span class="p">;</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">33</span><span class="p">;</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0xc4ceb9fe1a85ec53</span><span class="p">;</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">33</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">k</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>

<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">new_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocate_node</span><span class="p">();</span>
<span class="w">        </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">].</span><span class="n">head</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// æ£€æŸ¥é”®æ˜¯å¦å·²å­˜åœ¨</span>
<span class="w">            </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">free_node</span><span class="p">(</span><span class="n">new_node</span><span class="p">);</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// å°è¯•æ’å…¥</span>
<span class="w">            </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">].</span><span class="n">head</span><span class="p">,</span>
<span class="w">                         </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">head</span><span class="p">,</span>
<span class="w">                         </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">new_node</span><span class="p">)</span><span class="w"> </span><span class="o">==</span>
<span class="w">                </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">].</span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bucket_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>

<span class="w">        </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">].</span><span class="n">head</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="754-cuckoo">7.5.4 Cuckooå“ˆå¸Œè¡¨ï¼ˆé«˜é€ŸæŸ¥æ‰¾ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">typename</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span>
<span class="n">class</span><span class="w"> </span><span class="n">CuckooHashMap</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Entry</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span>
<span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">occupied</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">table1</span><span class="p">;</span>
<span class="w">    </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">table2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">table_size</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_EVICTIONS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x9e3779b9</span><span class="p">;</span><span class="w">  </span><span class="c1">// é»„é‡‘æ¯”ä¾‹å“ˆå¸Œ</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash2</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x517cc1b7</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¦ä¸€ä¸ªè´¨æ•°</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">table_size</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash2</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">table_size</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å°è¯•æ’å…¥ç¬¬ä¸€ä¸ªè¡¨</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table1</span><span class="p">[</span><span class="n">h1</span><span class="p">].</span><span class="n">occupied</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">table1</span><span class="p">[</span><span class="n">h1</span><span class="p">].</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">            </span><span class="n">table1</span><span class="p">[</span><span class="n">h1</span><span class="p">].</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">            </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table1</span><span class="p">[</span><span class="n">h1</span><span class="p">].</span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å°è¯•æ’å…¥ç¬¬äºŒä¸ªè¡¨</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table2</span><span class="p">[</span><span class="n">h2</span><span class="p">].</span><span class="n">occupied</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">table2</span><span class="p">[</span><span class="n">h2</span><span class="p">].</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">            </span><span class="n">table2</span><span class="p">[</span><span class="n">h2</span><span class="p">].</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">            </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table2</span><span class="p">[</span><span class="n">h2</span><span class="p">].</span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Cuckooè·¯å¾„é©±é€</span>
<span class="w">        </span><span class="n">Entry</span><span class="w"> </span><span class="n">evicted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">*</span><span class="w"> </span><span class="n">current_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h1</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_EVICTIONS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Entry</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_table</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
<span class="w">            </span><span class="n">current_table</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evicted</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">occupied</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">            </span><span class="n">evicted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¡¨</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_table</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">table1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">current_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table2</span><span class="p">;</span>
<span class="w">                </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash2</span><span class="p">(</span><span class="n">evicted</span><span class="p">.</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">table_size</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">current_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table1</span><span class="p">;</span>
<span class="w">                </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">evicted</span><span class="p">.</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">table_size</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// éœ€è¦é‡æ–°å“ˆå¸Œ</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">table_size</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash2</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">table_size</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æœ€å¤šä¸¤æ¬¡å†…å­˜è®¿é—®</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">table1</span><span class="p">[</span><span class="n">h1</span><span class="p">].</span><span class="n">occupied</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">table1</span><span class="p">[</span><span class="n">h1</span><span class="p">].</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table1</span><span class="p">[</span><span class="n">h1</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">table2</span><span class="p">[</span><span class="n">h2</span><span class="p">].</span><span class="n">occupied</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">table2</span><span class="p">[</span><span class="n">h2</span><span class="p">].</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table2</span><span class="p">[</span><span class="n">h2</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="755">7.5.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3>
<ol>
<li><strong>SIMDå‹å¥½çš„æ¢æµ‹</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨å‘é‡åŒ–loadè¿›è¡Œæ‰¹é‡æŸ¥æ‰¾</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">batch_find</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">keys</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">*</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åˆ©ç”¨å‘é‡åŒ–æŒ‡ä»¤ä¸€æ¬¡åŠ è½½å¤šä¸ªé”®</span>
<span class="w">    </span><span class="kt">uint4</span><span class="o">*</span><span class="w"> </span><span class="n">vec_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint4</span><span class="o">*</span><span class="p">)</span><span class="n">keys</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint4</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_keys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// å¹¶è¡Œè®¡ç®—4ä¸ªå“ˆå¸Œå€¼</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bucket_count</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// é¢„å–bucketæ•°æ®</span>
<span class="w">        </span><span class="n">__builtin_prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buckets</span><span class="p">[</span><span class="n">h0</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="n">__builtin_prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buckets</span><span class="p">[</span><span class="n">h1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="n">__builtin_prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buckets</span><span class="p">[</span><span class="n">h2</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="n">__builtin_prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buckets</span><span class="p">[</span><span class="n">h3</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¹¶è¡ŒæŸ¥æ‰¾</span>
<span class="w">        </span><span class="n">find_single</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">]);</span>
<span class="w">        </span><span class="n">find_single</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="n">find_single</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">        </span><span class="n">find_single</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å†…å­˜æ± ç®¡ç†</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// çº¿ç¨‹æœ¬åœ°å†…å­˜æ± å‡å°‘åˆ†é…å¼€é”€</span>
<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">POOL_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ThreadLocalPool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">pool</span><span class="p">[</span><span class="n">POOL_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">free_list</span><span class="p">[</span><span class="n">POOL_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">free_count</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">POOL_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">free_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">free_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POOL_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">allocate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">free_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pool</span><span class="p">[</span><span class="n">free_list</span><span class="p">[</span><span class="o">--</span><span class="n">free_count</span><span class="p">]];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nullptr</span><span class="p">;</span><span class="w">  </span><span class="c1">// éœ€è¦å…¨å±€åˆ†é…</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pool</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">POOL_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">free_list</span><span class="p">[</span><span class="n">free_count</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="756">7.5.6 å®é™…åº”ç”¨ï¼šç‚¹äº‘ç‰¹å¾åŒ¹é…</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç”¨äºè‡ªåŠ¨é©¾é©¶ä¸­çš„å®æ—¶ç‚¹äº‘é…å‡†</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">PointFeature</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">position</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">descriptor</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w">  </span><span class="c1">// FPFHç‰¹å¾</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">match_point_features</span><span class="p">(</span>
<span class="w">    </span><span class="n">PointFeature</span><span class="o">*</span><span class="w"> </span><span class="n">source_cloud</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">source_count</span><span class="p">,</span>
<span class="w">    </span><span class="n">PointFeature</span><span class="o">*</span><span class="w"> </span><span class="n">target_cloud</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">target_count</span><span class="p">,</span>
<span class="w">    </span><span class="n">LockFreeHashMap</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;*</span><span class="w"> </span><span class="n">feature_map</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">matches</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">source_count</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">PointFeature</span><span class="o">&amp;</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source_cloud</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// è®¡ç®—ç‰¹å¾å“ˆå¸Œ</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">feature_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">feature_hash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">__float_as_uint</span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">descriptor</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾åŒ¹é…</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">match_idx</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">feature_map</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">feature_hash</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">match_idx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// éªŒè¯ç©ºé—´ä¸€è‡´æ€§</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">target_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target_cloud</span><span class="p">[</span><span class="n">match_idx</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">target_pos</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 10cmé˜ˆå€¼</span>
<span class="w">            </span><span class="n">matches</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">match_idx</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†CUDAä¸­çš„åŸå­æ“ä½œå’ŒåŒæ­¥æœºåˆ¶ï¼š</p>
<p><strong>å…³é”®æ¦‚å¿µ</strong>ï¼š</p>
<ol>
<li>åŸå­æ“ä½œé€šè¿‡ç¡¬ä»¶ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ“ä½œåŸå­æ€§</li>
<li>å†…å­˜æ …æ æä¾›äº†ä¸åŒèŒƒå›´çš„å†…å­˜ä¸€è‡´æ€§ä¿è¯</li>
<li>æ— é”ç®—æ³•é€šè¿‡CASç­‰åŸè¯­é¿å…é”çš„å¼€é”€</li>
<li>é«˜å¹¶å‘æ•°æ®ç»“æ„éœ€è¦æƒè¡¡ååé‡ã€å»¶è¿Ÿå’Œå†…å­˜æ•ˆç‡</li>
</ol>
<p><strong>æ€§èƒ½å…¬å¼</strong>ï¼š</p>
<ul>
<li>åŸå­æ“ä½œååé‡ï¼š<code>T = min(å†…å­˜å¸¦å®½ / æ“ä½œå¤§å°, åŸå­å•å…ƒæ•°é‡ Ã— é¢‘ç‡)</code></li>
<li>é”ç«äº‰å¼€é”€ï¼š<code>O = ä¸²è¡ŒåŒ–å»¶è¿Ÿ Ã— å†²çªæ¦‚ç‡ Ã— çº¿ç¨‹æ•°</code></li>
<li>æ— é”ç®—æ³•å¤æ‚åº¦ï¼š<code>é‡è¯•æ¬¡æ•° = O(çº¿ç¨‹æ•° Ã— ç«äº‰å¼ºåº¦)</code></li>
</ul>
<p><strong>ä¼˜åŒ–è¦ç‚¹</strong>ï¼š</p>
<ol>
<li>æ‰¹é‡åŒ–åŸå­æ“ä½œå‡å°‘ç«äº‰</li>
<li>ä½¿ç”¨åˆé€‚çš„åŒæ­¥ç²’åº¦</li>
<li>é€‰æ‹©é€‚åˆè®¿é—®æ¨¡å¼çš„æ•°æ®ç»“æ„</li>
<li>åˆ©ç”¨warpçº§åŸè¯­ä¼˜åŒ–</li>
</ol>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>åŸå­æ“ä½œé€‰æ‹©</strong>
   å®ç°ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç»Ÿè®¡æ•°ç»„ä¸­å¤§äºé˜ˆå€¼çš„å…ƒç´ ä¸ªæ•°ã€‚æ¯”è¾ƒä½¿ç”¨åŸå­æ“ä½œå’Œå½’çº¦çš„æ€§èƒ½å·®å¼‚ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   å¯¹äºå¤§è§„æ¨¡æ•°æ®ï¼Œå…ˆåœ¨warpæˆ–blockå†…å½’çº¦ï¼Œå†ä½¿ç”¨åŸå­æ“ä½œæ›´æ–°å…¨å±€è®¡æ•°å™¨ã€‚è¿™æ ·å¯ä»¥å°†åŸå­æ“ä½œæ¬¡æ•°ä»Nå‡å°‘åˆ°N/32æˆ–N/blockSizeã€‚
   </details>
<ol start="2">
<li><strong>å†…å­˜æ …æ åº”ç”¨</strong>
   è®¾è®¡ä¸€ä¸ªåŒç¼“å†²ç³»ç»Ÿï¼Œä¿è¯å†™å…¥ç¼“å†²åŒºçš„æ•°æ®å¯¹è¯»å–çº¿ç¨‹å®Œå…¨å¯è§ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   å†™å…¥å®Œæˆåä½¿ç”¨__threadfence()ï¼Œç„¶åæ›´æ–°ç¼“å†²åŒºç´¢å¼•ã€‚è¯»å–æ—¶å…ˆè¯»ç´¢å¼•ï¼Œå†ä½¿ç”¨__threadfence()ç¡®ä¿åç»­è¯»å–çœ‹åˆ°å®Œæ•´æ•°æ®ã€‚
   </details>
<ol start="3">
<li><strong>è‡ªæ—‹é”ä¼˜åŒ–</strong>
   æ”¹è¿›åŸºç¡€è‡ªæ—‹é”ï¼Œæ·»åŠ é€€é¿æœºåˆ¶å‡å°‘æ€»çº¿ç«äº‰ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼šåˆå§‹ç­‰å¾…æ—¶é—´çŸ­ï¼Œæ¯æ¬¡å¤±è´¥ååŠ å€ç­‰å¾…æ—¶é—´ï¼Œè®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´ä¸Šé™ã€‚å¯ä»¥æ ¹æ®çº¿ç¨‹IDæ·»åŠ éšæœºæ€§é¿å…åŒæ­¥å†²çªã€‚
   </details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<ol start="4">
<li><strong>æ— é”å†…å­˜åˆ†é…å™¨</strong>
   è®¾è®¡ä¸€ä¸ªé€‚ç”¨äºGPUçš„æ— é”å†…å­˜åˆ†é…å™¨ï¼Œæ”¯æŒå¯å˜å¤§å°çš„å†…å­˜å—åˆ†é…ã€‚</li>
</ol>
<p>æç¤ºï¼šè€ƒè™‘ä½¿ç”¨å¤šä¸ªå¤§å°ç±»çš„å†…å­˜æ± </p>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   ä½¿ç”¨åˆ†çº§å†…å­˜æ± ï¼Œæ¯ä¸ªå¤§å°ç±»ç»´æŠ¤ä¸€ä¸ªæ— é”æ ˆã€‚åˆ†é…æ—¶æ ¹æ®è¯·æ±‚å¤§å°é€‰æ‹©åˆé€‚çš„æ± ï¼Œä½¿ç”¨CASæ“ä½œç®¡ç†ç©ºé—²åˆ—è¡¨ã€‚éœ€è¦å¤„ç†å†…å­˜ç¢ç‰‡å’Œæ± é—´è¿ç§»ã€‚
   </details>
<ol start="5">
<li><strong>è¯»å†™é”å®ç°</strong>
   å®ç°ä¸€ä¸ªè¯»è€…ä¼˜å…ˆçš„è¯»å†™é”ï¼Œå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è®¿é—®ï¼Œä½†å†™è€…ç‹¬å ã€‚</li>
</ol>
<p>æç¤ºï¼šä½¿ç”¨åŸå­è®¡æ•°å™¨è·Ÿè¸ªè¯»è€…æ•°é‡</p>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   ä½¿ç”¨ä¸¤ä¸ªåŸå­å˜é‡ï¼šreaders_countå’Œwriter_flagã€‚è¯»è€…é€šè¿‡åŸå­å¢åŠ readers_countè·å–é”ï¼Œå†™è€…éœ€è¦ç­‰å¾…readers_countä¸º0å¹¶è®¾ç½®writer_flagã€‚éœ€è¦å¤„ç†é¥¥é¥¿é—®é¢˜ã€‚
   </details>
<ol start="6">
<li><strong>å¹¶å‘B+æ ‘</strong>
   è®¾è®¡ä¸€ä¸ªGPUå‹å¥½çš„å¹¶å‘B+æ ‘ï¼Œæ”¯æŒé«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢ã€‚</li>
</ol>
<p>æç¤ºï¼šè€ƒè™‘ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶</p>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   ä½¿ç”¨ç‰ˆæœ¬å·å®ç°ä¹è§‚è¯»ï¼Œåªåœ¨ä¿®æ”¹æ—¶åŠ é”ã€‚å¶èŠ‚ç‚¹ä½¿ç”¨é“¾è¡¨è¿æ¥æ”¯æŒèŒƒå›´æ‰«æã€‚å†…éƒ¨èŠ‚ç‚¹ä½¿ç”¨åŸå­CASæ›´æ–°æŒ‡é’ˆï¼Œå¶èŠ‚ç‚¹ä½¿ç”¨ç»†ç²’åº¦é”ã€‚
   </details>
<h3 id="_5">å¼€æ”¾æ€§æ€è€ƒé¢˜</h3>
<ol start="7">
<li><strong>åŸå­æ“ä½œ vs äº‹åŠ¡å†…å­˜</strong>
   å¦‚æœGPUæ”¯æŒç¡¬ä»¶äº‹åŠ¡å†…å­˜ï¼ˆHTMï¼‰ï¼Œä¼šå¦‚ä½•æ”¹å˜å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Ÿåˆ†æä¼˜ç¼ºç‚¹ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   HTMå¯ä»¥ç®€åŒ–ç¼–ç¨‹æ¨¡å‹ï¼Œè‡ªåŠ¨å¤„ç†å†²çªå’Œå›æ»šã€‚ä½†GPUçš„å¤§è§„æ¨¡å¹¶è¡Œç‰¹æ€§å¯èƒ½å¯¼è‡´é¢‘ç¹å†²çªï¼Œäº‹åŠ¡å¤§å°é™åˆ¶ä¹Ÿæ˜¯æŒ‘æˆ˜ã€‚æ··åˆä½¿ç”¨HTMå’Œä¼ ç»ŸåŒæ­¥å¯èƒ½æ˜¯æœ€ä½³æ–¹æ¡ˆã€‚
   </details>
<ol start="8">
<li><strong>è·¨è®¾å¤‡åŸå­æ“ä½œ</strong>
   è®¾è®¡ä¸€ä¸ªæ”¯æŒå¤šGPUåŸå­æ“ä½œçš„ç³»ç»Ÿï¼Œè€ƒè™‘PCIeå»¶è¿Ÿå’Œå¸¦å®½é™åˆ¶ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   å¯ä»¥ä½¿ç”¨å±‚æ¬¡åŒ–è®¾è®¡ï¼šè®¾å¤‡å†…åŸå­æ“ä½œç›´æ¥æ‰§è¡Œï¼Œè·¨è®¾å¤‡æ“ä½œé€šè¿‡ä¸»æœºç«¯åè°ƒæˆ–ä½¿ç”¨GPUDirect RDMAã€‚æ‰¹é‡åŒ–è·¨è®¾å¤‡æ“ä½œï¼Œä½¿ç”¨ç‰ˆæœ¬å‘é‡ä¿è¯ä¸€è‡´æ€§ã€‚
   </details>
<h2 id="_6">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<ol>
<li>
<p><strong>æ­»é”</strong>
   - é”™è¯¯ï¼šå¤šä¸ªé”çš„è·å–é¡ºåºä¸ä¸€è‡´
   - æ­£ç¡®ï¼šå§‹ç»ˆæŒ‰ç›¸åŒé¡ºåºè·å–å¤šä¸ªé”</p>
</li>
<li>
<p><strong>ABAé—®é¢˜</strong>
   - é”™è¯¯ï¼šä»…æ¯”è¾ƒæŒ‡é’ˆå€¼
   - æ­£ç¡®ï¼šä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ ‡è®°æŒ‡é’ˆ</p>
</li>
<li>
<p><strong>å†…å­˜åºé”™è¯¯</strong>
   - é”™è¯¯ï¼šå¿½ç•¥å†…å­˜é‡æ’åº
   - æ­£ç¡®ï¼šæ­£ç¡®ä½¿ç”¨å†…å­˜æ …æ </p>
</li>
<li>
<p><strong>åŸå­æ“ä½œæ»¥ç”¨</strong>
   - é”™è¯¯ï¼šå¯¹æ‰€æœ‰å…±äº«å˜é‡ä½¿ç”¨åŸå­æ“ä½œ
   - æ­£ç¡®ï¼šåˆ†æè®¿é—®æ¨¡å¼ï¼Œå¿…è¦æ—¶æ‰ä½¿ç”¨</p>
</li>
<li>
<p><strong>æ´»é”</strong>
   - é”™è¯¯ï¼šæ— é™é‡è¯•å¤±è´¥çš„CAS
   - æ­£ç¡®ï¼šæ·»åŠ é€€é¿æœºåˆ¶æˆ–é‡è¯•é™åˆ¶</p>
</li>
</ol>
<h2 id="_7">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<ul>
<li>[ ] åŸå­æ“ä½œæ˜¯å¦å·²æ‰¹é‡åŒ–ï¼Ÿ</li>
<li>[ ] æ˜¯å¦é€‰æ‹©äº†æ­£ç¡®çš„åŒæ­¥ç²’åº¦ï¼Ÿ</li>
<li>[ ] å†…å­˜æ …æ èŒƒå›´æ˜¯å¦æœ€å°åŒ–ï¼Ÿ</li>
<li>[ ] æ˜¯å¦å¤„ç†äº†ABAé—®é¢˜ï¼Ÿ</li>
<li>[ ] æ— é”ç®—æ³•æ˜¯å¦æœ‰é€€é¿æœºåˆ¶ï¼Ÿ</li>
<li>[ ] æ˜¯å¦é¿å…äº†false sharingï¼Ÿ</li>
<li>[ ] å†…å­˜åˆ†é…æ˜¯å¦ä¼˜åŒ–ï¼Ÿ</li>
<li>[ ] æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„å“ˆå¸Œå‡½æ•°ï¼Ÿ</li>
<li>[ ] å¹¶å‘æ•°æ®ç»“æ„æ˜¯å¦æ”¯æŒæ‰©å±•ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æœ‰æ€§èƒ½ç›‘æ§å’Œè°ƒè¯•æœºåˆ¶ï¼Ÿ
```</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter6.html" class="nav-link prev">â† ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</a><a href="chapter8.html" class="nav-link next">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ– â†’</a></nav>
        </main>
    </div>
</body>
</html>