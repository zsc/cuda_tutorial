<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="10cutlass">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</h1>
<p>CUTLASSï¼ˆCUDA Templates for Linear Algebra Subroutinesï¼‰æ˜¯NVIDIAæä¾›çš„é«˜æ€§èƒ½çº¿æ€§ä»£æ•°æ¨¡æ¿åº“ï¼Œå®ƒä¸ä»…æ˜¯cuBLASå’ŒcuDNNèƒŒåçš„æ ¸å¿ƒå®ç°ï¼Œæ›´æ˜¯ç†è§£ç°ä»£GPUä¼˜åŒ–æŠ€æœ¯çš„ç»ä½³æ•™æã€‚é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å°†æŒæ¡å¦‚ä½•ä½¿ç”¨CUTLASSæ„å»ºæ¥è¿‘ç¡¬ä»¶æé™æ€§èƒ½çš„çŸ©é˜µè¿ç®—å†…æ ¸ï¼Œå¹¶èƒ½å¤Ÿæ ¹æ®å…·ä½“éœ€æ±‚å®šåˆ¶åŒ–ä¼˜åŒ–ç®—å­ã€‚è¿™å¯¹äºè‡ªåŠ¨é©¾é©¶ä¸­çš„ç¥ç»ç½‘ç»œæ¨ç†åŠ é€Ÿå’Œå…·èº«æ™ºèƒ½çš„å®æ—¶æ„ŸçŸ¥è®¡ç®—è‡³å…³é‡è¦ã€‚</p>
<h2 id="101-cutlass">10.1 CUTLASSæ¶æ„ä¸æŠ½è±¡å±‚æ¬¡</h2>
<h3 id="1011-cutlass">10.1.1 CUTLASSæ¦‚è¿°ä¸è®¾è®¡ç†å¿µ</h3>
<p>CUTLASSé‡‡ç”¨C++æ¨¡æ¿å…ƒç¼–ç¨‹æŠ€æœ¯ï¼Œåœ¨ç¼–è¯‘æ—¶ç”Ÿæˆé«˜åº¦ä¼˜åŒ–çš„CUDAå†…æ ¸ã€‚å…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯å°†å¤æ‚çš„çŸ©é˜µè¿ç®—åˆ†è§£ä¸ºå¤šä¸ªæŠ½è±¡å±‚æ¬¡ï¼Œæ¯ä¸€å±‚éƒ½å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–å’Œå®šåˆ¶ã€‚</p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Device Level               â”‚  â† æ•´ä½“é—®é¢˜åˆ†è§£
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Thread Block Level             â”‚  â† CTAçº§åˆ«è®¡ç®—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Warp Level                  â”‚  â† Warpåä½œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Thread Level                 â”‚  â† çº¿ç¨‹çº§è®¡ç®—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>CUTLASSçš„ä¼˜åŠ¿åœ¨äºï¼š</p>
<ul>
<li><strong>ç¼–è¯‘æ—¶ä¼˜åŒ–</strong>ï¼šé€šè¿‡æ¨¡æ¿ç‰¹åŒ–æ¶ˆé™¤è¿è¡Œæ—¶å¼€é”€</li>
<li><strong>å±‚æ¬¡åŒ–è®¾è®¡</strong>ï¼šæ¸…æ™°çš„æŠ½è±¡å±‚æ¬¡ä¾¿äºç†è§£å’Œä¿®æ”¹</li>
<li><strong>ç¡¬ä»¶æ„ŸçŸ¥</strong>ï¼šé’ˆå¯¹ä¸åŒGPUæ¶æ„è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å®ç°</li>
<li><strong>å¯æ‰©å±•æ€§</strong>ï¼šæ˜“äºæ·»åŠ æ–°çš„æ•°æ®ç±»å‹ã€å¸ƒå±€å’Œæ“ä½œ</li>
</ul>
<h3 id="1012">10.1.2 æ ¸å¿ƒæŠ½è±¡æ¦‚å¿µ</h3>
<p>CUTLASSä½¿ç”¨ä¸‰ä¸ªå…³é”®çš„Tileæ¦‚å¿µæ¥ç»„ç»‡è®¡ç®—ï¼š</p>
<ol>
<li><strong>Thread Block Tile (CTA Tile)</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>M_cta Ã— N_cta Ã— K_cta
ä¾‹å¦‚ï¼š128 Ã— 128 Ã— 32
</code></pre></div>

<p>è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹å—è´Ÿè´£è®¡ç®—çš„è¾“å‡ºçŸ©é˜µåŒºåŸŸã€‚é€‰æ‹©åˆé€‚çš„CTA Tileå¤§å°å¯¹äºï¼š</p>
<ul>
<li>æœ€å¤§åŒ–æ•°æ®é‡ç”¨</li>
<li>å¹³è¡¡å…±äº«å†…å­˜ä½¿ç”¨</li>
<li>ä¼˜åŒ–å ç”¨ç‡</li>
</ul>
<ol start="2">
<li><strong>Warp Tile</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>M_warp Ã— N_warp Ã— K_warp  
ä¾‹å¦‚ï¼š32 Ã— 64 Ã— 32
</code></pre></div>

<p>ä¸€ä¸ªwarpè´Ÿè´£çš„è®¡ç®—åŒºåŸŸã€‚Warp Tileçš„è®¾è®¡è€ƒè™‘ï¼š</p>
<ul>
<li>Tensor Coreçš„ä½¿ç”¨ï¼ˆå¿…é¡»æ˜¯ç‰¹å®šå¤§å°ï¼‰</li>
<li>å¯„å­˜å™¨å‹åŠ›å¹³è¡¡</li>
<li>Warpé—´çš„è´Ÿè½½å‡è¡¡</li>
</ul>
<ol start="3">
<li><strong>Thread Tile</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>M_thread Ã— N_thread
ä¾‹å¦‚ï¼š8 Ã— 8
</code></pre></div>

<p>å•ä¸ªçº¿ç¨‹è´Ÿè´£çš„è¾“å‡ºå…ƒç´ ã€‚è¿™ç›´æ¥å½±å“ï¼š</p>
<ul>
<li>å¯„å­˜å™¨ä½¿ç”¨é‡</li>
<li>æŒ‡ä»¤çº§å¹¶è¡Œåº¦</li>
<li>å†…å­˜è®¿é—®æ¨¡å¼</li>
</ul>
<h3 id="1013">10.1.3 è½¯ä»¶æµæ°´çº¿è®¾è®¡</h3>
<p>CUTLASSå®ç°äº†ç²¾å·§çš„è½¯ä»¶æµæ°´çº¿æ¥éšè—å†…å­˜å»¶è¿Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code>Stage 0: Global â†’ Shared (ä¸‹ä¸€æ¬¡è¿­ä»£çš„æ•°æ®)
Stage 1: Shared â†’ Register (å½“å‰è¿­ä»£çš„æ•°æ®)  
Stage 2: Compute (ä¸Šä¸€æ¬¡è¿­ä»£çš„æ•°æ®)
Stage 3: Register â†’ Global (è®¡ç®—å®Œæˆçš„æ•°æ®)

æ—¶é—´è½´ï¼š
t0: Load(k)   | -         | -           | -
t1: Load(k+1) | Load(k)   | -           | -  
t2: Load(k+2) | Load(k+1) | Compute(k)  | -
t3: Load(k+3) | Load(k+2) | Compute(k+1)| Store(k)
</code></pre></div>

<p>è¿™ç§å¤šçº§æµæ°´çº¿è®¾è®¡èƒ½å¤Ÿï¼š</p>
<ul>
<li>å®Œå…¨éšè—å…¨å±€å†…å­˜è®¿é—®å»¶è¿Ÿ</li>
<li>æœ€å¤§åŒ–è®¡ç®—å•å…ƒåˆ©ç”¨ç‡</li>
<li>å‡å°‘åŒæ­¥å¼€é”€</li>
</ul>
<h3 id="1014">10.1.4 æ¨¡æ¿å…ƒç¼–ç¨‹æ¶æ„</h3>
<p>CUTLASSä½¿ç”¨å¤æ‚çš„æ¨¡æ¿ç³»ç»Ÿæ¥å®ç°ç¼–è¯‘æ—¶é…ç½®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementA</span><span class="p">,</span><span class="w">           </span><span class="c1">// æ•°æ®ç±»å‹A</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">LayoutA</span><span class="p">,</span><span class="w">            </span><span class="c1">// å†…å­˜å¸ƒå±€A</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementB</span><span class="p">,</span><span class="w">           </span><span class="c1">// æ•°æ®ç±»å‹B</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">LayoutB</span><span class="p">,</span><span class="w">            </span><span class="c1">// å†…å­˜å¸ƒå±€B</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementC</span><span class="p">,</span><span class="w">           </span><span class="c1">// æ•°æ®ç±»å‹C</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">LayoutC</span><span class="p">,</span><span class="w">            </span><span class="c1">// å†…å­˜å¸ƒå±€C</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementAccumulator</span><span class="p">,</span><span class="w"> </span><span class="c1">// ç´¯åŠ å™¨ç±»å‹</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">OperatorClass</span><span class="p">,</span><span class="w">      </span><span class="c1">// è®¡ç®—ç±»å‹(SIMT/TensorOp)</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ArchTag</span><span class="p">,</span><span class="w">            </span><span class="c1">// æ¶æ„æ ‡ç­¾</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ThreadblockShape</span><span class="p">,</span><span class="w">   </span><span class="c1">// CTA Tileå½¢çŠ¶</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">WarpShape</span><span class="p">,</span><span class="w">          </span><span class="c1">// Warp Tileå½¢çŠ¶</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">InstructionShape</span><span class="p">,</span><span class="w">   </span><span class="c1">// æŒ‡ä»¤å½¢çŠ¶</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">EpilogueOp</span><span class="p">,</span><span class="w">         </span><span class="c1">// Epilogueæ“ä½œ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">Stages</span><span class="w">                   </span><span class="c1">// æµæ°´çº¿çº§æ•°</span>
<span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GemmKernel</span><span class="p">;</span>
</code></pre></div>

<p>è¿™ç§è®¾è®¡å…è®¸åœ¨ç¼–è¯‘æ—¶ï¼š</p>
<ul>
<li>è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„å†…å­˜è®¿é—®æ¨¡å¼</li>
<li>ç”Ÿæˆç‰¹å®šç¡¬ä»¶çš„ä¼˜åŒ–ä»£ç </li>
<li>æ¶ˆé™¤åˆ†æ”¯å’Œé—´æ¥è°ƒç”¨å¼€é”€</li>
</ul>
<h2 id="102-gemm">10.2 è‡ªå®šä¹‰GEMMå†…æ ¸</h2>
<h3 id="1021-gemm">10.2.1 GEMMé—®é¢˜åˆ†è§£ç­–ç•¥</h3>
<p>é€šç”¨çŸ©é˜µä¹˜æ³•ï¼ˆGEMMï¼‰è®¡ç®—ï¼šC = Î±Â·AÂ·B + Î²Â·C</p>
<p>CUTLASSå°†è¿™ä¸ªé—®é¢˜åˆ†è§£ä¸ºå¤šä¸ªå±‚æ¬¡ï¼š</p>
<div class="codehilite"><pre><span></span><code>è®¾å¤‡çº§åˆ†è§£ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MÃ—NÃ—K æ€»é—®é¢˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
çº¿ç¨‹å—çº§åˆ†è§£ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚CTA_0 â”‚CTA_1 â”‚CTA_2 â”‚ ...  â”‚  æ¯ä¸ªCTAå¤„ç†M_ctaÃ—N_cta
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚CTA_4 â”‚CTA_5 â”‚CTA_6 â”‚ ...  â”‚  Kç»´åº¦ä¸Šå¾ªç¯ç´¯åŠ 
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
           â†“
Warpçº§åˆ†è§£ï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚W_0 â”‚W_1 â”‚W_2 â”‚W_3 â”‚  æ¯ä¸ªWarpå¤„ç†M_warpÃ—N_warp
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚W_4 â”‚W_5 â”‚W_6 â”‚W_7 â”‚  åä½œåŠ è½½å’Œè®¡ç®—
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1022">10.2.2 ä¸»å¾ªç¯æ ¸å¿ƒå®ç°</h3>
<p>GEMMçš„ä¸»å¾ªç¯æ˜¯æ€§èƒ½çš„å…³é”®ï¼ŒCUTLASSé‡‡ç”¨äº†é«˜åº¦ä¼˜åŒ–çš„å®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¼ªä»£ç å±•ç¤ºä¸»å¾ªç¯ç»“æ„</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Mma</span><span class="o">&gt;</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">gemm_mainloop</span><span class="p">(</span><span class="n">Params</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. åˆå§‹åŒ–ç´¯åŠ å™¨</span>
<span class="w">    </span><span class="n">FragmentC</span><span class="w"> </span><span class="n">accum</span><span class="p">;</span>
<span class="w">    </span><span class="n">accum</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 2. é¢„å–ç¬¬ä¸€æ‰¹æ•°æ®åˆ°å…±äº«å†…å­˜</span>
<span class="w">    </span><span class="n">SharedStorage</span><span class="w"> </span><span class="n">shared_storage</span><span class="p">;</span>
<span class="w">    </span><span class="n">global_to_shared_A</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">A</span><span class="p">);</span>
<span class="w">    </span><span class="n">global_to_shared_B</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">B</span><span class="p">);</span>
<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 3. ä¸»å¾ªç¯ - Kç»´åº¦è¿­ä»£</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">K_cta</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 3.1 ä»å…±äº«å†…å­˜åŠ è½½åˆ°å¯„å­˜å™¨</span>
<span class="w">        </span><span class="n">FragmentA</span><span class="w"> </span><span class="n">frag_A</span><span class="p">;</span>
<span class="w">        </span><span class="n">FragmentB</span><span class="w"> </span><span class="n">frag_B</span><span class="p">;</span>
<span class="w">        </span><span class="n">shared_to_register_A</span><span class="p">(</span><span class="n">shared_storage</span><span class="p">.</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">frag_A</span><span class="p">);</span>
<span class="w">        </span><span class="n">shared_to_register_B</span><span class="p">(</span><span class="n">shared_storage</span><span class="p">.</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">frag_B</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 3.2 é¢„å–ä¸‹ä¸€æ‰¹æ•°æ®ï¼ˆåŒç¼“å†²ï¼‰</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K_cta</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">global_to_shared_A</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K_cta</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">A_next</span><span class="p">);</span>
<span class="w">            </span><span class="n">global_to_shared_B</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">B</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K_cta</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">B_next</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3.3 æ‰§è¡ŒçŸ©é˜µä¹˜ç´¯åŠ </span>
<span class="w">        </span><span class="n">mma</span><span class="p">(</span><span class="n">frag_A</span><span class="p">,</span><span class="w"> </span><span class="n">frag_B</span><span class="p">,</span><span class="w"> </span><span class="n">accum</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 3.4 äº¤æ¢ç¼“å†²åŒº</span>
<span class="w">        </span><span class="n">swap</span><span class="p">(</span><span class="n">shared_storage</span><span class="p">.</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">A_next</span><span class="p">);</span>
<span class="w">        </span><span class="n">swap</span><span class="p">(</span><span class="n">shared_storage</span><span class="p">.</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">B_next</span><span class="p">);</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 4. å°†ç»“æœå†™å›</span>
<span class="w">    </span><span class="n">epilogue</span><span class="p">(</span><span class="n">accum</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">C</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>å…³é”®ä¼˜åŒ–ç‚¹ï¼š</p>
<ul>
<li><strong>åŒç¼“å†²</strong>ï¼šè®¡ç®—å½“å‰æ•°æ®çš„åŒæ—¶é¢„å–ä¸‹ä¸€æ‰¹æ•°æ®</li>
<li><strong>å¯„å­˜å™¨é˜»å¡</strong>ï¼šæœ€å¤§åŒ–å¯„å­˜å™¨é‡ç”¨ï¼Œå‡å°‘å…±äº«å†…å­˜è®¿é—®</li>
<li><strong>å‘é‡åŒ–è®¿å­˜</strong>ï¼šä½¿ç”¨float4ç­‰å‘é‡ç±»å‹æé«˜å¸¦å®½åˆ©ç”¨</li>
<li><strong>æœ€å°åŒ–åŒæ­¥</strong>ï¼šåªåœ¨å¿…è¦æ—¶ä½¿ç”¨__syncthreads()</li>
</ul>
<h3 id="1023">10.2.3 å…±äº«å†…å­˜ä¼˜åŒ–ç­–ç•¥</h3>
<p>å…±äº«å†…å­˜çš„é«˜æ•ˆä½¿ç”¨æ˜¯CUTLASSæ€§èƒ½çš„å…³é”®ï¼š</p>
<ol>
<li><strong>Bank Conflicté¿å…</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// Paddingç­–ç•¥ - æ·»åŠ é¢å¤–åˆ—é¿å…bank conflict</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kPadding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯¹äºfloatç±»å‹</span>
<span class="k">using</span><span class="w"> </span><span class="n">SmemLayoutA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">layout</span><span class="o">::</span><span class="n">RowMajorPadded</span><span class="o">&lt;</span><span class="n">kPadding</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Swizzlingç­–ç•¥ - é€šè¿‡ä½æ“ä½œé‡æ’è®¿é—®æ¨¡å¼</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">kSwizzle</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">SwizzledLayout</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">kColumns</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">kColumns</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// XOR swizzling</span>
<span class="w">        </span><span class="n">col</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">((</span><span class="n">row</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">kSwizzle</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kColumns</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<ol start="2">
<li><strong>æ•°æ®å¸ƒå±€ä¼˜åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>æ ‡å‡†å¸ƒå±€ï¼ˆå¯èƒ½æœ‰bank conflictï¼‰ï¼š
Thread 0: Bank 0, 4, 8,  12
Thread 1: Bank 0, 4, 8,  12  â† å†²çªï¼

ä¼˜åŒ–åå¸ƒå±€ï¼ˆæ— bank conflictï¼‰ï¼š
Thread 0: Bank 0, 4, 8,  12
Thread 1: Bank 1, 5, 9,  13  â† æ— å†²çª
</code></pre></div>

<h3 id="1024">10.2.4 å¯„å­˜å™¨çº§ä¼˜åŒ–</h3>
<p>CUTLASSåœ¨å¯„å­˜å™¨çº§åˆ«å®ç°äº†ç²¾ç»†çš„ä¼˜åŒ–ï¼š</p>
<ol>
<li><strong>å¯„å­˜å™¨å¤ç”¨æ¨¡å¼</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// å¤–ç§¯ç´¯åŠ æ¨¡å¼ - æœ€å¤§åŒ–æ•°æ®é‡ç”¨</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M_thread</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N_thread</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">c_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K_thread</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">c_reg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a_reg</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_reg</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">n</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">c</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_reg</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å‘é‡åŒ–è®¡ç®—</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨å‘é‡ç±»å‹å‡å°‘æŒ‡ä»¤æ•°</span>
<span class="n">float4</span><span class="w"> </span><span class="n">a_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">float4</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">float4</span><span class="w"> </span><span class="n">b_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">float4</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">b_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">float4</span><span class="w"> </span><span class="n">c_vec</span><span class="p">;</span>
<span class="n">c_vec</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_vec</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_vec</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="n">c_vec</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_vec</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_vec</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="n">c_vec</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_vec</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_vec</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="n">c_vec</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_vec</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_vec</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</code></pre></div>

<h2 id="103-epilogue">10.3 Epilogueèåˆä¼˜åŒ–</h2>
<h3 id="1031-epilogue">10.3.1 Epilogueçš„ä½œç”¨ä¸é‡è¦æ€§</h3>
<p>Epilogueæ˜¯GEMMè®¡ç®—çš„æœ€åé˜¶æ®µï¼Œè´Ÿè´£å°†ç´¯åŠ ç»“æœå†™å›å…¨å±€å†…å­˜ï¼ŒåŒæ—¶å¯ä»¥èåˆé¢å¤–çš„æ“ä½œã€‚åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œè¿™ç§èåˆèƒ½å¤Ÿæ˜¾è‘—æå‡æ€§èƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¼ ç»Ÿæ–¹å¼ï¼ˆå¤šä¸ªkernelï¼‰ï¼š
GEMM â†’ ReLU â†’ Bias Add â†’ Scale
  â†“      â†“       â†“         â†“
å†…å­˜   å†…å­˜    å†…å­˜      å†…å­˜

CUTLASSèåˆï¼ˆå•ä¸ªkernelï¼‰ï¼š
GEMM + ReLU + Bias + Scale â†’ å†…å­˜
                              â†“
                          ä¸€æ¬¡å†™å…¥
</code></pre></div>

<p>æ€§èƒ½æå‡æ¥æºï¼š</p>
<ul>
<li>å‡å°‘å†…å­˜å¸¦å®½éœ€æ±‚ï¼ˆé¿å…ä¸­é—´ç»“æœçš„è¯»å†™ï¼‰</li>
<li>æé«˜æ•°æ®å±€éƒ¨æ€§ï¼ˆæ•°æ®åœ¨å¯„å­˜å™¨ä¸­å®Œæˆæ‰€æœ‰æ“ä½œï¼‰</li>
<li>å‡å°‘kernelå¯åŠ¨å¼€é”€</li>
</ul>
<h3 id="1032-epilogue">10.3.2 å¸¸è§çš„Epilogueæ“ä½œ</h3>
<p>CUTLASSæ”¯æŒä¸°å¯Œçš„Epilogueæ“ä½œï¼Œé€‚ç”¨äºä¸åŒçš„AIåœºæ™¯ï¼š</p>
<ol>
<li><strong>çº¿æ€§ç»„åˆ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>C = Î±Â·(AÂ·B) + Î²Â·C
</code></pre></div>

<p>ç”¨äºï¼šæ®‹å·®è¿æ¥ã€åŠ¨é‡æ›´æ–°</p>
<ol start="2">
<li><strong>æ¿€æ´»å‡½æ•°</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>C = activation(AÂ·B + bias)
æ¿€æ´»å‡½æ•°ï¼šReLU, GeLU, Sigmoid, Tanh, SiLU
</code></pre></div>

<p>ç”¨äºï¼šç¥ç»ç½‘ç»œå±‚é—´æ¿€æ´»</p>
<ol start="3">
<li><strong>é‡åŒ–æ“ä½œ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>C_int8 = quantize(AÂ·B, scale, zero_point)
</code></pre></div>

<p>ç”¨äºï¼šINT8æ¨ç†åŠ é€Ÿ</p>
<ol start="4">
<li><strong>å½’ä¸€åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>C = LayerNorm(AÂ·B) æˆ– C = BatchNorm(AÂ·B)
</code></pre></div>

<p>ç”¨äºï¼šTransformeræ¨¡å‹ã€CNNç½‘ç»œ</p>
<h3 id="1033-epilogue">10.3.3 è‡ªå®šä¹‰Epilogueå®ç°</h3>
<p>CUTLASSå…è®¸ç”¨æˆ·å®šä¹‰è‡ªå·±çš„Epilogueæ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementOutput</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">CustomEpilogue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">FragmentOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">ElementOutput</span><span class="p">,</span><span class="w"> </span><span class="n">kCount</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Params</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ElementOutput</span><span class="w"> </span><span class="n">alpha</span><span class="p">;</span>
<span class="w">        </span><span class="n">ElementOutput</span><span class="w"> </span><span class="n">beta</span><span class="p">;</span>
<span class="w">        </span><span class="n">ElementOutput</span><span class="o">*</span><span class="w"> </span><span class="n">bias</span><span class="p">;</span>
<span class="w">        </span><span class="n">ElementOutput</span><span class="w"> </span><span class="n">clip_min</span><span class="p">;</span>
<span class="w">        </span><span class="n">ElementOutput</span><span class="w"> </span><span class="n">clip_max</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="n">FragmentOutput</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span>
<span class="w">        </span><span class="n">FragmentOutput</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">accum</span><span class="p">,</span>
<span class="w">        </span><span class="n">FragmentOutput</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span>
<span class="w">        </span><span class="n">Params</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">FragmentOutput</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>

<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kCount</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 1. çº¿æ€§ç»„åˆ</span>
<span class="w">            </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">alpha</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">accum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                       </span><span class="n">params</span><span class="p">.</span><span class="n">beta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">            </span><span class="c1">// 2. æ·»åŠ åç½®</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">bias</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 3. è£å‰ªï¼ˆç”¨äºReLU6ç­‰ï¼‰</span>
<span class="w">            </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">clip_max</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="n">max</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">clip_min</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1034">10.3.4 æ€§èƒ½å½±å“åˆ†æ</h3>
<p>Epilogueèåˆå¯¹æ€§èƒ½çš„å½±å“éœ€è¦ä»”ç»†æƒè¡¡ï¼š</p>
<p><strong>æ­£é¢å½±å“ï¼š</strong></p>
<ul>
<li>å†…å­˜å¸¦å®½èŠ‚çœï¼šå¯è¾¾50%ä»¥ä¸Šï¼ˆé¿å…ä¸­é—´ç»“æœå­˜å‚¨ï¼‰</li>
<li>ç¼“å­˜åˆ©ç”¨ç‡æå‡ï¼šæ•°æ®åœ¨å¯„å­˜å™¨/L1ç¼“å­˜ä¸­å®Œæˆå¤„ç†</li>
<li>å‡å°‘åŒæ­¥å¼€é”€ï¼šå•kernelæ‰§è¡Œé¿å…å¤šæ¬¡åŒæ­¥</li>
</ul>
<p><strong>æ½œåœ¨è´Ÿé¢å½±å“ï¼š</strong></p>
<ul>
<li>å¯„å­˜å™¨å‹åŠ›å¢åŠ ï¼šå¤æ‚Epilogueå¯èƒ½é™ä½å ç”¨ç‡</li>
<li>ç¼–è¯‘æ—¶é—´å¢é•¿ï¼šæ¨¡æ¿å®ä¾‹åŒ–å¼€é”€</li>
<li>ä»£ç å¤æ‚åº¦ï¼šè°ƒè¯•å’Œç»´æŠ¤éš¾åº¦å¢åŠ </li>
</ul>
<p><strong>æ€§èƒ½å»ºæ¨¡ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>æ€»æ—¶é—´ = max(è®¡ç®—æ—¶é—´, å†…å­˜æ—¶é—´)

æœªèåˆï¼š
T_unfused = T_gemm + T_mem_write + T_epilogue + T_mem_read + T_mem_write
         = T_gemm + 3Ã—T_mem

èåˆåï¼š
T_fused = max(T_gemm, T_mem_write + Îµ)
        â‰ˆ T_gemm (å½“è®¡ç®—å¯†é›†æ—¶)

åŠ é€Ÿæ¯” = T_unfused / T_fused â‰ˆ 1 + 3Ã—T_mem/T_gemm
</code></pre></div>

<h2 id="104">10.4 å¸ƒå±€è½¬æ¢ä¸æ•°æ®ç§»åŠ¨</h2>
<h3 id="1041">10.4.1 å†…å­˜å¸ƒå±€ç±»å‹è¯¦è§£</h3>
<p>CUTLASSæ”¯æŒå¤šç§å†…å­˜å¸ƒå±€ï¼Œæ¯ç§å¸ƒå±€å¯¹æ€§èƒ½æœ‰ä¸åŒå½±å“ï¼š</p>
<ol>
<li><strong>åŸºç¡€å¸ƒå±€ç±»å‹</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">Row</span><span class="w"> </span><span class="n">Major</span><span class="w"> </span><span class="p">(</span><span class="n">è¡Œä¸»åº</span><span class="p">)</span><span class="err">ï¼š</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">A00</span><span class="w"> </span><span class="n">A01</span><span class="w"> </span><span class="n">A02</span><span class="w"> </span><span class="n">A03</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">å†…å­˜è¿ç»­</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">A10</span><span class="w"> </span><span class="n">A11</span><span class="w"> </span><span class="n">A12</span><span class="w"> </span><span class="n">A13</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">A20</span><span class="w"> </span><span class="n">A21</span><span class="w"> </span><span class="n">A22</span><span class="w"> </span><span class="n">A23</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="n">è®¿é—®æ¨¡å¼</span><span class="err">ï¼š</span><span class="n">A</span><span class="o">[</span><span class="n">row</span><span class="o">][</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">[</span><span class="n">row * N + col</span><span class="o">]</span>

<span class="k">Column</span><span class="w"> </span><span class="n">Major</span><span class="w"> </span><span class="p">(</span><span class="n">åˆ—ä¸»åº</span><span class="p">)</span><span class="err">ï¼š</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">A00</span><span class="w"> </span><span class="n">A10</span><span class="w"> </span><span class="n">A20</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â†“</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">A01</span><span class="w"> </span><span class="n">A11</span><span class="w"> </span><span class="n">A21</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">å†…</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">A02</span><span class="w"> </span><span class="n">A12</span><span class="w"> </span><span class="n">A22</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">å­˜</span>
<span class="err">â”‚</span><span class="w"> </span><span class="n">A03</span><span class="w"> </span><span class="n">A13</span><span class="w"> </span><span class="n">A23</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">è¿ç»­</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="n">è®¿é—®æ¨¡å¼</span><span class="err">ï¼š</span><span class="n">A</span><span class="o">[</span><span class="n">row</span><span class="o">][</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">[</span><span class="n">col * M + row</span><span class="o">]</span>
</code></pre></div>

<ol start="2">
<li><strong>ç‰¹æ®Šå¸ƒå±€ä¼˜åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// Interleavedå¸ƒå±€ - é€‚åˆå‘é‡åŒ–è®¿é—®</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">kInterleave</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">InterleavedLayout</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ•°æ®æŒ‰kInterleaveä¸ªå…ƒç´ äº¤é”™å­˜å‚¨</span>
<span class="w">    </span><span class="c1">// ä¾‹å¦‚ kInterleave=4ï¼š</span>
<span class="w">    </span><span class="c1">// [A00 A01 A02 A03] [A10 A11 A12 A13] ...</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">kInterleave</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">kInterleave</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kInterleave</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">elem</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Tensor Coreä¼˜åŒ–å¸ƒå±€</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TensorOpMultiplicandLayout</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä¸“ä¸ºTensor Coreè®¾è®¡çš„æ•°æ®å¸ƒå±€</span>
<span class="w">    </span><span class="c1">// 16x16çš„tileä»¥ç‰¹å®šæ¨¡å¼å­˜å‚¨</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kCrosswise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kTileSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">kTileSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kTileSize</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">within_tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="n">kTileSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kTileSize</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Swizzle pattern for optimal tensor core access</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">swizzle_pattern</span><span class="p">[</span><span class="n">within_tile</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1042">10.4.2 é«˜æ•ˆè½¬ç½®ç®—æ³•</h3>
<p>çŸ©é˜µè½¬ç½®æ˜¯è®¸å¤šAIç®—æ³•çš„åŸºç¡€æ“ä½œï¼ŒCUTLASSå®ç°äº†é«˜åº¦ä¼˜åŒ–çš„è½¬ç½®ï¼š</p>
<ol>
<li><strong>å…±äº«å†…å­˜è½¬ç½®ï¼ˆé¿å…Bank Conflictï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">BLOCK_ROWS</span><span class="o">&gt;</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">transpose_shared_optimized</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="c1">// +1 padding</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åä½œåŠ è½½åˆ°å…±äº«å†…å­˜ï¼ˆåˆå¹¶è®¿é—®ï¼‰</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_ROWS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tile</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                </span><span class="n">input</span><span class="p">[(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è½¬ç½®åçš„åæ ‡</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ä»å…±äº«å†…å­˜å†™å‡ºï¼ˆåˆå¹¶è®¿é—®ï¼‰</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_ROWS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">output</span><span class="p">[(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                </span><span class="n">tile</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å¯„å­˜å™¨çº§è½¬ç½®ï¼ˆå°çŸ©é˜µï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 4x4çŸ©é˜µå¯„å­˜å™¨çº§è½¬ç½®</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">transpose_4x4_register</span><span class="p">(</span><span class="n">float4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">row0</span><span class="p">,</span><span class="w"> </span><span class="n">float4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">row1</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                       </span><span class="n">float4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">row2</span><span class="p">,</span><span class="w"> </span><span class="n">float4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">row3</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨shuffleæŒ‡ä»¤è¿›è¡Œè½¬ç½®</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row0</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row0</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">b0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row1</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">b3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row1</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row2</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row2</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row2</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row2</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">d0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row3</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row3</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row3</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">d3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row3</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>

<span class="w">    </span><span class="n">row0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_float4</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">b0</span><span class="p">,</span><span class="w"> </span><span class="n">c0</span><span class="p">,</span><span class="w"> </span><span class="n">d0</span><span class="p">);</span>
<span class="w">    </span><span class="n">row1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_float4</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">d1</span><span class="p">);</span>
<span class="w">    </span><span class="n">row2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_float4</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">b2</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">d2</span><span class="p">);</span>
<span class="w">    </span><span class="n">row3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_float4</span><span class="p">(</span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">b3</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="p">,</span><span class="w"> </span><span class="n">d3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1043-swizzling">10.4.3 SwizzlingæŠ€æœ¯æ·±å…¥</h3>
<p>Swizzlingæ˜¯ä¸€ç§é‡æ’æ•°æ®è®¿é—®æ¨¡å¼çš„æŠ€æœ¯ï¼Œç”¨äºé¿å…bank conflictï¼š</p>
<ol>
<li><strong>XOR Swizzling</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">kSwizzleBits</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">XorSwizzle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨XORæ“ä½œæ‰“ä¹±è®¿é—®æ¨¡å¼</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">((</span><span class="n">col</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kSwizzleBits</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// åº”ç”¨ç¤ºä¾‹</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">load_with_swizzle</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">smem</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">gmem</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">swizzled_row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XorSwizzle</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;::</span><span class="n">apply</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">);</span>
<span class="w">    </span><span class="n">smem</span><span class="p">[</span><span class="n">swizzled_row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">        </span><span class="n">gmem</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>Permutation Swizzling</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸºäºæ’åˆ—çš„swizzling</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">kPermutation</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">PermutationSwizzle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">warp_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lane_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">new_lane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kPermutation</span><span class="p">[</span><span class="n">lane_id</span><span class="p">];</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">warp_id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new_lane</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1044">10.4.4 é¢„å–ç­–ç•¥ä¸åŒç¼“å†²</h3>
<p>CUTLASSä½¿ç”¨ç²¾å¿ƒè®¾è®¡çš„é¢„å–ç­–ç•¥æ¥éšè—å†…å­˜å»¶è¿Ÿï¼š</p>
<ol>
<li><strong>è½¯ä»¶é¢„å–å®ç°</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">kStages</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PipelinedGemm</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// kStagesçº§æµæ°´çº¿ç¼“å†²</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">smem_A</span><span class="p">[</span><span class="n">kStages</span><span class="p">][</span><span class="n">TILE_M</span><span class="p">][</span><span class="n">TILE_K</span><span class="p">];</span>
<span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">smem_B</span><span class="p">[</span><span class="n">kStages</span><span class="p">][</span><span class="n">TILE_K</span><span class="p">][</span><span class="n">TILE_N</span><span class="p">];</span>

<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mainloop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆå§‹åŒ–ï¼šå¡«å……æ‰€æœ‰æµæ°´çº¿çº§</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kStages</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">load_tile_A</span><span class="p">(</span><span class="n">smem_A</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">            </span><span class="n">load_tile_B</span><span class="p">(</span><span class="n">smem_B</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ä¸»å¾ªç¯</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">write_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kStages</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">read_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K_total</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">TILE_K</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å¼‚æ­¥åŠ è½½ä¸‹ä¸€æ‰¹æ•°æ®</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">kStages</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_K</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K_total</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">load_tile_A_async</span><span class="p">(</span><span class="n">smem_A</span><span class="p">[</span><span class="n">write_stage</span><span class="p">],</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">kStages</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_K</span><span class="p">);</span>
<span class="w">                </span><span class="n">load_tile_B_async</span><span class="p">(</span><span class="n">smem_B</span><span class="p">[</span><span class="n">write_stage</span><span class="p">],</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">kStages</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_K</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// è®¡ç®—å½“å‰æ•°æ®</span>
<span class="w">            </span><span class="n">compute_tile</span><span class="p">(</span><span class="n">smem_A</span><span class="p">[</span><span class="n">read_stage</span><span class="p">],</span><span class="w"> </span>
<span class="w">                        </span><span class="n">smem_B</span><span class="p">[</span><span class="n">read_stage</span><span class="p">]);</span>

<span class="w">            </span><span class="c1">// å¾ªç¯ç¼“å†²åŒºç´¢å¼•</span>
<span class="w">            </span><span class="n">write_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">write_stage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">kStages</span><span class="p">;</span>
<span class="w">            </span><span class="n">read_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_stage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">kStages</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// ç¡®ä¿å¼‚æ­¥åŠ è½½å®Œæˆ</span>
<span class="w">            </span><span class="n">__syncthreads</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<ol start="2">
<li><strong>ä½¿ç”¨cuda::memcpy_asyncï¼ˆSM80+ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// åˆ©ç”¨ç¡¬ä»¶å¼‚æ­¥æ‹·è´å¼•æ“</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">load_async_optimized</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">smem</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">gmem</span><span class="p">,</span>
<span class="w">                                     </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// åˆ›å»ºå¼‚æ­¥æ‹·è´ç»„</span>
<span class="w">    </span><span class="n">cuda</span><span class="o">::</span><span class="n">pipeline</span><span class="o">&lt;</span><span class="n">cuda</span><span class="o">::</span><span class="n">thread_scope_thread</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">        </span><span class="n">cuda</span><span class="o">::</span><span class="n">make_pipeline</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// å‘èµ·å¼‚æ­¥æ‹·è´</span>
<span class="w">    </span><span class="n">cuda</span><span class="o">::</span><span class="n">memcpy_async</span><span class="p">(</span><span class="n">smem</span><span class="p">,</span><span class="w"> </span><span class="n">gmem</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">pipe</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åœ¨éœ€è¦æ•°æ®å‰ç­‰å¾…å®Œæˆ</span>
<span class="w">    </span><span class="n">pipe</span><span class="p">.</span><span class="n">consumer_wait</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="105">10.5 æ¡ˆä¾‹ï¼šå®šåˆ¶åŒ–çš„å·ç§¯ç®—å­å®ç°</h2>
<h3 id="1051-im2col-vs-implicit-gemm">10.5.1 å·ç§¯ç®—æ³•é€‰æ‹©ï¼šIm2Col vs Implicit GEMM</h3>
<p>åœ¨è‡ªåŠ¨é©¾é©¶çš„è§†è§‰æ„ŸçŸ¥ä¸­ï¼Œå·ç§¯æ˜¯æœ€æ ¸å¿ƒçš„æ“ä½œã€‚CUTLASSæä¾›äº†ä¸¤ç§ä¸»è¦å®ç°ç­–ç•¥ï¼š</p>
<ol>
<li><strong>Im2Col + GEMM</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>åŸå§‹å·ç§¯ï¼š
Input: [N, C, H, W]
Filter: [K, C, R, S]
Output: [N, K, P, Q]

Im2Colè½¬æ¢ï¼š
Input â†’ Matrix A: [N*P*Q, C*R*S]
Filter â†’ Matrix B: [K, C*R*S]^T
GEMM: C = A Ã— B â†’ [N*P*Q, K]
Reshape: [N, K, P, Q]
</code></pre></div>

<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å®ç°ç®€å•ï¼Œå¯å¤ç”¨é«˜æ•ˆçš„GEMMå†…æ ¸</li>
<li>å¯¹å„ç§å·ç§¯å‚æ•°éƒ½æœ‰è¾ƒå¥½çš„æ€§èƒ½</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>é¢å¤–çš„å†…å­˜å¼€é”€ï¼ˆIm2Colå±•å¼€ï¼‰</li>
<li>æ•°æ®é‡å¤å­˜å‚¨</li>
</ul>
<ol start="2">
<li><strong>Implicit GEMMï¼ˆç›´æ¥å·ç§¯ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// Implicit GEMMé¿å…äº†æ˜¾å¼çš„Im2Colè½¬æ¢</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Conv2dProblemSize</span><span class="o">&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ImplicitGemmConvolution</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span>
<span class="w">        </span><span class="n">Conv2dProblemSize</span><span class="w"> </span><span class="n">problem</span><span class="p">,</span>
<span class="w">        </span><span class="n">TensorRef</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">        </span><span class="n">TensorRef</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span>
<span class="w">        </span><span class="n">TensorRef</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç›´æ¥ä»è¾“å…¥å¼ é‡è®¡ç®—GEMMç´¢å¼•</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">gemm_coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadblock_tile_offset</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// æ˜ å°„åˆ°å·ç§¯åæ ‡</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">conv_coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">implicit_gemm_coord_to_conv_coord</span><span class="p">(</span>
<span class="w">            </span><span class="n">gemm_coord</span><span class="p">,</span><span class="w"> </span><span class="n">problem</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ‰§è¡Œè®¡ç®—ï¼ŒåŠ¨æ€è®¡ç®—è¾“å…¥ä½ç½®</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">filter_height</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">filter_width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">input_coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_input_coord</span><span class="p">(</span>
<span class="w">                    </span><span class="n">conv_coord</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">problem</span><span class="p">.</span><span class="n">stride</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_valid_coord</span><span class="p">(</span><span class="n">input_coord</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">accumulator</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">input_coord</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">filter</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">s</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ— é¢å¤–å†…å­˜å¼€é”€</li>
<li>æ›´å¥½çš„ç¼“å­˜åˆ©ç”¨ç‡</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å®ç°å¤æ‚åº¦é«˜</li>
<li>éœ€è¦å¤„ç†è¾¹ç•Œæ¡ä»¶</li>
</ul>
<h3 id="1052">10.5.2 é«˜æ€§èƒ½å·ç§¯å®ç°</h3>
<p>ä»¥ä¸‹æ˜¯ä½¿ç”¨CUTLASSå®ç°çš„ä¼˜åŒ–å·ç§¯ç®—å­ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementA</span><span class="p">,</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementB</span><span class="p">,</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ElementC</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ThreadblockM</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ThreadblockN</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ThreadblockK</span>
<span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OptimizedConv2d</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">Conv2dProblemSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cutlass</span><span class="o">::</span><span class="n">conv</span><span class="o">::</span><span class="n">Conv2dProblemSize</span><span class="p">;</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">TensorRefA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cutlass</span><span class="o">::</span><span class="n">TensorRef</span><span class="o">&lt;</span><span class="n">ElementA</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">TensorRefB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cutlass</span><span class="o">::</span><span class="n">TensorRef</span><span class="o">&lt;</span><span class="n">ElementB</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">TensorRefC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cutlass</span><span class="o">::</span><span class="n">TensorRef</span><span class="o">&lt;</span><span class="n">ElementC</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Arguments</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Conv2dProblemSize</span><span class="w"> </span><span class="n">problem_size</span><span class="p">;</span>
<span class="w">        </span><span class="n">TensorRefA</span><span class="w"> </span><span class="n">ref_A</span><span class="p">;</span><span class="w">  </span><span class="c1">// Input tensor</span>
<span class="w">        </span><span class="n">TensorRefB</span><span class="w"> </span><span class="n">ref_B</span><span class="p">;</span><span class="w">  </span><span class="c1">// Filter tensor</span>
<span class="w">        </span><span class="n">TensorRefC</span><span class="w"> </span><span class="n">ref_C</span><span class="p">;</span><span class="w">  </span><span class="c1">// Output tensor</span>
<span class="w">        </span><span class="n">ElementC</span><span class="w"> </span><span class="n">alpha</span><span class="p">;</span>
<span class="w">        </span><span class="n">ElementC</span><span class="w"> </span><span class="n">beta</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">Arguments</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. è®¡ç®—çº¿ç¨‹å—çš„è¾“å‡ºtileä½ç½®</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">threadblock_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_threadblock_offset</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 2. åˆå§‹åŒ–å…±äº«å†…å­˜å’Œå¯„å­˜å™¨</span>
<span class="w">        </span><span class="n">__shared__</span><span class="w"> </span><span class="n">SharedStorage</span><span class="w"> </span><span class="n">shared_storage</span><span class="p">;</span>
<span class="w">        </span><span class="n">Fragment</span><span class="w"> </span><span class="n">accumulator</span><span class="p">;</span>
<span class="w">        </span><span class="n">accumulator</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 3. ä¸»å¾ªç¯ - éå†è¾“å…¥é€šé“ç»´åº¦</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">problem_size</span><span class="p">.</span><span class="n">C</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ThreadblockK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 3.1 åä½œåŠ è½½è¾“å…¥tileåˆ°å…±äº«å†…å­˜</span>
<span class="w">            </span><span class="n">load_input_tile</span><span class="p">(</span><span class="n">shared_storage</span><span class="p">.</span><span class="n">input_tile</span><span class="p">,</span>
<span class="w">                          </span><span class="n">args</span><span class="p">.</span><span class="n">ref_A</span><span class="p">,</span>
<span class="w">                          </span><span class="n">threadblock_offset</span><span class="p">,</span>
<span class="w">                          </span><span class="n">k</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 3.2 åä½œåŠ è½½filter tileåˆ°å…±äº«å†…å­˜</span>
<span class="w">            </span><span class="n">load_filter_tile</span><span class="p">(</span><span class="n">shared_storage</span><span class="p">.</span><span class="n">filter_tile</span><span class="p">,</span>
<span class="w">                           </span><span class="n">args</span><span class="p">.</span><span class="n">ref_B</span><span class="p">,</span>
<span class="w">                           </span><span class="n">k</span><span class="p">);</span>

<span class="w">            </span><span class="n">__syncthreads</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// 3.3 æ‰§è¡Œtileçº§åˆ«çš„å·ç§¯è®¡ç®—</span>
<span class="w">            </span><span class="n">compute_tile_convolution</span><span class="p">(</span>
<span class="w">                </span><span class="n">accumulator</span><span class="p">,</span>
<span class="w">                </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">input_tile</span><span class="p">,</span>
<span class="w">                </span><span class="n">shared_storage</span><span class="p">.</span><span class="n">filter_tile</span><span class="p">);</span>

<span class="w">            </span><span class="n">__syncthreads</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 4. Epilogue - å†™å›ç»“æœ</span>
<span class="w">        </span><span class="n">epilogue</span><span class="p">(</span><span class="n">accumulator</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="n">args</span><span class="p">.</span><span class="n">ref_C</span><span class="p">,</span>
<span class="w">                </span><span class="n">threadblock_offset</span><span class="p">,</span>
<span class="w">                </span><span class="n">args</span><span class="p">.</span><span class="n">alpha</span><span class="p">,</span>
<span class="w">                </span><span class="n">args</span><span class="p">.</span><span class="n">beta</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// ä¼˜åŒ–çš„è¾“å…¥æ•°æ®åŠ è½½</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">load_input_tile</span><span class="p">(</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">smem</span><span class="p">,</span>
<span class="w">        </span><span class="n">TensorRefA</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">        </span><span class="n">int2</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">channel_offset</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨å‘é‡åŒ–loadæé«˜å¸¦å®½åˆ©ç”¨</span>
<span class="w">        </span><span class="n">float4</span><span class="o">*</span><span class="w"> </span><span class="n">smem_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">smem</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è®¡ç®—æ¯ä¸ªçº¿ç¨‹è´Ÿè´£çš„æ•°æ®</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">linear_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// æ˜ å°„åˆ°è¾“å…¥å¼ é‡åæ ‡</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linear_to_tensor_coord</span><span class="p">(</span>
<span class="w">                </span><span class="n">linear_idx</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">channel_offset</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// è¾¹ç•Œæ£€æŸ¥å’Œpaddingå¤„ç†</span>
<span class="w">            </span><span class="n">float4</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_float4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_valid_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">float4</span><span class="o">*&gt;</span><span class="p">(</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">input</span><span class="p">[</span><span class="n">coord</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">smem_ptr</span><span class="p">[</span><span class="n">linear_idx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Warpçº§åˆ«çš„å·ç§¯è®¡ç®—</span>
<span class="w">    </span><span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">compute_tile_convolution</span><span class="p">(</span>
<span class="w">        </span><span class="n">Fragment</span><span class="o">&amp;</span><span class="w"> </span><span class="n">accumulator</span><span class="p">,</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input_tile</span><span class="p">,</span>
<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">filter_tile</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨Tensor Coreï¼ˆå¦‚æœå¯ç”¨ï¼‰</span>
<span class="w">        </span><span class="cp">#if __CUDA_ARCH__ &gt;= 700</span>
<span class="w">            </span><span class="n">wmma</span><span class="o">::</span><span class="n">fragment</span><span class="o">&lt;</span><span class="n">wmma</span><span class="o">::</span><span class="n">matrix_a</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="n">half</span><span class="p">,</span><span class="w"> </span><span class="n">wmma</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">a_frag</span><span class="p">;</span>
<span class="w">            </span><span class="n">wmma</span><span class="o">::</span><span class="n">fragment</span><span class="o">&lt;</span><span class="n">wmma</span><span class="o">::</span><span class="n">matrix_b</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="n">half</span><span class="p">,</span><span class="w"> </span><span class="n">wmma</span><span class="o">::</span><span class="n">col_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">b_frag</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// åŠ è½½æ•°æ®åˆ°tensor core fragment</span>
<span class="w">            </span><span class="n">wmma</span><span class="o">::</span><span class="n">load_matrix_sync</span><span class="p">(</span><span class="n">a_frag</span><span class="p">,</span><span class="w"> </span><span class="n">input_tile</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">            </span><span class="n">wmma</span><span class="o">::</span><span class="n">load_matrix_sync</span><span class="p">(</span><span class="n">b_frag</span><span class="p">,</span><span class="w"> </span><span class="n">filter_tile</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// æ‰§è¡ŒçŸ©é˜µä¹˜ç´¯åŠ </span>
<span class="w">            </span><span class="n">wmma</span><span class="o">::</span><span class="n">mma_sync</span><span class="p">(</span><span class="n">accumulator</span><span class="p">,</span><span class="w"> </span><span class="n">a_frag</span><span class="p">,</span><span class="w"> </span><span class="n">b_frag</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="n">accumulator</span><span class="p">);</span>
<span class="w">        </span><span class="cp">#else</span>
<span class="w">            </span><span class="c1">// å›é€€åˆ°SIMTå®ç°</span>
<span class="w">            </span><span class="n">compute_simt_convolution</span><span class="p">(</span><span class="n">accumulator</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                    </span><span class="n">input_tile</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                    </span><span class="n">filter_tile</span><span class="p">);</span>
<span class="w">        </span><span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1053">10.5.3 ç‰¹æ®Šå·ç§¯ä¼˜åŒ–æŠ€å·§</h3>
<ol>
<li><strong>Depthwise Convolutionä¼˜åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ·±åº¦å¯åˆ†ç¦»å·ç§¯ - æ¯ä¸ªé€šé“ç‹¬ç«‹è®¡ç®—</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">CHANNELS_PER_THREAD</span><span class="o">&gt;</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">depthwise_conv_optimized</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">channels</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">channel_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CHANNELS_PER_THREAD</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªé€šé“ï¼Œæé«˜æŒ‡ä»¤çº§å¹¶è¡Œ</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CHANNELS_PER_THREAD</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">channels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// å°kernelç›´æ¥å±•å¼€</span>
<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ky</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ky</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cp">#pragma unroll</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">kx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">kx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">kx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">input</span><span class="p">[...]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filter</span><span class="p">[</span><span class="n">channel</span><span class="p">][</span><span class="n">ky</span><span class="p">][</span><span class="n">kx</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">output</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>Winogradå·ç§¯ä¼˜åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// Winograd F(2,3) - å‡å°‘ä¹˜æ³•æ¬¡æ•°</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">winograd_f2x3_transform</span><span class="p">(</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">transformed</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// è¾“å…¥å˜æ¢çŸ©é˜µ B^T</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">BT</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// B^T Ã— input Ã— B</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// è¡Œå˜æ¢</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">BT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">BT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">BT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ—å˜æ¢</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">transformed</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BT</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                               </span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BT</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                               </span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BT</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                               </span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BT</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>CUTLASSä½œä¸ºé«˜æ€§èƒ½GPUè®¡ç®—çš„åŸºç¡€è®¾æ–½ï¼Œå±•ç¤ºäº†å¦‚ä½•é€šè¿‡ç²¾å·§çš„è½¯ä»¶è®¾è®¡å……åˆ†å‘æŒ¥ç¡¬ä»¶æ½œåŠ›ã€‚æœ¬ç« çš„æ ¸å¿ƒè¦ç‚¹åŒ…æ‹¬ï¼š</p>
<p><strong>æ¶æ„è®¾è®¡ç²¾é«“ï¼š</strong></p>
<ul>
<li><strong>å±‚æ¬¡åŒ–æŠ½è±¡</strong>ï¼šThread Block Tile â†’ Warp Tile â†’ Thread Tileçš„ä¸‰çº§åˆ†è§£ç­–ç•¥ï¼Œæ¯ä¸€çº§éƒ½é’ˆå¯¹ç‰¹å®šç¡¬ä»¶ç‰¹æ€§ä¼˜åŒ–</li>
<li><strong>ç¼–è¯‘æ—¶ä¼˜åŒ–</strong>ï¼šé€šè¿‡C++æ¨¡æ¿å…ƒç¼–ç¨‹ï¼Œåœ¨ç¼–è¯‘æœŸç¡®å®šæ‰€æœ‰å‚æ•°ï¼Œæ¶ˆé™¤è¿è¡Œæ—¶å¼€é”€</li>
<li><strong>è½¯ä»¶æµæ°´çº¿</strong>ï¼šå¤šçº§æµæ°´çº¿è®¾è®¡å®Œå…¨éšè—å†…å­˜å»¶è¿Ÿï¼Œå®ç°è®¡ç®—ä¸æ•°æ®ä¼ è¾“çš„å®Œç¾é‡å </li>
</ul>
<p><strong>æ€§èƒ½ä¼˜åŒ–å…³é”®æŠ€æœ¯ï¼š</strong></p>
<ul>
<li><strong>å†…å­˜è®¿é—®ä¼˜åŒ–</strong>ï¼šBank conflicté¿å…ï¼ˆpaddingã€swizzlingï¼‰ã€å‘é‡åŒ–è®¿å­˜ã€å¼‚æ­¥æ‹·è´</li>
<li><strong>å¯„å­˜å™¨ä¼˜åŒ–</strong>ï¼šæœ€å¤§åŒ–æ•°æ®é‡ç”¨ã€å¤–ç§¯ç´¯åŠ æ¨¡å¼ã€å¯„å­˜å™¨é˜»å¡</li>
<li><strong>Epilogueèåˆ</strong>ï¼šå‡å°‘å†…å­˜å¸¦å®½éœ€æ±‚50%ä»¥ä¸Šï¼Œä¸€æ¬¡kernelå®Œæˆå¤šä¸ªæ“ä½œ</li>
</ul>
<p><strong>å®è·µåº”ç”¨è¦ç‚¹ï¼š</strong></p>
<ul>
<li><strong>GEMMä¼˜åŒ–</strong>ï¼šåŒç¼“å†²æŠ€æœ¯ã€å…±äº«å†…å­˜ä¼˜åŒ–ã€Tensor Coreåˆ©ç”¨</li>
<li><strong>å·ç§¯å®ç°</strong>ï¼šIm2Col vs Implicit GEMMçš„æƒè¡¡ã€Winograd/FFTç­‰ç®—æ³•é€‰æ‹©</li>
<li><strong>ç‰¹æ®Šä¼˜åŒ–</strong>ï¼šDepthwiseå·ç§¯ã€INT8é‡åŒ–ã€æ··åˆç²¾åº¦è®¡ç®—</li>
</ul>
<p><strong>æ€§èƒ½æŒ‡æ ‡å‚è€ƒï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>ä¼˜åŒ–çº§åˆ«        ç›¸å¯¹æ€§èƒ½    é€‚ç”¨åœºæ™¯
åŸºç¡€å®ç°        1.0x       åŸå‹éªŒè¯
å…±äº«å†…å­˜ä¼˜åŒ–    3-5x       ä¸­ç­‰è§„æ¨¡çŸ©é˜µ
å¯„å­˜å™¨ä¼˜åŒ–      5-10x      è®¡ç®—å¯†é›†åœºæ™¯
Tensor Core     10-20x     FP16/INT8æ¨ç†
å®Œæ•´CUTLASS     15-30x     ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
</code></pre></div>

<p>é€šè¿‡æŒæ¡CUTLASSçš„è®¾è®¡ç†å¿µå’Œä¼˜åŒ–æŠ€æœ¯ï¼Œä½ ä¸ä»…èƒ½å¤Ÿä½¿ç”¨ç°æˆçš„é«˜æ€§èƒ½ç®—å­ï¼Œæ›´é‡è¦çš„æ˜¯ç†è§£äº†GPUä¼˜åŒ–çš„æœ¬è´¨ï¼Œèƒ½å¤Ÿæ ¹æ®å…·ä½“éœ€æ±‚å®šåˆ¶åŒ–å¼€å‘ã€‚è¿™å¯¹äºè‡ªåŠ¨é©¾é©¶å’Œå…·èº«æ™ºèƒ½ä¸­çš„å®æ—¶è®¡ç®—éœ€æ±‚è‡³å…³é‡è¦ã€‚</p>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹ 10.1ï¼šTileå¤§å°é€‰æ‹©</strong>
ç»™å®šä¸€ä¸ªGEMMé—®é¢˜ï¼šM=4096, N=4096, K=1024ï¼ŒGPUæœ‰80ä¸ªSMï¼Œæ¯ä¸ªSMæœ‰65536ä¸ª32ä½å¯„å­˜å™¨ï¼Œ48KBå…±äº«å†…å­˜ã€‚è¯·è®¾è®¡åˆé€‚çš„Thread Block Tileã€Warp Tileå’ŒThread Tileå¤§å°ã€‚</p>
<p><em>Hint: è€ƒè™‘å ç”¨ç‡ã€æ•°æ®é‡ç”¨å’Œç¡¬ä»¶é™åˆ¶çš„å¹³è¡¡</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å»ºè®®é…ç½®ï¼š</p>
<ul>
<li>Thread Block Tile: 128Ã—128Ã—32</li>
<li>Warp Tile: 64Ã—64Ã—32ï¼ˆ4ä¸ªwarpå¤„ç†ä¸€ä¸ªCTA tileï¼‰</li>
<li>Thread Tile: 8Ã—8</li>
</ul>
<p>ç†ç”±ï¼š</p>
<ol>
<li>CTA tile 128Ã—128éœ€è¦32KBå…±äº«å†…å­˜ï¼ˆåŒç¼“å†²ï¼‰ï¼Œç•™æœ‰ä½™é‡</li>
<li>256ä¸ªçº¿ç¨‹ï¼Œæ¯çº¿ç¨‹64ä¸ªå¯„å­˜å™¨ï¼Œæ€»è®¡16384ä¸ªå¯„å­˜å™¨ï¼Œå¯è¾¾åˆ°4ä¸ªblock/SM</li>
<li>Kç»´åº¦32é€‚åˆL1ç¼“å­˜è¡Œå¤§å°ï¼Œå‡å°‘äº‹åŠ¡æ•°</li>
<li>Thread tile 8Ã—8éœ€è¦64ä¸ªå¯„å­˜å™¨å­˜å‚¨ç´¯åŠ å™¨ï¼Œåˆç†</li>
</ol>
</details>
<p><strong>ç»ƒä¹ 10.2ï¼šBank Conflictåˆ†æ</strong>
ä»¥ä¸‹å…±äº«å†…å­˜è®¿é—®æ¨¡å¼æ˜¯å¦ä¼šäº§ç”Ÿbank conflictï¼Ÿå¦‚æœæœ‰ï¼Œå¦‚ä½•ä¿®å¤ï¼Ÿ</p>
<div class="codehilite"><pre><span></span><code><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">smem</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span>
<span class="c1">// 32ä¸ªçº¿ç¨‹çš„warpè®¿é—®</span>
<span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smem</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="n">tid</span><span class="p">];</span><span class="w">  </span><span class="c1">// è®¿é—®æ¨¡å¼1</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">tid</span><span class="p">];</span><span class="w">   </span><span class="c1">// è®¿é—®æ¨¡å¼2</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smem</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span><span class="w">   </span><span class="c1">// è®¿é—®æ¨¡å¼3</span>
</code></pre></div>

<p><em>Hint: è€ƒè™‘32ä¸ªbankçš„åˆ†å¸ƒè§„å¾‹</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>åˆ†æï¼š</p>
<ul>
<li>æ¨¡å¼1ï¼š32è·¯bank conflictï¼æ¯ä¸ªçº¿ç¨‹è®¿é—®smem[i][i]ï¼Œç”±äº32Ã—32å¸ƒå±€ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è®¿é—®åŒä¸€ä¸ªbank</li>
<li>æ¨¡å¼2ï¼šæ— conflictï¼Œè¿ç»­è®¿é—®åŒä¸€è¡Œ</li>
<li>æ¨¡å¼3ï¼šæ— conflictï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒè¡Œçš„ç¬¬0åˆ—ï¼Œåˆ†å¸ƒåœ¨ä¸åŒbank</li>
</ul>
<p>ä¿®å¤æ–¹æ¡ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">smem</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">33</span><span class="p">];</span><span class="w">  </span><span class="c1">// padding</span>
<span class="c1">// æˆ–ä½¿ç”¨swizzling</span>
<span class="kt">int</span><span class="w"> </span><span class="n">swizzled_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smem</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="n">swizzled_col</span><span class="p">];</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹ 10.3ï¼šEpilogueè®¾è®¡</strong>
è®¾è®¡ä¸€ä¸ªEpilogueå‡½æ•°ï¼Œå®ç°ï¼šC = ReLU6(Î±Â·AÂ·B + Î²Â·C + bias)ï¼Œå…¶ä¸­ReLU6(x) = min(max(x, 0), 6)</p>
<p><em>Hint: è€ƒè™‘å‘é‡åŒ–å’Œåˆ†æ”¯æ¶ˆé™¤</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–å®ç°ï¼š</p>
<ol>
<li>ä½¿ç”¨å‘é‡åŒ–ç±»å‹ï¼ˆfloat4ï¼‰å¤„ç†</li>
<li>ä½¿ç”¨fmaxf/fminfé¿å…åˆ†æ”¯</li>
<li>é¢„è®¡ç®—å¸¸é‡é¿å…é‡å¤è®¡ç®—</li>
<li>å¾ªç¯å±•å¼€æé«˜ILP</li>
</ol>
<p>å…³é”®ä»£ç ç»“æ„ï¼š</p>
<ul>
<li>çº¿æ€§ç»„åˆï¼šä½¿ç”¨FMAæŒ‡ä»¤</li>
<li>BiasåŠ æ³•ï¼šå‘é‡åŒ–åŠ æ³•</li>
<li>ReLU6ï¼šfminf(fmaxf(x, 0.0f), 6.0f)</li>
<li>ä½¿ç”¨#pragma unrollå±•å¼€å¾ªç¯</li>
</ul>
</details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹ 10.4ï¼šæ€§èƒ½å»ºæ¨¡</strong>
ç»™å®šç¡¬ä»¶è§„æ ¼ï¼šå³°å€¼è®¡ç®—280 TFLOPSï¼ˆFP16 Tensor Coreï¼‰ï¼Œå†…å­˜å¸¦å®½1.5 TB/sã€‚å¯¹äºM=N=K=8192çš„GEMMï¼Œç†è®ºå³°å€¼æ€§èƒ½æ˜¯å¤šå°‘ï¼Ÿå¦‚æœå®æµ‹åªæœ‰150 TFLOPSï¼Œåˆ†æå¯èƒ½çš„ç“¶é¢ˆã€‚</p>
<p><em>Hint: è®¡ç®—arithmetic intensityå’Œrooflineæ¨¡å‹</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç†è®ºåˆ†æï¼š</p>
<ol>
<li>è®¡ç®—é‡ï¼š2Ã—8192Â³ = 1.1Ã—10Â¹Â² FLOP</li>
<li>æ•°æ®é‡ï¼š3Ã—8192Â²Ã—2 bytes = 402 MBï¼ˆFP16ï¼‰</li>
<li>Arithmetic Intensity = 1.1Ã—10Â¹Â²/(402Ã—10â¶) = 2736 FLOP/byte</li>
<li>è®¡ç®—é™åˆ¶ï¼š280 TFLOPS</li>
<li>å¸¦å®½é™åˆ¶ï¼š1.5 TB/s Ã— 2736 = 4104 TFLOPS</li>
</ol>
<p>ç»“è®ºï¼šè®¡ç®—å—é™ï¼Œç†è®ºå³°å€¼280 TFLOPS</p>
<p>å®é™…150 TFLOPSçš„å¯èƒ½åŸå› ï¼š</p>
<ul>
<li>Tensor Coreåˆ©ç”¨ç‡ä¸è¶³ï¼ˆ53%ï¼‰</li>
<li>éæœ€ä¼˜çš„tileé…ç½®å¯¼è‡´å ç”¨ç‡ä½</li>
<li>åŒæ­¥å¼€é”€è¿‡å¤§</li>
<li>æœªä½¿ç”¨é€‚å½“çš„æµæ°´çº¿æ·±åº¦</li>
<li>Bank conflictå¯¼è‡´çš„åœé¡¿</li>
</ul>
</details>
<p><strong>ç»ƒä¹ 10.5ï¼šå·ç§¯ç®—å­é€‰æ‹©</strong>
å¯¹äºä»¥ä¸‹å·ç§¯é…ç½®ï¼Œé€‰æ‹©æœ€ä¼˜ç®—æ³•å¹¶è¯´æ˜ç†ç”±ï¼š</p>
<ol>
<li>1Ã—1å·ç§¯ï¼ŒC=2048, K=512</li>
<li>3Ã—3å·ç§¯ï¼ŒC=3, K=64ï¼Œstride=2</li>
<li>7Ã—7å·ç§¯ï¼ŒC=128, K=128</li>
<li>Depthwise 3Ã—3å·ç§¯ï¼ŒC=1024</li>
</ol>
<p><em>Hint: è€ƒè™‘è®¡ç®—/å†…å­˜æ¯”ã€æ•°æ®é‡ç”¨æ¨¡å¼</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æœ€ä¼˜é€‰æ‹©ï¼š</p>
<ol>
<li><strong>1Ã—1å·ç§¯</strong>ï¼šç›´æ¥ä½œä¸ºGEMMå¤„ç†ï¼Œæ— éœ€Im2Colï¼Œä½¿ç”¨Tensor Core</li>
<li><strong>3Ã—3å·ç§¯ï¼Œå°é€šé“</strong>ï¼šDirect Convolutionï¼Œé¿å…Im2Colå¼€é”€</li>
<li><strong>7Ã—7å·ç§¯</strong>ï¼šWinograd F(4,3)æˆ–FFTå·ç§¯ï¼Œå‡å°‘è®¡ç®—é‡</li>
<li><strong>Depthwiseå·ç§¯</strong>ï¼šä¸“ç”¨çš„channel-parallelå®ç°ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†ç‹¬ç«‹é€šé“</li>
</ol>
<p>é€‰æ‹©ä¾æ®ï¼š</p>
<ul>
<li>è®¡ç®—å¯†åº¦ï¼š1Ã—1å·ç§¯è®¡ç®—å¯†é›†ï¼Œé€‚åˆGEMM</li>
<li>å†…å­˜å¼€é”€ï¼šå°é€šé“æ•°æ—¶Im2Colå¼€é”€è¿‡å¤§</li>
<li>ç®—æ³•å¤æ‚åº¦ï¼šå¤§kernelç”¨Winograd/FFTå‡å°‘è¿ç®—</li>
<li>å¹¶è¡Œæ¨¡å¼ï¼šDepthwiseçš„é€šé“ç‹¬ç«‹æ€§</li>
</ul>
</details>
<p><strong>ç»ƒä¹ 10.6ï¼šå¤šçº§ç¼“å­˜ä¼˜åŒ–</strong>
è®¾è®¡ä¸€ä¸ªåˆ©ç”¨L2ç¼“å­˜çš„GEMMåˆ†å—ç­–ç•¥ã€‚L2ç¼“å­˜å¤§å°6MBï¼Œå¸¦å®½3.5TB/sã€‚å¦‚ä½•é€‰æ‹©åˆ†å—å¤§å°ä»¥æœ€å¤§åŒ–L2é‡ç”¨ï¼Ÿ</p>
<p><em>Hint: è€ƒè™‘L2ç¼“å­˜çš„å®¹é‡å’Œä¸‰ä¸ªçŸ©é˜µçš„footprint</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>L2ç¼“å­˜åˆ†å—ç­–ç•¥ï¼š</p>
<ol>
<li>è®¾ç½®L2 tile: M_L2 Ã— N_L2 Ã— K_L2</li>
<li>ä¸‰ä¸ªçŸ©é˜µçš„footprint: (M_L2Ã—K_L2 + K_L2Ã—N_L2 + M_L2Ã—N_L2) Ã— 4 bytes â‰¤ 6MB</li>
<li>æœ€å¤§åŒ–M_L2Ã—N_L2ï¼ˆè¾“å‡ºé‡ç”¨ï¼‰</li>
</ol>
<p>ä¼˜åŒ–é…ç½®ï¼š</p>
<ul>
<li>M_L2 = N_L2 = 768, K_L2 = 768</li>
<li>Footprint: 3Ã—768Â²Ã—4 = 7MBï¼ˆç•¥è¶…ï¼Œä½¿ç”¨ï¼‰</li>
<li>è°ƒæ•´ä¸ºï¼šM_L2 = N_L2 = 704, K_L2 = 704</li>
<li>Footprint: 3Ã—704Â²Ã—4 = 5.9MB</li>
</ul>
<p>å®æ–½è¦ç‚¹ï¼š</p>
<ul>
<li>CTAæŒ‰L2 tileè¾¹ç•Œå¯¹é½</li>
<li>ä½¿ç”¨persistent kernelä¿æŒL2çƒ­åº¦</li>
<li>é¢„å–ä¸‹ä¸€ä¸ªL2 tileåˆ°L2ç¼“å­˜</li>
</ul>
</details>
<p><strong>ç»ƒä¹ 10.7ï¼šè‡ªå®šä¹‰æ•°æ®ç±»å‹</strong>
ä¸ºINT4é‡åŒ–è®¾è®¡CUTLASSæ¨¡æ¿ç‰¹åŒ–ï¼Œå®ç°INT4Ã—INT4â†’INT32çš„GEMMã€‚éœ€è¦è€ƒè™‘å“ªäº›å…³é”®ç‚¹ï¼Ÿ</p>
<p><em>Hint: è€ƒè™‘æ•°æ®æ‰“åŒ…ã€è§£åŒ…å’Œè®¡ç®—æŒ‡ä»¤</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å…³é”®è®¾è®¡ç‚¹ï¼š</p>
<ol>
<li><strong>æ•°æ®æ‰“åŒ…</strong>ï¼š8ä¸ªINT4æ‰“åŒ…åˆ°ä¸€ä¸ª32ä½å¯„å­˜å™¨</li>
<li><strong>å†…å­˜è®¿é—®</strong>ï¼šä½¿ç”¨å‘é‡åŒ–loadï¼Œä¸€æ¬¡åŠ è½½8ä¸ªINT4</li>
<li><strong>è§£åŒ…ç­–ç•¥</strong>ï¼šä½¿ç”¨ä½æ“ä½œå’Œæ©ç æå–</li>
<li><strong>è®¡ç®—æŒ‡ä»¤</strong>ï¼šä½¿ç”¨DP4AæŒ‡ä»¤ï¼ˆ4ä¸ªINT8ç‚¹ç§¯ï¼‰</li>
<li><strong>ç´¯åŠ å™¨</strong>ï¼šä½¿ç”¨INT32é¿å…æº¢å‡º</li>
</ol>
<p>å®ç°è¦ç‚¹ï¼š</p>
<ul>
<li>è‡ªå®šä¹‰Fragmentç±»å‹å¤„ç†æ‰“åŒ…æ•°æ®</li>
<li>ç‰¹åŒ–SharedLoadIteratorå¤„ç†INT4åŠ è½½</li>
<li>ä½¿ç”¨__dp4aå†…ç½®å‡½æ•°åŠ é€Ÿè®¡ç®—</li>
<li>Epilogueä¸­å¤„ç†åé‡åŒ–å’Œç¼©æ”¾</li>
<li>Bank conflictï¼šINT4è®¿é—®æ¨¡å¼ä¸åŒï¼Œéœ€é‡æ–°è®¾è®¡swizzling</li>
</ul>
</details>
<p><strong>ç»ƒä¹ 10.8ï¼šæ€§èƒ½è°ƒè¯•å®æˆ˜</strong>
ä¸€ä¸ªCUTLASS GEMM kernelçš„æ€§èƒ½åˆ†ææ˜¾ç¤ºï¼šSMåˆ©ç”¨ç‡95%ï¼Œå ç”¨ç‡50%ï¼ŒL1ç¼“å­˜å‘½ä¸­ç‡30%ï¼Œå¯„å­˜å™¨æº¢å‡º20%ã€‚è¯·è¯Šæ–­é—®é¢˜å¹¶æå‡ºä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<p><em>Hint: ç»¼åˆåˆ†æå„é¡¹æŒ‡æ ‡çš„å«ä¹‰</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>é—®é¢˜è¯Šæ–­ï¼š</p>
<ol>
<li><strong>å ç”¨ç‡ä½ï¼ˆ50%ï¼‰+ å¯„å­˜å™¨æº¢å‡ºï¼ˆ20%ï¼‰</strong>ï¼šThread Tileè¿‡å¤§ï¼Œå¯„å­˜å™¨å‹åŠ›è¿‡é«˜</li>
<li><strong>L1å‘½ä¸­ç‡ä½ï¼ˆ30%ï¼‰</strong>ï¼šæ•°æ®é‡ç”¨ä¸è¶³æˆ–è®¿é—®æ¨¡å¼å·®</li>
<li><strong>SMåˆ©ç”¨ç‡é«˜ï¼ˆ95%ï¼‰</strong>ï¼šè®¡ç®—å•å…ƒå¿™ç¢Œï¼Œä½†æ•ˆç‡ä¸é«˜</li>
</ol>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li>å‡å°Thread Tileï¼ˆå¦‚8Ã—8â†’4Ã—8ï¼‰ï¼Œé™ä½å¯„å­˜å™¨ä½¿ç”¨</li>
<li>å¢åŠ Warp Tileï¼Œæé«˜æ•°æ®é‡ç”¨</li>
<li>è°ƒæ•´Kç»´åº¦åˆ†å—ï¼Œæ”¹å–„L1ç¼“å­˜å±€éƒ¨æ€§</li>
<li>ä½¿ç”¨æ›´æ·±çš„æµæ°´çº¿ï¼ˆ3çº§â†’5çº§ï¼‰</li>
<li>è€ƒè™‘ä½¿ç”¨Tensor Coreé™ä½å¯„å­˜å™¨å‹åŠ›</li>
</ol>
<p>é¢„æœŸæ”¹è¿›ï¼š</p>
<ul>
<li>å ç”¨ç‡æå‡åˆ°75%</li>
<li>å¯„å­˜å™¨æº¢å‡ºé™åˆ°5%ä»¥ä¸‹</li>
<li>L1å‘½ä¸­ç‡æå‡åˆ°60%</li>
<li>æ•´ä½“æ€§èƒ½æå‡40-60%</li>
</ul>
</details>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="1">1. æ¨¡æ¿å®ä¾‹åŒ–çˆ†ç‚¸</h3>
<p><strong>é—®é¢˜</strong>ï¼šCUTLASSçš„æ¨¡æ¿å‚æ•°ç»„åˆå¯èƒ½å¯¼è‡´ç¼–è¯‘æ—¶é—´æé•¿å’ŒäºŒè¿›åˆ¶è†¨èƒ€
<strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>é™åˆ¶æ¨¡æ¿å®ä¾‹åŒ–æ•°é‡ï¼Œåªç”Ÿæˆéœ€è¦çš„é…ç½®</li>
<li>ä½¿ç”¨é¢„ç¼–è¯‘çš„kernelåº“</li>
<li>é‡‡ç”¨JITç¼–è¯‘ç­–ç•¥</li>
</ul>
<h3 id="2-bank-conflict">2. å…±äº«å†…å­˜Bank Conflict</h3>
<p><strong>é—®é¢˜</strong>ï¼šæœªæ­£ç¡®å¤„ç†çš„bank conflictå¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™8-32å€
<strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>å§‹ç»ˆä½¿ç”¨paddingæˆ–swizzling</li>
<li>ç”¨Nsight ComputeéªŒè¯bank conflict</li>
<li>å¯¹ä¸åŒçš„æ•°æ®ç±»å‹ä½¿ç”¨ä¸åŒçš„paddingç­–ç•¥</li>
</ul>
<h3 id="3">3. å¯„å­˜å™¨æº¢å‡º</h3>
<p><strong>é—®é¢˜</strong>ï¼šè¿‡å¤§çš„Thread Tileå¯¼è‡´å¯„å­˜å™¨æº¢å‡ºåˆ°æœ¬åœ°å†…å­˜
<strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>ç›‘æ§å¯„å­˜å™¨ä½¿ç”¨é‡ï¼ˆ&lt; 255ï¼‰</li>
<li>å¹³è¡¡Thread Tileå¤§å°å’Œå ç”¨ç‡</li>
<li>è€ƒè™‘ä½¿ç”¨è¾ƒå°çš„ç´¯åŠ å™¨ç²¾åº¦</li>
</ul>
<h3 id="4">4. é”™è¯¯çš„æµæ°´çº¿åŒæ­¥</h3>
<p><strong>é—®é¢˜</strong>ï¼šæµæ°´çº¿çº§ä¹‹é—´çš„åŒæ­¥é”™è¯¯å¯¼è‡´æ•°æ®ç«äº‰
<strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>æ­£ç¡®æ”¾ç½®__syncthreads()</li>
<li>ä½¿ç”¨cuda::pipelineè¿›è¡Œç¡¬ä»¶çº§åŒæ­¥</li>
<li>ä»”ç»†éªŒè¯è¯»å†™é˜¶æ®µçš„åˆ†ç¦»</li>
</ul>
<h3 id="5-tensor-core">5. Tensor Coreæœªå¯¹é½</h3>
<p><strong>é—®é¢˜</strong>ï¼šæ•°æ®æˆ–æ“ä½œæœªæ»¡è¶³Tensor Coreçš„å¯¹é½è¦æ±‚
<strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>ç¡®ä¿çŸ©é˜µç»´åº¦æ˜¯16çš„å€æ•°</li>
<li>ä½¿ç”¨æ­£ç¡®çš„æ•°æ®å¸ƒå±€</li>
<li>æ£€æŸ¥æŒ‡é’ˆå¯¹é½ï¼ˆ16å­—èŠ‚è¾¹ç•Œï¼‰</li>
</ul>
<h3 id="6-l2">6. L2ç¼“å­˜æŠ–åŠ¨</h3>
<p><strong>é—®é¢˜</strong>ï¼šå¤šä¸ªkernelç«äº‰L2ç¼“å­˜å¯¼è‡´æ€§èƒ½ä¸ç¨³å®š
<strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨L2 cacheæŒä¹…åŒ–ç­–ç•¥</li>
<li>åˆç†è®¾ç½®L2 cacheé¢„ç•™</li>
<li>è€ƒè™‘kernelèåˆå‡å°‘L2å‹åŠ›</li>
</ul>
<h2 id="_5">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_6">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] åˆ†æé—®é¢˜çš„arithmetic intensityï¼Œç¡®å®šæ˜¯è®¡ç®—å—é™è¿˜æ˜¯å†…å­˜å—é™</li>
<li>[ ] æ ¹æ®ç¡¬ä»¶è§„æ ¼é€‰æ‹©åˆé€‚çš„Tileå¤§å°</li>
<li>[ ] è¯„ä¼°ä¸åŒç®—æ³•ï¼ˆç›´æ¥å·ç§¯ã€Im2Colã€Winogradã€FFTï¼‰çš„é€‚ç”¨æ€§</li>
<li>[ ] è€ƒè™‘æ•°æ®ç²¾åº¦éœ€æ±‚ï¼ˆFP32/FP16/INT8/INT4ï¼‰</li>
<li>[ ] è§„åˆ’Epilogueèåˆæœºä¼š</li>
</ul>
<h3 id="_7">å®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] ä½¿ç”¨CUTLASSæä¾›çš„åŸºç¡€ç±»å‹å’Œè¿­ä»£å™¨</li>
<li>[ ] å®ç°æ­£ç¡®çš„bank conflicté¿å…ç­–ç•¥</li>
<li>[ ] é‡‡ç”¨é€‚å½“çš„æµæ°´çº¿æ·±åº¦ï¼ˆé€šå¸¸3-5çº§ï¼‰</li>
<li>[ ] å‘é‡åŒ–æ‰€æœ‰å†…å­˜è®¿é—®</li>
<li>[ ] ä¸ºä¸åŒæ¶æ„æä¾›ç‰¹åŒ–å®ç°</li>
</ul>
<h3 id="_8">ä¼˜åŒ–é˜¶æ®µ</h3>
<ul>
<li>[ ] Profileç¡®è®¤æ— bank conflict</li>
<li>[ ] å¯„å­˜å™¨ä½¿ç”¨é‡åœ¨åˆç†èŒƒå›´ï¼ˆ&lt;255ï¼‰</li>
<li>[ ] å ç”¨ç‡è¾¾åˆ°ç›®æ ‡ï¼ˆ&gt;50%ï¼‰</li>
<li>[ ] L1/L2ç¼“å­˜å‘½ä¸­ç‡ç¬¦åˆé¢„æœŸ</li>
<li>[ ] Tensor Coreåˆ©ç”¨ç‡ï¼ˆå¦‚æœé€‚ç”¨ï¼‰&gt;80%</li>
</ul>
<h3 id="_9">éªŒè¯é˜¶æ®µ</h3>
<ul>
<li>[ ] æ•°å€¼ç²¾åº¦éªŒè¯ï¼ˆç›¸å¯¹è¯¯å·®&lt;1e-3ï¼‰</li>
<li>[ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•</li>
<li>[ ] ä¸åŒè¾“å…¥è§„æ¨¡çš„æ€§èƒ½ç¨³å®šæ€§</li>
<li>[ ] ä¸cuBLAS/cuDNNçš„æ€§èƒ½å¯¹æ¯”</li>
<li>[ ] å†…å­˜æ³„æ¼å’Œé”™è¯¯æ£€æŸ¥</li>
</ul>
<h3 id="_10">éƒ¨ç½²é˜¶æ®µ</h3>
<ul>
<li>[ ] äºŒè¿›åˆ¶å¤§å°å¯æ¥å—</li>
<li>[ ] ç¼–è¯‘æ—¶é—´åˆç†</li>
<li>[ ] æä¾›æ€§èƒ½è°ƒä¼˜æŒ‡å—</li>
<li>[ ] æ–‡æ¡£åŒ–ç¡¬ä»¶è¦æ±‚å’Œé™åˆ¶</li>
<li>[ ] å‡†å¤‡é™çº§æ–¹æ¡ˆï¼ˆfallbackè·¯å¾„ï¼‰</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter9.html" class="nav-link prev">â† ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</a><a href="chapter11.html" class="nav-link next">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ â†’</a></nav>
        </main>
    </div>
</body>
</html>