<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="18">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨å¤§è§„æ¨¡ç‚¹äº‘æ•°æ®çš„GPUåŠ é€Ÿé‡å»ºæŠ€æœ¯ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ©ç”¨CUDAå¹¶è¡ŒåŒ–ç»å…¸çš„ä¸‰ç»´é‡å»ºç®—æ³•ï¼ŒåŒ…æ‹¬Poissoné‡å»ºã€Marching Cubesç­‰ï¼Œå¹¶å®ç°é«˜æ•ˆçš„ç½‘æ ¼åå¤„ç†æµç¨‹ã€‚è¿™äº›æŠ€æœ¯åœ¨è‡ªåŠ¨é©¾é©¶çš„é«˜ç²¾åœ°å›¾æ„å»ºã€å…·èº«æ™ºèƒ½çš„ç¯å¢ƒå»ºæ¨¡ç­‰åœºæ™¯ä¸­å‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚</p>
<h2 id="181-poissongpu">18.1 Poissoné‡å»ºçš„GPUåŠ é€Ÿ</h2>
<h3 id="1811-poisson">18.1.1 Poissoné‡å»ºåŸç†å›é¡¾</h3>
<p>Poissonè¡¨é¢é‡å»ºæ˜¯ä¸€ç§å°†å¸¦æ³•å‘é‡çš„ç‚¹äº‘è½¬æ¢ä¸ºæ°´å¯†ç½‘æ ¼çš„å…¨å±€ä¼˜åŒ–æ–¹æ³•ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†è¡¨é¢é‡å»ºé—®é¢˜è½¬åŒ–ä¸ºæ±‚è§£Poissonæ–¹ç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code>âˆ‡Â²Ï‡ = âˆ‡Â·V
</code></pre></div>

<p>å…¶ä¸­Ï‡æ˜¯æŒ‡ç¤ºå‡½æ•°ï¼ˆindicator functionï¼‰ï¼ŒVæ˜¯ç”±ç‚¹äº‘æ³•å‘é‡æ„å»ºçš„å‘é‡åœºã€‚è¯¥æ–¹æ³•çš„ä¼˜åŠ¿åœ¨äºå¯¹å™ªå£°é²æ£’ï¼Œèƒ½ç”Ÿæˆå…‰æ»‘çš„æ°´å¯†è¡¨é¢ã€‚</p>
<h3 id="1812">18.1.2 å…«å‰æ ‘å¹¶è¡Œæ„å»º</h3>
<p>Poissoné‡å»ºçš„ç¬¬ä¸€æ­¥æ˜¯æ„å»ºè‡ªé€‚åº”å…«å‰æ ‘ã€‚åœ¨GPUä¸Šå¹¶è¡Œæ„å»ºå…«å‰æ ‘çš„å…³é”®æŒ‘æˆ˜åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>Mortonç¼–ç </strong>ï¼šä½¿ç”¨Z-orderæ›²çº¿å°†3Dåæ ‡æ˜ å°„åˆ°1Dç©ºé—´</li>
<li><strong>å¹¶è¡ŒèŠ‚ç‚¹åˆ†è£‚</strong>ï¼šåŸºäºç‚¹å¯†åº¦çš„è‡ªé€‚åº”ç»†åˆ†</li>
<li><strong>å±‚çº§éå†</strong>ï¼šè‡ªåº•å‘ä¸Šå’Œè‡ªé¡¶å‘ä¸‹çš„å¹¶è¡Œéå†ç­–ç•¥</li>
</ol>
<div class="codehilite"><pre><span></span><code>Mortonç¼–ç ç¤ºæ„å›¾ï¼š
    Y
    â†‘
  3 â”‚ 10  11  14  15
  2 â”‚ 08  09  12  13
  1 â”‚ 02  03  06  07
  0 â”‚ 00  01  04  05
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ X
      0   1   2   3

3Dæ‰©å±•ï¼šäº¤é”™x,y,zçš„äºŒè¿›åˆ¶ä½
</code></pre></div>

<h3 id="1813">18.1.3 ç¨€ç–çº¿æ€§ç³»ç»Ÿæ±‚è§£</h3>
<p>Poissonæ–¹ç¨‹ç¦»æ•£åŒ–åå½¢æˆå¤§è§„æ¨¡ç¨€ç–çº¿æ€§ç³»ç»ŸAx=bã€‚GPUä¸Šçš„é«˜æ•ˆæ±‚è§£ç­–ç•¥ï¼š</p>
<p><strong>å…±è½­æ¢¯åº¦æ³•ï¼ˆCGï¼‰å¹¶è¡ŒåŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ç®—æ³•æµç¨‹ï¼š

<span class="mi">1</span>.<span class="w"> </span><span class="nv">r</span>â‚€<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">Ax</span>â‚€
<span class="mi">2</span>.<span class="w"> </span><span class="nv">p</span>â‚€<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">r</span>â‚€
<span class="mi">3</span>.<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>,<span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="mi">2</span>,<span class="w"> </span>...
<span class="w">   </span>Î±â‚–<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">r</span>â‚–áµ€<span class="nv">r</span>â‚–<span class="ss">)</span><span class="o">/</span><span class="ss">(</span><span class="nv">p</span>â‚–áµ€<span class="nv">Ap</span>â‚–<span class="ss">)</span>
<span class="w">   </span><span class="nv">x</span>â‚–â‚Šâ‚<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">x</span>â‚–<span class="w"> </span><span class="o">+</span><span class="w"> </span>Î±â‚–<span class="nv">p</span>â‚–
<span class="w">   </span><span class="nv">r</span>â‚–â‚Šâ‚<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">r</span>â‚–<span class="w"> </span><span class="o">-</span><span class="w"> </span>Î±â‚–<span class="nv">Ap</span>â‚–
<span class="w">   </span>Î²â‚–<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">r</span>â‚–â‚Šâ‚áµ€<span class="nv">r</span>â‚–â‚Šâ‚<span class="ss">)</span><span class="o">/</span><span class="ss">(</span><span class="nv">r</span>â‚–áµ€<span class="nv">r</span>â‚–<span class="ss">)</span>
<span class="w">   </span><span class="nv">p</span>â‚–â‚Šâ‚<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">r</span>â‚–â‚Šâ‚<span class="w"> </span><span class="o">+</span><span class="w"> </span>Î²â‚–<span class="nv">p</span>â‚–
</code></pre></div>

<p>å…³é”®å¹¶è¡Œæ“ä½œï¼š</p>
<ul>
<li><strong>ç¨€ç–çŸ©é˜µ-å‘é‡ä¹˜æ³•ï¼ˆSpMVï¼‰</strong>ï¼šä½¿ç”¨CSRæ ¼å¼ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€è¡Œ</li>
<li><strong>å‘é‡ç‚¹ç§¯</strong>ï¼šä½¿ç”¨åˆ†æ®µå½’çº¦ï¼Œç»“åˆwarp shuffleä¼˜åŒ–</li>
<li><strong>å‘é‡æ›´æ–°</strong>ï¼šå®Œå…¨å¹¶è¡Œï¼Œå¸¦å®½å—é™æ“ä½œ</li>
</ul>
<p><strong>å¤šé‡ç½‘æ ¼æ–¹æ³•ï¼ˆMultigridï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>V-Cycleç¤ºæ„ï¼š
ç»†ç½‘æ ¼  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
         â†˜                                     â†—
          â†˜ é™åˆ¶(Restriction)     å»¶æ‹“(Prolongation) â†—
           â†˜                                   â†—
ä¸­ç½‘æ ¼      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
              â†˜                         â†—
               â†˜                       â†—
ç²—ç½‘æ ¼         â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    ç›´æ¥æ±‚è§£
</code></pre></div>

<h3 id="1814-gpu">18.1.4 GPUä¼˜åŒ–ç­–ç•¥</h3>
<p><strong>å†…å­˜è®¿é—®ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li><strong>çº¹ç†å†…å­˜ç¼“å­˜å…«å‰æ ‘èŠ‚ç‚¹</strong>ï¼šåˆ©ç”¨ç©ºé—´å±€éƒ¨æ€§</li>
<li><strong>å…±äº«å†…å­˜ç¼“å­˜é‚»å±…ä¿¡æ¯</strong>ï¼šå‡å°‘å…¨å±€å†…å­˜è®¿é—®</li>
<li><strong>å‘é‡åŒ–åŠ è½½</strong>ï¼šä½¿ç”¨float4æé«˜å¸¦å®½åˆ©ç”¨ç‡</li>
</ol>
<p><strong>è®¡ç®—ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li><strong>Warpçº§åŸè¯­åŠ é€Ÿå½’çº¦</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨warp shuffleè¿›è¡Œå¿«é€Ÿå½’çº¦</span>
<span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">warpReduce</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__shfl_down_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æ··åˆç²¾åº¦è®¡ç®—</strong>ï¼š
- ä½¿ç”¨FP32è¿›è¡Œä¸»è¦è®¡ç®—
- FP16å­˜å‚¨ä¸­é—´ç»“æœ
- å…³é”®ç´¯åŠ ä½¿ç”¨FP64é¿å…ç²¾åº¦æŸå¤±</p>
</li>
<li>
<p><strong>åŠ¨æ€å¹¶è¡Œä¼˜åŒ–å…«å‰æ ‘éå†</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">traverseOctree</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åŠ¨æ€å¯åŠ¨å­ç½‘æ ¼å¤„ç†å­èŠ‚ç‚¹</span>
<span class="w">        </span><span class="kt">dim3</span><span class="w"> </span><span class="nf">childGrid</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="w">        </span><span class="n">traverseOctree</span><span class="o">&lt;&lt;&lt;</span><span class="n">childGrid</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">nodes</span><span class="p">[</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">].</span><span class="n">children</span><span class="p">,</span><span class="w"> </span><span class="n">level</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1815">18.1.5 æ€§èƒ½åˆ†æä¸ç“¶é¢ˆ</h3>
<p><strong>å…¸å‹æ€§èƒ½ç“¶é¢ˆ</strong>ï¼š</p>
<ol>
<li><strong>ä¸è§„åˆ™å†…å­˜è®¿é—®</strong>ï¼šå…«å‰æ ‘éå†çš„éšæœºè®¿é—®æ¨¡å¼</li>
<li><strong>è´Ÿè½½ä¸å‡è¡¡</strong>ï¼šè‡ªé€‚åº”ç»†åˆ†å¯¼è‡´çš„å·¥ä½œé‡å·®å¼‚</li>
<li><strong>åŒæ­¥å¼€é”€</strong>ï¼šå¤šé‡ç½‘æ ¼çš„å±‚çº§é—´åŒæ­¥</li>
</ol>
<p><strong>æ€§èƒ½æŒ‡æ ‡</strong>ï¼ˆRTX 4090ï¼‰ï¼š</p>
<ul>
<li>100ä¸‡ç‚¹é‡å»ºï¼š~200msï¼ˆCPUï¼š~8sï¼‰</li>
<li>1000ä¸‡ç‚¹é‡å»ºï¼š~2.5sï¼ˆCPUï¼š~120sï¼‰</li>
<li>å†…å­˜å¸¦å®½åˆ©ç”¨ç‡ï¼š~65%</li>
<li>SMå ç”¨ç‡ï¼š~80%</li>
</ul>
<h2 id="182-marching-cubes">18.2 Marching Cubeså¹¶è¡ŒåŒ–</h2>
<h3 id="1821">18.2.1 ç®—æ³•åŸç†ä¸æŸ¥æ‰¾è¡¨</h3>
<p>Marching Cubesæ˜¯å°†ä½“æ•°æ®ï¼ˆå¦‚è·ç¦»åœºï¼‰è½¬æ¢ä¸ºä¸‰è§’ç½‘æ ¼çš„ç»å…¸ç®—æ³•ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯éå†æ¯ä¸ªä½“ç´ ï¼ˆ8ä¸ªé¡¶ç‚¹çš„ç«‹æ–¹ä½“ï¼‰ï¼Œæ ¹æ®é¡¶ç‚¹çš„å†…å¤–çŠ¶æ€ç”Ÿæˆä¸‰è§’å½¢ã€‚</p>
<p><strong>æŸ¥æ‰¾è¡¨ç»“æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ç«‹æ–¹ä½“é¡¶ç‚¹ç¼–å·ï¼š
    4 â”€â”€â”€â”€â”€â”€ 5
   /â”‚       /â”‚
  / â”‚      / â”‚
 7 â”€â”€â”€â”€â”€â”€ 6  â”‚
 â”‚  0 â”€â”€â”€â”€â”‚â”€ 1
 â”‚ /      â”‚ /
 â”‚/       â”‚/
 3 â”€â”€â”€â”€â”€â”€ 2

256ç§é…ç½® = 2^8ï¼ˆæ¯ä¸ªé¡¶ç‚¹å†…/å¤–ï¼‰
</code></pre></div>

<p><strong>è¾¹ç´¢å¼•è¡¨</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__constant__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">edgeTable</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w">  </span><span class="c1">// æ¯ä¸ªé…ç½®æ¿€æ´»çš„è¾¹</span>
<span class="kt">__constant__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">triTable</span><span class="p">[</span><span class="mi">256</span><span class="p">][</span><span class="mi">16</span><span class="p">];</span><span class="w"> </span><span class="c1">// æ¯ä¸ªé…ç½®çš„ä¸‰è§’å½¢é¡¶ç‚¹</span>
</code></pre></div>

<p>å…³é”®ä¼˜åŒ–ï¼šå°†æŸ¥æ‰¾è¡¨æ”¾å…¥å¸¸é‡å†…å­˜ï¼Œæ‰€æœ‰çº¿ç¨‹è®¿é—®åŒä¸€åœ°å€æ—¶å¯è¾¾åˆ°å…¨å¸¦å®½ã€‚</p>
<h3 id="1822">18.2.2 å¹¶è¡Œä½“ç´ éå†</h3>
<p><strong>ä¸¤éæ‰«æç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>ç¬¬ä¸€éï¼šè®¡æ•°</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">countVertices</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">volume</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">vertexCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è·å–8ä¸ªé¡¶ç‚¹çš„å€¼</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="w">    </span><span class="n">loadCubeVertices</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">volume</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¡ç®—é…ç½®ç´¢å¼•</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cubeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">isoValue</span><span class="p">)</span><span class="w"> </span><span class="n">cubeIndex</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æŸ¥è¡¨è·å–é¡¶ç‚¹æ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nVerts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numVertsTable</span><span class="p">[</span><span class="n">cubeIndex</span><span class="p">];</span>
<span class="w">    </span><span class="n">vertexCount</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nVerts</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å‰ç¼€å’Œåˆ†é…å†…å­˜</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨thrustæˆ–CUBè¿›è¡Œå¹¶è¡Œå‰ç¼€å’Œ</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">exclusive_scan</span><span class="p">(</span><span class="n">vertexCount</span><span class="p">,</span><span class="w"> </span><span class="n">vertexCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">numVoxels</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">vertexOffset</span><span class="p">);</span>
</code></pre></div>

<ol start="3">
<li><strong>ç¬¬äºŒéï¼šç”Ÿæˆé¡¶ç‚¹</strong></li>
</ol>
<h3 id="1823">18.2.3 é¡¶ç‚¹ç”Ÿæˆä¸ç´¢å¼•</h3>
<p><strong>çº¿æ€§æ’å€¼è®¡ç®—é¡¶ç‚¹ä½ç½®</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">vertexInterp</span><span class="p">(</span><span class="kt">float3</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span>
<span class="w">                               </span><span class="kt">float</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">iso</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v1</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å…±äº«å†…å­˜ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">generateTriangles</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">vertexCache</span><span class="p">[</span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">indexCache</span><span class="p">[</span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åä½œåŠ è½½ä½“ç´ æ•°æ®åˆ°å…±äº«å†…å­˜</span>
<span class="w">    </span><span class="n">loadToShared</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span><span class="w"> </span><span class="n">vertexCache</span><span class="p">);</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ç”Ÿæˆä¸‰è§’å½¢</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cubeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeCubeIndex</span><span class="p">(</span><span class="n">vertexCache</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">cubeIndex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cubeIndex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">generateTrianglesForVoxel</span><span class="p">(</span><span class="n">cubeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">vertexCache</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">indexCache</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1824">18.2.4 æµå‹ç¼©ä¸è¾“å‡ºç®¡ç†</h3>
<p><strong>æ— é”åŸå­åˆ†é…</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">allocateVertices</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">globalCounter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">globalCounter</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æµå‹ç¼©ä¼˜åŒ–</strong>ï¼š
ä½¿ç”¨CUBçš„DeviceSelectè¿›è¡Œé«˜æ•ˆæµå‹ç¼©ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç§»é™¤é€€åŒ–ä¸‰è§’å½¢</span>
<span class="n">cub</span><span class="o">::</span><span class="n">DeviceSelect</span><span class="o">::</span><span class="n">Flagged</span><span class="p">(</span><span class="n">d_temp_storage</span><span class="p">,</span><span class="w"> </span><span class="n">temp_storage_bytes</span><span class="p">,</span>
<span class="w">                           </span><span class="n">d_triangles</span><span class="p">,</span><span class="w"> </span><span class="n">d_flags</span><span class="p">,</span><span class="w"> </span><span class="n">d_output</span><span class="p">,</span>
<span class="w">                           </span><span class="n">d_num_selected</span><span class="p">,</span><span class="w"> </span><span class="n">num_triangles</span><span class="p">);</span>
</code></pre></div>

<p><strong>å†…å­˜æ± ç®¡ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">class</span><span class="w"> </span><span class="n">TrianglePool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float3</span><span class="o">*</span><span class="w"> </span><span class="n">vertices</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">indices</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">counters</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">resize</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">estimatedTriangles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é¢„åˆ†é…1.5å€ä¼°è®¡å¤§å°é¿å…é‡åˆ†é…</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimatedTriangles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vertices</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float3</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1825-dual-marching-cubes">18.2.5 æ‰©å±•ï¼šDual Marching Cubes</h3>
<p>Dual Marching Cubesé€šè¿‡åœ¨å¯¹å¶ç½‘æ ¼ä¸Šæ“ä½œï¼Œç”Ÿæˆæ›´é«˜è´¨é‡çš„ç½‘æ ¼ï¼š</p>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>é¿å…äº†åŸå§‹MCçš„äºŒä¹‰æ€§é—®é¢˜</li>
<li>ç”Ÿæˆçš„ç½‘æ ¼æ‹“æ‰‘æ›´åŠ è§„åˆ™</li>
<li>æ›´é€‚åˆåç»­çš„ç½‘æ ¼ä¼˜åŒ–</li>
</ul>
<p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dualMarchingCubes</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åœ¨ä½“ç´ ä¸­å¿ƒè€Œéè¾¹ä¸Šç”Ÿæˆé¡¶ç‚¹</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeVoxelCenter</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨Hermiteæ•°æ®ï¼ˆä½ç½®+æ¢¯åº¦ï¼‰</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">gradient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeGradient</span><span class="p">(</span><span class="n">center</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// QEFï¼ˆäºŒæ¬¡è¯¯å·®å‡½æ•°ï¼‰æ±‚è§£æœ€ä¼˜é¡¶ç‚¹ä½ç½®</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">vertex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solveQEF</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">gradient</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="183">18.3 ç½‘æ ¼ç®€åŒ–ä¸ä¼˜åŒ–</h2>
<h3 id="1831">18.3.1 è¾¹æŠ˜å ç®—æ³•å¹¶è¡ŒåŒ–</h3>
<p>è¾¹æŠ˜å ï¼ˆEdge Collapseï¼‰æ˜¯ç½‘æ ¼ç®€åŒ–çš„æ ¸å¿ƒæ“ä½œã€‚GPUå¹¶è¡ŒåŒ–çš„æŒ‘æˆ˜åœ¨äºå¤„ç†ä¾èµ–å…³ç³»å’Œä¿æŒç½‘æ ¼ä¸€è‡´æ€§ã€‚</p>
<p><strong>åŸºæœ¬è¾¹æŠ˜å æ“ä½œ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>æŠ˜å å‰ï¼š        æŠ˜å åï¼š
    v1              v_new
   /â”‚\              /|\
  / â”‚ \            / | \
 /  â”‚  \          /  |  \
v3â”€â”€v2â”€â”€v4  â†’   v3â”€â”€â”€â”€â”€â”€â”€v4

è¾¹(v1,v2)æŠ˜å ä¸ºæ–°é¡¶ç‚¹v_new
</code></pre></div>

<p><strong>å¹¶è¡Œç­–ç•¥ï¼šç‹¬ç«‹é›†æ–¹æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">findIndependentEdges</span><span class="p">(</span><span class="n">Edge</span><span class="o">*</span><span class="w"> </span><span class="n">edges</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">*</span><span class="w"> </span><span class="n">canCollapse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">Edge</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edges</span><span class="p">[</span><span class="n">eid</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥è¾¹çš„ä¸¤ä¸ªé¡¶ç‚¹æ˜¯å¦è¢«å…¶ä»–è¾¹æ ‡è®°</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">independent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">numNeighbors</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">atomicCAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vertexLocked</span><span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">independent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">canCollapse</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">independent</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1832">18.3.2 è¯¯å·®åº¦é‡è®¡ç®—</h3>
<p><strong>äºŒæ¬¡è¯¯å·®åº¦é‡ï¼ˆQEMï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Quadric</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float4</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span><span class="w">  </span><span class="c1">// å¯¹ç§°4x4çŸ©é˜µçš„10ä¸ªç‹¬ç«‹å…ƒç´ </span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">computeError</span><span class="p">(</span><span class="kt">float3</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// v^T Q v è®¡ç®—</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">            </span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Quadric</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>æœ€ä¼˜é¡¶ç‚¹ä½ç½®æ±‚è§£</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">computeOptimalPosition</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Quadric</span><span class="o">&amp;</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ±‚è§£çº¿æ€§ç³»ç»Ÿ âˆ‡error = 0</span>
<span class="w">    </span><span class="n">float3x3</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractMatrix</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractVector</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨Crameræ³•åˆ™ï¼ˆ3x3çŸ©é˜µï¼‰</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">det</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determinant</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">det</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">solveLinearSystem</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">det</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é€€åŒ–æƒ…å†µï¼šä½¿ç”¨ä¸­ç‚¹</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">v1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1833">18.3.3 ä¼˜å…ˆé˜Ÿåˆ—ç®¡ç†</h3>
<p><strong>GPUå‹å¥½çš„ä¼˜å…ˆé˜Ÿåˆ—</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">class</span><span class="w"> </span><span class="n">GPUPriorityQueue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">HeapNode</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">cost</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">edgeId</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">HeapNode</span><span class="o">*</span><span class="w"> </span><span class="n">heap</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">insertBatch</span><span class="p">(</span><span class="n">HeapNode</span><span class="o">*</span><span class="w"> </span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ‰¹é‡æ’å…¥+å¹¶è¡Œå †åŒ–</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">oldSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ‹·è´åˆ°å †å°¾</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">heap</span><span class="p">[</span><span class="n">oldSize</span><span class="p">],</span><span class="w"> </span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">HeapNode</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// å¹¶è¡Œä¸Šæµ®</span>
<span class="w">        </span><span class="n">parallelHeapify</span><span class="p">(</span><span class="n">oldSize</span><span class="p">,</span><span class="w"> </span><span class="n">oldSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">parallelHeapify</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨åˆ†æ®µå¹¶è¡Œå †åŒ–ç®—æ³•</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__log2f</span><span class="p">(</span><span class="n">end</span><span class="p">);</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">level</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stride</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">                </span><span class="n">heapifyDown</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1834">18.3.4 æ‹“æ‰‘ä¿æŒç­–ç•¥</h3>
<p><strong>æµå½¢ä¿æŒæ£€æŸ¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">preservesManifold</span><span class="p">(</span><span class="n">Edge</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. é“¾æ¥æ¡ä»¶æ£€æŸ¥</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sharedNeighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">valence</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">valence</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">neighbors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="w">                </span><span class="n">sharedNeighbors</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è¾¹ç•Œè¾¹åº”æœ‰1ä¸ªå…±äº«é‚»å±…ï¼Œå†…éƒ¨è¾¹åº”æœ‰2ä¸ª</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isBoundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">boundary</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">boundary</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sharedNeighbors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">isBoundary</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">preventsFoldover</span><span class="p">(</span><span class="n">Edge</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">newPos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ£€æŸ¥æŠ˜å åæ˜¯å¦äº§ç”Ÿç¿»è½¬çš„ä¸‰è§’å½¢</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">numFaces</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Face</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">faces</span><span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">faces</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">normal_before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeNormal</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ¨¡æ‹ŸæŠ˜å åçš„æ³•å‘</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">normal_after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeNormalAfterCollapse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">newPos</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_before</span><span class="p">,</span><span class="w"> </span><span class="n">normal_after</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">)</span><span class="w">  </span><span class="c1">// é˜ˆå€¼</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1835-gpu">18.3.5 GPUå‹å¥½çš„æ•°æ®ç»“æ„</h3>
<p><strong>åŠè¾¹æ•°æ®ç»“æ„çš„GPUå®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">HalfEdge</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vertex</span><span class="p">;</span><span class="w">      </span><span class="c1">// æŒ‡å‘çš„é¡¶ç‚¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">opposite</span><span class="p">;</span><span class="w">    </span><span class="c1">// å¯¹è¾¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">        </span><span class="c1">// ä¸‹ä¸€æ¡åŠè¾¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">face</span><span class="p">;</span><span class="w">        </span><span class="c1">// æ‰€å±é¢</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">CompactMesh</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// SOAå¸ƒå±€æé«˜å†…å­˜åˆå¹¶</span>
<span class="w">    </span><span class="kt">float3</span><span class="o">*</span><span class="w"> </span><span class="n">positions</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float3</span><span class="o">*</span><span class="w"> </span><span class="n">normals</span><span class="p">;</span>
<span class="w">    </span><span class="n">HalfEdge</span><span class="o">*</span><span class="w"> </span><span class="n">halfedges</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">vertexEdges</span><span class="p">;</span><span class="w">    </span><span class="c1">// æ¯ä¸ªé¡¶ç‚¹çš„ä¸€æ¡å‡ºè¾¹</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">collapseEdge</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">edgeId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">HalfEdge</span><span class="w"> </span><span class="n">he</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halfedges</span><span class="p">[</span><span class="n">edgeId</span><span class="p">];</span>
<span class="w">        </span><span class="n">HalfEdge</span><span class="w"> </span><span class="n">opp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">halfedges</span><span class="p">[</span><span class="n">he</span><span class="p">.</span><span class="n">opposite</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// æ›´æ–°æ‹“æ‰‘è¿æ¥</span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">halfedges</span><span class="p">[</span><span class="n">he</span><span class="p">.</span><span class="n">next</span><span class="p">].</span><span class="n">opposite</span><span class="p">,</span><span class="w"> </span><span class="n">opp</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">halfedges</span><span class="p">[</span><span class="n">opp</span><span class="p">.</span><span class="n">next</span><span class="p">].</span><span class="n">opposite</span><span class="p">,</span><span class="w"> </span><span class="n">he</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ ‡è®°åˆ é™¤çš„å…ƒç´ </span>
<span class="w">        </span><span class="n">atomicExch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">halfedges</span><span class="p">[</span><span class="n">edgeId</span><span class="p">].</span><span class="n">vertex</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>å†…å­˜æ± ä¸å‹ç¼©</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">compactMesh</span><span class="p">(</span><span class="n">CompactMesh</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">validFlags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨æµå‹ç¼©ç§»é™¤å·²åˆ é™¤çš„å…ƒç´ </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mesh</span><span class="p">.</span><span class="n">numVertices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mesh</span><span class="p">.</span><span class="n">positions</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DELETED_MARKER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">validFlags</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">validFlags</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨CUBè¿›è¡Œæµå‹ç¼©</span>
<span class="n">cub</span><span class="o">::</span><span class="n">DeviceSelect</span><span class="o">::</span><span class="n">Flagged</span><span class="p">(...)</span>
</code></pre></div>

<h2 id="184">18.4 çº¹ç†æ˜ å°„ä¸æ··åˆ</h2>
<h3 id="1841-uv">18.4.1 UVå‚æ•°åŒ–</h3>
<p>UVå‚æ•°åŒ–å°†3Dç½‘æ ¼è¡¨é¢æ˜ å°„åˆ°2Dçº¹ç†ç©ºé—´ã€‚GPUåŠ é€Ÿçš„å…³é”®åœ¨äºå¹¶è¡ŒåŒ–ä¼˜åŒ–è¿‡ç¨‹ã€‚</p>
<p><strong>æœ€å°åŒ–ç•¸å˜çš„å‚æ•°åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">computeParameterization</span><span class="p">(</span><span class="n">Vertex</span><span class="o">*</span><span class="w"> </span><span class="n">vertices</span><span class="p">,</span><span class="w"> </span><span class="n">Face</span><span class="o">*</span><span class="w"> </span><span class="n">faces</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">float2</span><span class="o">*</span><span class="w"> </span><span class="n">uvCoords</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// LSCMï¼ˆLeast Squares Conformal Mapsï¼‰æ–¹æ³•</span>
<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">gradient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¡ç®—å…±å½¢èƒ½é‡æ¢¯åº¦</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vertices</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">numFaces</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Face</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">faces</span><span class="p">[</span><span class="n">vertices</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">faces</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
<span class="w">        </span><span class="kt">float2</span><span class="w"> </span><span class="n">localGrad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeConformalGradient</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">vid</span><span class="p">);</span>
<span class="w">        </span><span class="n">gradient</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">localGrad</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ¢¯åº¦ä¸‹é™æ›´æ–°</span>
<span class="w">    </span><span class="n">uvCoords</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.01f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gradient</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">__device__</span><span class="w"> </span><span class="kt">float2</span><span class="w"> </span><span class="n">computeConformalGradient</span><span class="p">(</span><span class="n">Face</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">vid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è®¡ç®—è§’åº¦ç•¸å˜</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vertices</span><span class="p">[</span><span class="n">f</span><span class="p">.</span><span class="n">v0</span><span class="p">].</span><span class="n">pos</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vertices</span><span class="p">[</span><span class="n">f</span><span class="p">.</span><span class="n">v1</span><span class="p">].</span><span class="n">pos</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vertices</span><span class="p">[</span><span class="n">f</span><span class="p">.</span><span class="n">v2</span><span class="p">].</span><span class="n">pos</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">uv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uvCoords</span><span class="p">[</span><span class="n">f</span><span class="p">.</span><span class="n">v0</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">uv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uvCoords</span><span class="p">[</span><span class="n">f</span><span class="p">.</span><span class="n">v1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">uv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uvCoords</span><span class="p">[</span><span class="n">f</span><span class="p">.</span><span class="n">v2</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// å…±å½¢æ˜ å°„çš„JacobiançŸ©é˜µ</span>
<span class="w">    </span><span class="n">float2x2</span><span class="w"> </span><span class="n">J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeJacobian</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">uv0</span><span class="p">,</span><span class="w"> </span><span class="n">uv1</span><span class="p">,</span><span class="w"> </span><span class="n">uv2</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æœ€å°åŒ– ||J - cR||Â²ï¼Œå…¶ä¸­Ræ˜¯æ—‹è½¬çŸ©é˜µ</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">computeGradient</span><span class="p">(</span><span class="n">J</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1842">18.4.2 å¤šè§†å›¾çº¹ç†èåˆ</h3>
<p>ä»å¤šä¸ªè§†è§’çš„å›¾åƒä¸­æå–å¹¶èåˆçº¹ç†ä¿¡æ¯ï¼š</p>
<p><strong>è§†å›¾é€‰æ‹©ä¸æƒé‡è®¡ç®—</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">selectBestViews</span><span class="p">(</span><span class="n">Face</span><span class="o">*</span><span class="w"> </span><span class="n">faces</span><span class="p">,</span><span class="w"> </span><span class="n">Camera</span><span class="o">*</span><span class="w"> </span><span class="n">cameras</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">bestViews</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">Face</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">faces</span><span class="p">[</span><span class="n">fid</span><span class="p">];</span>

<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">faceNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeFaceNormal</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">faceCenter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeFaceCenter</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">maxScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0f</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bestView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è¯„ä¼°æ¯ä¸ªç›¸æœºè§†è§’</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numCameras</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">viewDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">cameras</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">faceCenter</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è§†è§’è´¨é‡è¯„åˆ†</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">angleCos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span><span class="w"> </span><span class="n">faceNormal</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">cameras</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">faceCenter</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cameras</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">focalLength</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">distance</span><span class="p">;</span>

<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angleCos</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resolution</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxScore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">maxScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">;</span>
<span class="w">            </span><span class="n">bestView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">bestViews</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestView</span><span class="p">;</span>
<span class="w">    </span><span class="n">weights</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxScore</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>çº¹ç†é‡‡æ ·ä¸æ··åˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">blendTextures</span><span class="p">(</span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">outputTexture</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="n">cudaTextureObject_t</span><span class="o">*</span><span class="w"> </span><span class="n">inputTextures</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">blendWeights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float4</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å¤šè§†å›¾åŠ æƒæ··åˆ</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numViews</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float2</span><span class="w"> </span><span class="n">uv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">projectToView</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">isValidProjection</span><span class="p">(</span><span class="n">uv</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float4</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tex2D</span><span class="o">&lt;</span><span class="kt">float4</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inputTextures</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="w"> </span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blendWeights</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">computeSeamWeight</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>

<span class="w">            </span><span class="n">color</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="w">            </span><span class="n">totalWeight</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">outputTexture</span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalWeight</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1843">18.4.3 æ¥ç¼æ¶ˆé™¤æŠ€æœ¯</h3>
<p><strong>Poissonå›¾åƒç¼–è¾‘</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">poissonBlending</span><span class="p">(</span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">texture</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">seamMask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">seamMask</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åœ¨æ¥ç¼å¤„æ±‚è§£Poissonæ–¹ç¨‹</span>
<span class="w">        </span><span class="kt">float4</span><span class="w"> </span><span class="n">laplacian</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeLaplacian</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float4</span><span class="w"> </span><span class="n">gradient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeSeamGradient</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Jacobiè¿­ä»£</span>
<span class="w">        </span><span class="n">texture</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="n">texture</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">texture</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">texture</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">width</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">texture</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">width</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gradient</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å›¾å‰²ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">graphCutSeam</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">dataCost</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">smoothCost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Î±-expansionç®—æ³•çš„å¹¶è¡Œå®ç°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">currentLabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labels</span><span class="p">[</span><span class="n">pixel</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// è®¡ç®—åˆ‡æ¢æ ‡ç­¾çš„ä»£ä»·</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">costKeep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataCost</span><span class="p">[</span><span class="n">pixel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numLabels</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentLabel</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">costSwitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLT_MAX</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numLabels</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">currentLabel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataCost</span><span class="p">[</span><span class="n">pixel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numLabels</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l</span><span class="p">];</span>

<span class="w">            </span><span class="c1">// æ·»åŠ å¹³æ»‘é¡¹</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">neighbor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNeighbor</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">neighbor</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cost</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">smoothCost</span><span class="p">[</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">labels</span><span class="p">[</span><span class="n">neighbor</span><span class="p">])];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">costSwitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">costSwitch</span><span class="p">,</span><span class="w"> </span><span class="n">cost</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ›´æ–°æ ‡ç­¾</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">costSwitch</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">costKeep</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">labels</span><span class="p">[</span><span class="n">pixel</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argmin</span><span class="p">(</span><span class="n">costSwitch</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1844">18.4.4 çº¹ç†å›¾é›†ç”Ÿæˆ</h3>
<p><strong>çŸ©å½¢æ‰“åŒ…ç®—æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">TextureChart</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">  </span><span class="c1">// åœ¨å›¾é›†ä¸­çš„ä½ç½®</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">packCharts</span><span class="p">(</span><span class="n">TextureChart</span><span class="o">*</span><span class="w"> </span><span class="n">charts</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">atlasSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨æ‰«æçº¿ç®—æ³•å¹¶è¡Œæ‰“åŒ…</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">scanline</span><span class="p">[</span><span class="n">MAX_ATLAS_WIDTH</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">chartId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ‰¾åˆ°æœ€ä½çš„å¯ç”¨ä½ç½®</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_ATLAS_HEIGHT</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">*</span><span class="n">atlasSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">charts</span><span class="p">[</span><span class="n">chartId</span><span class="p">].</span><span class="n">width</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">charts</span><span class="p">[</span><span class="n">chartId</span><span class="p">].</span><span class="n">width</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">maxY</span><span class="p">,</span><span class="w"> </span><span class="n">scanline</span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="p">]);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">maxY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bestY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">bestY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxY</span><span class="p">;</span>
<span class="w">                </span><span class="n">bestX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">charts</span><span class="p">[</span><span class="n">chartId</span><span class="p">].</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestX</span><span class="p">;</span>
<span class="w">        </span><span class="n">charts</span><span class="p">[</span><span class="n">chartId</span><span class="p">].</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestY</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ›´æ–°æ‰«æçº¿</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">charts</span><span class="p">[</span><span class="n">chartId</span><span class="p">].</span><span class="n">width</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">scanline</span><span class="p">[</span><span class="n">bestX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">charts</span><span class="p">[</span><span class="n">chartId</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1845-gpu">18.4.5 GPUçº¹ç†å‹ç¼©</h3>
<p><strong>å®æ—¶DXTå‹ç¼©</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">compressDXT1</span><span class="p">(</span><span class="kt">uchar4</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">uint2</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float3</span><span class="w"> </span><span class="n">colors</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">blockX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">blockY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åŠ è½½4x4å—åˆ°å…±äº«å†…å­˜</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uchar4</span><span class="w"> </span><span class="n">pixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">];</span>
<span class="w">        </span><span class="n">colors</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_float3</span><span class="p">(</span><span class="n">pixel</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">pixel</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">pixel</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// PCAæ‰¾åˆ°ä¸»è½´</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeMean</span><span class="p">(</span><span class="n">colors</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computePrincipalAxis</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æŠ•å½±åˆ°ä¸»è½´æ‰¾åˆ°ç«¯ç‚¹</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">minProj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLT_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">maxProj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">FLT_MAX</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">minIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">maxIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">proj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">proj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minProj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">minProj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proj</span><span class="p">;</span><span class="w"> </span><span class="n">minIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">proj</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxProj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">maxProj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proj</span><span class="p">;</span><span class="w"> </span><span class="n">maxIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ç”Ÿæˆè°ƒè‰²æ¿</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="p">[</span><span class="n">maxIdx</span><span class="p">];</span>
<span class="w">        </span><span class="kt">float3</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="p">[</span><span class="n">minIdx</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// ç¼–ç ç´¢å¼•</span>
<span class="w">        </span><span class="n">uint</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findClosestColor</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">c0</span><span class="p">,</span><span class="w"> </span><span class="n">c1</span><span class="p">);</span>
<span class="w">            </span><span class="n">indices</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ‰“åŒ…è¾“å‡º</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">blockY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">            </span><span class="n">make_uint2</span><span class="p">(</span><span class="n">packColor565</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span><span class="w"> </span><span class="n">c1</span><span class="p">),</span><span class="w"> </span><span class="n">indices</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="185-lod">18.5 LODï¼ˆç»†èŠ‚å±‚æ¬¡ï¼‰ç”Ÿæˆ</h2>
<h3 id="1851-lod">18.5.1 LODç­–ç•¥é€‰æ‹©</h3>
<p>ä¸åŒçš„LODç­–ç•¥é€‚ç”¨äºä¸åŒåœºæ™¯ã€‚GPUå¹¶è¡ŒåŒ–éœ€è¦è€ƒè™‘å„ç­–ç•¥çš„ç‰¹ç‚¹ï¼š</p>
<p><strong>ç¦»æ•£LOD vs è¿ç»­LOD</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="n">LODStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DISCRETE_LOD</span><span class="p">,</span><span class="w">      </span><span class="c1">// é¢„ç”Ÿæˆå›ºå®šå‡ ä¸ªçº§åˆ«</span>
<span class="w">    </span><span class="n">CONTINUOUS_LOD</span><span class="p">,</span><span class="w">    </span><span class="c1">// å®æ—¶è°ƒæ•´ç»†èŠ‚</span>
<span class="w">    </span><span class="n">HLOD</span><span class="p">,</span><span class="w">             </span><span class="c1">// å±‚æ¬¡åŒ–LODï¼Œç”¨äºå¤§è§„æ¨¡åœºæ™¯</span>
<span class="w">    </span><span class="n">PROGRESSIVE_MESH</span><span class="w">  </span><span class="c1">// æ¸è¿›å¼ç½‘æ ¼</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">selectLODLevel</span><span class="p">(</span><span class="n">Object</span><span class="o">*</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">Camera</span><span class="w"> </span><span class="n">camera</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lodLevels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">objPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">oid</span><span class="p">].</span><span class="n">center</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">camera</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">objPos</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">screenSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">oid</span><span class="p">].</span><span class="n">radius</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">fov</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åŸºäºå±å¹•è¦†ç›–ç‡é€‰æ‹©LOD</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">screenSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">)</span><span class="w"> </span><span class="n">lodLevels</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">      </span><span class="c1">// æœ€é«˜ç»†èŠ‚</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">screenSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">)</span><span class="w"> </span><span class="n">lodLevels</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// ä¸­ç­‰ç»†èŠ‚</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">screenSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.02f</span><span class="p">)</span><span class="w"> </span><span class="n">lodLevels</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// ä½ç»†èŠ‚</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">lodLevels</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">                        </span><span class="c1">// æœ€ä½ç»†èŠ‚</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1852">18.5.2 æ¸è¿›ç½‘æ ¼æ„å»º</h3>
<p><strong>è¾¹æŠ˜å åºåˆ—è®°å½•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">CollapseRecord</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">;</span><span class="w">           </span><span class="c1">// æŠ˜å çš„è¾¹</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">newPos</span><span class="p">;</span><span class="w">        </span><span class="c1">// æ–°é¡¶ç‚¹ä½ç½®</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">affectedFaces</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w"> </span><span class="c1">// å—å½±å“çš„é¢</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numAffected</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">buildProgressiveMesh</span><span class="p">(</span><span class="n">Mesh</span><span class="o">*</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                     </span><span class="n">CollapseRecord</span><span class="o">*</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¹¶è¡Œè¯„ä¼°æ‰€æœ‰è¾¹çš„æŠ˜å ä»£ä»·</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">costs</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">edges</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>

<span class="w">    </span><span class="n">costs</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeCollapseCost</span><span class="p">(</span><span class="n">mesh</span><span class="o">-&gt;</span><span class="n">edges</span><span class="p">[</span><span class="n">eid</span><span class="p">]);</span>
<span class="w">    </span><span class="n">edges</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eid</span><span class="p">;</span>
<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// å—å†…æ‰¾æœ€å°ä»£ä»·</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">costs</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">costs</span><span class="p">[</span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">costs</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">costs</span><span class="p">[</span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">];</span>
<span class="w">            </span><span class="n">edges</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edges</span><span class="p">[</span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è®°å½•æŠ˜å ä¿¡æ¯</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestEdge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">        </span><span class="n">records</span><span class="p">[</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createCollapseRecord</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">bestEdge</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æ¸è¿›ä¼ è¾“ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ProgressiveStream</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åŸºç¡€ç½‘æ ¼</span>
<span class="w">    </span><span class="kt">float3</span><span class="o">*</span><span class="w"> </span><span class="n">baseVertices</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int3</span><span class="o">*</span><span class="w"> </span><span class="n">baseFaces</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">baseVertCount</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç»†åŒ–è®°å½•ï¼ˆå‹ç¼©å­˜å‚¨ï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">RefinementOp</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">parentVertex</span><span class="p">;</span><span class="w">    </span><span class="c1">// çˆ¶é¡¶ç‚¹ç´¢å¼•</span>
<span class="w">        </span><span class="kt">int8_t</span><span class="w"> </span><span class="n">deltaX</span><span class="p">,</span><span class="w"> </span><span class="n">deltaY</span><span class="p">,</span><span class="w"> </span><span class="n">deltaZ</span><span class="p">;</span><span class="w"> </span><span class="c1">// ä½ç½®å¢é‡ï¼ˆé‡åŒ–ï¼‰</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">faceConfig</span><span class="p">;</span><span class="w">       </span><span class="c1">// é¢æ‹†åˆ†é…ç½®</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">refinements</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">refineToLevel</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">targetLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentLevel</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targetLevel</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">applyRefinement</span><span class="p">(</span><span class="n">refinements</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1853">18.5.3 è§†è§‰è´¨é‡åº¦é‡</h3>
<p><strong>å±å¹•ç©ºé—´è¯¯å·®</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">computeScreenSpaceError</span><span class="p">(</span><span class="n">Triangle</span><span class="w"> </span><span class="n">tri</span><span class="p">,</span><span class="w"> </span><span class="n">Camera</span><span class="w"> </span><span class="n">cam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æŠ•å½±ä¸‰è§’å½¢åˆ°å±å¹•ç©ºé—´</span>
<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">projectToScreen</span><span class="p">(</span><span class="n">tri</span><span class="p">.</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">cam</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">projectToScreen</span><span class="p">(</span><span class="n">tri</span><span class="p">.</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">cam</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float2</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">projectToScreen</span><span class="p">(</span><span class="n">tri</span><span class="p">.</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">cam</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¡ç®—å±å¹•ç©ºé—´é¢ç§¯</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">screenArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">abs</span><span class="p">((</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p0</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>
<span class="w">                          </span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p0</span><span class="p">.</span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®¡ç®—å‡ ä½•è¯¯å·®</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">geometricError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeHausdorffDistance</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span><span class="w"> </span><span class="n">originalMesh</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç»„åˆåº¦é‡</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">screenArea</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">geometricError</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æ„ŸçŸ¥è´¨é‡åº¦é‡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">computePerceptualError</span><span class="p">(</span><span class="n">Mesh</span><span class="o">*</span><span class="w"> </span><span class="n">lod</span><span class="p">,</span><span class="w"> </span><span class="n">Mesh</span><span class="o">*</span><span class="w"> </span><span class="n">original</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">errors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®¡ç®—æ³•å‘é‡å·®å¼‚</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">lodNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeFaceNormal</span><span class="p">(</span><span class="n">lod</span><span class="o">-&gt;</span><span class="n">faces</span><span class="p">[</span><span class="n">fid</span><span class="p">]);</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">origNormal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findClosestNormal</span><span class="p">(</span><span class="n">original</span><span class="p">,</span><span class="w"> </span><span class="n">lod</span><span class="o">-&gt;</span><span class="n">faces</span><span class="p">[</span><span class="n">fid</span><span class="p">]);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">normalError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">lodNormal</span><span class="p">,</span><span class="w"> </span><span class="n">origNormal</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¡ç®—è½®å»“ä¿æŒåº¦</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">silhouetteError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeSilhouetteDeviation</span><span class="p">(</span><span class="n">lod</span><span class="p">,</span><span class="w"> </span><span class="n">original</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¡ç®—çº¹ç†åæ ‡ç•¸å˜</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">uvDistortion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeUVDistortion</span><span class="p">(</span><span class="n">lod</span><span class="o">-&gt;</span><span class="n">faces</span><span class="p">[</span><span class="n">fid</span><span class="p">]);</span>

<span class="w">    </span><span class="c1">// åŠ æƒç»„åˆ</span>
<span class="w">    </span><span class="n">errors</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.4f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">normalError</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                  </span><span class="mf">0.4f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">silhouetteError</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                  </span><span class="mf">0.2f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">uvDistortion</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1854-lod">18.5.4 å®æ—¶LODåˆ‡æ¢</h3>
<p><strong>æ— ç¼è¿‡æ¸¡æŠ€æœ¯</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">blendLODs</span><span class="p">(</span><span class="n">Vertex</span><span class="o">*</span><span class="w"> </span><span class="n">lod0</span><span class="p">,</span><span class="w"> </span><span class="n">Vertex</span><span class="o">*</span><span class="w"> </span><span class="n">lod1</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="kt">float</span><span class="w"> </span><span class="n">blendFactor</span><span class="p">,</span><span class="w"> </span><span class="n">Vertex</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ‰¾åˆ°å¯¹åº”é¡¶ç‚¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vid1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findCorrespondingVertex</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span><span class="w"> </span><span class="n">lod0</span><span class="p">,</span><span class="w"> </span><span class="n">lod1</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">vid1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// çº¿æ€§æ’å€¼ä½ç½®å’Œæ³•å‘</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lerp</span><span class="p">(</span><span class="n">lod0</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">position</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="n">lod1</span><span class="p">[</span><span class="n">vid1</span><span class="p">].</span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="n">blendFactor</span><span class="p">);</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">lerp</span><span class="p">(</span><span class="n">lod0</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">normal</span><span class="p">,</span>
<span class="w">                                           </span><span class="n">lod1</span><span class="p">[</span><span class="n">vid1</span><span class="p">].</span><span class="n">normal</span><span class="p">,</span><span class="w"> </span><span class="n">blendFactor</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ¸éšå¤„ç†å­¤ç«‹é¡¶ç‚¹</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lod0</span><span class="p">[</span><span class="n">vid</span><span class="p">];</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">blendFactor</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>åœ°ç†è£å‰ªLODï¼ˆGeomorphingï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">geomorphLOD</span><span class="p">(</span><span class="n">Vertex</span><span class="o">*</span><span class="w"> </span><span class="n">vertices</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">morphWeights</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">float3</span><span class="o">*</span><span class="w"> </span><span class="n">targetPositions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">morphWeights</span><span class="p">[</span><span class="n">vid</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡ä½ç½®</span>
<span class="w">    </span><span class="n">vertices</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vertices</span><span class="p">[</span><span class="n">vid</span><span class="p">].</span><span class="n">position</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                             </span><span class="n">targetPositions</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// é‡æ–°è®¡ç®—æ³•å‘é‡</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.01f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">recomputeVertexNormal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vertices</span><span class="p">[</span><span class="n">vid</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1855">18.5.5 å†…å­˜ç®¡ç†ä¼˜åŒ–</h3>
<p><strong>LODç¼“å­˜ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">class</span><span class="w"> </span><span class="n">LODCache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">CacheEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">objectId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lodLevel</span><span class="p">;</span>
<span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">gpuData</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">refCount</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">CacheEntry</span><span class="o">*</span><span class="w"> </span><span class="n">entries</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lruList</span><span class="p">;</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">fetchLOD</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">objId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objId</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">CACHE_SIZE</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥ç¼“å­˜å‘½ä¸­</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">objectId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">objId</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">           </span><span class="n">entries</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">lodLevel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">refCount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">updateLRU</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">entries</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">gpuData</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ç¼“å­˜æœªå‘½ä¸­ï¼Œè§¦å‘å¼‚æ­¥åŠ è½½</span>
<span class="w">        </span><span class="n">requestAsyncLoad</span><span class="p">(</span><span class="n">objId</span><span class="p">,</span><span class="w"> </span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">__device__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">evictLRU</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lruList</span><span class="p">[</span><span class="n">CACHE_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">victim</span><span class="p">].</span><span class="n">refCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">freeGPUMemory</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">victim</span><span class="p">].</span><span class="n">gpuData</span><span class="p">);</span>
<span class="w">            </span><span class="n">entries</span><span class="p">[</span><span class="n">victim</span><span class="p">].</span><span class="n">objectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>æµå¼LODåŠ è½½</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">streamLODData</span><span class="p">(</span><span class="n">LODRequest</span><span class="o">*</span><span class="w"> </span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numRequests</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numRequests</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LODRequest</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requests</span><span class="p">[</span><span class="n">rid</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// è®¡ç®—éœ€è¦çš„å†…å­˜</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">vertexCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getVertexCount</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">objId</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">faceCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFaceCount</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">objId</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆ†é…GPUå†…å­˜</span>
<span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">gpuMem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocateFromPool</span><span class="p">(</span><span class="n">vertexCount</span><span class="p">,</span><span class="w"> </span><span class="n">faceCount</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¼‚æ­¥ä¼ è¾“æ•°æ®</span>
<span class="w">        </span><span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="n">gpuMem</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">getLODData</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">objId</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">level</span><span class="p">),</span>
<span class="w">                       </span><span class="n">getDataSize</span><span class="p">(</span><span class="n">vertexCount</span><span class="p">,</span><span class="w"> </span><span class="n">faceCount</span><span class="p">),</span>
<span class="w">                       </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">,</span>
<span class="w">                       </span><span class="n">req</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ›´æ–°ç¼“å­˜</span>
<span class="w">        </span><span class="n">updateCache</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">objId</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">gpuMem</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†å¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–çš„GPUåŠ é€ŸæŠ€æœ¯ã€‚æˆ‘ä»¬å­¦ä¹ äº†ï¼š</p>
<ol>
<li><strong>Poissoné‡å»ºåŠ é€Ÿ</strong>ï¼šé€šè¿‡å…«å‰æ ‘å¹¶è¡Œæ„å»ºã€ç¨€ç–çº¿æ€§ç³»ç»Ÿçš„GPUæ±‚è§£ï¼Œå®ç°äº†40å€ä»¥ä¸Šçš„åŠ é€Ÿæ¯”</li>
<li><strong>Marching Cubeså¹¶è¡ŒåŒ–</strong>ï¼šä½¿ç”¨ä¸¤éæ‰«æã€æµå‹ç¼©å’ŒæŸ¥æ‰¾è¡¨ä¼˜åŒ–ï¼Œé«˜æ•ˆç”Ÿæˆä¸‰è§’ç½‘æ ¼</li>
<li><strong>ç½‘æ ¼ç®€åŒ–ä¼˜åŒ–</strong>ï¼šå®ç°äº†GPUå‹å¥½çš„è¾¹æŠ˜å ç®—æ³•ï¼ŒåŒ…æ‹¬QEMè¯¯å·®åº¦é‡å’Œæ‹“æ‰‘ä¿æŒ</li>
<li><strong>çº¹ç†æ˜ å°„æŠ€æœ¯</strong>ï¼šæŒæ¡äº†UVå‚æ•°åŒ–ã€å¤šè§†å›¾èåˆã€æ¥ç¼æ¶ˆé™¤ç­‰å…³é”®æŠ€æœ¯</li>
<li><strong>LODç³»ç»Ÿè®¾è®¡</strong>ï¼šæ„å»ºäº†å®Œæ•´çš„å¤šç»†èŠ‚å±‚æ¬¡ç³»ç»Ÿï¼Œæ”¯æŒæ¸è¿›ä¼ è¾“å’Œå®æ—¶åˆ‡æ¢</li>
</ol>
<p>å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼š</p>
<ul>
<li>Poissoné‡å»ºï¼š1000ä¸‡ç‚¹ ~2.5ç§’ï¼ˆRTX 4090ï¼‰</li>
<li>Marching Cubesï¼š512Â³ä½“ç´  ~50ms</li>
<li>ç½‘æ ¼ç®€åŒ–ï¼š100ä¸‡é¢ç®€åŒ–åˆ°10ä¸‡é¢ ~200ms</li>
<li>LODåˆ‡æ¢ï¼š&lt;1mså»¶è¿Ÿï¼Œæ”¯æŒä¸Šåƒä¸ªå¯¹è±¡</li>
</ul>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>å…«å‰æ ‘æ„å»ºä¼˜åŒ–</strong>
   å®ç°ä¸€ä¸ªå¹¶è¡Œçš„è‡ªé€‚åº”å…«å‰æ ‘æ„å»ºç®—æ³•ï¼Œè¦æ±‚æ”¯æŒä¸å‡åŒ€ç‚¹äº‘åˆ†å¸ƒã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨Mortonç¼–ç è¿›è¡Œç©ºé—´æ’åºï¼Œåˆ©ç”¨åŸå­æ“ä½œå¤„ç†èŠ‚ç‚¹åˆ†è£‚ã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   ä½¿ç”¨Z-orderæ›²çº¿å°†3Dåæ ‡æ˜ å°„åˆ°1Dï¼Œå…ˆå¯¹ç‚¹è¿›è¡Œæ’åºï¼Œç„¶åå¹¶è¡Œæ„å»ºèŠ‚ç‚¹ã€‚å…³é”®æ˜¯ä½¿ç”¨åŸå­æ“ä½œatomicMaxæ¥ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹çš„ç»†åˆ†æ·±åº¦ï¼Œé¿å…ç«äº‰æ¡ä»¶ã€‚é‡‡ç”¨è‡ªåº•å‘ä¸Šçš„æ„å»ºç­–ç•¥ï¼Œå…ˆåˆ›å»ºå¶èŠ‚ç‚¹ï¼Œå†åˆå¹¶ç”Ÿæˆçˆ¶èŠ‚ç‚¹ã€‚
   </details>
<ol start="2">
<li><strong>Marching CubesæŸ¥æ‰¾è¡¨ç”Ÿæˆ</strong>
   ç¼–å†™ä»£ç è‡ªåŠ¨ç”ŸæˆMarching Cubesçš„256ç§é…ç½®æŸ¥æ‰¾è¡¨ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šåˆ©ç”¨å¯¹ç§°æ€§å‡å°‘ç‹¬ç«‹é…ç½®æ•°é‡ã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   256ç§é…ç½®å®é™…åªæœ‰15ç§åŸºæœ¬æƒ…å†µï¼Œå…¶ä½™é€šè¿‡æ—‹è½¬å’Œé•œåƒå˜æ¢å¾—åˆ°ã€‚é¦–å…ˆç”Ÿæˆ15ç§åŸºæœ¬é…ç½®çš„ä¸‰è§’å½¢æ¨¡æ¿ï¼Œç„¶åé€šè¿‡24ç§å¯¹ç§°å˜æ¢ï¼ˆ8ä¸ªé¡¶ç‚¹çš„ç½®æ¢ï¼‰ç”Ÿæˆå®Œæ•´æŸ¥æ‰¾è¡¨ã€‚ä½¿ç”¨ä½æ“ä½œå¿«é€Ÿè®¡ç®—é…ç½®ç´¢å¼•ã€‚
   </details>
<ol start="3">
<li><strong>ç®€å•QEMå®ç°</strong>
   å®ç°åŸºæœ¬çš„äºŒæ¬¡è¯¯å·®åº¦é‡è®¡ç®—ï¼Œç”¨äºè¯„ä¼°è¾¹æŠ˜å ä»£ä»·ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šQEMå¯ä»¥è¡¨ç¤ºä¸º4x4å¯¹ç§°çŸ©é˜µã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   æ¯ä¸ªé¡¶ç‚¹å…³è”ä¸€ä¸ª4x4çš„äºŒæ¬¡å‹çŸ©é˜µQï¼Œè¡¨ç¤ºåˆ°ç›¸é‚»å¹³é¢çš„è·ç¦»å¹³æ–¹å’Œã€‚è¾¹æŠ˜å æ—¶ï¼Œæ–°é¡¶ç‚¹çš„QçŸ©é˜µæ˜¯ä¸¤ä¸ªç«¯ç‚¹QçŸ©é˜µä¹‹å’Œã€‚æŠ˜å ä»£ä»·é€šè¿‡æ±‚è§£çº¿æ€§ç³»ç»Ÿâˆ‡(v^T Q v) = 0å¾—åˆ°æœ€ä¼˜ä½ç½®ï¼Œå†è®¡ç®—è¯¥ä½ç½®çš„è¯¯å·®å€¼ã€‚
   </details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<ol start="4">
<li><strong>å¹¶è¡ŒPoissonæ±‚è§£å™¨</strong>
   å®ç°ä¸€ä¸ªé«˜æ•ˆçš„GPUå¤šé‡ç½‘æ ¼æ±‚è§£å™¨ï¼Œç”¨äºPoissoné‡å»ºã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨çº¢é»‘Gauss-Seidelä½œä¸ºå¹³æ»‘å™¨ã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   å®ç°V-cycleå¤šé‡ç½‘æ ¼ï¼Œæ¯å±‚ä½¿ç”¨çº¢é»‘ç€è‰²çš„Gauss-Seidelè¿­ä»£ã€‚çº¢é»‘ç€è‰²å…è®¸å¹¶è¡Œæ›´æ–°åŒè‰²èŠ‚ç‚¹ã€‚é™åˆ¶å’Œå»¶æ‹“æ“ä½œä½¿ç”¨ä¸‰çº¿æ€§æ’å€¼ã€‚ç²—ç½‘æ ¼ç›´æ¥æ±‚è§£ä½¿ç”¨å…±è½­æ¢¯åº¦æ³•ã€‚å…³é”®ä¼˜åŒ–åŒ…æ‹¬ï¼šçº¹ç†å†…å­˜ç¼“å­˜ç³»æ•°çŸ©é˜µï¼Œå…±äº«å†…å­˜ç¼“å­˜æ¨¡æ¿å€¼ï¼Œä½¿ç”¨shuffleæŒ‡ä»¤åŠ é€Ÿå½’çº¦ã€‚
   </details>
<ol start="5">
<li><strong>å®æ—¶ç½‘æ ¼ç®€åŒ–ç³»ç»Ÿ</strong>
   è®¾è®¡ä¸€ä¸ªæ”¯æŒè§†ç‚¹ç›¸å…³ç®€åŒ–çš„å®æ—¶ç³»ç»Ÿï¼Œèƒ½æ ¹æ®è§‚å¯Ÿè§’åº¦åŠ¨æ€è°ƒæ•´ç½‘æ ¼ç»†èŠ‚ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šç»“åˆå±å¹•ç©ºé—´è¯¯å·®å’Œå‡ ä½•è¯¯å·®ã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   ä½¿ç”¨åŒç¼“å†²æœºåˆ¶ï¼Œä¸€ä¸ªç”¨äºæ¸²æŸ“ï¼Œä¸€ä¸ªç”¨äºç®€åŒ–ã€‚æ ¹æ®è§†ç‚¹è®¡ç®—æ¯ä¸ªé¢çš„é‡è¦æ€§åˆ†æ•°ï¼Œä¼˜å…ˆç®€åŒ–èƒŒå‘é¢å’Œè¿œå¤„ç»†èŠ‚ã€‚ä½¿ç”¨GPUä¼˜å…ˆé˜Ÿåˆ—ç®¡ç†è¾¹æŠ˜å æ“ä½œï¼Œæ¯å¸§é™åˆ¶æ“ä½œæ•°é‡ä¿è¯å®æ—¶æ€§ã€‚å®ç°å¢é‡å¼æ›´æ–°ï¼Œé¿å…å…¨å±€é‡å»ºã€‚
   </details>
<ol start="6">
<li><strong>æ— ç¼çº¹ç†å›¾é›†ç”Ÿæˆ</strong>
   å®ç°ä¸€ä¸ªGPUåŠ é€Ÿçš„çº¹ç†å›¾é›†æ‰“åŒ…ç®—æ³•ï¼Œæœ€å°åŒ–çº¹ç†æµªè´¹å¹¶æ¶ˆé™¤æ¥ç¼ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨æœ€å¤§çŸ©å½¢ç®—æ³•å’ŒPoissonæ··åˆã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   å…ˆä½¿ç”¨å¹¶è¡Œçš„æœ€å¤§çŸ©å½¢ç®—æ³•æ‰¾åˆ°æœ€ä¼˜æ‰“åŒ…æ–¹æ¡ˆï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸€ä¸ªchartçš„æ”¾ç½®ã€‚ä½¿ç”¨æ‰«æçº¿ç®—æ³•ç»´æŠ¤å¯ç”¨ç©ºé—´ã€‚å¯¹äºæ¥ç¼ï¼Œåœ¨chartè¾¹ç•Œæ‰©å±•å‡ ä¸ªåƒç´ ï¼Œä½¿ç”¨Poissonæ–¹ç¨‹æ··åˆç›¸é‚»chartçš„é¢œè‰²ã€‚æœ€åä½¿ç”¨mipmapé‡‘å­—å¡”å¡«å……æœªä½¿ç”¨åŒºåŸŸï¼Œé¿å…é‡‡æ ·é”™è¯¯ã€‚
   </details>
<ol start="7">
<li><strong>HLODè‡ªåŠ¨ç”Ÿæˆ</strong>
   å®ç°å±‚æ¬¡åŒ–LODï¼ˆHLODï¼‰ç³»ç»Ÿï¼Œè‡ªåŠ¨åˆå¹¶è¿œå¤„çš„å¤šä¸ªå¯¹è±¡ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨ç©ºé—´èšç±»å’Œä»£ç†å‡ ä½•ä½“ã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   ä½¿ç”¨å…«å‰æ ‘æˆ–KDæ ‘è¿›è¡Œç©ºé—´åˆ’åˆ†ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨å­å¯¹è±¡çš„ç®€åŒ–ç‰ˆæœ¬ã€‚å½“èŠ‚ç‚¹è¦†ç›–çš„å±å¹•ç©ºé—´å°äºé˜ˆå€¼æ—¶ï¼Œç”¨å•ä¸ªä»£ç†å‡ ä½•ä½“æ›¿æ¢æ‰€æœ‰å­å¯¹è±¡ã€‚ä»£ç†å‡ ä½•ä½“é€šè¿‡ä½“ç´ åŒ–å’ŒMarching Cubesç”Ÿæˆã€‚ä½¿ç”¨impostoræŠ€æœ¯ä¸ºæè¿œè·ç¦»çš„å¯¹è±¡ç¾¤ç”Ÿæˆbillboardã€‚
   </details>
<ol start="8">
<li><strong>GPUåŠ é€Ÿçš„ç½‘æ ¼ä¿®å¤</strong>
   è®¾è®¡ä¸€ä¸ªè‡ªåŠ¨ä¿®å¤ç½‘æ ¼æ‹“æ‰‘é”™è¯¯çš„GPUç®—æ³•ï¼Œå¤„ç†å­”æ´ã€è‡ªç›¸äº¤ç­‰é—®é¢˜ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨ä½“ç´ åŒ–æ£€æµ‹å’Œä¿®å¤æ‹“æ‰‘é—®é¢˜ã€‚</p>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   é¦–å…ˆä½“ç´ åŒ–ç½‘æ ¼å¾—åˆ°æ°´å¯†çš„è·ç¦»åœºï¼Œç„¶åç”¨Marching Cubesé‡æ–°æå–è¡¨é¢ã€‚å¯¹äºå°å­”æ´ï¼Œä½¿ç”¨advancing frontæ–¹æ³•å¹¶è¡Œå¡«å……ã€‚å¯¹äºè‡ªç›¸äº¤ï¼Œé€šè¿‡å°„çº¿æŠ•å°„æ£€æµ‹å¹¶ä½¿ç”¨BSPæ ‘åˆ†å‰²ç›¸äº¤é¢ã€‚ä½¿ç”¨å¹¶è¡Œçš„è¿é€šåˆ†é‡æ ‡è®°ç®—æ³•ç§»é™¤å­¤ç«‹çš„å°éƒ¨ä»¶ã€‚æœ€åè¿è¡ŒLaplacianå¹³æ»‘æ”¹å–„ç½‘æ ¼è´¨é‡ã€‚
   </details>
<h2 id="_5">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<ol>
<li>
<p><strong>å…«å‰æ ‘éå†çš„å†…å­˜è®¿é—®æ¨¡å¼</strong>
   - é”™è¯¯ï¼šéšæœºè®¿é—®å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ç‡é«˜
   - æ­£ç¡®ï¼šä½¿ç”¨Mortoné¡ºåºæ”¹å–„ç©ºé—´å±€éƒ¨æ€§</p>
</li>
<li>
<p><strong>Marching Cubesçš„é‡å¤é¡¶ç‚¹</strong>
   - é”™è¯¯ï¼šæ¯ä¸ªä½“ç´ ç‹¬ç«‹ç”Ÿæˆé¡¶ç‚¹ï¼Œé€ æˆå¤§é‡é‡å¤
   - æ­£ç¡®ï¼šä½¿ç”¨å“ˆå¸Œè¡¨æˆ–è¾¹ç´¢å¼•å»é‡</p>
</li>
<li>
<p><strong>ç½‘æ ¼ç®€åŒ–çš„æ‹“æ‰‘ç ´å</strong>
   - é”™è¯¯ï¼šç›²ç›®æŠ˜å è¾¹å¯¼è‡´éæµå½¢ç»“æ„
   - æ­£ç¡®ï¼šå®æ–½é“¾æ¥æ¡ä»¶æ£€æŸ¥</p>
</li>
<li>
<p><strong>çº¹ç†æ¥ç¼çš„å¯è§æ€§</strong>
   - é”™è¯¯ï¼šç®€å•çš„çº¿æ€§æ··åˆåœ¨å…‰ç…§ä¸‹ä»å¯è§
   - æ­£ç¡®ï¼šä½¿ç”¨Poissonæ··åˆæˆ–å›¾å‰²ä¼˜åŒ–</p>
</li>
<li>
<p><strong>LODåˆ‡æ¢çš„çªå˜</strong>
   - é”™è¯¯ï¼šç›´æ¥åˆ‡æ¢é€ æˆæ˜æ˜¾è·³å˜
   - æ­£ç¡®ï¼šä½¿ç”¨geomorphingæˆ–alphaæ··åˆ</p>
</li>
<li>
<p><strong>å†…å­˜æ³„æ¼å’Œç¢ç‰‡åŒ–</strong>
   - é”™è¯¯ï¼šé¢‘ç¹çš„cudaMalloc/cudaFree
   - æ­£ç¡®ï¼šä½¿ç”¨å†…å­˜æ± å’Œå‹ç¼©ç­–ç•¥</p>
</li>
</ol>
<h2 id="_6">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_7">ç®—æ³•é€‰æ‹©</h3>
<ul>
<li>[ ] æ ¹æ®è¾“å…¥æ•°æ®ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„é‡å»ºç®—æ³•</li>
<li>[ ] è¯„ä¼°è´¨é‡vsé€Ÿåº¦çš„æƒè¡¡</li>
<li>[ ] è€ƒè™‘å†…å­˜é™åˆ¶é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„</li>
</ul>
<h3 id="_8">æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>[ ] ä½¿ç”¨çº¹ç†å†…å­˜ç¼“å­˜åªè¯»æ•°æ®</li>
<li>[ ] åˆå¹¶å†…å­˜è®¿é—®ï¼Œä½¿ç”¨å‘é‡åŒ–load/store</li>
<li>[ ] å¹³è¡¡å¯„å­˜å™¨ä½¿ç”¨å’Œå ç”¨ç‡</li>
<li>[ ] å®ç°å¤šæµå¹¶å‘å’Œå¼‚æ­¥æ“ä½œ</li>
</ul>
<h3 id="_9">è´¨é‡ä¿è¯</h3>
<ul>
<li>[ ] å®æ–½æ‹“æ‰‘ä¸€è‡´æ€§æ£€æŸ¥</li>
<li>[ ] éªŒè¯æ³•å‘é‡æ–¹å‘æ­£ç¡®æ€§</li>
<li>[ ] æµ‹è¯•æç«¯æƒ…å†µï¼ˆé€€åŒ–ä¸‰è§’å½¢ã€å­¤ç«‹é¡¶ç‚¹ç­‰ï¼‰</li>
<li>[ ] ç¡®ä¿æ•°å€¼ç¨³å®šæ€§</li>
</ul>
<h3 id="_10">å†…å­˜ç®¡ç†</h3>
<ul>
<li>[ ] å®ç°å†…å­˜æ± é¿å…ç¢ç‰‡åŒ–</li>
<li>[ ] ä½¿ç”¨æµå‹ç¼©ç§»é™¤æ— æ•ˆå…ƒç´ </li>
<li>[ ] ç›‘æ§GPUå†…å­˜ä½¿ç”¨æƒ…å†µ</li>
<li>[ ] å®æ–½å†…å­˜é¢„ç®—æ§åˆ¶</li>
</ul>
<h3 id="_11">ç³»ç»Ÿé›†æˆ</h3>
<ul>
<li>[ ] è®¾è®¡æ¸…æ™°çš„APIæ¥å£</li>
<li>[ ] æä¾›åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ¨¡å¼</li>
<li>[ ] å®ç°é”™è¯¯æ¢å¤æœºåˆ¶</li>
<li>[ ] æ”¯æŒå¢é‡å¼æ›´æ–°</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter17.html" class="nav-link prev">â† ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</a><a href="chapter19.html" class="nav-link next">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±• â†’</a></nav>
        </main>
    </div>
</body>
</html>