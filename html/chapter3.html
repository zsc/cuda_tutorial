<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">CUDA é«˜æ€§èƒ½ç¼–ç¨‹å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šCUDAç¡¬ä»¶æ¶æ„æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šå¯„å­˜å™¨ä¼˜åŒ–ä¸å¸¸é‡å†…å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šWarpçº§ç¼–ç¨‹ä¸åä½œç»„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šåŸå­æ“ä½œä¸åŒæ­¥åŸè¯­</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šPTXå†…è”ä¸åº•å±‚ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šå¼ é‡æ ¸å¿ƒä¸æ··åˆç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šCUTLASSæ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šæ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå¤šä¼ æ„Ÿå™¨èåˆçš„å¹¶è¡ŒåŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®æ—¶è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šè·¯å¾„è§„åˆ’ä¸è½¨è¿¹ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šè§†è§‰SLAMçš„GPUåŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šæœºæ¢°è‡‚è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šå¼ºåŒ–å­¦ä¹ æ¨ç†åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šå¤§è§„æ¨¡ç‚¹äº‘é‡å»ºä¸ç½‘æ ¼åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šå¤šGPUç¼–ç¨‹ä¸æ‰©å±•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šCUDA Graphä¸å†…æ ¸èåˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šåµŒå…¥å¼GPUå¼€å‘ï¼ˆJetsonï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šç¨€ç–è®¡ç®—ä¸åŠ¨æ€ç¨€ç–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šé‡åŒ–ä¸ä½ç²¾åº¦è®¡ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šæ–°ä¸€ä»£GPUç‰¹æ€§å±•æœ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒä¼˜æ–¹æ³•è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šCUDAè°ƒè¯•æŠ€æœ¯ä¸é”™è¯¯å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå¼€å‘ç¯å¢ƒä¸å·¥å…·é“¾é…ç½®</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="3">ç¬¬3ç« ï¼šå…¨å±€å†…å­˜ä¼˜åŒ–ç­–ç•¥</h1>
<p>å…¨å±€å†…å­˜æ˜¯CUDAç¼–ç¨‹ä¸­æœ€åŸºç¡€ä¹Ÿæ˜¯æœ€å…³é”®çš„å†…å­˜ç±»å‹ã€‚ä½œä¸ºGPUä¸Šå®¹é‡æœ€å¤§çš„å†…å­˜ç©ºé—´ï¼Œå…¨å±€å†…å­˜æ‰¿è½½ç€ç»å¤§éƒ¨åˆ†çš„æ•°æ®å­˜å‚¨å’Œä¼ è¾“ä»»åŠ¡ã€‚ç„¶è€Œï¼Œå®ƒä¹Ÿæ˜¯å»¶è¿Ÿæœ€é«˜çš„å†…å­˜å±‚çº§ï¼Œä¸€æ¬¡æœªä¼˜åŒ–çš„å…¨å±€å†…å­˜è®¿é—®å¯èƒ½éœ€è¦æ•°ç™¾ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚åœ¨è‡ªåŠ¨é©¾é©¶çš„æ¿€å…‰é›·è¾¾ç‚¹äº‘å¤„ç†æˆ–å…·èº«æ™ºèƒ½çš„é«˜åˆ†è¾¨ç‡è§†è§‰SLAMä¸­ï¼Œæ¯ç§’éœ€è¦å¤„ç†GBçº§åˆ«çš„æ•°æ®ï¼Œå†…å­˜å¸¦å®½å¾€å¾€æˆä¸ºåˆ¶çº¦ç³»ç»Ÿæ€§èƒ½çš„ä¸»è¦ç“¶é¢ˆã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨å…¨å±€å†…å­˜çš„è®¿é—®æœºåˆ¶ï¼ŒæŒæ¡åˆå¹¶è®¿é—®ã€ç¼“å­˜ä¼˜åŒ–ã€å‘é‡åŒ–ç­‰å…³é”®æŠ€æœ¯ï¼Œæœ€ç»ˆå®ç°æ¥è¿‘ç¡¬ä»¶ç†è®ºå³°å€¼çš„å†…å­˜å¸¦å®½åˆ©ç”¨ç‡ã€‚</p>
<h2 id="31">3.1 å†…å­˜åˆå¹¶è®¿é—®æ¨¡å¼</h2>
<h3 id="311">3.1.1 åˆå¹¶è®¿é—®çš„ç¡¬ä»¶æœºåˆ¶</h3>
<p>å½“ä¸€ä¸ªwarpï¼ˆ32ä¸ªçº¿ç¨‹ï¼‰æ‰§è¡Œå†…å­˜è®¿é—®æŒ‡ä»¤æ—¶ï¼Œç¡¬ä»¶ä¼šå°è¯•å°†è¿™äº›è®¿é—®åˆå¹¶æˆå°½å¯èƒ½å°‘çš„å†…å­˜äº‹åŠ¡ã€‚ç°ä»£GPUæ”¯æŒ32å­—èŠ‚ã€64å­—èŠ‚å’Œ128å­—èŠ‚ä¸‰ç§äº‹åŠ¡å¤§å°ï¼Œé€‰æ‹©å“ªç§å–å†³äºè®¿é—®çš„åœ°å€åˆ†å¸ƒå’Œæ•°æ®é‡ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nx">å†…å­˜äº‹åŠ¡ç”Ÿæˆè§„åˆ™</span><span class="err">ï¼š</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Warpå†…32ä¸ªçº¿ç¨‹çš„å†…å­˜è¯·æ±‚</span><span class="w">                    </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Thread</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nx">addr_0</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Thread</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nx">addr_1</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">...</span><span class="w">                                        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">Thread</span><span class="w"> </span><span class="mi">31</span><span class="p">:</span><span class="w"> </span><span class="nx">addr_31</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">              </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">ç¡¬ä»¶åˆå¹¶é€»è¾‘</span><span class="w">                               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">è®¡ç®—æœ€å°å’Œæœ€å¤§åœ°å€</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">ç¡®å®šè¦†ç›–çš„128å­—èŠ‚å¯¹é½æ®µæ•°é‡</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">ç”Ÿæˆ1</span><span class="o">-</span><span class="mi">32</span><span class="nx">ä¸ªå†…å­˜äº‹åŠ¡</span><span class="w">                       </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">              </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">å†…å­˜äº‹åŠ¡</span><span class="err">ï¼ˆ</span><span class="mi">32</span><span class="nx">B</span><span class="o">/</span><span class="mi">64</span><span class="nx">B</span><span class="o">/</span><span class="mi">128</span><span class="nx">B</span><span class="err">ï¼‰</span><span class="w">                   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">äº‹åŠ¡1</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">base_addr</span><span class="p">,</span><span class="w"> </span><span class="nx">base_addr</span><span class="o">+</span><span class="nx">size</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="nx">äº‹åŠ¡2</span><span class="p">:</span><span class="w"> </span><span class="o">...</span><span class="w">                                 </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æœwarpå†…æ‰€æœ‰çº¿ç¨‹è®¿é—®è¿ç»­çš„å†…å­˜åœ°å€ï¼Œä¸”èµ·å§‹åœ°å€128å­—èŠ‚å¯¹é½ï¼Œé‚£ä¹ˆåªéœ€è¦ä¸€ä¸ª128å­—èŠ‚çš„äº‹åŠ¡å³å¯å®Œæˆå…¨éƒ¨è®¿é—®ã€‚æœ€åæƒ…å†µä¸‹ï¼Œå¦‚æœæ¯ä¸ªçº¿ç¨‹è®¿é—®çš„åœ°å€éƒ½åˆ†æ•£åœ¨ä¸åŒçš„128å­—èŠ‚æ®µä¸­ï¼Œåˆ™éœ€è¦32ä¸ªäº‹åŠ¡ã€‚</p>
<h3 id="312">3.1.2 åˆå¹¶è®¿é—®æ¨¡å¼åˆ†æ</h3>
<p><strong>è¿ç»­è®¿é—®æ¨¡å¼ï¼ˆCoalesced Accessï¼‰</strong></p>
<p>æœ€ç†æƒ³çš„è®¿é—®æ¨¡å¼ï¼Œçº¿ç¨‹IDä¸å†…å­˜åœ°å€å‘ˆçº¿æ€§å…³ç³»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nc">float</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">N</span><span class="o">]</span><span class="p">;</span>
<span class="nc">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="nc">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">å®Œç¾åˆå¹¶</span>

<span class="n">å†…å­˜å¸ƒå±€</span><span class="err">ï¼š</span>
<span class="nl">Thread</span><span class="p">:</span><span class="w">  </span><span class="mi">0</span><span class="w">   </span><span class="mi">1</span><span class="w">   </span><span class="mi">2</span><span class="w">   </span><span class="mi">3</span><span class="w">   </span><span class="mi">4</span><span class="w">   </span><span class="mi">5</span><span class="w">   </span><span class="mi">6</span><span class="w">   </span><span class="mi">7</span><span class="w">  </span><span class="p">...</span><span class="w">  </span><span class="mi">31</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="mi">4</span><span class="w">   </span><span class="mi">8</span><span class="w">   </span><span class="mi">12</span><span class="w">  </span><span class="mi">16</span><span class="w">  </span><span class="mi">20</span><span class="w">  </span><span class="mi">24</span><span class="w">  </span><span class="mi">28</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="mi">124</span>
<span class="w">         </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="mi">128</span><span class="n">å­—èŠ‚</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">         </span><span class="n">ç”Ÿæˆ1ä¸ª128Bäº‹åŠ¡</span>
</code></pre></div>

<p><strong>è·¨æ­¥è®¿é—®æ¨¡å¼ï¼ˆStrided Accessï¼‰</strong></p>
<p>çº¿ç¨‹ä»¥å›ºå®šæ­¥é•¿è®¿é—®å†…å­˜ï¼Œåˆå¹¶æ•ˆç‡å–å†³äºæ­¥é•¿å¤§å°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nc">float</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">N</span><span class="o">]</span><span class="p">;</span>
<span class="nc">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="nc">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">tid * stride</span><span class="o">]</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">è·¨æ­¥è®¿é—®</span>

<span class="n">æ­¥é•¿</span><span class="o">=</span><span class="mi">2</span><span class="n">æ—¶çš„å†…å­˜å¸ƒå±€</span><span class="err">ï¼š</span>
<span class="nl">Thread</span><span class="p">:</span><span class="w">  </span><span class="mi">0</span><span class="w">   </span><span class="mi">1</span><span class="w">   </span><span class="mi">2</span><span class="w">   </span><span class="mi">3</span><span class="w">   </span><span class="mi">4</span><span class="w">   </span><span class="mi">5</span><span class="w">   </span><span class="mi">6</span><span class="w">   </span><span class="mi">7</span><span class="w">  </span><span class="p">...</span><span class="w">  </span><span class="mi">31</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="mi">8</span><span class="w">   </span><span class="mi">16</span><span class="w">  </span><span class="mi">24</span><span class="w">  </span><span class="mi">32</span><span class="w">  </span><span class="mi">40</span><span class="w">  </span><span class="mi">48</span><span class="w">  </span><span class="mi">56</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="mi">248</span>
<span class="w">         </span><span class="err">â””â”€â”€â”€â”€</span><span class="w"> </span><span class="mi">128</span><span class="n">B</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€</span><span class="w"> </span><span class="mi">128</span><span class="n">B</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”˜</span>
<span class="w">         </span><span class="n">ç”Ÿæˆ2ä¸ª128Bäº‹åŠ¡</span><span class="err">ï¼Œ</span><span class="n">å¸¦å®½åˆ©ç”¨ç‡50</span><span class="o">%</span>

<span class="n">æ­¥é•¿</span><span class="o">=</span><span class="mi">32</span><span class="n">æ—¶</span><span class="err">ï¼š</span>
<span class="n">æ¯ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„128Bæ®µ</span><span class="err">ï¼Œ</span><span class="n">ç”Ÿæˆ32ä¸ªäº‹åŠ¡</span>
<span class="n">å¸¦å®½åˆ©ç”¨ç‡ä»…3</span><span class="mf">.125</span><span class="o">%</span><span class="err">ï¼ˆ</span><span class="mi">4</span><span class="n">B</span><span class="o">/</span><span class="mi">128</span><span class="n">B</span><span class="err">ï¼‰</span>
</code></pre></div>

<p><strong>éšæœºè®¿é—®æ¨¡å¼ï¼ˆRandom Accessï¼‰</strong></p>
<p>æœ€å·®çš„è®¿é—®æ¨¡å¼ï¼Œé€šå¸¸å‡ºç°åœ¨å“ˆå¸Œè¡¨ã€ç¨€ç–æ•°æ®ç»“æ„ä¸­ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nc">int</span><span class="w"> </span><span class="n">indices</span><span class="o">[</span><span class="n">N</span><span class="o">]</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">éšæœºç´¢å¼•</span>
<span class="nc">float</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">M</span><span class="o">]</span><span class="p">;</span>
<span class="nc">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="nc">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">indices[tid</span><span class="o">]</span><span class="err">]</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">éšæœºè®¿é—®</span>

<span class="n">å¯èƒ½ç”Ÿæˆ1</span><span class="o">-</span><span class="mi">32</span><span class="n">ä¸ªäº‹åŠ¡</span><span class="err">ï¼Œ</span><span class="n">å¹³å‡æ€§èƒ½æå·®</span>
</code></pre></div>

<h3 id="313">3.1.3 ä¼˜åŒ–ç­–ç•¥</h3>
<p><strong>æ•°æ®å¸ƒå±€è½¬æ¢ï¼šAoSåˆ°SoA</strong></p>
<p>åœ¨è‡ªåŠ¨é©¾é©¶åœºæ™¯ä¸­ï¼Œç‚¹äº‘æ•°æ®å¸¸ç”¨ç»“æ„ä½“æ•°ç»„ï¼ˆAoSï¼‰è¡¨ç¤ºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="n">AoSå¸ƒå±€</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">è®¿é—®æ•ˆç‡ä½</span>
<span class="n">struct</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="nc">float</span><span class="w"> </span><span class="n">intensity</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">ring</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">padding</span><span class="p">;</span>
<span class="err">}</span><span class="p">;</span>
<span class="n">Point</span><span class="w"> </span><span class="n">points</span><span class="o">[</span><span class="n">N</span><span class="o">]</span><span class="p">;</span>

<span class="o">//</span><span class="w"> </span><span class="n">è®¿é—®xåæ ‡æ—¶</span><span class="err">ï¼Œ</span><span class="n">å®é™…è¯»å–äº†æ•´ä¸ªç»“æ„ä½“</span>
<span class="nc">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">è¯»å–16å­—èŠ‚</span><span class="err">ï¼Œ</span><span class="n">åªç”¨4å­—èŠ‚</span>
<span class="o">//</span><span class="w"> </span><span class="n">å¸¦å®½åˆ©ç”¨ç‡</span><span class="err">ï¼š</span><span class="mi">4</span><span class="o">/</span><span class="mi">16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="o">%</span>

<span class="o">//</span><span class="w"> </span><span class="n">SoAå¸ƒå±€</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">è®¿é—®æ•ˆç‡é«˜</span>
<span class="n">struct</span><span class="w"> </span><span class="n">PointCloud</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">float</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="nc">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="nc">float</span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="nc">float</span><span class="o">*</span><span class="w"> </span><span class="n">intensity</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint16_t</span><span class="o">*</span><span class="w"> </span><span class="n">ring</span><span class="p">;</span>
<span class="err">}</span><span class="p">;</span>

<span class="o">//</span><span class="w"> </span><span class="n">è®¿é—®xåæ ‡</span><span class="err">ï¼Œ</span><span class="n">å®Œç¾åˆå¹¶</span>
<span class="nc">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_cloud</span><span class="p">.</span><span class="n">x</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">å¸¦å®½åˆ©ç”¨ç‡100</span><span class="o">%</span>
</code></pre></div>

<p><strong>è®¿é—®æ¨¡å¼é‡ç»„</strong></p>
<p>é€šè¿‡æ”¹å˜è®¡ç®—é¡ºåºæˆ–ä½¿ç”¨å…±äº«å†…å­˜ç¼“å†²ï¼Œå°†éšæœºè®¿é—®è½¬æ¢ä¸ºåˆå¹¶è®¿é—®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸå§‹ï¼šéšæœºè®¿é—®</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">scatter_kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">tid</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span><span class="w">  </span><span class="c1">// éšæœºå†™</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä¼˜åŒ–ï¼šä½¿ç”¨åŸå­æ“ä½œ+æ’åº</span>
<span class="c1">// 1. å…ˆå¯¹indicesæ’åº</span>
<span class="c1">// 2. ä½¿ç”¨åˆ†æ®µçš„åˆå¹¶å†™å…¥</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">scatter_optimized</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                  </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">sorted_indices</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">segment_starts</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">n_segments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ¯ä¸ªblockå¤„ç†ä¸€ä¸ªsegmentï¼Œä¿è¯åˆå¹¶å†™å…¥</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">seg_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">segment_starts</span><span class="p">[</span><span class="n">seg_id</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">segment_starts</span><span class="p">[</span><span class="n">seg_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w">  </span><span class="c1">// segmentå†…åˆå¹¶å†™</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="32">3.2 ç¼“å­˜è¡Œä¸ºä¸é…ç½®</h2>
<h3 id="321-l1l2">3.2.1 L1/L2ç¼“å­˜æ¶æ„</h3>
<p>ç°ä»£GPUçš„ç¼“å­˜å±‚æ¬¡ç»“æ„åœ¨ä¸åŒæ¶æ„é—´æœ‰æ˜¾è‘—å·®å¼‚ï¼š</p>
<div class="codehilite"><pre><span></span><code>Volta/Turingæ¶æ„ï¼ˆV100/RTX 2080ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SM (æµå¤šå¤„ç†å™¨)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  L1 Data Cache (128KB)     â”‚  â”‚  â† ä¸å…±äº«å†…å­˜ç»Ÿä¸€
â”‚  â”‚  + Shared Memory            â”‚  â”‚     å¯é…ç½®åˆ†å‰²
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â†“                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      L2 Cache (6MB)              â”‚  â† å…¨å±€å…±äº«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Global Memory (HBM2)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ampereæ¶æ„ï¼ˆA100/RTX 3090ï¼‰ï¼š

- L1: 192KBæ¯SMï¼ˆå¯é…ç½®ï¼‰
- L2: 40MBï¼ˆA100ï¼‰æˆ– 6MBï¼ˆRTX 3090ï¼‰
- æ–°å¢å¼‚æ­¥æ‹·è´æŒ‡ä»¤ï¼Œæ”¯æŒç»•è¿‡L1

Hopperæ¶æ„ï¼ˆH100ï¼‰ï¼š

- L1: 256KBæ¯SM
- L2: 50MB
- æ–°å¢TMAï¼ˆTensor Memory Acceleratorï¼‰å•å…ƒ
</code></pre></div>

<p>ç¼“å­˜è¡Œä¸ºçš„å…³é”®å‚æ•°ï¼š</p>
<ul>
<li><strong>ç¼“å­˜è¡Œå¤§å°</strong>ï¼š128å­—èŠ‚ï¼ˆæ‰€æœ‰æ¶æ„ç»Ÿä¸€ï¼‰</li>
<li><strong>L1ç¼“å­˜ç­–ç•¥</strong>ï¼šå†™ç©¿ï¼ˆwrite-throughï¼‰ï¼Œè¯»æ—¶ç¼“å­˜</li>
<li><strong>L2ç¼“å­˜ç­–ç•¥</strong>ï¼šå†™å›ï¼ˆwrite-backï¼‰ï¼Œæ”¯æŒåŸå­æ“ä½œç¼“å­˜</li>
</ul>
<h3 id="322">3.2.2 ç¼“å­˜é…ç½®ä¸æ§åˆ¶</h3>
<p><strong>é…ç½®L1ç¼“å­˜å¤§å°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é…ç½®kernelçš„L1ç¼“å­˜åå¥½</span>
<span class="n">cudaFuncSetCacheConfig</span><span class="p">(</span><span class="n">my_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">cudaFuncCachePreferL1</span><span class="p">);</span><span class="w">    </span><span class="c1">// åå¥½L1</span>
<span class="n">cudaFuncSetCacheConfig</span><span class="p">(</span><span class="n">my_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">cudaFuncCachePreferShared</span><span class="p">);</span><span class="w"> </span><span class="c1">// åå¥½å…±äº«å†…å­˜</span>
<span class="n">cudaFuncSetCacheConfig</span><span class="p">(</span><span class="n">my_kernel</span><span class="p">,</span><span class="w"> </span><span class="n">cudaFuncCachePreferEqual</span><span class="p">);</span><span class="w">  </span><span class="c1">// å‡è¡¡åˆ†é…</span>

<span class="c1">// Volta+æ¶æ„çš„åŠ¨æ€é…ç½®</span>
<span class="n">cudaFuncSetAttribute</span><span class="p">(</span><span class="n">my_kernel</span><span class="p">,</span>
<span class="w">    </span><span class="n">cudaFuncAttributePreferredSharedMemoryCarveout</span><span class="p">,</span>
<span class="w">    </span><span class="n">cudaSharedmemCarveoutMaxL1</span><span class="p">);</span><span class="w">  </span><span class="c1">// æœ€å¤§åŒ–L1ç¼“å­˜</span>
</code></pre></div>

<p><strong>ä½¿ç”¨åªè¯»ç¼“å­˜è·¯å¾„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// __ldgå†…åœ¨å‡½æ•°ï¼šé€šè¿‡åªè¯»ç¼“å­˜è·¯å¾„åŠ è½½</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ™®é€šåŠ è½½ï¼šé€šè¿‡L1/L2</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// åªè¯»ç¼“å­˜åŠ è½½ï¼šé€šè¿‡çº¹ç†ç¼“å­˜è·¯å¾„</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ldg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>

<span class="w">    </span><span class="c1">// const __restrict__ä¹Ÿä¼šå¯ç”¨åªè¯»ç¼“å­˜</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">ro_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">val3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ro_data</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ç¼“å­˜ç»•è¿‡ç­–ç•¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨å‘é‡åŒ–åŠ è½½ç»•è¿‡L1ï¼ˆAmpere+ï¼‰</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">streaming_kernel</span><span class="p">(</span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æµå¼è®¿é—®ï¼Œä¸æ±¡æŸ“L1ç¼“å­˜</span>
<span class="w">    </span><span class="kt">float4</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld.global.cs.v4.f32 {%0,%1,%2,%3}, [%4];&quot;</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;=f&quot;</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">]));</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="323">3.2.3 ç¼“å­˜å‹å¥½çš„è®¿é—®æ¨¡å¼</h3>
<p><strong>æ—¶é—´å±€éƒ¨æ€§ä¼˜åŒ–</strong></p>
<p>åœ¨å…·èº«æ™ºèƒ½çš„ä¼ æ„Ÿå™¨èåˆä¸­ï¼Œå¤šæ¬¡è®¿é—®åŒä¸€æ•°æ®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å·®çš„æ—¶é—´å±€éƒ¨æ€§</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">sensor_fusion_bad</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">lidar</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">camera</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">imu</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ¯ä¸ªæ•°æ®åªè®¿é—®ä¸€æ¬¡ï¼Œç¼“å­˜æ— æ³•å‘æŒ¥ä½œç”¨</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lidar</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imu</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.3f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¥½çš„æ—¶é—´å±€éƒ¨æ€§</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">sensor_fusion_good</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">lidar</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">camera</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">imu</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨æ»‘åŠ¨çª—å£ï¼Œé‡å¤è®¿é—®ç¼“å­˜ä¸­çš„æ•°æ®</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">window</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lidar</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imu</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

<span class="w">            </span><span class="c1">// æ—¶é—´åºåˆ—æ»¤æ³¢ï¼Œå¤šæ¬¡è®¿é—®ç›¸é‚»æ•°æ®</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nidx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nidx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">filtered</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">lidar</span><span class="p">[</span><span class="n">nidx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2f</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä»ç¼“å­˜è¯»å–</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.3f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ç©ºé—´å±€éƒ¨æ€§ä¼˜åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 2Då·ç§¯çš„ç©ºé—´å±€éƒ¨æ€§ä¼˜åŒ–</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">conv2d_optimized</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                 </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨2D thread blockåŒ¹é…2Dæ•°æ®å¸ƒå±€</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// è®¿é—®3x3é‚»åŸŸï¼Œåˆ©ç”¨ç©ºé—´å±€éƒ¨æ€§</span>
<span class="w">        </span><span class="cp">#pragma unroll</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">ky</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ky</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">kx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">kx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">kx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kx</span><span class="p">;</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ky</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// ç›¸é‚»çº¿ç¨‹è®¿é—®ç›¸é‚»å†…å­˜ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡</span>
<span class="w">                    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">ny</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kernel</span><span class="p">[(</span><span class="n">ky</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">kx</span><span class="o">+</span><span class="mi">1</span><span class="p">)];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="33-loadstore">3.3 å‘é‡åŒ–load/storeæ“ä½œ</h2>
<h3 id="331">3.3.1 å‘é‡åŒ–è®¿å­˜åŸç†</h3>
<p>GPUçš„å†…å­˜æ§åˆ¶å™¨é’ˆå¯¹å‘é‡åŒ–è®¿é—®è¿›è¡Œäº†ä¼˜åŒ–ã€‚ä½¿ç”¨float2ã€float4ç­‰å‘é‡ç±»å‹å¯ä»¥ï¼š</p>
<ul>
<li>å‡å°‘æŒ‡ä»¤æ•°é‡</li>
<li>æé«˜å†…å­˜ååé‡</li>
<li>æ”¹å–„æŒ‡ä»¤çº§å¹¶è¡Œæ€§</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">æ ‡é‡è®¿é—®</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="n">å‘é‡è®¿é—®çš„æŒ‡ä»¤ç”Ÿæˆ</span><span class="err">ï¼š</span>

<span class="n">æ ‡é‡è®¿é—®</span><span class="err">ï¼ˆ</span><span class="mi">4</span><span class="n">æ¡æŒ‡ä»¤</span><span class="err">ï¼‰ï¼š</span>
<span class="n">LD</span><span class="p">.</span><span class="n">E</span><span class="w"> </span><span class="n">R0</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">address+0</span><span class="o">]</span>
<span class="n">LD</span><span class="p">.</span><span class="n">E</span><span class="w"> </span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">address+4</span><span class="o">]</span>
<span class="n">LD</span><span class="p">.</span><span class="n">E</span><span class="w"> </span><span class="n">R2</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">address+8</span><span class="o">]</span>
<span class="n">LD</span><span class="p">.</span><span class="n">E</span><span class="w"> </span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">address+12</span><span class="o">]</span>

<span class="n">å‘é‡è®¿é—®</span><span class="err">ï¼ˆ</span><span class="mi">1</span><span class="n">æ¡æŒ‡ä»¤</span><span class="err">ï¼‰ï¼š</span>
<span class="n">LD</span><span class="p">.</span><span class="n">E</span><span class="mf">.128</span><span class="w"> </span><span class="nl">R0</span><span class="p">:</span><span class="n">R3</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">address</span><span class="o">]</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">ä¸€æ¬¡åŠ è½½128ä½</span>
</code></pre></div>

<h3 id="332">3.3.2 å®ç°æŠ€æœ¯</h3>
<p><strong>ä½¿ç”¨å†…å»ºå‘é‡ç±»å‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å‘é‡åŒ–çš„çŸ©é˜µæ‹·è´</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">matrix_copy_vectorized</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vec_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ¯ä¸ªçº¿ç¨‹å¤„ç†4ä¸ªfloat</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vec_tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å°†æŒ‡é’ˆè½¬æ¢ä¸ºfloat4*</span>
<span class="w">        </span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">dst4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">src4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ä¸€æ¬¡è¯»å†™16å­—èŠ‚</span>
<span class="w">        </span><span class="n">dst4</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src4</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ›´æ¿€è¿›çš„å‘é‡åŒ–ï¼šä½¿ç”¨CUDAçš„å¤§å‘é‡ç±»å‹</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">alignas</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="n">float8</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float4</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">matrix_copy_float8</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vec_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vec_tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">float8</span><span class="o">*</span><span class="w"> </span><span class="n">dst8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">float8</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">float8</span><span class="o">*</span><span class="w"> </span><span class="n">src8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">float8</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
<span class="w">        </span><span class="n">dst8</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src8</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span><span class="w">  </span><span class="c1">// ä¸€æ¬¡32å­—èŠ‚</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è”åˆä½“ä¼˜åŒ–æŠ€å·§</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨è”åˆä½“è¿›è¡Œç±»å‹åŒå…³</span>
<span class="k">union</span><span class="w"> </span><span class="nc">Vec4</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float4</span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">;</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kt">uint4</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">process_rgbadata</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è¯»å–4ä¸ªRGBAåƒç´ ï¼ˆ16å­—èŠ‚ï¼‰</span>
<span class="w">        </span><span class="kt">uint4</span><span class="w"> </span><span class="n">pixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint4</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">image</span><span class="p">)[</span><span class="n">tid</span><span class="p">];</span>

<span class="w">        </span><span class="n">Vec4</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// æå–å¹¶å½’ä¸€åŒ–æ¯ä¸ªé€šé“</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pixels</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0f</span><span class="p">;</span><span class="w">         </span><span class="c1">// R</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">pixels</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// G</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">pixels</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// B</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">pixels</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// A</span>

<span class="w">        </span><span class="c1">// å‘é‡åŒ–å†™å…¥</span>
<span class="w">        </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">vec</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="333">3.3.3 åº”ç”¨åœºæ™¯ï¼šå¤šé€šé“ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†</h3>
<p>åœ¨è‡ªåŠ¨é©¾é©¶ä¸­ï¼Œå¤„ç†å¤šé€šé“æ¿€å…‰é›·è¾¾æ•°æ®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Velodyne 64çº¿æ¿€å…‰é›·è¾¾æ•°æ®å¤„ç†</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">VelodynePoint</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w">        </span><span class="c1">// 3Dåæ ‡</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">intensity</span><span class="p">;</span><span class="w">      </span><span class="c1">// åå°„å¼ºåº¦</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">azimuth</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ–¹ä½è§’</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">distance</span><span class="p">;</span><span class="w">      </span><span class="c1">// è·ç¦»</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">ring</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ¿€å…‰çº¿å·</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">time</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ—¶é—´æˆ³</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">process_velodyne_vectorized</span><span class="p">(</span>
<span class="w">    </span><span class="n">VelodynePoint</span><span class="o">*</span><span class="w"> </span><span class="n">points</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">cartesian_out</span><span class="p">,</span><span class="w">  </span><span class="c1">// x,y,z,intensity</span>
<span class="w">    </span><span class="kt">float2</span><span class="o">*</span><span class="w"> </span><span class="n">polar_out</span><span class="p">,</span><span class="w">      </span><span class="c1">// azimuth,distance</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_points</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_points</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å‘é‡åŒ–è¯»å–ç‚¹äº‘æ•°æ®ï¼ˆ32å­—èŠ‚å¯¹é½ï¼‰</span>
<span class="w">        </span><span class="n">VelodynePoint</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// åæ ‡å˜æ¢ï¼ˆè‡ªè½¦åæ ‡ç³»ï¼‰</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">cos_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__cosf</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">azimuth</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">sin_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__sinf</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">azimuth</span><span class="p">);</span>

<span class="w">        </span><span class="kt">float4</span><span class="w"> </span><span class="n">cartesian</span><span class="p">;</span>
<span class="w">        </span><span class="n">cartesian</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos_a</span><span class="p">;</span>
<span class="w">        </span><span class="n">cartesian</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin_a</span><span class="p">;</span>
<span class="w">        </span><span class="n">cartesian</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">        </span><span class="n">cartesian</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">intensity</span><span class="p">;</span>

<span class="w">        </span><span class="kt">float2</span><span class="w"> </span><span class="n">polar</span><span class="p">;</span>
<span class="w">        </span><span class="n">polar</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">azimuth</span><span class="p">;</span>
<span class="w">        </span><span class="n">polar</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">distance</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å‘é‡åŒ–å†™å…¥</span>
<span class="w">        </span><span class="n">cartesian_out</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cartesian</span><span class="p">;</span>
<span class="w">        </span><span class="n">polar_out</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">polar</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">## 3.4 å†…å­˜å¸¦å®½ä¼˜åŒ–</span>

<span class="cp">### 3.4.1 å¸¦å®½åˆ†æä¸æµ‹é‡</span>

<span class="n">ç†è§£å’Œæµ‹é‡å†…å­˜å¸¦å®½æ˜¯ä¼˜åŒ–çš„ç¬¬ä¸€æ­¥</span><span class="err">ã€‚</span><span class="n">GPUçš„å†…å­˜å¸¦å®½å—å¤šä¸ªå› ç´ å½±å“</span><span class="err">ï¼š</span>

<span class="o">**</span><span class="n">ç†è®ºå¸¦å®½è®¡ç®—</span><span class="o">**</span>
</code></pre></div>

<p>ç†è®ºå¸¦å®½ = å†…å­˜é¢‘ç‡ Ã— æ€»çº¿å®½åº¦ Ã— 2 (DDR)</p>
<p>ç¤ºä¾‹ï¼ˆV100ï¼‰ï¼š</p>
<ul>
<li>HBM2å†…å­˜é¢‘ç‡ï¼š877 MHz</li>
<li>æ€»çº¿å®½åº¦ï¼š4096 bits = 512 bytes</li>
<li>ç†è®ºå¸¦å®½ = 877 MHz Ã— 512 bytes Ã— 2 = 900 GB/s</li>
</ul>
<p>ç¤ºä¾‹ï¼ˆA100ï¼‰ï¼š</p>
<ul>
<li>HBM2eå†…å­˜é¢‘ç‡ï¼š1215 MHz  </li>
<li>æ€»çº¿å®½åº¦ï¼š5120 bits = 640 bytes</li>
<li>ç†è®ºå¸¦å®½ = 1215 MHz Ã— 640 bytes Ã— 2 = 1555 GB/s</li>
</ul>
<p>ç¤ºä¾‹ï¼ˆH100ï¼‰ï¼š</p>
<ul>
<li>HBM3å†…å­˜é¢‘ç‡ï¼š1593 MHz</li>
<li>æ€»çº¿å®½åº¦ï¼š6144 bits = 768 bytes  </li>
<li>ç†è®ºå¸¦å®½ = 1593 MHz Ã— 768 bytes Ã— 2 = 2448 GB/s</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="o">**</span><span class="n">æœ‰æ•ˆå¸¦å®½æµ‹é‡</span><span class="o">**</span>

<span class="err">```</span><span class="n">cuda</span>
<span class="o">//</span><span class="w"> </span><span class="n">å¸¦å®½æµ‹è¯•kernel</span>
<span class="n">__global__</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">bandwidth_test</span><span class="p">(</span><span class="nc">float</span><span class="o">*</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="nc">float</span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stride</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">dst</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="o">//</span><span class="w"> </span><span class="n">æµ‹é‡å‡½æ•°</span>
<span class="nc">float</span><span class="w"> </span><span class="n">measure_bandwidth</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">n_elements</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">float</span><span class="w"> </span><span class="o">*</span><span class="n">d_src</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_dst</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_src</span><span class="p">,</span><span class="w"> </span><span class="n">n_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="nc">float</span><span class="p">));</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_dst</span><span class="p">,</span><span class="w"> </span><span class="n">n_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="nc">float</span><span class="p">));</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">é¢„çƒ­</span>
<span class="w">    </span><span class="n">bandwidth_test</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">d_dst</span><span class="p">,</span><span class="w"> </span><span class="n">d_src</span><span class="p">,</span><span class="w"> </span><span class="n">n_elements</span><span class="p">);</span>

<span class="w">    </span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="k">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">start</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">æµ‹é‡</span>
<span class="w">    </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="k">start</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">bandwidth_test</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">d_dst</span><span class="p">,</span><span class="w"> </span><span class="n">d_src</span><span class="p">,</span><span class="w"> </span><span class="n">n_elements</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaEventSynchronize</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>

<span class="w">    </span><span class="nc">float</span><span class="w"> </span><span class="n">milliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaEventElapsedTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">milliseconds</span><span class="p">,</span><span class="w"> </span><span class="k">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">è®¡ç®—å¸¦å®½</span><span class="err">ï¼ˆ</span><span class="n">è¯»</span><span class="o">+</span><span class="n">å†™</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="nc">float</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="nc">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="nc">float</span><span class="w"> </span><span class="n">bandwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">milliseconds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="p">);</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">GB</span><span class="o">/</span><span class="n">s</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bandwidth</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p><strong>Rooflineæ¨¡å‹åˆ†æ</strong></p>
<div class="codehilite"><pre><span></span><code>Rooflineæ¨¡å‹ï¼šæ€§èƒ½å—è®¡ç®—å¼ºåº¦é™åˆ¶

æ€§èƒ½(GFLOPS)
    â†‘
    â”‚     è®¡ç®—å—é™åŒºåŸŸ
    â”‚    â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å³°å€¼è®¡ç®—æ€§èƒ½
    â”‚   â•± 
    â”‚  â•±  å†…å­˜å—é™åŒºåŸŸ
    â”‚ â•±   
    â”‚â•±    æ€§èƒ½ = å¸¦å®½ Ã— è®¡ç®—å¼ºåº¦
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è®¡ç®—å¼ºåº¦(FLOPS/Byte)
         Ridge Point

è®¡ç®—å¼ºåº¦ = æµ®ç‚¹è¿ç®—æ•° / å†…å­˜è®¿é—®å­—èŠ‚æ•°

ç¤ºä¾‹åˆ†æï¼š

<span class="k">-</span> SAXPY (y = a*x + y): 2 FLOPS / 12 Bytes = 0.167
<span class="k">-</span> GEMM (C = A*B + C): 2*nÂ³ FLOPS / 4*nÂ² Bytes = n/2
<span class="k">-</span> å·ç§¯: å–å†³äºkernelå¤§å°å’Œå¤ç”¨ç¨‹åº¦
</code></pre></div>

<h3 id="342">3.4.2 å¸¦å®½ä¼˜åŒ–æŠ€æœ¯</h3>
<p><strong>æ•°æ®å‹ç¼©ä¸è§£å‹</strong></p>
<p>åœ¨å…·èº«æ™ºèƒ½åœºæ™¯ä¸­ï¼Œæ·±åº¦å›¾åƒçš„å‹ç¼©ä¼ è¾“ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 16ä½æ·±åº¦å›¾å‹ç¼©ä¸º8ä½+ç¼©æ”¾å› å­</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">compress_depth</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">compressed</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">scale_factors</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="o">*</span><span class="w"> </span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¡ç®—16x16å—çš„æœ€å¤§æœ€å°å€¼ï¼ˆä½¿ç”¨å…±äº«å†…å­˜ï¼‰</span>
<span class="w">        </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">s_min</span><span class="p">,</span><span class="w"> </span><span class="n">s_max</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">s_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">65535</span><span class="p">;</span>
<span class="w">            </span><span class="n">s_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">depth</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// åŸå­æ›´æ–°æœ€å€¼</span>
<span class="w">        </span><span class="n">atomicMin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_min</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<span class="w">        </span><span class="n">atomicMax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_max</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// é‡åŒ–åˆ°8ä½</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">s_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_min</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0f</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">compressed_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_min</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>

<span class="w">        </span><span class="n">compressed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compressed_val</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å—çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¿å­˜ç¼©æ”¾å› å­</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">block_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">            </span><span class="n">scale_factors</span><span class="p">[</span><span class="n">block_id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s_min</span><span class="p">;</span>
<span class="w">            </span><span class="n">scale_factors</span><span class="p">[</span><span class="n">block_id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å¼‚æ­¥å†…å­˜ä¼ è¾“ä¸è®¡ç®—é‡å </strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨CUDAæµå®ç°ä¼ è¾“ä¸è®¡ç®—é‡å </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">process_with_overlap</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">h_data</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_data</span><span class="p">,</span><span class="w"> </span>
<span class="w">                         </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_chunks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">chunk_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_chunks</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºæµ</span>
<span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åŒç¼“å†²</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">d_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">chunk_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">chunk_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// æµæ°´çº¿å¤„ç†</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_chunks</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">stream_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å¼‚æ­¥æ‹·è´åˆ°GPU</span>
<span class="w">        </span><span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="n">d_buffer</span><span class="p">[</span><span class="n">stream_id</span><span class="p">],</span><span class="w"> </span>
<span class="w">                       </span><span class="n">h_data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span>
<span class="w">                       </span><span class="n">chunk_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                       </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">,</span>
<span class="w">                       </span><span class="n">streams</span><span class="p">[</span><span class="n">stream_id</span><span class="p">]);</span>

<span class="w">        </span><span class="c1">// åœ¨è¯¥æµä¸Šå¯åŠ¨kernel</span>
<span class="w">        </span><span class="n">process_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">streams</span><span class="p">[</span><span class="n">stream_id</span><span class="p">]</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">d_result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span>
<span class="w">            </span><span class="n">d_buffer</span><span class="p">[</span><span class="n">stream_id</span><span class="p">],</span>
<span class="w">            </span><span class="n">chunk_size</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¼‚æ­¥æ‹·è´å›CPUï¼ˆå¦‚éœ€è¦ï¼‰</span>
<span class="w">        </span><span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="n">h_result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span>
<span class="w">                       </span><span class="n">d_result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span>
<span class="w">                       </span><span class="n">chunk_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="w">                       </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">,</span>
<span class="w">                       </span><span class="n">streams</span><span class="p">[</span><span class="n">stream_id</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åŒæ­¥æ‰€æœ‰æµ</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>é¢„å–ç­–ç•¥ï¼ˆUnified Memoryï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç»Ÿä¸€å†…å­˜çš„é¢„å–ä¼˜åŒ–</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">slam_with_prefetch</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">unified_map</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">map_size</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">new_scan</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">scan_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// é¢„å–åœ°å›¾æ•°æ®åˆ°GPU</span>
<span class="w">    </span><span class="n">cudaMemPrefetchAsync</span><span class="p">(</span><span class="n">unified_map</span><span class="p">,</span><span class="w"> </span><span class="n">map_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// é¢„å–æ–°æ‰«ææ•°æ®åˆ°GPU</span>
<span class="w">    </span><span class="n">cudaMemPrefetchAsync</span><span class="p">(</span><span class="n">new_scan</span><span class="p">,</span><span class="w"> </span><span class="n">scan_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¯åŠ¨SLAM kernel</span>
<span class="w">    </span><span class="n">slam_update_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">unified_map</span><span class="p">,</span><span class="w"> </span><span class="n">new_scan</span><span class="p">,</span><span class="w"> </span><span class="n">map_size</span><span class="p">,</span><span class="w"> </span><span class="n">scan_size</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// é¢„å–æ›´æ–°åçš„åœ°å›¾å›CPUï¼ˆç”¨äºå¯è§†åŒ–ï¼‰</span>
<span class="w">    </span><span class="n">cudaMemPrefetchAsync</span><span class="p">(</span><span class="n">unified_map</span><span class="p">,</span><span class="w"> </span><span class="n">map_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaCpuDeviceId</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="343">3.4.3 å¸¦å®½å—é™ç®—æ³•ä¼˜åŒ–</h3>
<p><strong>Kernelèåˆå‡å°‘å†…å­˜è®¿é—®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æœªèåˆç‰ˆæœ¬ï¼š3æ¬¡å…¨å±€å†…å­˜è®¿é—®</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">add_kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="p">}</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mul_kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">scalar</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scalar</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// èåˆç‰ˆæœ¬ï¼š2æ¬¡å…¨å±€å†…å­˜è®¿é—®</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_add_mul</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="kt">float</span><span class="w"> </span><span class="n">scalar</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">c</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scalar</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯„å­˜å™¨ä¸­å®Œæˆæ‰€æœ‰è®¡ç®—</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è®¡ç®—ä¸è®¿å­˜é‡å ï¼ˆå»¶è¿Ÿéšè—ï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨æŒ‡ä»¤çº§å¹¶è¡Œéšè—å†…å­˜å»¶è¿Ÿ</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">compute_intensive_kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å±•å¼€å¾ªç¯ï¼Œå¢åŠ å¹¶è¡Œåº¦</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">acc0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">acc1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">acc2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">acc3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å‘èµ·å¤šä¸ªç‹¬ç«‹çš„å†…å­˜è¯·æ±‚</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stride</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">stride</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">stride</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">stride</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">stride</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åœ¨ç­‰å¾…å†…å­˜æ—¶è¿›è¡Œè®¡ç®—</span>
<span class="w">        </span><span class="n">acc0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__sinf</span><span class="p">(</span><span class="n">val0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">__cosf</span><span class="p">(</span><span class="n">val0</span><span class="p">);</span>
<span class="w">        </span><span class="n">acc1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__sinf</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">__cosf</span><span class="p">(</span><span class="n">val1</span><span class="p">);</span>
<span class="w">        </span><span class="n">acc2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__sinf</span><span class="p">(</span><span class="n">val2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">__cosf</span><span class="p">(</span><span class="n">val2</span><span class="p">);</span>
<span class="w">        </span><span class="n">acc3</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">__sinf</span><span class="p">(</span><span class="n">val3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">__cosf</span><span class="p">(</span><span class="n">val3</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å½’çº¦ç»“æœ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acc1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acc2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acc3</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å…·èº«æ™ºèƒ½æ¡ˆä¾‹ï¼šå®æ—¶SLAMçš„å¸¦å®½ä¼˜åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ICPï¼ˆè¿­ä»£æœ€è¿‘ç‚¹ï¼‰ç®—æ³•çš„å¸¦å®½ä¼˜åŒ–</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">PointNormal</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">point</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">normal</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">icp_correspondence_optimized</span><span class="p">(</span>
<span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">correspondences</span><span class="p">,</span><span class="w">        </span><span class="c1">// è¾“å‡ºï¼šå¯¹åº”å…³ç³»</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">distances</span><span class="p">,</span><span class="w">            </span><span class="c1">// è¾“å‡ºï¼šè·ç¦»</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">PointNormal</span><span class="o">*</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w">   </span><span class="c1">// æºç‚¹äº‘</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">PointNormal</span><span class="o">*</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w">   </span><span class="c1">// ç›®æ ‡ç‚¹äº‘</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w">      </span><span class="c1">// 4x4å˜æ¢çŸ©é˜µ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_source</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_target</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">max_dist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// æ¯ä¸ªblockå¤„ç†ä¸€ä¸ªæºç‚¹ï¼Œä½¿ç”¨å…±äº«å†…å­˜ç¼“å­˜ç›®æ ‡ç‚¹</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="n">PointNormal</span><span class="w"> </span><span class="n">s_target</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">source_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n_source</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åŠ è½½å¹¶å˜æ¢æºç‚¹</span>
<span class="w">    </span><span class="n">PointNormal</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source</span><span class="p">[</span><span class="n">source_idx</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float3</span><span class="w"> </span><span class="n">transformed_point</span><span class="p">;</span>
<span class="w">    </span><span class="n">transformed_point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                         </span><span class="n">transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="w">    </span><span class="n">transformed_point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                         </span><span class="n">transform</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="w">    </span><span class="n">transformed_point</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                         </span><span class="n">transform</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">transform</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">min_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_dist</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">best_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ†å—å¤„ç†ç›®æ ‡ç‚¹äº‘</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">chunk_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">chunk_start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_target</span><span class="p">;</span><span class="w"> </span><span class="n">chunk_start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åä½œåŠ è½½ç›®æ ‡ç‚¹åˆ°å…±äº«å†…å­˜</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">target_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">s_target</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">[</span><span class="n">target_idx</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// è®¡ç®—è·ç¦»</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">chunk_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">n_target</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">chunk_start</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float3</span><span class="w"> </span><span class="n">diff</span><span class="p">;</span>
<span class="w">            </span><span class="n">diff</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transformed_point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">            </span><span class="n">diff</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transformed_point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">            </span><span class="n">diff</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transformed_point</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">point</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diff</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diff</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">diff</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diff</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">diff</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diff</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_dist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">min_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<span class="w">                </span><span class="n">best_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨warpçº§å½’çº¦æ‰¾åˆ°æœ€å°è·ç¦»</span>
<span class="w">    </span><span class="n">min_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">warp_reduce_min</span><span class="p">(</span><span class="n">min_dist</span><span class="p">);</span>
<span class="w">    </span><span class="n">best_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">warp_broadcast</span><span class="p">(</span><span class="n">best_idx</span><span class="p">,</span><span class="w"> </span><span class="n">min_dist</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç¬¬ä¸€ä¸ªçº¿ç¨‹å†™å…¥ç»“æœ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">correspondences</span><span class="p">[</span><span class="n">source_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best_idx</span><span class="p">;</span>
<span class="w">        </span><span class="n">distances</span><span class="p">[</span><span class="n">source_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">min_dist</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="35">3.5 æ¡ˆä¾‹ï¼šé«˜å¸¦å®½çŸ©é˜µè½¬ç½®</h2>
<p>çŸ©é˜µè½¬ç½®æ˜¯å±•ç¤ºå†…å­˜ä¼˜åŒ–æŠ€æœ¯çš„ç»å…¸æ¡ˆä¾‹ã€‚çœ‹ä¼¼ç®€å•çš„æ“ä½œï¼Œå®åˆ™å……åˆ†æš´éœ²äº†å†…å­˜è®¿é—®æ¨¡å¼å¯¹æ€§èƒ½çš„å†³å®šæ€§å½±å“ã€‚</p>
<h3 id="351">3.5.1 æœ´ç´ å®ç°ä¸æ€§èƒ½åˆ†æ</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// æœ´ç´ å®ç°ï¼šä¸¥é‡çš„å†…å­˜è®¿é—®é—®é¢˜</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">transpose_naive</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">];</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// é—®é¢˜ï¼šè¯»å–åˆå¹¶ï¼Œä½†å†™å…¥è·¨æ­¥ï¼</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">æ€§èƒ½åˆ†æ</span><span class="err">ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="n">è¯»å–</span><span class="err">ï¼š</span><span class="n">è¿ç»­çº¿ç¨‹è¯»å–è¿ç»­åœ°å€</span><span class="err">ï¼Œ</span><span class="n">å®Œç¾åˆå¹¶</span>
<span class="o">-</span><span class="w"> </span><span class="n">å†™å…¥</span><span class="err">ï¼š</span><span class="n">è¿ç»­çº¿ç¨‹å†™å…¥é—´éš”heightçš„åœ°å€</span><span class="err">ï¼Œ</span><span class="n">ä¸¥é‡ä¸åˆå¹¶</span>
<span class="o">-</span><span class="w"> </span><span class="n">å¸¦å®½åˆ©ç”¨ç‡</span><span class="err">ï¼š</span><span class="n">çº¦10</span><span class="mi">-15</span><span class="o">%</span><span class="err">ï¼ˆ</span><span class="n">å–å†³äºçŸ©é˜µå¤§å°</span><span class="err">ï¼‰</span>
</code></pre></div>

<h3 id="352">3.5.2 åˆå¹¶è®¿é—®ä¼˜åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨å…±äº«å†…å­˜å®ç°åˆå¹¶è¯»å†™</span>
<span class="cp">#define TILE_DIM 32</span>
<span class="cp">#define BLOCK_ROWS 8</span>

<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">transpose_coalesced</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w">  </span><span class="c1">// +1é¿å…bank conflict</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆå¹¶è¯»å–åˆ°å…±äº«å†…å­˜ï¼ˆæ¯ä¸ªçº¿ç¨‹è¯»4ä¸ªå…ƒç´ ï¼‰</span>
<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_ROWS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">[(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// äº¤æ¢çº¿ç¨‹çš„xå’Œyæ¥å®ç°è½¬ç½®åçš„åˆå¹¶å†™å…¥</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#pragma unroll</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_ROWS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">out</span><span class="p">[(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">æ€§èƒ½æå‡</span><span class="err">ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="n">è¯»å†™éƒ½å®ç°åˆå¹¶è®¿é—®</span>
<span class="o">-</span><span class="w"> </span><span class="n">å¸¦å®½åˆ©ç”¨ç‡</span><span class="err">ï¼š</span><span class="n">çº¦60</span><span class="mi">-70</span><span class="o">%</span>
</code></pre></div>

<h3 id="353">3.5.3 å‘é‡åŒ–ä¼˜åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨float4å‘é‡åŒ–è¿›ä¸€æ­¥ä¼˜åŒ–</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">transpose_vectorized</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// æ¯ä¸ªçº¿ç¨‹å¤„ç†4ä¸ªfloat</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å‘é‡åŒ–è¯»å–</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float4</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">])[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">        </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">        </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">        </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è½¬ç½®åå‘é‡åŒ–å†™å…¥</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float4</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">];</span>
<span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">];</span>
<span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">];</span>
<span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">];</span>
<span class="w">        </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float4</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">æ€§èƒ½æå‡</span><span class="err">ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="n">å‡å°‘å†…å­˜äº‹åŠ¡æ•°é‡</span>
<span class="o">-</span><span class="w"> </span><span class="n">å¸¦å®½åˆ©ç”¨ç‡</span><span class="err">ï¼š</span><span class="n">çº¦75</span><span class="mi">-80</span><span class="o">%</span>
</code></pre></div>

<h3 id="354">3.5.4 å…±äº«å†…å­˜ååŒä¼˜åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç»ˆæä¼˜åŒ–ï¼šåŒç¼“å†²+å¼‚æ­¥æ‹·è´ï¼ˆAmpere+ï¼‰</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">transpose_ultimate</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åŒç¼“å†²å…±äº«å†…å­˜</span>
<span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// å¼‚æ­¥æ‹·è´ç®¡é“</span>
<span class="w">    </span><span class="n">cuda</span><span class="o">::</span><span class="n">pipeline</span><span class="o">&lt;</span><span class="n">cuda</span><span class="o">::</span><span class="n">thread_scope_thread</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda</span><span class="o">::</span><span class="n">make_pipeline</span><span class="p">();</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tile_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tile_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç¬¬ä¸€ä¸ªtileçš„å¼‚æ­¥åŠ è½½</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cuda</span><span class="o">::</span><span class="n">memcpy_async</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">in</span><span class="p">[(</span><span class="n">tile_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tile_x</span><span class="p">],</span>
<span class="w">            </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">,</span>
<span class="w">            </span><span class="n">pipe</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pipe</span><span class="p">.</span><span class="n">producer_commit</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ä¸»å¾ªç¯ï¼šé‡å ä¼ è¾“å’Œè®¡ç®—</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">buffer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">next_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer_id</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…å½“å‰tileå°±ç»ª</span>
<span class="w">        </span><span class="n">pipe</span><span class="p">.</span><span class="n">consumer_wait</span><span class="p">();</span>
<span class="w">        </span><span class="nf">__syncthreads</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// é¢„å–ä¸‹ä¸€ä¸ªtileï¼ˆå¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªï¼‰</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">next_tile_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span>
<span class="w">                </span><span class="n">cuda</span><span class="o">::</span><span class="n">memcpy_async</span><span class="p">(</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">tile</span><span class="p">[</span><span class="n">next_buffer</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">in</span><span class="p">[(</span><span class="n">tile_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">next_tile_x</span><span class="p">],</span>
<span class="w">                    </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">,</span>
<span class="w">                    </span><span class="n">pipe</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">pipe</span><span class="p">.</span><span class="n">producer_commit</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å¤„ç†å½“å‰tileçš„è½¬ç½®å†™å…¥</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">out_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tile_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">out_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">out_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cp">#pragma unroll</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BLOCK_ROWS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">out</span><span class="p">[(</span><span class="n">out_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">out_x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                    </span><span class="n">tile</span><span class="p">[</span><span class="n">buffer_id</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">pipe</span><span class="p">.</span><span class="n">consumer_release</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">æ€§èƒ½è¾¾åˆ°</span><span class="err">ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="n">å¸¦å®½åˆ©ç”¨ç‡</span><span class="err">ï¼š</span><span class="n">çº¦85</span><span class="mi">-90</span><span class="o">%</span>
<span class="o">-</span><span class="w"> </span><span class="n">æ¥è¿‘ç¡¬ä»¶ç†è®ºæé™</span>
</code></pre></div>

<h3 id="355">3.5.5 æ€§èƒ½å¯¹æ¯”ä¸åˆ†æ</h3>
<div class="codehilite"><pre><span></span><code>æ€§èƒ½æµ‹è¯•ç»“æœï¼ˆ8192x8192çŸ©é˜µï¼ŒV100ï¼‰ï¼š

å®ç°ç‰ˆæœ¬            å¸¦å®½(GB/s)   åˆ©ç”¨ç‡    ç›¸å¯¹æ€§èƒ½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æœ´ç´ å®ç°            95          10.6%     1.0x
åˆå¹¶è®¿é—®            570         63.3%     6.0x  
å‘é‡åŒ–              684         76.0%     7.2x
åŒç¼“å†²+å¼‚æ­¥         810         90.0%     8.5x
ç†è®ºå³°å€¼            900         100%      -

å…³é”®ä¼˜åŒ–ç‚¹ï¼š

1. åˆå¹¶è®¿é—®ï¼š6å€æ€§èƒ½æå‡ï¼ˆæœ€å…³é”®ï¼‰
2. å‘é‡åŒ–ï¼šé¢å¤–20%æå‡
3. å¼‚æ­¥ä¼ è¾“ï¼šé¢å¤–18%æå‡
4. Bank conflicté¿å…ï¼šçº¦5%æå‡
</code></pre></div>

<h2 id="36">3.6 æœ¬ç« å°ç»“</h2>
<p>å…¨å±€å†…å­˜ä¼˜åŒ–æ˜¯CUDAæ€§èƒ½è°ƒä¼˜çš„åŸºç¡€å’Œå…³é”®ã€‚æœ¬ç« æ·±å…¥æ¢è®¨äº†å†…å­˜è®¿é—®æ¨¡å¼ã€ç¼“å­˜è¡Œä¸ºã€å‘é‡åŒ–æŠ€æœ¯å’Œå¸¦å®½ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š</p>
<ol>
<li>
<p><strong>åˆå¹¶è®¿é—®æ˜¯ç¬¬ä¸€è¦åŠ¡</strong>ï¼šæœªåˆå¹¶çš„å†…å­˜è®¿é—®ä¼šå¯¼è‡´10å€ç”šè‡³æ›´å¤šçš„æ€§èƒ½æŸå¤±ã€‚é€šè¿‡æ•°æ®å¸ƒå±€è½¬æ¢ï¼ˆAoSâ†’SoAï¼‰å’Œè®¿é—®æ¨¡å¼é‡ç»„å¯ä»¥å®ç°åˆå¹¶ã€‚</p>
</li>
<li>
<p><strong>ç¼“å­˜é…ç½®å› åœºæ™¯è€Œå¼‚</strong>ï¼šL1ç¼“å­˜å¯¹å…·æœ‰æ—¶ç©ºå±€éƒ¨æ€§çš„ç®—æ³•æœ‰åˆ©ï¼Œä½†æµå¼è®¿é—®åº”è€ƒè™‘ç»•è¿‡L1ã€‚ä½¿ç”¨<code>__ldg</code>å’Œ<code>const __restrict__</code>å¯ä»¥åˆ©ç”¨åªè¯»ç¼“å­˜è·¯å¾„ã€‚</p>
</li>
<li>
<p><strong>å‘é‡åŒ–å‡å°‘æŒ‡ä»¤å¼€é”€</strong>ï¼šfloat2/float4ç­‰å‘é‡ç±»å‹å¯ä»¥å‡å°‘å†…å­˜äº‹åŠ¡æ•°é‡ï¼Œæé«˜å¸¦å®½åˆ©ç”¨ç‡ã€‚åœ¨å¤„ç†å¤šé€šé“æ•°æ®æ—¶å°¤å…¶æœ‰æ•ˆã€‚</p>
</li>
<li>
<p><strong>å¸¦å®½ä¼˜åŒ–éœ€è¦ç³»ç»Ÿæ€ç»´</strong>ï¼š
   - æµ‹é‡å’Œåˆ†æï¼šä½¿ç”¨Rooflineæ¨¡å‹è¯†åˆ«ç“¶é¢ˆ
   - æ•°æ®å‹ç¼©ï¼šåœ¨å¸¦å®½å—é™æ—¶æƒè¡¡è®¡ç®—ä¸ä¼ è¾“
   - å¼‚æ­¥ä¼ è¾“ï¼šé‡å è®¡ç®—ä¸æ•°æ®ç§»åŠ¨
   - Kernelèåˆï¼šå‡å°‘å†…å­˜å¾€è¿”æ¬¡æ•°</p>
</li>
<li>
<p><strong>å®æˆ˜æ¡ˆä¾‹çš„å¯ç¤º</strong>ï¼šçŸ©é˜µè½¬ç½®æ¡ˆä¾‹å±•ç¤ºäº†ä»10%åˆ°90%å¸¦å®½åˆ©ç”¨ç‡çš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œæ ¸å¿ƒåœ¨äºåˆå¹¶è®¿é—®+å…±äº«å†…å­˜+å‘é‡åŒ–+å¼‚æ­¥ä¼ è¾“çš„ç»„åˆä½¿ç”¨ã€‚</p>
</li>
</ol>
<p><strong>å…³é”®å…¬å¼</strong>ï¼š</p>
<ul>
<li>æœ‰æ•ˆå¸¦å®½ = æ•°æ®ä¼ è¾“é‡ / æ‰§è¡Œæ—¶é—´</li>
<li>å¸¦å®½åˆ©ç”¨ç‡ = æœ‰æ•ˆå¸¦å®½ / ç†è®ºå¸¦å®½</li>
<li>è®¡ç®—å¼ºåº¦ = FLOPS / å†…å­˜è®¿é—®å­—èŠ‚æ•°</li>
<li>å†…å­˜äº‹åŠ¡æ•ˆç‡ = è¯·æ±‚å­—èŠ‚æ•° / ä¼ è¾“å­—èŠ‚æ•°</li>
</ul>
<p>è®°ä½ï¼šåœ¨è‡ªåŠ¨é©¾é©¶å’Œå…·èº«æ™ºèƒ½çš„å®æ—¶ç³»ç»Ÿä¸­ï¼Œæ¯GB/sçš„å¸¦å®½æå‡éƒ½å¯èƒ½æ„å‘³ç€æ›´é«˜çš„å¸§ç‡ã€æ›´ä½çš„å»¶è¿Ÿï¼Œç”šè‡³å†³å®šç³»ç»Ÿèƒ½å¦å®æ—¶è¿è¡Œã€‚æŒæ¡è¿™äº›ä¼˜åŒ–æŠ€æœ¯ï¼Œæ˜¯æ„å»ºé«˜æ€§èƒ½AIç³»ç»Ÿçš„å¿…å¤‡æŠ€èƒ½ã€‚</p>
<h2 id="37">3.7 ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜ï¼ˆç†è§£æ¦‚å¿µï¼‰</h3>
<p><strong>ç»ƒä¹ 3.1</strong>ï¼šç»™å®šä¸€ä¸ªwarpçš„32ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«è®¿é—®åœ°å€[0, 128, 256, ..., 3968]ï¼ˆæ­¥é•¿128å­—èŠ‚ï¼‰ï¼Œè®¡ç®—éœ€è¦å¤šå°‘ä¸ª128å­—èŠ‚çš„å†…å­˜äº‹åŠ¡ï¼Ÿå¸¦å®½åˆ©ç”¨ç‡æ˜¯å¤šå°‘ï¼Ÿ</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘128å­—èŠ‚å¯¹é½çš„å†…å­˜æ®µï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„æ®µã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>éœ€è¦32ä¸ª128å­—èŠ‚äº‹åŠ¡ã€‚æ¯ä¸ªçº¿ç¨‹è®¿é—®4å­—èŠ‚ï¼Œå…±éœ€128å­—èŠ‚ï¼Œä½†å®é™…ä¼ è¾“32Ã—128=4096å­—èŠ‚ã€‚å¸¦å®½åˆ©ç”¨ç‡=128/4096=3.125%ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 3.2</strong>ï¼šè§£é‡Šä¸ºä»€ä¹ˆåœ¨å…±äº«å†…å­˜tileå£°æ˜ä¸­ä½¿ç”¨<code>[TILE_DIM][TILE_DIM+1]</code>è€Œä¸æ˜¯<code>[TILE_DIM][TILE_DIM]</code>ï¼Ÿ</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘å…±äº«å†…å­˜çš„bankç»„ç»‡ï¼Œ32ä¸ªbankï¼Œæ¯ä¸ªbank 4å­—èŠ‚å®½ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ·»åŠ paddingé¿å…bank conflictã€‚å½“TILE_DIM=32æ—¶ï¼ŒåŒä¸€åˆ—çš„è¿ç»­å…ƒç´ ä¼šæ˜ å°„åˆ°åŒä¸€ä¸ªbankï¼Œå¯¼è‡´32è·¯bank conflictã€‚+1ä½¿å¾—åˆ—å…ƒç´ åˆ†æ•£åˆ°ä¸åŒbankã€‚</p>
</details>
<p><strong>ç»ƒä¹ 3.3</strong>ï¼šåœ¨Voltaæ¶æ„ä¸Šï¼ŒL1ç¼“å­˜å’Œå…±äº«å†…å­˜å…±äº«128KBç©ºé—´ã€‚å¦‚æœkernelä½¿ç”¨64KBå…±äº«å†…å­˜ï¼ŒL1ç¼“å­˜æœ‰å¤šå¤§ï¼Ÿè¿™å¯¹æ€§èƒ½æœ‰ä½•å½±å“ï¼Ÿ</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ç¼“å­˜å¤§å°å¯¹å‘½ä¸­ç‡çš„å½±å“ï¼Œä»¥åŠä¸åŒè®¿é—®æ¨¡å¼çš„éœ€æ±‚ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>L1ç¼“å­˜ä¸º64KBã€‚å½±å“ï¼š1)ç¼“å­˜å®¹é‡å‡å°‘å¯èƒ½é™ä½æ—¶é—´å±€éƒ¨æ€§å¥½çš„ç®—æ³•æ€§èƒ½ï¼›2)å¯¹æµå¼è®¿é—®å½±å“å°ï¼›3)éœ€è¦æƒè¡¡å…±äº«å†…å­˜å¸¦æ¥çš„æ•°æ®å¤ç”¨æ”¶ç›Šä¸L1ç¼“å­˜å‡å°‘çš„æŸå¤±ã€‚</p>
</details>
<h3 id="_2">è¿›é˜¶é¢˜ï¼ˆåº”ç”¨æŠ€æœ¯ï¼‰</h3>
<p><strong>ç»ƒä¹ 3.4</strong>ï¼šè®¾è®¡ä¸€ä¸ªkernelï¼Œé«˜æ•ˆåœ°å°†RGBå›¾åƒï¼ˆ3é€šé“ï¼Œuint8_tï¼‰è½¬æ¢ä¸ºç°åº¦å›¾åƒï¼Œç°åº¦å€¼è®¡ç®—å…¬å¼ä¸ºï¼š<code>gray = 0.299*R + 0.587*G + 0.114*B</code>ã€‚è¦æ±‚è¾¾åˆ°&gt;80%çš„å¸¦å®½åˆ©ç”¨ç‡ã€‚</p>
<details>
<summary>æç¤º</summary>
<ol>
<li>ä½¿ç”¨å‘é‡åŒ–åŠ è½½RGBæ•°æ®</li>
<li>è€ƒè™‘æ•°æ®å¯¹é½</li>
<li>ä½¿ç”¨æ•´æ•°è¿ç®—é¿å…æµ®ç‚¹è½¬æ¢</li>
</ol>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å…³é”®ç‚¹ï¼š1)ä½¿ç”¨uchar4å‘é‡åŒ–è¯»å–4ä¸ªåƒç´ ï¼ˆ12å­—èŠ‚ï¼‰ï¼›2)ä½¿ç”¨å®šç‚¹æ•°è¿ç®—(Ã—1000)é¿å…æµ®ç‚¹ï¼›3)ç¡®ä¿è¾“å…¥è¾“å‡ºéƒ½æ˜¯åˆå¹¶è®¿é—®ï¼›4)æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªåƒç´ å¢åŠ ILPã€‚</p>
</details>
<p><strong>ç»ƒä¹ 3.5</strong>ï¼šä¼˜åŒ–ç¨€ç–çŸ©é˜µå‘é‡ä¹˜æ³•ï¼ˆSpMVï¼‰çš„å†…å­˜è®¿é—®ã€‚ç»™å®šCSRæ ¼å¼çš„ç¨€ç–çŸ©é˜µï¼Œå¦‚ä½•å‡å°‘éšæœºè®¿é—®å¸¦æ¥çš„æ€§èƒ½æŸå¤±ï¼Ÿ</p>
<details>
<summary>æç¤º</summary>
<ol>
<li>è€ƒè™‘å‘é‡xçš„è®¿é—®æ¨¡å¼</li>
<li>ä½¿ç”¨çº¹ç†å†…å­˜æˆ–åªè¯»ç¼“å­˜</li>
<li>åˆ†å—å¤„ç†æé«˜å±€éƒ¨æ€§</li>
</ol>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç­–ç•¥ï¼š1)å‘é‡xé€šè¿‡çº¹ç†ç¼“å­˜/__ldgè®¿é—®ï¼›2)ä½¿ç”¨SELL-C-Ïƒæ ¼å¼æ”¹å–„åˆå¹¶ï¼›3)è¡Œåˆ†å—ä½¿å¤šä¸ªçº¿ç¨‹åä½œå¤„ç†é•¿è¡Œï¼›4)ä½¿ç”¨å…±äº«å†…å­˜ç¼“å­˜é¢‘ç¹è®¿é—®çš„xå…ƒç´ ã€‚</p>
</details>
<h3 id="_3">æŒ‘æˆ˜é¢˜ï¼ˆç»¼åˆä¼˜åŒ–ï¼‰</h3>
<p><strong>ç»ƒä¹ 3.6</strong>ï¼šå®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„2Då·ç§¯kernelï¼ˆ5Ã—5å·ç§¯æ ¸ï¼‰ï¼Œå¤„ç†4Kåˆ†è¾¨ç‡å›¾åƒï¼Œè¦æ±‚è¾¾åˆ°&gt;1TFLOPSçš„è®¡ç®—ååé‡ã€‚åˆ†æå†…å­˜è®¿é—®æ¨¡å¼å¹¶ç»™å‡ºä¼˜åŒ–ç­–ç•¥ã€‚</p>
<details>
<summary>æç¤º</summary>
<ol>
<li>è®¡ç®—é‡ç”¨ç‡ï¼šæ¯ä¸ªè¾“å‡ºéœ€è¦25æ¬¡ä¹˜åŠ </li>
<li>ä½¿ç”¨å…±äº«å†…å­˜ç¼“å­˜è¾“å…¥tile</li>
<li>è€ƒè™‘haloåŒºåŸŸçš„å¤„ç†</li>
<li>å‘é‡åŒ–å’Œå¾ªç¯å±•å¼€</li>
</ol>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–è¦ç‚¹ï¼š1)è¾“å…¥tileåŠ è½½åˆ°å…±äº«å†…å­˜(å¦‚18Ã—18 for 14Ã—14è¾“å‡º)ï¼›2)ä½¿ç”¨float4å‘é‡åŒ–ï¼›3)å¯„å­˜å™¨ç¼“å­˜å·ç§¯æ ¸ï¼›4)æ¯ä¸ªçº¿ç¨‹è®¡ç®—2Ã—2æˆ–4Ã—4è¾“å‡ºå—ï¼›5)textureå†…å­˜å¤„ç†è¾¹ç•Œï¼›6)è€ƒè™‘ä½¿ç”¨Tensor Coreï¼ˆå¦‚å¯ç”¨ï¼‰ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 3.7</strong>ï¼šåœ¨è‡ªåŠ¨é©¾é©¶åœºæ™¯ä¸­ï¼Œéœ€è¦å®æ—¶å¤„ç†64çº¿æ¿€å…‰é›·è¾¾æ•°æ®ï¼ˆæ¯å¸§çº¦13ä¸‡ç‚¹ï¼‰ã€‚è®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„å’Œè®¿é—®æ¨¡å¼ï¼Œæ”¯æŒï¼š1)å¿«é€ŸèŒƒå›´æŸ¥è¯¢ï¼›2)ä½“ç´ åŒ–ï¼ˆvoxelizationï¼‰ï¼›3)KNNæœç´¢ã€‚è¦æ±‚æ€»å¤„ç†æ—¶é—´&lt;10msã€‚</p>
<details>
<summary>æç¤º</summary>
<ol>
<li>è€ƒè™‘ç©ºé—´æ•°æ®ç»“æ„ï¼ˆç½‘æ ¼ã€å…«å‰æ ‘ï¼‰</li>
<li>å¹³è¡¡æ„å»ºæ—¶é—´å’ŒæŸ¥è¯¢æ•ˆç‡</li>
<li>åˆ©ç”¨ç‚¹äº‘çš„æ—¶åºç‰¹æ€§</li>
</ol>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ–¹æ¡ˆï¼š1)ä½¿ç”¨è§„åˆ™ç½‘æ ¼+å“ˆå¸Œè¡¨ï¼ŒO(1)ä½“ç´ æŸ¥è¯¢ï¼›2)Mortonç¼–ç å®ç°ç©ºé—´å±€éƒ¨æ€§ï¼›3)åˆ†å±‚ç½‘æ ¼æ”¯æŒå¤šå°ºåº¦ï¼›4)ä½¿ç”¨æ»‘åŠ¨çª—å£å¤ç”¨ä¸Šå¸§ç»“æ„ï¼›5)å…±äº«å†…å­˜ç¼“å­˜é‚»åŸŸä½“ç´ ï¼›6)åŸå­æ“ä½œå¤„ç†ç‚¹è®¡æ•°ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 3.8</strong>ï¼šè®¾è®¡ä¸€ä¸ªç»Ÿä¸€å†…å­˜(Unified Memory)çš„ä½¿ç”¨ç­–ç•¥ï¼Œç”¨äºå…·èº«æ™ºèƒ½æœºå™¨äººçš„SLAMç³»ç»Ÿã€‚ç³»ç»Ÿéœ€è¦ç»´æŠ¤ä¸€ä¸ªå¤§è§„æ¨¡åœ°å›¾ï¼ˆ&gt;1GBï¼‰ï¼ŒåŒæ—¶CPUéœ€è¦è¿›è¡Œè·¯å¾„è§„åˆ’ï¼ŒGPUè¿›è¡Œåœ°å›¾æ›´æ–°ã€‚å¦‚ä½•ä¼˜åŒ–æ•°æ®ç§»åŠ¨ï¼Ÿ</p>
<details>
<summary>æç¤º</summary>
<ol>
<li>ä½¿ç”¨cudaMemAdviseæç¤ºè®¿é—®æ¨¡å¼</li>
<li>é¢„å–ç­–ç•¥</li>
<li>åˆ†åŒºç®¡ç†</li>
<li>è€ƒè™‘é¡µé¢è¿ç§»å¼€é”€</li>
</ol>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç­–ç•¥ï¼š1)åœ°å›¾åˆ†å—ï¼Œæ´»è·ƒå—é¢„å–åˆ°GPUï¼›2)ä½¿ç”¨cudaMemAdviseSetReadMostlyæ ‡è®°é™æ€åŒºåŸŸï¼›3)CPUè·¯å¾„è§„åˆ’æ—¶é¢„å–ç›¸å…³å—ï¼›4)ä½¿ç”¨æµå¹¶å‘æ›´æ–°ä¸åŒå—ï¼›5)å®šæœŸæ•´ç†å‡å°‘ç¢ç‰‡ï¼›6)å…³é”®è·¯å¾„é¿å…é¡µé”™è¯¯ã€‚</p>
</details>
<h2 id="38">3.8 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1">é™·é˜±1ï¼šè¯¯åˆ¤å†…å­˜åˆå¹¶</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// çœ‹ä¼¼åˆå¹¶ï¼Œå®é™…ä¸åˆå¹¶</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Vec3</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="p">};</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="n">Vec3</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">x</span><span class="p">;</span><span class="w">  </span><span class="c1">// çº¿ç¨‹è®¿é—®æ­¥é•¿12å­—èŠ‚ï¼Œä¸å®Œå…¨åˆå¹¶ï¼</span>
<span class="p">}</span>
<span class="c1">// è§£å†³ï¼šä½¿ç”¨SoAå¸ƒå±€æˆ–float3å‘é‡ç±»å‹</span>
</code></pre></div>

<h3 id="2">é™·é˜±2ï¼šç¼“å­˜æ±¡æŸ“</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// å¤§é‡æµå¼æ•°æ®æ±¡æŸ“L1ç¼“å­˜</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">stream_process</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">out</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ— é‡ç”¨ï¼Œå´å ç”¨ç¼“å­˜</span>
<span class="p">}</span>
<span class="c1">// è§£å†³ï¼šä½¿ç”¨ -Xptxas -dlcm=cg ç¼–è¯‘é€‰é¡¹ç»•è¿‡L1</span>
</code></pre></div>

<h3 id="3_1">é™·é˜±3ï¼šå‘é‡åŒ–çš„é”™è¯¯å‡è®¾</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šå‡è®¾åœ°å€æ€»æ˜¯å¯¹é½çš„</span>
<span class="kt">float4</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float4</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w">  </span><span class="c1">// offsetä¸æ˜¯4çš„å€æ•°æ—¶æœªå¯¹é½ï¼</span>
<span class="kt">float4</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™æˆ–é”™è¯¯</span>
<span class="c1">// è§£å†³ï¼šæ£€æŸ¥å¯¹é½æˆ–ä½¿ç”¨éå¯¹é½åŠ è½½</span>
</code></pre></div>

<h3 id="4">é™·é˜±4ï¼šç»Ÿä¸€å†…å­˜çš„éšè—å¼€é”€</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é¡µé¢è¿ç§»çš„éšè—æˆæœ¬</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">unified_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// é¦–æ¬¡è®¿é—®è§¦å‘é¡µé”™è¯¯ï¼Œå¯èƒ½æœ‰msçº§å»¶è¿Ÿï¼</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unified_data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span><span class="w">  </span>
<span class="p">}</span>
<span class="c1">// è§£å†³ï¼šä½¿ç”¨cudaMemPrefetchAsyncé¢„å–</span>
</code></pre></div>

<h3 id="5">é™·é˜±5ï¼šåŸå­æ“ä½œçš„å¸¦å®½å½±å“</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// åŸå­æ“ä½œä¸¥é‡é™ä½å¸¦å®½</span>
<span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">histogram</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">bins</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
<span class="w">    </span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bins</span><span class="p">[</span><span class="n">val</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€åœ°å€</span>
<span class="p">}</span>
<span class="c1">// è§£å†³ï¼šä½¿ç”¨å…±äº«å†…å­˜å±€éƒ¨ç›´æ–¹å›¾+å½’çº¦</span>
</code></pre></div>

<h3 id="6bank-conflict">é™·é˜±6ï¼šBank Conflictçš„éšè”½æ€§</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// éšè”½çš„bank conflict</span>
<span class="kt">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">matrix</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">16</span><span class="p">];</span><span class="w">  </span><span class="c1">// 16 &lt; 32ï¼Œçœ‹ä¼¼å®‰å…¨</span>
<span class="n">matrix</span><span class="p">[</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä½†åˆ—è®¿é—®æ—¶ä»æœ‰conflictï¼</span>
<span class="c1">// è§£å†³ï¼šä½¿ç”¨[16][17]æˆ–é‡æ–°å®‰æ’è®¿é—®æ¨¡å¼</span>
</code></pre></div>

<h3 id="7">é™·é˜±7ï¼šé”™è¯¯çš„å¸¦å®½è®¡ç®—</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šåªè®¡ç®—æœ‰ç”¨æ•°æ®</span>
<span class="n">bandwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">useful_bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">time</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¿½ç•¥äº†æµªè´¹çš„ä¼ è¾“ï¼</span>
<span class="c1">// æ­£ç¡®ï¼šè®¡ç®—å®é™…ä¼ è¾“</span>
<span class="n">bandwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual_transferred_bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>
</code></pre></div>

<h3 id="8">é™·é˜±8ï¼šè¿‡åº¦ä¼˜åŒ–çš„é™·é˜±</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// è¿‡åº¦å¤æ‚çš„ä¼˜åŒ–åè€Œé™ä½æ€§èƒ½</span>
<span class="c1">// 16ä¸ªä¸åŒçš„å†…å­˜è®¿é—®æ¨¡å¼ï¼Œå¯„å­˜å™¨å‹åŠ›è¿‡å¤§</span>
<span class="c1">// è§£å†³ï¼šå¹³è¡¡ä¼˜åŒ–å¤æ‚åº¦ä¸æ”¶ç›Š</span>
</code></pre></div>

<h2 id="39">3.9 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_4">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ•°æ®ç»“æ„é€‰æ‹©</strong>ï¼šAoS vs SoAï¼Œè€ƒè™‘è®¿é—®æ¨¡å¼</li>
<li>[ ] <strong>å†…å­˜åˆ†é…</strong>ï¼šç¡®ä¿åŸºåœ°å€å¯¹é½ï¼ˆä½¿ç”¨cudaMallocPitchï¼‰</li>
<li>[ ] <strong>ç®—æ³•é€‰æ‹©</strong>ï¼šè¯„ä¼°è®¡ç®—å¼ºåº¦ï¼Œåˆ¤æ–­æ˜¯å¦å†…å­˜å—é™</li>
<li>[ ] <strong>å®¹é‡è§„åˆ’</strong>ï¼šä¼°ç®—å†…å­˜å¸¦å®½éœ€æ±‚vsç¡¬ä»¶èƒ½åŠ›</li>
<li>[ ] <strong>è®¿é—®æ¨¡å¼åˆ†æ</strong>ï¼šç”»å‡ºå†…å­˜è®¿é—®å›¾ï¼Œè¯†åˆ«çƒ­ç‚¹</li>
</ul>
<h3 id="_5">å®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>åˆå¹¶è®¿é—®</strong>ï¼šè¿ç»­çº¿ç¨‹è®¿é—®è¿ç»­åœ°å€</li>
<li>[ ] <strong>å‘é‡åŒ–</strong>ï¼šä½¿ç”¨float2/float4å‡å°‘äº‹åŠ¡</li>
<li>[ ] <strong>ç¼“å­˜é…ç½®</strong>ï¼šæ ¹æ®è®¿é—®æ¨¡å¼é€‰æ‹©L1/Sharedæ¯”ä¾‹</li>
<li>[ ] <strong>åªè¯»è·¯å¾„</strong>ï¼šæ ‡è®°const __restrict__æˆ–ä½¿ç”¨__ldg</li>
<li>[ ] <strong>é¿å…bank conflict</strong>ï¼šå…±äº«å†…å­˜padding</li>
<li>[ ] <strong>æ•°æ®é¢„å–</strong>ï¼šç»Ÿä¸€å†…å­˜ä½¿ç”¨cudaMemPrefetchAsync</li>
<li>[ ] <strong>å¾ªç¯å±•å¼€</strong>ï¼šå¢åŠ æŒ‡ä»¤çº§å¹¶è¡Œï¼Œéšè—å»¶è¿Ÿ</li>
</ul>
<h3 id="_6">ä¼˜åŒ–é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ€§èƒ½åˆ†æ</strong>ï¼šä½¿ç”¨Nsight Computeæ£€æŸ¥å†…å­˜æ•ˆç‡</li>
<li>[ ] <strong>å¸¦å®½æµ‹é‡</strong>ï¼šå¯¹æ¯”å®æµ‹vsç†è®ºå¸¦å®½</li>
<li>[ ] <strong>ç“¶é¢ˆè¯†åˆ«</strong>ï¼šLoad/Storeå•å…ƒåˆ©ç”¨ç‡</li>
<li>[ ] <strong>äº‹åŠ¡åˆ†æ</strong>ï¼šæ£€æŸ¥L2ç¼“å­˜äº‹åŠ¡å¤§å°åˆ†å¸ƒ</li>
<li>[ ] <strong>å ç”¨ç‡åˆ†æ</strong>ï¼šç¡®ä¿è¶³å¤Ÿçš„æ´»è·ƒwarpéšè—å»¶è¿Ÿ</li>
<li>[ ] <strong>è¿­ä»£ä¼˜åŒ–</strong>ï¼šæ ¹æ®profileræ•°æ®è°ƒæ•´</li>
</ul>
<h3 id="_7">éªŒè¯é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ­£ç¡®æ€§</strong>ï¼šcuda-memcheckæ£€æŸ¥è¶Šç•Œè®¿é—®</li>
<li>[ ] <strong>æ‰©å±•æ€§</strong>ï¼šæµ‹è¯•ä¸åŒé—®é¢˜è§„æ¨¡</li>
<li>[ ] <strong>ç¨³å®šæ€§</strong>ï¼šé•¿æ—¶é—´è¿è¡Œæµ‹è¯•</li>
<li>[ ] <strong>ç§»æ¤æ€§</strong>ï¼šä¸åŒGPUæ¶æ„çš„æ€§èƒ½</li>
<li>[ ] <strong>è¾¹ç•Œæƒ…å†µ</strong>ï¼šéå¯¹é½ã€é2çš„å¹‚æ¬¡å¤§å°</li>
<li>[ ] <strong>é”™è¯¯å¤„ç†</strong>ï¼šå†…å­˜åˆ†é…å¤±è´¥ç­‰å¼‚å¸¸æƒ…å†µ</li>
</ul>
<h3 id="_8">éƒ¨ç½²é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ€§èƒ½ç›‘æ§</strong>ï¼šè¿è¡Œæ—¶å¸¦å®½ç›‘æ§</li>
<li>[ ] <strong>è‡ªé€‚åº”è°ƒä¼˜</strong>ï¼šæ ¹æ®ç¡¬ä»¶åŠ¨æ€è°ƒæ•´å‚æ•°</li>
<li>[ ] <strong>ç‰ˆæœ¬å…¼å®¹</strong>ï¼šä¸åŒCUDAç‰ˆæœ¬çš„å…¼å®¹æ€§</li>
<li>[ ] <strong>æ–‡æ¡£å®Œå–„</strong>ï¼šè®°å½•ä¼˜åŒ–å†³ç­–å’Œæƒè¡¡</li>
<li>[ ] <strong>æŒç»­ä¼˜åŒ–</strong>ï¼šæ–°ç¡¬ä»¶çš„é€‚é…è®¡åˆ’</li>
</ul>
<p>è®°ä½ï¼šä¼˜ç§€çš„CUDAç¨‹åºå‘˜æ€»æ˜¯ä»å†…å­˜è®¿é—®æ¨¡å¼å¼€å§‹æ€è€ƒé—®é¢˜ã€‚åœ¨åŠ¨æ‰‹ç¼–ç å‰ï¼Œå…ˆåœ¨çº¸ä¸Šç”»å‡ºæ•°æ®å¸ƒå±€å’Œè®¿é—®æ¨¡å¼ï¼æ¯ä¸€ä¸ªå­—èŠ‚çš„ä¼ è¾“éƒ½åº”è¯¥æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæ¯ä¸€æ¬¡å†…å­˜è®¿é—®éƒ½åº”è¯¥ç»è¿‡ç²¾å¿ƒè®¾è®¡ã€‚</p>
            </article>
            
            <nav class="page-nav"><a href="chapter2.html" class="nav-link prev">â† ç¬¬2ç« ï¼šCUDAç¼–ç¨‹æ¨¡å‹ä¸æ‰§è¡Œæ¨¡å‹</a><a href="chapter4.html" class="nav-link next">ç¬¬4ç« ï¼šå…±äº«å†…å­˜ä¸Bank Conflict â†’</a></nav>
        </main>
    </div>
</body>
</html>